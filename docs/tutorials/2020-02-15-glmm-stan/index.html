<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrea Gabrio">
<meta name="dcterms.date" content="2020-02-15">
<meta name="keywords" content="Software, Statistics, Stan">

<title>Generalised Linear Mixed Models (Stan) – Andrea Gabrio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andrea Gabrio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../missing_data.html"> 
<span class="menu-text">Missing Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#hierarchical-poisson-regression" id="toc-hierarchical-poisson-regression" class="nav-link" data-scroll-target="#hierarchical-poisson-regression">Hierarchical Poisson regression</a></li>
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data">Loading the data</a>
  <ul class="collapse">
  <li><a href="#data-check" id="toc-data-check" class="nav-link" data-scroll-target="#data-check">Data check</a></li>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model fitting</a></li>
  <li><a href="#mcmc-diagnostics" id="toc-mcmc-diagnostics" class="nav-link" data-scroll-target="#mcmc-diagnostics">MCMC diagnostics</a></li>
  <li><a href="#model-validation" id="toc-model-validation" class="nav-link" data-scroll-target="#model-validation">Model validation</a></li>
  </ul></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Generalised Linear Mixed Models (Stan)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Quarto</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Academia</div>
    <div class="quarto-category">Software</div>
    <div class="quarto-category">Statistics</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://angabrio.github.io/agabriosite2/">Andrea Gabrio</a> <a href="mailto:a.gabrio@maastrichtuniversity.nl" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-7650-4534" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://www.maastrichtuniversity.nl/research/methodology-and-statistics">
            Maastricht University
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 15, 2020</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p><span style="font-size: 85%">This tutorial will focus on the use of Bayesian estimation to fit simple linear regression models …</span></p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Software, Statistics, Stan</p>
  </div>
</div>

</header>


<p>This tutorial will focus on the use of Bayesian estimation to fit simple linear regression models. <code>BUGS</code> (Bayesian inference Using <em>Gibbs Sampling</em>) is an algorithm and supporting language (resembling <code>R</code>) dedicated to performing the Gibbs sampling implementation of <em>Markov Chain Monte Carlo</em> (MCMC) method. Dialects of the <code>BUGS</code> language are implemented within three main projects:</p>
<ol type="1">
<li><p><strong>OpenBUGS</strong> - written in component pascal.</p></li>
<li><p><strong>JAGS</strong> - (Just Another Gibbs Sampler) - written in <code>C++</code>.</p></li>
<li><p><strong>Stan</strong> - a dedicated Bayesian modelling framework written in <code>C++</code> and implementing <em>Hamiltonian</em> MCMC samplers.</p></li>
</ol>
<p>Whilst the above programs can be used stand-alone, they do offer the rich data pre-processing and graphical capabilities of <code>R</code>, and thus, they are best accessed from within <code>R</code> itself. As such there are multiple packages devoted to interfacing with the various software implementations:</p>
<ul>
<li><p><em>R2OpenBUGS</em> - interfaces with <code>OpenBUGS</code></p></li>
<li><p><em>R2jags</em> - interfaces with <code>JAGS</code></p></li>
<li><p><em>rstan</em> - interfaces with <code>Stan</code></p></li>
</ul>
<p>This tutorial will demonstrate how to fit models in <code>Stan</code> (<span class="citation" data-cites="gelman2015stan">Gelman, Lee, and Guo (<a href="#ref-gelman2015stan" role="doc-biblioref">2015</a>)</span>) using the package <code>rstan</code> (<span class="citation" data-cites="rstanpackage">Stan Development Team (<a href="#ref-rstanpackage" role="doc-biblioref">2018</a>)</span>) as interface, which also requires to load some other packages.</p>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>In some respects, <em>Generalized Linear Mixed effects Models</em> (GLMM) are a hierarchical extension of <em>Generalized linear models</em> (GLM) in a similar manner that Linear Mixed effects Models (LMM) are a hierarchical extension of Linear Models (LM). However, whilst the Gaussian (normal) distribution facilitates a relatively straight way of generating the marginal likelihood of the observed response by integrating likelihoods across all possible (and unobserved) levels of a random effect to yield parameter estimates, the same cannot be said for other distributions. Consequently various approximations have been developed to estimate the fixed and random parameters for GLMM’s:</p>
<ol type="1">
<li><p><strong>Penalized quasi-likelihood</strong> (PQL). This method approximates a quasi-likelihood by iterative fitting of (re)weighted linear mixed effects models based on the fit of GLM fit. Specifically, it estimates the fixed effects parameters by fitting a GLM that incorporates a correlation (variance-covariance) structure resulting from a LMM and then refits a LMM to re-estimate the variance-covariance structure by using the variance structure from the previous GLM. The cycle continues to iterate until either the fit improvement is below a threshold or a defined number of iterations has occurred. Whilst this is a relatively simple approach, that enables us to leverage methodologies for accommodating heterogeneity and spatial/temporal autocorrelation, it is known to perform poorly (estimates biased towards large variance) for Poisson distributions when the expected value is less than <span class="math inline">\(5\)</span> and for binary data when the expected number of successes or failures are less than <span class="math inline">\(5\)</span>. Moreover, as it approximates quasi-likelihood rather than likelihood, likelihood based inference and information criterion methods (such as likelihood ratio tests and AIC) are not appropriate with this approach. Instead, Wald tests are required for inference.</p></li>
<li><p><strong>Laplace approximation</strong>. This approach utilises a second-order Taylor series expansion to approximate (a mathematical technique for approximating the properties of a function around a point by taking multiple derivatives of the function and summing them together) the likelihood function. If we assume that the likelihood function is approximately normal and thus a quadratic function on a log scale, we can use second-order Taylor series expansion to approximate this likelihood. Whilst this approach is considered to be more accurate than PQL, it is considerably slower and unable to accommodate alternative variance and correlation structures.</p></li>
<li><p><strong>Gauss-Hermite quadrature</strong> (GHQ). This approach approximates the marginal likelihood by approximating the value of integrals at specific points (quadratures). This technique can be further adapted by allowing the number of quadratures and their weights to be optimized via a set of rules.</p></li>
<li><p><strong>Markov-chain Monte-Carlo</strong> (MCMC). This takes a bruit force approach by recreating the likelihood by traversing the likelihood function with sequential sampling proportional to the likelihood. Although this approach is very robust (when the posteriors have converged), they are computationally very intense. Interestingly, some (including Andrew Gelman) argue that PQL, Laplace and GHQ do not yield estimates. Rather they are only approximations of estimates. By contrast, as MCMC methods are able to integrate over all levels by bruit force, the resulting parameters are indeed true estimates.</p></li>
</ol>
<p>We will focus on the last approach which is the more general among the ones considered here and which is based on a Bayesian approach, which can be very flexible and accurate, yet very slow and complex.</p>
</section>
<section id="hierarchical-poisson-regression" class="level1">
<h1>Hierarchical Poisson regression</h1>
<p>The model I will be developing is a Bayesian hierarchical Poisson regression model which I used for the modelling of match results in volleyball, also available as a published <a href="https://www.tandfonline.com/doi/full/10.1080/02664763.2020.1723506?casa_token=5NyZAGE970gAAAAA%3AjcSlhut9cztg1nQheK_Z3NZPUuKvwUAcodvBD7g47amY1Cb-ViZZFt-ikcaYhU7o7sIzwEOOcEgH">paper</a>. The objective of the analysis is to model the match results from the season 2017-2018 of <em>Serie A1</em>, the premium Italian female volleyball league. In total there were <span class="math inline">\(136\)</span> games (rows) in the dataset each with information regarding which was the home and away team, what these teams scored, whether the match ended with <span class="math inline">\(4\)</span> or <span class="math inline">\(5\)</span> sets, and additional in-game statistics such as number of attacks, digs, serves, and blocks for each team in each match. The point outcomes of the teams in the games are assumed to be distributed according to a Poisson distribution. This model is similar to other models used for the modelling of football results, where the points scored by the home and away teams are defined as a function of latent attacking and defensive skills of the teams estimated across the games.</p>
<p>The peculiar (and novel) aspect of the model is that it takes into account the features of volleyball to generate plausible game results and league points scored by the teams across the season. In particular, for modelling purposes it is important to accout for the following aspects. 1) according to the current scoring system, matches are played until a team wins a total of three sets, with each set typically going to <span class="math inline">\(25\)</span> points. However, if the two teams won two sets each, the third set then goes only up to <span class="math inline">\(15\)</span> points. 2) a team must win each set by <span class="math inline">\(2\)</span> points. If the score is tied with even numbers, both teams have to continue playing the set until a <span class="math inline">\(2\)</span>-point lead is obtained. Otherwise, points keep accumulating until one team wins with a margin of victory of <span class="math inline">\(2\)</span> points, even if the score is greater than <span class="math inline">\(25\)</span> or <span class="math inline">\(15\)</span> points. 3) in professional volleyball leagues, the teams get points according to set numbers at the end of all matches in the league. More specifically, the team points are awarded as follows: if the match is won <span class="math inline">\(3–0\)</span> or <span class="math inline">\(3–1\)</span>, <span class="math inline">\(3\)</span> points are assigned to the winner and <span class="math inline">\(0\)</span> points to the loser; if the match is won <span class="math inline">\(3–2\)</span>, <span class="math inline">\(2\)</span> points are assigned to the winner and <span class="math inline">\(1\)</span> point to the loser.</p>
<p>The model is a Bayesian hierarchical analysis of volleyball data which allows to jointly predict match results and team rankings in national leagues. I use data from the women’s volleyball Italian Serie A1 <span class="math inline">\(2017–2018\)</span> season as a motivating example to implement and validate the model.</p>
</section>
<section id="loading-the-data" class="level1">
<h1>Loading the data</h1>
<p>I start by loading libraries, reading in the data and preprocessing it for <code>Stan</code>. In the original verison of the analysis I used <code>JAGS</code> and a slightly more complicated model which I do not consider here, but that you may consult in my paper if interested (<span class="citation" data-cites="gabrio2020bayesian">Gabrio (<a href="#ref-gabrio2020bayesian" role="doc-biblioref">2020</a>)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#load data</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span><span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">"Volley_prepro_v1.csv"</span>,<span class="at">header =</span> T)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>home.team<span class="ot">&lt;-</span><span class="fu">as.factor</span>(data<span class="sc">$</span>home.team)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>away.team<span class="ot">&lt;-</span><span class="fu">as.factor</span>(data<span class="sc">$</span>away.team)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>bloeff1<span class="ot">&lt;-</span>(data<span class="sc">$</span>bloper1<span class="sc">-</span>data<span class="sc">$</span>bloinv1)<span class="sc">/</span>(data<span class="sc">$</span>blo1<span class="sc">+</span>data<span class="sc">$</span>bloper1)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>bloeff2<span class="ot">&lt;-</span>(data<span class="sc">$</span>bloper2<span class="sc">-</span>data<span class="sc">$</span>bloinv2)<span class="sc">/</span>(data<span class="sc">$</span>blo2<span class="sc">+</span>data<span class="sc">$</span>bloper2)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>data_stat1<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(h), summarise, <span class="at">meanatteff1=</span><span class="fu">mean</span>(atteff1),<span class="at">meansereff1=</span><span class="fu">mean</span>(sereff1),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">meandefeff1=</span><span class="fu">mean</span>(defeff1),<span class="at">meanbloeff1=</span><span class="fu">mean</span>(bloeff1))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>data_stat2<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(a), summarise, <span class="at">meanatteff2=</span><span class="fu">mean</span>(atteff2),<span class="at">meansereff2=</span><span class="fu">mean</span>(sereff2),</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">meandefeff2=</span><span class="fu">mean</span>(defeff2),<span class="at">meanbloeff2=</span><span class="fu">mean</span>(bloeff2))</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">#center cov grand mean</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>atteff1.cen<span class="ot">&lt;-</span>data<span class="sc">$</span>atteff1<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>atteff1)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>sereff1.cen<span class="ot">&lt;-</span>data<span class="sc">$</span>sereff1<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>sereff1)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>bloeff1.cen<span class="ot">&lt;-</span>data<span class="sc">$</span>bloeff1<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>bloeff1)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>defeff1.cen<span class="ot">&lt;-</span>data<span class="sc">$</span>defeff1<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>defeff1)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>atteff2.cen<span class="ot">&lt;-</span>data<span class="sc">$</span>atteff2<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>atteff2)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>sereff2.cen<span class="ot">&lt;-</span>data<span class="sc">$</span>sereff2<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>sereff2)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>bloeff2.cen<span class="ot">&lt;-</span>data<span class="sc">$</span>bloeff2<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>bloeff2)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>defeff2.cen<span class="ot">&lt;-</span>data<span class="sc">$</span>defeff2<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>defeff2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-check" class="level2">
<h2 class="anchored" data-anchor-id="data-check">Data check</h2>
<p>How are the number of points for each team in a volleyball match distributed? Well, let’s start by assuming that both teams have many chances at making a point and that each team have the same probability of scoring each point chance. Given these assumptions the distribution of the number of points for each team should be well captured by a Poisson distribution. A quick and dirty comparison between the actual distribution of the number of scored goals and a Poisson distribution having the same mean number of scored goals support this notion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="fl">2.2</span>, <span class="dv">4</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">c</span>(data<span class="sc">$</span>y2, data<span class="sc">$</span>y1), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">120</span>), <span class="at">breaks =</span> <span class="dv">8</span>,<span class="at">main =</span> <span class="st">"Distribution of the number of points</span><span class="sc">\n</span><span class="st">scored by a team in a match."</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>mean_goals <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">c</span>(data<span class="sc">$</span>y2, data<span class="sc">$</span>y1))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">rpois</span>(<span class="dv">9999</span>, mean_goals), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">120</span>), <span class="at">breaks =</span> <span class="dv">8</span> ,<span class="at">main =</span> <span class="st">"Random draw from a Poisson distribution with</span><span class="sc">\n</span><span class="st">the same mean as the distribution above."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting">Model fitting</h2>
<p>All teams aren’t equally good and it will be assumed that all teams have a latent skill variable and the skill of a team minus the skill of the opposing team defines the predicted outcome of a game. As the number of goals are assumed to be Poisson distributed it is natural that the skills of the teams are on the log scale of the mean of the distribution. The distribution of the number of goals for the home team <span class="math inline">\(i\)</span> when facing the away team <span class="math inline">\(j\)</span> is then</p>
<p><span class="math display">\[
\text{Points} \sim \text{Pois}(\lambda)
\]</span></p>
<p>where <span class="math inline">\(\log(\lambda)=\mu + \text{home} + \text{skill}_i - \text{skill}_j\)</span>. <span class="math inline">\(\mu\)</span> is a constant, while home is the advantage for the team hosting the game which is typically assumed to be constant for all the teams and throughout the season. The point outcome of a match between home team <span class="math inline">\(i\)</span> and away team <span class="math inline">\(j\)</span> is modeled as:</p>
<p><span class="math display">\[
\text{HomePoins}_{ij} \sim \text{Pois}(\lambda_{\text{home},ij}),
\]</span></p>
<p><span class="math display">\[
\text{AwayPoints}_{ij} \sim \text{Pois}(\lambda_{\text{away},ij}),
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\log(\lambda_{\text{home},ij}) = \mu + \text{home} + \text{skill}_i - \text{skill}_j,
\]</span></p>
<p><span class="math display">\[
\log(\lambda_{\text{away},ij}) = \mu + \text{skill}_j - \text{skill}_i.
\]</span></p>
<p>The skill parameters for the home and away teams are specified as a function of a set of attack and defense skills, which in turn are a linear function of different in-game statistics including the number of attacks, digs, serves and blocks for each team:</p>
<p><span class="math display">\[
\text{skill}_i = \alpha_{0i} + \alpha_{1i}\text{attacks} + \alpha_{2i}\text{serves} + ,
\]</span></p>
<p><span class="math display">\[
\text{skill}_j = \beta_{0j} + \beta_{1j}\text{digs} + \beta_{2j}\text{blocks},
\]</span></p>
<p>The distribution of two indicator variables, related to whether or not the fifth set was played (<span class="math inline">\(d^s\)</span>) and whether the home team was the winner (<span class="math inline">\(d^g\)</span>) in each match, are also included in the model. These are modelled as:</p>
<p><span class="math display">\[
d^s \sim \text{Bernoulli}(\pi^s) \;\;\; \text{and} \;\;\; d^g \sim \text{Bernoulli}(\pi^g),
\]</span></p>
<p>where the corresponding probabilities are specified as</p>
<p><span class="math display">\[
\text{logit}(\pi^s) = \gamma_{0} + \gamma_1\text{HomePoins}_{i} + \gamma_2\text{AwayPoins}_{j},
\]</span></p>
<p><span class="math display">\[
\text{logit}(\pi^g) = \delta_{0} + \delta_1\text{HomePoins}_{i} + \delta_2\text{AwayPoins}_{j} + \delta_3d^g.
\]</span></p>
<p>I set the prior distributions over <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\text{home}\)</span> to:</p>
<p><span class="math display">\[
\text{home} \sim N(0, 10000) \;\;\; \text{and} \;\;\; \mu \sim N(0, 10000),
\]</span></p>
<p>weakly informative priors on <span class="math inline">\(\boldsymbol \gamma\)</span>, <span class="math inline">\(\boldsymbol \delta\)</span>, and set the priors on the skill of all <span class="math inline">\(n\)</span> teams using a hierarchical approach to :</p>
<p><span class="math display">\[
\text{skill}_{1,\ldots,n} \sim N(\mu_{\text{teams}}, \sigma^2_{\text{teams}}),
\]</span></p>
<p>so that teams are assumed to have similar but not identical mean and variance parameters for thier skill parameters. Turning this into a <code>Stan</code> model requires some minor adjustments. I have to “anchor” the sum of team skills to a constant otherwise the mean skill can drift away freely (<em>sum to zero constraint</em>) and the model cannot be identified. Doing these adjustments results in the following model description:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rstanString<span class="ot">&lt;-</span><span class="st">"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=1&gt; nteams; // number of teams</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=1&gt; ngames; // number of games</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=1, upper=nteams&gt; home_team[ngames]; // home team ID (1, ..., 12)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=1, upper=nteams&gt; away_team[ngames]; // away team ID (1, ..., 12)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="st">vector [ngames] att_eff1; // in game statistics for number of attacks (home)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">vector [ngames] ser_eff1; // in game statistics for number of serves (home)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">vector [ngames] def_eff2; // in game statistics for number of digs (away)</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="st">vector [ngames] blo_eff2; // in game statistics for number of blocks (away)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="st">vector [ngames] att_eff2; // in game statistics for number of attacks (away)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="st">vector [ngames] ser_eff2; // in game statistics for number of serves (away)</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="st">vector [ngames] def_eff1; // in game statistics for number of digs (home)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="st">vector [ngames] blo_eff1; // in game statistics for number of blocks (home)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0&gt; y1[ngames]; // number of points scored by home team</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0&gt; y2[ngames]; // number of points scored by away team</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0, upper=1&gt; ds[ngames]; // indicator for number of sets played (3/4 or 5)</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="st">int&lt;lower=0, upper=1&gt; dg[ngames]; // indicator for winning of the match for home team</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="st">real home;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="st">real mu;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="st">real mu0_att;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="st">real mu0_def;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="st">real&lt;lower=0&gt; sigma0_att;</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="st">real&lt;lower=0&gt; sigma0_def;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="st">real mu1_att;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="st">real mu1_def;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="st">real&lt;lower=0&gt; sigma1_att;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="st">real&lt;lower=0&gt; sigma1_def;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="st">real mu1_ser;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="st">real mu1_blo;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="st">real&lt;lower=0&gt; sigma1_ser;</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="st">real&lt;lower=0&gt; sigma1_blo;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta0_att_star;</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta1_att_star;</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta1_ser_star;</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta0_def_star;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta1_def_star;</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta1_blo_star;</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="st">real gamma[3];</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="st">real delta[4];</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters{</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="st">//Trick to code the sum-to-zero constraint</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta0_att;</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta1_att;</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta1_ser;</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta0_def;</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta1_def;</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="st">vector [nteams] beta1_blo;</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[ngames] theta1;</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[ngames] theta2;</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="st">beta0_att = beta0_att_star - mean(beta0_att_star);</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="st">beta1_att = beta1_att_star - mean(beta1_att_star);</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="st">beta1_ser = beta1_ser_star - mean(beta1_ser_star);</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="st">beta0_def = beta0_def_star - mean(beta0_def_star);</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="st">beta1_def = beta1_def_star - mean(beta1_def_star);</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="st">beta1_blo = beta1_blo_star - mean(beta1_blo_star);</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="st"> for (g in 1:ngames) {</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="st">    theta1[g] = exp(home + mu + beta0_att[home_team[g]] + beta1_att[home_team[g]]*att_eff1[g] + beta1_ser[home_team[g]]*ser_eff1[g] + </span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="st">             beta0_def[away_team[g]] + beta1_def[away_team[g]]*def_eff2[g] + beta1_blo[away_team[g]]*blo_eff2[g]); </span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="st">    theta2[g] = exp(mu + beta0_att[away_team[g]] + beta1_att[away_team[g]]*att_eff2[g] + beta1_ser[away_team[g]]*ser_eff2[g] + </span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="st">             beta0_def[home_team[g]] + beta1_def[home_team[g]]*def_eff1[g] + beta1_blo[home_team[g]]*blo_eff1[g]); </span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="st"> }</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="st">//priors</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="st">home ~ normal(0, 100);</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="st">mu ~ normal(0, 100);</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="st">mu0_att ~ normal(0, 100);</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="st">mu0_def ~ normal(0, 100);</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="st">sigma0_att ~ uniform(0, 100);</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="st">sigma0_def ~ uniform(0, 100);</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="st">mu1_att ~ normal(0, 100);</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a><span class="st">mu1_def ~ normal(0, 100);</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="st">sigma1_att ~ uniform(0, 100);</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="st">sigma1_def ~ uniform(0, 100);</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="st">mu1_ser ~ normal(0, 100);</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a><span class="st">mu1_blo ~ normal(0, 100);</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="st">sigma1_ser ~ uniform(0, 100);</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a><span class="st">sigma1_blo ~ uniform(0, 100);</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="st">gamma ~ normal(0, 100);</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="st">delta ~ normal(0, 100);</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="st">beta0_att_star ~ normal(mu0_att, sigma0_att);</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="st">beta0_def_star ~ normal(mu0_def, sigma0_def);</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="st">beta1_att_star ~ normal(mu1_att, sigma1_att);</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a><span class="st">beta1_def_star ~ normal(mu1_def, sigma1_def);</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a><span class="st">beta1_ser_star ~ normal(mu1_ser, sigma1_ser);</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a><span class="st">beta1_blo_star ~ normal(mu1_blo, sigma1_blo);</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a><span class="st">// likelihood</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a><span class="st"> for (g in 1:ngames) {</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a><span class="st">  y1[g] ~ poisson(theta1[g]);</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a><span class="st">  y2[g] ~ poisson(theta2[g]);</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a><span class="st">  ds[g] ~ bernoulli_logit(gamma[1] + gamma[2]*y1[g] + gamma[3]*y2[g]);</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a><span class="st">  dg[g] ~ bernoulli_logit(delta[1] + delta[2]*y1[g] + delta[3]*y2[g] + delta[4]*ds[g]);</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a><span class="st"> }</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities{</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a><span class="st">// loglikelihood </span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="st">vector[ngames] loglik_y1;</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a><span class="st">vector[ngames] loglik_y2;</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a><span class="st">vector[ngames] loglik_ds;</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a><span class="st">vector[ngames] loglik_dg;</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="st"> for (g in 1:ngames) {</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a><span class="st">  loglik_y1[g] = poisson_lpmf(y1[g]| theta1[g]);</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a><span class="st">  loglik_y2[g] = poisson_lpmf(y2[g]| theta2[g]);</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a><span class="st">  loglik_ds[g] = bernoulli_logit_lpmf(ds[g]| gamma[1] + gamma[2]*y1[g] + gamma[3]*y2[g]);</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a><span class="st">  loglik_dg[g] = bernoulli_logit_lpmf(dg[g]| delta[1] + delta[2]*y1[g] + delta[3]*y2[g] + delta[4]*ds[g]);</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="st"> }</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(rstanString, <span class="at">con =</span> <span class="st">"Modelbasic.stan"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we put the data into a list to be passed to <code>Stan</code>, define the nodes (parameters and derivatives) to monitor and the chain parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#prepare data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>y1<span class="ot">&lt;-</span>data<span class="sc">$</span>y1</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>y2<span class="ot">&lt;-</span>data<span class="sc">$</span>y2</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>ngames<span class="ot">&lt;-</span><span class="fu">max</span>(data<span class="sc">$</span>Game)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>nteams<span class="ot">&lt;-</span><span class="fu">max</span>(data<span class="sc">$</span>h)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>home_team<span class="ot">&lt;-</span>data<span class="sc">$</span>h</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>away_team<span class="ot">&lt;-</span>data<span class="sc">$</span>a</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>att_eff1<span class="ot">&lt;-</span>data<span class="sc">$</span>atteff1</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>att_eff2<span class="ot">&lt;-</span>data<span class="sc">$</span>atteff2</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>ser_eff1<span class="ot">&lt;-</span>data<span class="sc">$</span>sereff1</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>ser_eff2<span class="ot">&lt;-</span>data<span class="sc">$</span>sereff2</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>blo_eff1<span class="ot">&lt;-</span>data<span class="sc">$</span>bloeff1</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>blo_eff2<span class="ot">&lt;-</span>data<span class="sc">$</span>bloeff2</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>def_eff1<span class="ot">&lt;-</span>data<span class="sc">$</span>defeff1</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>def_eff2<span class="ot">&lt;-</span>data<span class="sc">$</span>defeff2</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>att_eff1<span class="ot">&lt;-</span>atteff1.cen</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>att_eff2<span class="ot">&lt;-</span>atteff2.cen</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>ser_eff1<span class="ot">&lt;-</span>sereff1.cen</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>ser_eff2<span class="ot">&lt;-</span>sereff2.cen</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>blo_eff1<span class="ot">&lt;-</span>bloeff1.cen</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>blo_eff2<span class="ot">&lt;-</span>bloeff2.cen</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>def_eff1<span class="ot">&lt;-</span>defeff1.cen</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>def_eff2<span class="ot">&lt;-</span>defeff2.cen</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>ds<span class="ot">&lt;-</span><span class="fu">ifelse</span>(data<span class="sc">$</span>settot<span class="sc">==</span><span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>dg<span class="ot">&lt;-</span><span class="fu">ifelse</span>(data<span class="sc">$</span>set1<span class="sc">&gt;</span>data<span class="sc">$</span>set2,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">#pre-processing</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>datalist <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y1=</span>y1,<span class="at">y2=</span>y2,<span class="at">ngames=</span>ngames,<span class="at">nteams=</span>nteams,<span class="at">home_team=</span>home_team,<span class="at">away_team=</span>away_team,<span class="at">att_eff1=</span>att_eff1,<span class="at">att_eff2=</span>att_eff2,<span class="at">def_eff1=</span>def_eff1,<span class="at">def_eff2=</span>def_eff2,<span class="at">ser_eff1=</span>ser_eff1,<span class="at">ser_eff2=</span>ser_eff2,<span class="at">blo_eff1=</span>blo_eff1,<span class="at">blo_eff2=</span>blo_eff2,<span class="at">ds=</span>ds, <span class="at">dg=</span>dg)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mu"</span>,<span class="st">"home"</span>,<span class="st">"gamma"</span>,<span class="st">"delta"</span>,<span class="st">"beta0_att"</span>,<span class="st">"beta0_def"</span>,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta1_att"</span>,<span class="st">"beta1_def"</span>,<span class="st">"beta1_ser"</span>,<span class="st">"beta1_blo"</span>,<span class="st">"theta1"</span>,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"theta2"</span>,<span class="st">"loglik_y1"</span>,<span class="st">"loglik_y2"</span>,<span class="st">"loglik_ds"</span>,<span class="st">"loglik_dg"</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">500</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">2000</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Start the <code>Stan</code> model (check the model, load data into the model, specify the number of chains and compile the model). Run the <code>Stan</code> code via the <code>rstan</code> package and the <code>stan</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>model_stan<span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">data =</span> datalist, <span class="at">file =</span> <span class="st">"Modelbasic.stan"</span>, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">chains =</span> nChains, <span class="at">pars =</span> params, <span class="at">iter =</span> nIter, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">warmup =</span> burnInSteps, <span class="at">thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
NA Chain 1: 
NA Chain 1: Gradient evaluation took 0.000182 seconds
NA Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.82 seconds.
NA Chain 1: Adjust your expectations accordingly!
NA Chain 1: 
NA Chain 1: 
NA Chain 1: Iteration:   1 / 1000 [  0%]  (Warmup)
NA Chain 1: Iteration: 100 / 1000 [ 10%]  (Warmup)
NA Chain 1: Iteration: 200 / 1000 [ 20%]  (Warmup)
NA Chain 1: Iteration: 300 / 1000 [ 30%]  (Warmup)
NA Chain 1: Iteration: 400 / 1000 [ 40%]  (Warmup)
NA Chain 1: Iteration: 500 / 1000 [ 50%]  (Warmup)
NA Chain 1: Iteration: 501 / 1000 [ 50%]  (Sampling)
NA Chain 1: Iteration: 600 / 1000 [ 60%]  (Sampling)
NA Chain 1: Iteration: 700 / 1000 [ 70%]  (Sampling)
NA Chain 1: Iteration: 800 / 1000 [ 80%]  (Sampling)
NA Chain 1: Iteration: 900 / 1000 [ 90%]  (Sampling)
NA Chain 1: Iteration: 1000 / 1000 [100%]  (Sampling)
NA Chain 1: 
NA Chain 1:  Elapsed Time: 62.452 seconds (Warm-up)
NA Chain 1:                67.426 seconds (Sampling)
NA Chain 1:                129.878 seconds (Total)
NA Chain 1: 
NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
NA Chain 2: 
NA Chain 2: Gradient evaluation took 0.00014 seconds
NA Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 1.4 seconds.
NA Chain 2: Adjust your expectations accordingly!
NA Chain 2: 
NA Chain 2: 
NA Chain 2: Iteration:   1 / 1000 [  0%]  (Warmup)
NA Chain 2: Iteration: 100 / 1000 [ 10%]  (Warmup)
NA Chain 2: Iteration: 200 / 1000 [ 20%]  (Warmup)
NA Chain 2: Iteration: 300 / 1000 [ 30%]  (Warmup)
NA Chain 2: Iteration: 400 / 1000 [ 40%]  (Warmup)
NA Chain 2: Iteration: 500 / 1000 [ 50%]  (Warmup)
NA Chain 2: Iteration: 501 / 1000 [ 50%]  (Sampling)
NA Chain 2: Iteration: 600 / 1000 [ 60%]  (Sampling)
NA Chain 2: Iteration: 700 / 1000 [ 70%]  (Sampling)
NA Chain 2: Iteration: 800 / 1000 [ 80%]  (Sampling)
NA Chain 2: Iteration: 900 / 1000 [ 90%]  (Sampling)
NA Chain 2: Iteration: 1000 / 1000 [100%]  (Sampling)
NA Chain 2: 
NA Chain 2:  Elapsed Time: 61.322 seconds (Warm-up)
NA Chain 2:                75.791 seconds (Sampling)
NA Chain 2:                137.113 seconds (Total)
NA Chain 2:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_stan, <span class="at">pars =</span><span class="fu">c</span>(<span class="st">"mu"</span>,<span class="st">"home"</span>,<span class="st">"gamma"</span>,<span class="st">"delta"</span>,<span class="st">"beta0_att"</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"beta0_def"</span>,<span class="st">"beta1_att"</span>,<span class="st">"beta1_def"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"beta1_ser"</span>,<span class="st">"beta1_blo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Stan model: anon_model.
NA 2 chains, each with iter=1000; warmup=500; thin=1; 
NA post-warmup draws per chain=500, total post-warmup draws=1000.
NA 
NA                  mean se_mean    sd    2.5%     25%     50%    75%  97.5% n_eff
NA mu               4.44    0.00  0.01    4.42    4.43    4.44   4.45   4.47    75
NA home             0.03    0.00  0.02    0.00    0.02    0.03   0.05   0.06    55
NA gamma[1]      -111.64    8.40 37.84 -204.58 -129.36 -102.85 -85.91 -58.49    20
NA gamma[2]         0.59    0.05  0.25    0.22    0.41    0.54   0.71   1.19    23
NA gamma[3]         0.56    0.04  0.18    0.29    0.42    0.53   0.67   0.96    25
NA delta[1]       -12.56    0.98  5.61  -23.44  -16.21  -12.60  -8.90  -1.70    33
NA delta[2]         0.48    0.02  0.11    0.30    0.41    0.48   0.56   0.73    36
NA delta[3]        -0.34    0.01  0.07   -0.49   -0.38   -0.33  -0.29  -0.21    61
NA delta[4]        -3.28    0.24  1.49   -6.06   -4.34   -3.26  -2.27  -0.47    40
NA beta0_att[1]    -0.01    0.00  0.02   -0.06   -0.03   -0.01   0.01   0.03   954
NA beta0_att[2]     0.02    0.00  0.02   -0.02    0.00    0.02   0.03   0.06  1000
NA beta0_att[3]     0.02    0.00  0.02   -0.02    0.01    0.02   0.04   0.06   931
NA beta0_att[4]     0.00    0.00  0.02   -0.04   -0.01    0.00   0.02   0.05   949
NA beta0_att[5]    -0.07    0.00  0.03   -0.13   -0.09   -0.07  -0.06  -0.02   682
NA beta0_att[6]    -0.09    0.00  0.03   -0.14   -0.11   -0.09  -0.07  -0.04   717
NA beta0_att[7]     0.03    0.00  0.02   -0.02    0.01    0.03   0.04   0.08   985
NA beta0_att[8]     0.14    0.00  0.03    0.08    0.12    0.14   0.16   0.21   361
NA beta0_att[9]    -0.05    0.00  0.02   -0.10   -0.07   -0.05  -0.04  -0.01   780
NA beta0_att[10]    0.01    0.00  0.02   -0.04   -0.01    0.01   0.03   0.06   793
NA beta0_att[11]   -0.01    0.00  0.03   -0.07   -0.03   -0.01   0.00   0.04  1008
NA beta0_att[12]    0.02    0.00  0.03   -0.04    0.00    0.02   0.04   0.08   821
NA beta0_def[1]     0.04    0.00  0.02    0.00    0.03    0.04   0.06   0.09   740
NA beta0_def[2]     0.06    0.00  0.03    0.01    0.04    0.06   0.08   0.11   835
NA beta0_def[3]     0.08    0.00  0.02    0.04    0.07    0.08   0.10   0.13   951
NA beta0_def[4]    -0.08    0.00  0.02   -0.13   -0.10   -0.08  -0.07  -0.03   759
NA beta0_def[5]     0.03    0.00  0.02   -0.02    0.01    0.03   0.05   0.08   668
NA beta0_def[6]     0.01    0.00  0.02   -0.03    0.00    0.02   0.03   0.06  1086
NA beta0_def[7]     0.05    0.00  0.03    0.00    0.03    0.05   0.07   0.10   782
NA beta0_def[8]    -0.01    0.00  0.03   -0.06   -0.02   -0.01   0.01   0.05   745
NA beta0_def[9]    -0.03    0.00  0.02   -0.08   -0.05   -0.03  -0.02   0.01   850
NA beta0_def[10]    0.03    0.00  0.02   -0.02    0.02    0.03   0.05   0.08   909
NA beta0_def[11]    0.01    0.00  0.03   -0.04   -0.01    0.01   0.03   0.06   995
NA beta0_def[12]   -0.20    0.00  0.03   -0.27   -0.22   -0.20  -0.17  -0.13   216
NA beta1_att[1]     0.39    0.01  0.38   -0.38    0.15    0.39   0.63   1.12   972
NA beta1_att[2]    -0.87    0.01  0.38   -1.64   -1.13   -0.86  -0.62  -0.17  1045
NA beta1_att[3]     0.32    0.01  0.35   -0.32    0.07    0.30   0.55   1.05   920
NA beta1_att[4]     0.20    0.01  0.36   -0.47   -0.04    0.20   0.43   0.91   954
NA beta1_att[5]    -0.17    0.02  0.39   -0.93   -0.42   -0.17   0.07   0.65   673
NA beta1_att[6]     0.95    0.01  0.35    0.26    0.72    0.96   1.18   1.64   705
NA beta1_att[7]    -0.54    0.02  0.49   -1.52   -0.88   -0.53  -0.22   0.50   895
NA beta1_att[8]    -2.14    0.03  0.57   -3.33   -2.52   -2.11  -1.77  -1.10   330
NA beta1_att[9]     0.79    0.01  0.32    0.15    0.57    0.79   1.02   1.41   939
NA beta1_att[10]    0.05    0.02  0.42   -0.79   -0.22    0.04   0.34   0.89   768
NA beta1_att[11]    1.17    0.01  0.36    0.46    0.92    1.17   1.42   1.83   897
NA beta1_att[12]   -0.16    0.00  0.05   -0.25   -0.19   -0.15  -0.12  -0.06   729
NA beta1_def[1]     0.12    0.01  0.17   -0.20    0.00    0.11   0.22   0.45   894
NA beta1_def[2]     0.02    0.00  0.13   -0.24   -0.06    0.03   0.11   0.29   814
NA beta1_def[3]     0.00    0.00  0.14   -0.27   -0.09    0.01   0.09   0.28   834
NA beta1_def[4]     0.29    0.01  0.17   -0.06    0.17    0.29   0.40   0.64   317
NA beta1_def[5]     0.07    0.01  0.17   -0.25   -0.04    0.06   0.18   0.41   466
NA beta1_def[6]     0.04    0.01  0.17   -0.28   -0.07    0.03   0.15   0.35   990
NA beta1_def[7]    -0.18    0.01  0.20   -0.60   -0.31   -0.17  -0.05   0.20   479
NA beta1_def[8]    -0.71    0.02  0.17   -1.01   -0.83   -0.72  -0.61  -0.37    92
NA beta1_def[9]    -0.07    0.01  0.15   -0.35   -0.18   -0.06   0.03   0.23   866
NA beta1_def[10]    0.03    0.01  0.14   -0.26   -0.05    0.03   0.13   0.30   696
NA beta1_def[11]   -0.01    0.01  0.14   -0.29   -0.11   -0.01   0.09   0.28   804
NA beta1_def[12]    0.40    0.01  0.15    0.11    0.29    0.39   0.49   0.70   194
NA beta1_ser[1]     0.13    0.02  0.50   -0.80   -0.20    0.12   0.43   1.15   956
NA beta1_ser[2]     0.49    0.02  0.51   -0.48    0.15    0.46   0.82   1.53   815
NA beta1_ser[3]     0.72    0.02  0.48   -0.20    0.39    0.71   1.03   1.67   474
NA beta1_ser[4]    -0.65    0.01  0.43   -1.50   -0.92   -0.64  -0.36   0.20   884
NA beta1_ser[5]     1.27    0.02  0.44    0.39    0.97    1.26   1.57   2.18   569
NA beta1_ser[6]    -0.39    0.02  0.61   -1.57   -0.78   -0.42   0.00   0.83   883
NA beta1_ser[7]    -0.88    0.03  0.60   -2.13   -1.27   -0.87  -0.45   0.24   432
NA beta1_ser[8]     0.00    0.02  0.54   -1.06   -0.35   -0.01   0.35   1.06   879
NA beta1_ser[9]    -0.05    0.02  0.47   -0.92   -0.37   -0.07   0.28   0.93   951
NA beta1_ser[10]   -0.60    0.02  0.49   -1.61   -0.90   -0.58  -0.27   0.37   771
NA beta1_ser[11]    0.99    0.02  0.52   -0.01    0.63    0.99   1.35   1.99   526
NA beta1_ser[12]   -1.03    0.02  0.46   -1.99   -1.33   -1.02  -0.71  -0.17   685
NA beta1_blo[1]    -0.02    0.00  0.09   -0.20   -0.08   -0.02   0.05   0.17   981
NA beta1_blo[2]    -0.21    0.01  0.12   -0.45   -0.28   -0.20  -0.12   0.00   404
NA beta1_blo[3]    -0.02    0.00  0.06   -0.14   -0.06   -0.02   0.02   0.10   856
NA beta1_blo[4]    -0.04    0.00  0.06   -0.17   -0.08   -0.04   0.00   0.08  1037
NA beta1_blo[5]     0.16    0.00  0.10   -0.02    0.09    0.15   0.23   0.36   586
NA beta1_blo[6]     0.01    0.00  0.06   -0.10   -0.03    0.01   0.05   0.12  1100
NA beta1_blo[7]     0.08    0.00  0.07   -0.05    0.04    0.08   0.13   0.23   734
NA beta1_blo[8]    -0.09    0.00  0.11   -0.30   -0.16   -0.09  -0.01   0.11   922
NA beta1_blo[9]    -0.15    0.00  0.08   -0.32   -0.21   -0.15  -0.10   0.00   773
NA beta1_blo[10]   -0.03    0.00  0.05   -0.14   -0.07   -0.03   0.01   0.08   968
NA beta1_blo[11]   -0.01    0.00  0.09   -0.19   -0.07   -0.01   0.05   0.16   993
NA beta1_blo[12]    0.31    0.01  0.12    0.09    0.23    0.30   0.39   0.57   263
NA               Rhat
NA mu            1.02
NA home          1.02
NA gamma[1]      1.05
NA gamma[2]      1.03
NA gamma[3]      1.06
NA delta[1]      1.01
NA delta[2]      1.01
NA delta[3]      1.03
NA delta[4]      1.01
NA beta0_att[1]  1.00
NA beta0_att[2]  1.00
NA beta0_att[3]  1.00
NA beta0_att[4]  1.00
NA beta0_att[5]  1.00
NA beta0_att[6]  1.00
NA beta0_att[7]  1.00
NA beta0_att[8]  1.00
NA beta0_att[9]  1.00
NA beta0_att[10] 1.00
NA beta0_att[11] 1.00
NA beta0_att[12] 1.00
NA beta0_def[1]  1.00
NA beta0_def[2]  1.00
NA beta0_def[3]  1.00
NA beta0_def[4]  1.00
NA beta0_def[5]  1.00
NA beta0_def[6]  1.00
NA beta0_def[7]  1.00
NA beta0_def[8]  1.00
NA beta0_def[9]  1.00
NA beta0_def[10] 1.00
NA beta0_def[11] 1.00
NA beta0_def[12] 1.00
NA beta1_att[1]  1.00
NA beta1_att[2]  1.00
NA beta1_att[3]  1.00
NA beta1_att[4]  1.00
NA beta1_att[5]  1.00
NA beta1_att[6]  1.00
NA beta1_att[7]  1.00
NA beta1_att[8]  1.00
NA beta1_att[9]  1.00
NA beta1_att[10] 1.00
NA beta1_att[11] 1.00
NA beta1_att[12] 1.00
NA beta1_def[1]  1.00
NA beta1_def[2]  1.00
NA beta1_def[3]  1.00
NA beta1_def[4]  1.01
NA beta1_def[5]  1.00
NA beta1_def[6]  1.00
NA beta1_def[7]  1.01
NA beta1_def[8]  1.03
NA beta1_def[9]  1.00
NA beta1_def[10] 1.00
NA beta1_def[11] 1.00
NA beta1_def[12] 1.01
NA beta1_ser[1]  1.00
NA beta1_ser[2]  1.00
NA beta1_ser[3]  1.00
NA beta1_ser[4]  1.00
NA beta1_ser[5]  1.01
NA beta1_ser[6]  1.00
NA beta1_ser[7]  1.00
NA beta1_ser[8]  1.00
NA beta1_ser[9]  1.00
NA beta1_ser[10] 1.00
NA beta1_ser[11] 1.01
NA beta1_ser[12] 1.00
NA beta1_blo[1]  1.00
NA beta1_blo[2]  1.00
NA beta1_blo[3]  1.00
NA beta1_blo[4]  1.00
NA beta1_blo[5]  1.00
NA beta1_blo[6]  1.00
NA beta1_blo[7]  1.00
NA beta1_blo[8]  1.00
NA beta1_blo[9]  1.00
NA beta1_blo[10] 1.00
NA beta1_blo[11] 1.00
NA beta1_blo[12] 1.00
NA 
NA Samples were drawn using NUTS(diag_e) at Mon Jul 22 14:06:07 2024.
NA For each parameter, n_eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor on split chains (at 
NA convergence, Rhat=1).</code></pre>
</div>
</div>
<p>The diagnostic results are not perfect, perhaps I should run the algorithm a bit longer to get better results as a total of <span class="math inline">\(1000\)</span> iterations does not seem enough. Here I do not bother to save time. To get an idea about posterior results I can plot at the average marginal mean offensive and defensive skills for each of the <span class="math inline">\(12\)</span> teams in the league using the following code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#plot att vs def effext by team</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>model_stan_par<span class="ot">&lt;-</span><span class="fu">extract</span>(model_stan)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>beta0.att<span class="ot">&lt;-</span><span class="fu">apply</span>(model_stan_par<span class="sc">$</span>beta0_att, <span class="dv">2</span>, mean)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>beta0.def<span class="ot">&lt;-</span><span class="fu">apply</span>(model_stan_par<span class="sc">$</span>beta0_def, <span class="dv">2</span>, mean)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>names<span class="ot">&lt;-</span><span class="fu">unique</span>(<span class="fu">data.frame</span>(data<span class="sc">$</span>home.team,data<span class="sc">$</span>h)[<span class="fu">order</span>(data<span class="sc">$</span>h),][,<span class="dv">1</span>])</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(beta0.att,beta0.def, <span class="at">main =</span> <span class="st">""</span>, <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">xlab =</span> <span class="st">"Mean attack effect"</span>, <span class="at">ylab =</span> <span class="st">"Mean defence effect"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.13</span>,<span class="fl">0.08</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.18</span>,<span class="fl">0.1</span>))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(beta0.att,beta0.def, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"red"</span>,<span class="at">cex =</span> <span class="fl">1.2</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">0</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(beta0.att,beta0.def,names,<span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">adj =</span> <span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">1.3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Different clusters of teams can be easily detected and suggest a different performance of the teams based on their average offensive and defensive skills. Those associated with higher offensive (to the right) and lower defensive (to the bottom) effects are the ones with the best performance across the season.</p>
</section>
<section id="mcmc-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="mcmc-diagnostics">MCMC diagnostics</h2>
<p>Using the generated MCMC samples I can now look at some diagnostic measures. For example, we can assess convergence of the chains using the function <code>mcmc_combo</code> in the package <code>bayesplot</code> which provides a summary of convergence diagnostics using different graphics. We consider the marginal skill parameters for four teams to give an example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_combo</span>(model_stan, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">"beta0_att[1]"</span>,<span class="st">"beta0_att[2]"</span>,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"beta0_att[3]"</span>,<span class="st">"beta0_att[4]"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_combo</span>(model_stan, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">"beta0_def[1]"</span>,<span class="st">"beta0_def[2]"</span>,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"beta0_def[3]"</span>,<span class="st">"beta0_def[4]"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-validation" class="level2">
<h2 class="anchored" data-anchor-id="model-validation">Model validation</h2>
<p>We can finally assess the fit of the model to the data by computing posterior predictive checks, where we use the posterior values of the parameters to sample a large number of replications for the data. We then use these to generate different types of results and compare them with the actual results to detect possible misfits of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#obtain parameters to generate replications</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>y1.pred<span class="ot">&lt;-</span>y2.pred<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="fu">length</span>(model_stan_par<span class="sc">$</span>home),<span class="dv">132</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>ds.pred<span class="ot">&lt;-</span>dg.pred<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="fu">length</span>(model_stan_par<span class="sc">$</span>home),<span class="dv">132</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>pi.s<span class="ot">&lt;-</span>pi.g<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="fu">length</span>(model_stan_par<span class="sc">$</span>home),<span class="dv">132</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>y1.mat<span class="ot">&lt;-</span>y2.mat<span class="ot">&lt;-</span>ds.mat<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="fu">length</span>(model_stan_par<span class="sc">$</span>home),<span class="dv">132</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(model_stan_par<span class="sc">$</span>home)){</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a> y1.mat[i,]<span class="ot">&lt;-</span>y1</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a> y2.mat[i,]<span class="ot">&lt;-</span>y2</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a> ds.mat[i,]<span class="ot">&lt;-</span>ds</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a> pi.s[i,]<span class="ot">&lt;-</span><span class="fu">inv.logit</span>(model_stan_par<span class="sc">$</span>gamma[i,<span class="dv">1</span>] <span class="sc">+</span> model_stan_par<span class="sc">$</span>gamma[i,<span class="dv">2</span>]<span class="sc">*</span>y1.mat[i,] <span class="sc">+</span> model_stan_par<span class="sc">$</span>gamma[i,<span class="dv">3</span>]<span class="sc">*</span>y2.mat[i,])</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a> pi.g[i,]<span class="ot">&lt;-</span><span class="fu">inv.logit</span>(model_stan_par<span class="sc">$</span>delta[i,<span class="dv">1</span>] <span class="sc">+</span> model_stan_par<span class="sc">$</span>delta[i,<span class="dv">2</span>]<span class="sc">*</span>y1.mat[i,] <span class="sc">+</span> model_stan_par<span class="sc">$</span>delta[i,<span class="dv">3</span>]<span class="sc">*</span>y2.mat[i,] <span class="sc">+</span> model_stan_par<span class="sc">$</span>delta[i,<span class="dv">4</span>]<span class="sc">*</span>ds.mat[i,])</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">#generate predictions</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3456</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(model_stan_par<span class="sc">$</span>home)){</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  y1.pred[i,]<span class="ot">&lt;-</span><span class="fu">rpois</span>(<span class="at">n=</span><span class="dv">132</span>,<span class="at">lambda =</span> model_stan_par<span class="sc">$</span>theta1[i,])</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  y2.pred[i,]<span class="ot">&lt;-</span><span class="fu">rpois</span>(<span class="at">n=</span><span class="dv">132</span>,<span class="at">lambda =</span> model_stan_par<span class="sc">$</span>theta2[i,])</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  ds.pred[i,]<span class="ot">&lt;-</span><span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">132</span>, <span class="at">size =</span> <span class="dv">1</span>,<span class="at">prob =</span> pi.s[i,])</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  dg.pred[i,]<span class="ot">&lt;-</span><span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">132</span>, <span class="at">size =</span> <span class="dv">1</span>,<span class="at">prob =</span> pi.g[i,])</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co">#compute prediction points</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>results<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="ot">&lt;-</span><span class="fu">data.frame</span>(y1.pred[i,],y2.pred[i,],ds.pred[i,],dg.pred[i,],data<span class="sc">$</span>h,data<span class="sc">$</span>a) </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.home<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">0</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.home<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">1</span>,<span class="dv">2</span>,results[[i]]<span class="sc">$</span>points.home)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.home<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,results[[i]]<span class="sc">$</span>points.home)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.away<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.away<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">0</span>,<span class="dv">2</span>,results[[i]]<span class="sc">$</span>points.away)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.away<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,results[[i]]<span class="sc">$</span>points.away)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co">#compare results for scores by team</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>tot.y1.list<span class="ot">&lt;-</span>tot.y2.list<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  tot.y1.list[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(results[[i]], .(data.h), summarise, <span class="at">totscorehome=</span><span class="fu">sum</span>(y1.pred.i...))</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  tot.y2.list[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(results[[i]], .(data.a), summarise, <span class="at">totscoreaway=</span><span class="fu">sum</span>(y2.pred.i...))</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>tot.y1.list.neg<span class="ot">&lt;-</span>tot.y2.list.neg<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>  tot.y1.list.neg[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(results[[i]], .(data.h), summarise, <span class="at">totscorehomeneg=</span><span class="fu">sum</span>(y2.pred.i...))</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>  tot.y2.list.neg[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(results[[i]], .(data.a), summarise, <span class="at">totscoreawayneg=</span><span class="fu">sum</span>(y1.pred.i...))</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>tot.y1.list.mat<span class="ot">&lt;-</span>tot.y2.list.mat<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">1000</span>,<span class="dv">12</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>tot.y1.list.neg.mat<span class="ot">&lt;-</span>tot.y2.list.neg.mat<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">1000</span>,<span class="dv">12</span>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>  tot.y1.list.mat[i,]<span class="ot">&lt;-</span>tot.y1.list[[i]][,<span class="dv">2</span>]</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>  tot.y2.list.mat[i,]<span class="ot">&lt;-</span>tot.y2.list[[i]][,<span class="dv">2</span>]</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>  tot.y1.list.neg.mat[i,]<span class="ot">&lt;-</span>tot.y1.list.neg[[i]][,<span class="dv">2</span>]</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>  tot.y2.list.neg.mat[i,]<span class="ot">&lt;-</span>tot.y2.list.neg[[i]][,<span class="dv">2</span>]</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>tot.y1.obs<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(h), summarise, <span class="at">totscorehomeobs=</span><span class="fu">sum</span>(y1))</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>tot.y2.obs<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(a), summarise, <span class="at">totscorehomeobs=</span><span class="fu">sum</span>(y2))</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>tot.y1.obs.neg<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(h), summarise, <span class="at">totscorehomeobs=</span><span class="fu">sum</span>(y2))</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>tot.y2.obs.neg<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(a), summarise, <span class="at">totscorehomeobs=</span><span class="fu">sum</span>(y1))</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a><span class="co">#compute prediction points</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>results<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="ot">&lt;-</span><span class="fu">data.frame</span>(y1.pred[i,],y2.pred[i,],ds.pred[i,],dg.pred[i,],data<span class="sc">$</span>h,data<span class="sc">$</span>a) </span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.home<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">0</span>)</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.home<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">1</span>,<span class="dv">2</span>,results[[i]]<span class="sc">$</span>points.home)</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.home<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,results[[i]]<span class="sc">$</span>points.home)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.away<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.away<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">0</span>,<span class="dv">2</span>,results[[i]]<span class="sc">$</span>points.away)</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>  results[[i]]<span class="sc">$</span>points.away<span class="ot">&lt;-</span><span class="fu">ifelse</span>(results[[i]]<span class="sc">$</span>ds.pred.i...<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> results[[i]]<span class="sc">$</span>dg.pred.i...<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,results[[i]]<span class="sc">$</span>points.away)</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a><span class="co">#compare results for scores by team</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>tot.y1.list<span class="ot">&lt;-</span>tot.y2.list<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>  tot.y1.list[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(results[[i]], .(data.h), summarise, <span class="at">totscorehome=</span><span class="fu">sum</span>(y1.pred.i...))</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>  tot.y2.list[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(results[[i]], .(data.a), summarise, <span class="at">totscoreaway=</span><span class="fu">sum</span>(y2.pred.i...))</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>tot.y1.list.neg<span class="ot">&lt;-</span>tot.y2.list.neg<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>  tot.y1.list.neg[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(results[[i]], .(data.h), summarise, <span class="at">totscorehomeneg=</span><span class="fu">sum</span>(y2.pred.i...))</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>  tot.y2.list.neg[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(results[[i]], .(data.a), summarise, <span class="at">totscoreawayneg=</span><span class="fu">sum</span>(y1.pred.i...))</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>tot.y1.list.mat<span class="ot">&lt;-</span>tot.y2.list.mat<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">1000</span>,<span class="dv">12</span>)</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>tot.y1.list.neg.mat<span class="ot">&lt;-</span>tot.y2.list.neg.mat<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">1000</span>,<span class="dv">12</span>)</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>  tot.y1.list.mat[i,]<span class="ot">&lt;-</span>tot.y1.list[[i]][,<span class="dv">2</span>]</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>  tot.y2.list.mat[i,]<span class="ot">&lt;-</span>tot.y2.list[[i]][,<span class="dv">2</span>]</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>  tot.y1.list.neg.mat[i,]<span class="ot">&lt;-</span>tot.y1.list.neg[[i]][,<span class="dv">2</span>]</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>  tot.y2.list.neg.mat[i,]<span class="ot">&lt;-</span>tot.y2.list.neg[[i]][,<span class="dv">2</span>]</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>tot.y1.obs<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(h), summarise, <span class="at">totscorehomeobs=</span><span class="fu">sum</span>(y1))</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>tot.y2.obs<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(a), summarise, <span class="at">totscorehomeobs=</span><span class="fu">sum</span>(y2))</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>tot.y1.obs.neg<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(h), summarise, <span class="at">totscorehomeobs=</span><span class="fu">sum</span>(y2))</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>tot.y2.obs.neg<span class="ot">&lt;-</span><span class="fu">ddply</span>(data, .(a), summarise, <span class="at">totscorehomeobs=</span><span class="fu">sum</span>(y1))</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="co">#scored</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>tot.y.obs<span class="ot">&lt;-</span>tot.y1.obs[,<span class="dv">2</span>]<span class="sc">+</span>tot.y2.obs[,<span class="dv">2</span>]</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>tot.y.pred<span class="ot">&lt;-</span><span class="fu">apply</span>(tot.y1.list.mat,<span class="dv">2</span>,median)<span class="sc">+</span><span class="fu">apply</span>(tot.y2.list.mat,<span class="dv">2</span>,median)</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>res.y<span class="ot">&lt;-</span><span class="fu">cbind</span>(tot.y.obs,tot.y.pred)</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(res.y)<span class="ot">&lt;-</span>names</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>res.y<span class="ot">&lt;-</span><span class="fu">round</span>(res.y,<span class="at">digits =</span> <span class="dv">0</span>)</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="co">#conceded</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>tot.y.obs.neg<span class="ot">&lt;-</span>tot.y1.obs.neg[,<span class="dv">2</span>]<span class="sc">+</span>tot.y2.obs.neg[,<span class="dv">2</span>]</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>tot.y.pred.neg<span class="ot">&lt;-</span><span class="fu">apply</span>(tot.y1.list.neg.mat,<span class="dv">2</span>,median)<span class="sc">+</span><span class="fu">apply</span>(tot.y2.list.neg.mat,<span class="dv">2</span>,median)</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>res.y.neg<span class="ot">&lt;-</span><span class="fu">cbind</span>(tot.y.obs.neg,tot.y.pred.neg)</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(res.y.neg)<span class="ot">&lt;-</span>names</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>res.y.neg<span class="ot">&lt;-</span><span class="fu">round</span>(res.y.neg,<span class="at">digits =</span> <span class="dv">0</span>)</span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="co">#compare results for points</span></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>data.points.list<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>  data.points.list[[i]]<span class="ot">&lt;-</span><span class="fu">data.frame</span>(data<span class="sc">$</span>Game)</span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>  data.points.list[[i]]<span class="sc">$</span>Game<span class="ot">&lt;-</span>data<span class="sc">$</span>Game</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>  data.points.list[[i]]<span class="sc">$</span>h<span class="ot">&lt;-</span>data<span class="sc">$</span>h</span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>  data.points.list[[i]]<span class="sc">$</span>a<span class="ot">&lt;-</span>data<span class="sc">$</span>a</span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>  data.points.list[[i]]<span class="sc">$</span>points.home<span class="ot">&lt;-</span>results[[i]]<span class="sc">$</span>points.home</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>  data.points.list[[i]]<span class="sc">$</span>points.away<span class="ot">&lt;-</span>results[[i]]<span class="sc">$</span>points.away</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>tot.home.list<span class="ot">&lt;-</span>tot.away.list<span class="ot">&lt;-</span>tot.team.list<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>  tot.home.list[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(data.points.list[[i]], .(h), summarise, <span class="at">totpointhome=</span><span class="fu">sum</span>(points.home))</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>  tot.away.list[[i]]<span class="ot">&lt;-</span><span class="fu">ddply</span>(data.points.list[[i]], .(a), summarise, <span class="at">totpointaway=</span><span class="fu">sum</span>(points.away))</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>  tot.team.list[[i]]<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">levels</span>(data<span class="sc">$</span>home.team), tot.home.list[[i]]<span class="sc">$</span>h)</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>  tot.team.list[[i]]<span class="sc">$</span>tot.team<span class="ot">&lt;-</span>tot.home.list[[i]]<span class="sc">$</span>totpointhome <span class="sc">+</span> tot.away.list[[i]]<span class="sc">$</span>totpointaway</span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>  tot.team.list[[i]]<span class="sc">$</span>true.team<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">39</span>, <span class="dv">23</span>, <span class="dv">50</span>, <span class="dv">19</span>, <span class="dv">11</span>, <span class="dv">37</span>, <span class="dv">51</span>, <span class="dv">32</span>, <span class="dv">33</span>, <span class="dv">27</span>, <span class="dv">50</span>)</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>  tot.team.list[[i]]<span class="ot">&lt;-</span>tot.team.list[[i]][<span class="fu">order</span>(tot.team.list[[i]]<span class="sc">$</span>tot.team, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),]</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>  tot.team.list[[i]]<span class="sc">$</span>rank<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a><span class="co">#plot total scores by team</span></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>tot.scores<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">1000</span>,<span class="dv">12</span>)</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tot.scores)<span class="ot">&lt;-</span>names</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>){</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>    tot.scores[i,j]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>tot.team[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span>j] </span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>tot.scores.obs<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">39</span>, <span class="dv">23</span>, <span class="dv">50</span>, <span class="dv">19</span>, <span class="dv">11</span>, <span class="dv">37</span>, <span class="dv">51</span>, <span class="dv">32</span>, <span class="dv">33</span>, <span class="dv">27</span>, <span class="dv">50</span>)</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>tot.scores.med<span class="ot">&lt;-</span><span class="fu">apply</span>(tot.scores, <span class="dv">2</span>, median)</span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>tot.scores.final<span class="ot">&lt;-</span><span class="fu">cbind</span>(tot.scores.obs,tot.scores.med)</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a><span class="co">#plot total wins </span></span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>tot.wins<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">1000</span>,<span class="dv">12</span>)</span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tot.wins)<span class="ot">&lt;-</span>names</span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>){</span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>    tot.wins[i,j]<span class="ot">&lt;-</span><span class="fu">length</span>(data.points.list[[i]]<span class="sc">$</span>points.home[data.points.list[[i]]<span class="sc">$</span>points.home<span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>                                                              data.points.list[[i]]<span class="sc">$</span>h<span class="sc">==</span>j]) <span class="sc">+</span> <span class="fu">length</span>(data.points.list[[i]]<span class="sc">$</span>points.away[data.points.list[[i]]<span class="sc">$</span>points.away<span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>                                                                                                                                        data.points.list[[i]]<span class="sc">$</span>a<span class="sc">==</span>j])</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>tot.wins.obs<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">12</span>,<span class="dv">6</span>,<span class="dv">17</span>,<span class="dv">7</span>,<span class="dv">5</span>,<span class="dv">13</span>,<span class="dv">17</span>,<span class="dv">10</span>,<span class="dv">12</span>,<span class="dv">8</span>,<span class="dv">18</span>)</span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>tot.wins.prop<span class="ot">&lt;-</span>tot.wins<span class="sc">/</span><span class="dv">22</span></span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>tot.wins.obs.prop<span class="ot">&lt;-</span>tot.wins.obs<span class="sc">/</span><span class="dv">22</span></span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>tot.wins.med<span class="ot">&lt;-</span><span class="fu">apply</span>(tot.wins, <span class="dv">2</span>, median)</span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>tot.wins.final<span class="ot">&lt;-</span><span class="fu">cbind</span>(tot.wins.obs,tot.wins.med)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, for each team, we compare the predicted and observed total number of points scored in the matches, the number of won/lost matches, and the league points scored based on a replicated and the original season results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#summarise pred results</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>res.final.obs<span class="ot">&lt;-</span><span class="fu">cbind</span>(res.y[,<span class="dv">1</span>],res.y.neg[,<span class="dv">1</span>],tot.wins.final[,<span class="dv">1</span>],tot.scores.final[,<span class="dv">1</span>])</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>res.final.pred<span class="ot">&lt;-</span><span class="fu">cbind</span>(res.y[,<span class="dv">2</span>],res.y.neg[,<span class="dv">2</span>],tot.wins.final[,<span class="dv">2</span>],tot.scores.final[,<span class="dv">2</span>])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>res.final<span class="ot">&lt;-</span><span class="fu">cbind</span>(res.final.obs,res.final.pred)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(res.final)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"scored"</span>,<span class="st">"conc'd"</span>,<span class="st">"wins"</span>,<span class="st">"points"</span>,<span class="st">"scored"</span>,<span class="st">"conc'd"</span>,<span class="st">"wins"</span>,<span class="st">"points"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(res.final, <span class="st">"pandoc"</span>, <span class="at">align =</span> <span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">scored</th>
<th style="text-align: center;">conc’d</th>
<th style="text-align: center;">wins</th>
<th style="text-align: center;">points</th>
<th style="text-align: center;">scored</th>
<th style="text-align: center;">conc’d</th>
<th style="text-align: center;">wins</th>
<th style="text-align: center;">points</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Bergamo</td>
<td style="text-align: center;">1848</td>
<td style="text-align: center;">2025</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">19</td>
<td style="text-align: center;">1846</td>
<td style="text-align: center;">2019</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">20</td>
</tr>
<tr class="even">
<td>Busto Arsizio</td>
<td style="text-align: center;">1999</td>
<td style="text-align: center;">1927</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">39</td>
<td style="text-align: center;">1996</td>
<td style="text-align: center;">1918</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">37</td>
</tr>
<tr class="odd">
<td>Casalmaggiore</td>
<td style="text-align: center;">1922</td>
<td style="text-align: center;">2051</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">23</td>
<td style="text-align: center;">1914</td>
<td style="text-align: center;">2035</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">23</td>
</tr>
<tr class="even">
<td>Conegliano</td>
<td style="text-align: center;">1960</td>
<td style="text-align: center;">1696</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">50</td>
<td style="text-align: center;">1958</td>
<td style="text-align: center;">1704</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">50</td>
</tr>
<tr class="odd">
<td>Filottrano</td>
<td style="text-align: center;">1781</td>
<td style="text-align: center;">1961</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">19</td>
<td style="text-align: center;">1799</td>
<td style="text-align: center;">1955</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">18</td>
</tr>
<tr class="even">
<td>Legnano</td>
<td style="text-align: center;">1642</td>
<td style="text-align: center;">1903</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">1662</td>
<td style="text-align: center;">1902</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">17</td>
</tr>
<tr class="odd">
<td>Monza</td>
<td style="text-align: center;">2003</td>
<td style="text-align: center;">1943</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">1999</td>
<td style="text-align: center;">1936</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">38</td>
</tr>
<tr class="even">
<td>Novara</td>
<td style="text-align: center;">1987</td>
<td style="text-align: center;">1776</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">51</td>
<td style="text-align: center;">1954</td>
<td style="text-align: center;">1774</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">51</td>
</tr>
<tr class="odd">
<td>Pesaro</td>
<td style="text-align: center;">1776</td>
<td style="text-align: center;">1820</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">32</td>
<td style="text-align: center;">1786</td>
<td style="text-align: center;">1823</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">33</td>
</tr>
<tr class="even">
<td>Piacenza</td>
<td style="text-align: center;">1888</td>
<td style="text-align: center;">1939</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">33</td>
<td style="text-align: center;">1887</td>
<td style="text-align: center;">1934</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">30</td>
</tr>
<tr class="odd">
<td>San Casciano</td>
<td style="text-align: center;">1807</td>
<td style="text-align: center;">1881</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">27</td>
<td style="text-align: center;">1808</td>
<td style="text-align: center;">1878</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">29</td>
</tr>
<tr class="even">
<td>Scandicci</td>
<td style="text-align: center;">1865</td>
<td style="text-align: center;">1556</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">50</td>
<td style="text-align: center;">1862</td>
<td style="text-align: center;">1583</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">51</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Predicted results (the last four columns in the table) are not so bad, especially when looking at the number of league points scored by the teams between the replicated and observed season which are quite similar. These results suggest that the model seems to predict in a reasonable way the league results. To further assess this aspect, we consider two plots. The first compares the ranking of the teams across a large number of replications of the season based on the number of wins, losses and league points gained for each team.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#summarise pred results</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>res.matrix<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="fu">length</span>(tot.team.list),<span class="dv">12</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(res.matrix)<span class="ot">&lt;-</span>names</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>){</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">1</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">2</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">2</span>]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">3</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">3</span>]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">4</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">4</span>]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">5</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">5</span>]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">6</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">6</span>]</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">7</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">7</span>]</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">8</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">8</span>]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">9</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">9</span>]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">10</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">10</span>]</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">11</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">11</span>]</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  res.matrix[i,<span class="dv">12</span>]<span class="ot">&lt;-</span>tot.team.list[[i]]<span class="sc">$</span>rank[tot.team.list[[i]]<span class="sc">$</span>tot.home.list..i...h<span class="sc">==</span><span class="dv">12</span>]</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">#create stacked barplot of results</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">c</span>(<span class="dv">1000</span><span class="sc">*</span><span class="dv">12</span>)))</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data.barplot)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Game"</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>position<span class="ot">&lt;-</span><span class="fu">as.factor</span>(<span class="fu">c</span>(res.matrix[,<span class="dv">1</span>],res.matrix[,<span class="dv">2</span>],res.matrix[,<span class="dv">3</span>],res.matrix[,<span class="dv">4</span>],</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>                                   res.matrix[,<span class="dv">5</span>],res.matrix[,<span class="dv">6</span>],res.matrix[,<span class="dv">7</span>],res.matrix[,<span class="dv">8</span>],</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>                                   res.matrix[,<span class="dv">9</span>],res.matrix[,<span class="dv">10</span>],res.matrix[,<span class="dv">11</span>],res.matrix[,<span class="dv">12</span>]))</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">1000</span><span class="sc">*</span><span class="dv">12</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">1</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">1001</span><span class="sc">:</span><span class="dv">2000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">2</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">2001</span><span class="sc">:</span><span class="dv">3000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">3</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">3001</span><span class="sc">:</span><span class="dv">4000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">4</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">4001</span><span class="sc">:</span><span class="dv">5000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">5</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">5001</span><span class="sc">:</span><span class="dv">6000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">6</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">6001</span><span class="sc">:</span><span class="dv">7000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">7</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">7001</span><span class="sc">:</span><span class="dv">8000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">8</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">8001</span><span class="sc">:</span><span class="dv">9000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">9</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">9001</span><span class="sc">:</span><span class="dv">10000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">10</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">10001</span><span class="sc">:</span><span class="dv">11000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">11</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team[<span class="dv">11001</span><span class="sc">:</span><span class="dv">12000</span>]<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">paste</span>(names[<span class="dv">12</span>]),<span class="dv">1000</span>)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co">#data.barplot$team&lt;-as.factor(data.barplot$team)</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team <span class="ot">&lt;-</span><span class="fu">factor</span>(data.barplot<span class="sc">$</span>team, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Novara"</span>, <span class="st">"Scandicci"</span>,<span class="st">"Conegliano"</span>, <span class="st">"Monza"</span>,<span class="st">"Busto Arsizio"</span>,</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>                                                         <span class="st">"Pesaro"</span>,<span class="st">"Piacenza"</span>, <span class="st">"San Casciano"</span>,<span class="st">"Casalmaggiore"</span>, <span class="st">"Bergamo"</span>,</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>                                                         <span class="st">"Filottrano"</span>, <span class="st">"Legnano"</span>))</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>match<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">2</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">3</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">4</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">5</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">6</span>,<span class="dv">1000</span>),</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">rep</span>(<span class="dv">7</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">8</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">9</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">10</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">11</span>,<span class="dv">1000</span>),<span class="fu">rep</span>(<span class="dv">12</span>,<span class="dv">1000</span>))</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>match<span class="ot">&lt;-</span><span class="fu">as.factor</span>(data.barplot<span class="sc">$</span>match)</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>Game<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">nrow</span>(data.barplot))</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>area<span class="ot">&lt;-</span><span class="fu">ifelse</span>(data.barplot<span class="sc">$</span>position<span class="sc">==</span><span class="dv">1</span><span class="sc">|</span>data.barplot<span class="sc">$</span>position<span class="sc">==</span><span class="dv">2</span><span class="sc">|</span>data.barplot<span class="sc">$</span>position<span class="sc">==</span><span class="dv">3</span>,<span class="st">"high"</span>,<span class="st">"middle"</span>)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>area<span class="ot">&lt;-</span><span class="fu">ifelse</span>(data.barplot<span class="sc">$</span>position<span class="sc">==</span><span class="dv">12</span><span class="sc">|</span>data.barplot<span class="sc">$</span>position<span class="sc">==</span><span class="dv">11</span><span class="sc">|</span>data.barplot<span class="sc">$</span>position<span class="sc">==</span><span class="dv">10</span>,<span class="st">"low"</span>,data.barplot<span class="sc">$</span>area)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>area<span class="ot">&lt;-</span><span class="fu">as.factor</span>(data.barplot<span class="sc">$</span>area)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>area<span class="ot">&lt;-</span><span class="fu">ordered</span>(data.barplot<span class="sc">$</span>area,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"middle"</span>,<span class="st">"high"</span>))</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>data.barplot<span class="sc">$</span>team<span class="ot">&lt;-</span><span class="fu">factor</span>(data.barplot<span class="sc">$</span>team,<span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(data.barplot<span class="sc">$</span>team)))</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>df.summary1<span class="ot">&lt;-</span><span class="fu">ddply</span>(data.barplot,.(team,position),summarise,<span class="at">count=</span><span class="fu">sum</span>(Game), <span class="at">percent=</span><span class="fu">sum</span>(Game)<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>df.summary2<span class="ot">&lt;-</span><span class="fu">ddply</span>(data.barplot,.(team,area),summarise,<span class="at">count=</span><span class="fu">sum</span>(Game), <span class="at">percent=</span><span class="fu">sum</span>(Game)<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df.summary1, <span class="fu">aes</span>(<span class="at">x=</span>team, <span class="at">y=</span>percent, <span class="at">fill=</span>position)) <span class="sc">+</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>, <span class="at">width =</span> <span class="fl">0.7</span>, <span class="at">colour=</span><span class="st">"black"</span>, <span class="at">lwd=</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span><span class="fu">ifelse</span>(percent <span class="sc">&gt;=</span> <span class="fl">0.1</span>, <span class="fu">paste0</span>(<span class="fu">sprintf</span>(<span class="st">"%.0f"</span>, percent<span class="sc">*</span><span class="dv">100</span>),<span class="st">"%"</span>),<span class="st">""</span>)),</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>            <span class="at">position=</span><span class="fu">position_stack</span>(<span class="at">vjust=</span><span class="fl">0.5</span>), <span class="at">colour=</span><span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">""</span>, <span class="at">x=</span><span class="st">""</span>) <span class="sc">+</span> <span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> T) <span class="sc">+</span> </span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(), <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>),</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The mean rankings of the teams are in line with those observed in the actual season, while also providing uncertainty about the chance of each team to end in a particular position in the league (only percentages above <span class="math inline">\(10\%\)</span> are shown for clarity).</p>
<p>The second plot compares the points trend throughout the season for each team with respect to the trend predicted by the model based on the replicated results for each match in the season.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">#########plot for cumlative points over simulated season</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>points.list<span class="ot">&lt;-</span>cum.points.list<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(res.matrix)){</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  points.list[[i]]<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">22</span>,<span class="dv">12</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  cum.points.list[[i]]<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">22</span>,<span class="dv">12</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>){</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    points.list[[i]][,j]<span class="ot">&lt;-</span><span class="fu">c</span>(data.points.list[[i]]<span class="sc">$</span>points.home[data.points.list[[i]]<span class="sc">$</span>h<span class="sc">==</span>j],data.points.list[[i]]<span class="sc">$</span>points.away[data.points.list[[i]]<span class="sc">$</span>a<span class="sc">==</span>j])</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(points.list[[i]])<span class="ot">&lt;-</span><span class="fu">unique</span>(<span class="fu">levels</span>(data<span class="sc">$</span>home.team))</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(points.list[[i]])<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  cum.points.list[[i]]<span class="ot">&lt;-</span><span class="fu">apply</span>(points.list[[i]], <span class="dv">2</span>, cumsum)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="do">#########plot for cumlative points over simulated season</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>points.list<span class="ot">&lt;-</span>cum.points.list<span class="ot">&lt;-</span><span class="fu">list</span>()</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(res.matrix)){</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  points.list[[i]]<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">22</span>,<span class="dv">12</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  cum.points.list[[i]]<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">22</span>,<span class="dv">12</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>){</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    points.list[[i]][,j]<span class="ot">&lt;-</span><span class="fu">c</span>(data.points.list[[i]]<span class="sc">$</span>points.home[data.points.list[[i]]<span class="sc">$</span>h<span class="sc">==</span>j],data.points.list[[i]]<span class="sc">$</span>points.away[data.points.list[[i]]<span class="sc">$</span>a<span class="sc">==</span>j])</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(points.list[[i]])<span class="ot">&lt;-</span><span class="fu">unique</span>(<span class="fu">levels</span>(data<span class="sc">$</span>home.team))</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(points.list[[i]])<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  cum.points.list[[i]]<span class="ot">&lt;-</span><span class="fu">apply</span>(points.list[[i]], <span class="dv">2</span>, cumsum)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co">#plot cumulative points obs vs pred</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>obs.cum.points<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">22</span>,<span class="dv">12</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(obs.cum.points)<span class="ot">&lt;-</span><span class="fu">unique</span>(<span class="fu">levels</span>(data<span class="sc">$</span>home.team))</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(obs.cum.points)<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">1</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">2</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">3</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">4</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">5</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">6</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">7</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">8</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">9</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">10</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">11</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">12</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">13</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">14</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">15</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">16</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">17</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">18</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">0</span>)</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">19</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">20</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">21</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>obs.cum.points[<span class="dv">22</span>,]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>obs.cum.points<span class="ot">&lt;-</span><span class="fu">apply</span>(obs.cum.points, <span class="dv">2</span>, cumsum)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">3.1</span>, <span class="fl">3.1</span>, <span class="fl">3.1</span>))</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="at">mai =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.4</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>))</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>){</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>),obs.cum.points[,i], <span class="at">axes =</span> F, <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">xlab =</span> <span class="st">"games"</span>, <span class="at">ylab =</span> <span class="st">"points"</span>,<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">23</span>),<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">54</span>))</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>,<span class="at">at=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>,<span class="dv">25</span>),<span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>,<span class="dv">25</span>))</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">2</span>,<span class="at">at=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>),<span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>))</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>),obs.cum.points[,i], <span class="at">lty=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">"black"</span>)</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">22</span>), cum.points.list[[<span class="dv">7</span>]][,i], <span class="at">lty=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">"red"</span>)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(<span class="dv">5</span>,<span class="dv">50</span>,<span class="fu">unique</span>(<span class="fu">levels</span>(names))[i],<span class="at">pos =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The observed trends (black lines) are pretty much matched by the trends predicted by the model (red lines) for most of the teams with few exceptions. This suggests that, although the model seems to have a good predictive ability, in some cases there are still margins of improvement. In my original paper I have improved the model using a different parameterisation where I tried to account for the dependence between the latent skill parameters using a scaled inverse Wishart distribution for the covariance matrix of the random effects. Here I do not consider this model here, which lead to some improvements compared with the basic Poisson model.</p>
</section>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>One potential limitation of the framework is that only match-specific statistics are used for estimation and prediction purposes. Ideally, the use of set-specific statistics could improve the predictive power of the model. However, this would introduce additional problems related to the choice of the distributions for modelling the number of points scored by the opposing teams in a set, which is subject to specific constraints. Finally, the flexibility of the proposed framework allows the extension of the model in many ways. For example, additional types of in-game statistics (e.g.&nbsp;number of passes), if available, could be incorporated to further improve the predictions of the model; alternative distributions could also be specified to model the total number of scores <span class="math inline">\(y\)</span> during the season (e.g.&nbsp;Negative Binomial) which may result in a better fit to the data.</p>
</section>
<section id="references" class="level1">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-gabrio2020bayesian" class="csl-entry" role="listitem">
Gabrio, Andrea. 2020. <span>“Bayesian Hierarchical Models for the Prediction of Volleyball Results.”</span> <em>Journal of Applied Statistics</em>, 1–21.
</div>
<div id="ref-gelman2015stan" class="csl-entry" role="listitem">
Gelman, Andrew, Daniel Lee, and Jiqiang Guo. 2015. <span>“Stan: A Probabilistic Programming Language for Bayesian Inference and Optimization.”</span> <em>Journal of Educational and Behavioral Statistics</em> 40 (5): 530–43.
</div>
<div id="ref-rstanpackage" class="csl-entry" role="listitem">
Stan Development Team. 2018. <span>“<span>RStan</span>: The <span>R</span> Interface to <span>Stan</span>.”</span> <a href="http://mc-stan.org/">http://mc-stan.org/</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Andrea Gabrio</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>