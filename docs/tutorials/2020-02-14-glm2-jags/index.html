<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrea Gabrio">
<meta name="dcterms.date" content="2020-02-14">
<meta name="keywords" content="Software, Statistics, Stan">

<title>Andrea Gabrio - Generalised Linear Models part II (JAGS)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andrea Gabrio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../missing_data.html"> 
<span class="menu-text">Missing Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#poisson-regression" id="toc-poisson-regression" class="nav-link" data-scroll-target="#poisson-regression">Poisson regression</a></li>
  <li><a href="#data-generation" id="toc-data-generation" class="nav-link" data-scroll-target="#data-generation">Data generation</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory data analysis</a></li>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model fitting</a></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation">Model evaluation</a></li>
  <li><a href="#goodness-of-fit" id="toc-goodness-of-fit" class="nav-link" data-scroll-target="#goodness-of-fit">Goodness of fit</a></li>
  <li><a href="#exploring-the-model-parameters" id="toc-exploring-the-model-parameters" class="nav-link" data-scroll-target="#exploring-the-model-parameters">Exploring the model parameters</a></li>
  <li><a href="#explorations-of-the-trends" id="toc-explorations-of-the-trends" class="nav-link" data-scroll-target="#explorations-of-the-trends">Explorations of the trends</a></li>
  <li><a href="#full-log-likelihood-function" id="toc-full-log-likelihood-function" class="nav-link" data-scroll-target="#full-log-likelihood-function">Full log-likelihood function</a></li>
  </ul></li>
  <li><a href="#negative-binomial" id="toc-negative-binomial" class="nav-link" data-scroll-target="#negative-binomial">Negative binomial</a>
  <ul class="collapse">
  <li><a href="#data-generation-1" id="toc-data-generation-1" class="nav-link" data-scroll-target="#data-generation-1">Data generation</a></li>
  <li><a href="#model-fitting-1" id="toc-model-fitting-1" class="nav-link" data-scroll-target="#model-fitting-1">Model fitting</a></li>
  <li><a href="#model-evaluation-1" id="toc-model-evaluation-1" class="nav-link" data-scroll-target="#model-evaluation-1">Model evaluation</a></li>
  <li><a href="#exploring-the-model-parameters-1" id="toc-exploring-the-model-parameters-1" class="nav-link" data-scroll-target="#exploring-the-model-parameters-1">Exploring the model parameters</a></li>
  <li><a href="#explorations-of-the-trends-1" id="toc-explorations-of-the-trends-1" class="nav-link" data-scroll-target="#explorations-of-the-trends-1">Explorations of the trends</a></li>
  <li><a href="#full-log-likelihood-function-1" id="toc-full-log-likelihood-function-1" class="nav-link" data-scroll-target="#full-log-likelihood-function-1">Full log-likelihood function</a></li>
  </ul></li>
  <li><a href="#zero-inflated-poisson" id="toc-zero-inflated-poisson" class="nav-link" data-scroll-target="#zero-inflated-poisson">Zero inflated Poisson</a>
  <ul class="collapse">
  <li><a href="#data-generation-2" id="toc-data-generation-2" class="nav-link" data-scroll-target="#data-generation-2">Data generation</a></li>
  <li><a href="#exploratory-data-analysis-1" id="toc-exploratory-data-analysis-1" class="nav-link" data-scroll-target="#exploratory-data-analysis-1">Exploratory data analysis</a></li>
  <li><a href="#model-fitting-2" id="toc-model-fitting-2" class="nav-link" data-scroll-target="#model-fitting-2">Model fitting</a></li>
  <li><a href="#model-evaluation-2" id="toc-model-evaluation-2" class="nav-link" data-scroll-target="#model-evaluation-2">Model evaluation</a></li>
  <li><a href="#goodness-of-fit-1" id="toc-goodness-of-fit-1" class="nav-link" data-scroll-target="#goodness-of-fit-1">Goodness of fit</a></li>
  <li><a href="#exploring-the-model-parameters-2" id="toc-exploring-the-model-parameters-2" class="nav-link" data-scroll-target="#exploring-the-model-parameters-2">Exploring the model parameters</a></li>
  <li><a href="#explorations-of-the-trends-2" id="toc-explorations-of-the-trends-2" class="nav-link" data-scroll-target="#explorations-of-the-trends-2">Explorations of the trends</a></li>
  <li><a href="#full-log-likelihood-function-2" id="toc-full-log-likelihood-function-2" class="nav-link" data-scroll-target="#full-log-likelihood-function-2">Full log-likelihood function</a></li>
  </ul></li>
  <li><a href="#zero-inflated-negative-binomial" id="toc-zero-inflated-negative-binomial" class="nav-link" data-scroll-target="#zero-inflated-negative-binomial">Zero inflated Negative Binomial</a>
  <ul class="collapse">
  <li><a href="#data-generation-3" id="toc-data-generation-3" class="nav-link" data-scroll-target="#data-generation-3">Data generation</a></li>
  <li><a href="#exploratory-data-analysis-2" id="toc-exploratory-data-analysis-2" class="nav-link" data-scroll-target="#exploratory-data-analysis-2">Exploratory data analysis</a></li>
  <li><a href="#model-fitting-3" id="toc-model-fitting-3" class="nav-link" data-scroll-target="#model-fitting-3">Model fitting</a></li>
  <li><a href="#model-evaluation-3" id="toc-model-evaluation-3" class="nav-link" data-scroll-target="#model-evaluation-3">Model evaluation</a></li>
  <li><a href="#goodness-of-fit-2" id="toc-goodness-of-fit-2" class="nav-link" data-scroll-target="#goodness-of-fit-2">Goodness of fit</a></li>
  <li><a href="#exploring-the-model-parameters-3" id="toc-exploring-the-model-parameters-3" class="nav-link" data-scroll-target="#exploring-the-model-parameters-3">Exploring the model parameters</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Generalised Linear Models part II (JAGS)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Quarto</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Academia</div>
    <div class="quarto-category">Software</div>
    <div class="quarto-category">Statistics</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://angabrio.github.io/agabriosite2/">Andrea Gabrio</a> <a href="mailto:a.gabrio@maastrichtuniversity.nl" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-7650-4534" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://www.maastrichtuniversity.nl/research/methodology-and-statistics">
            Maastricht University
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 14, 2020</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p><span style="font-size: 85%">The focus of this simple tutorial is to provide a brief introduction and overview about how to fit Bayesian models using <code>JAGS</code> via <code>R</code> …</span></p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Software, Statistics, Stan</p>
  </div>
</div>

</header>


<p>This tutorial will focus on the use of Bayesian estimation to fit simple linear regression models. <code>BUGS</code> (Bayesian inference Using <em>Gibbs Sampling</em>) is an algorithm and supporting language (resembling <code>R</code>) dedicated to performing the Gibbs sampling implementation of <em>Markov Chain Monte Carlo</em> (MCMC) method. Dialects of the <code>BUGS</code> language are implemented within three main projects:</p>
<ol type="1">
<li><p><strong>OpenBUGS</strong> - written in component pascal.</p></li>
<li><p><strong>JAGS</strong> - (Just Another Gibbs Sampler) - written in <code>C++</code>.</p></li>
<li><p><strong>STAN</strong> - a dedicated Bayesian modelling framework written in <code>C++</code> and implementing <em>Hamiltonian</em> MCMC samplers.</p></li>
</ol>
<p>Whilst the above programs can be used stand-alone, they do offer the rich data pre-processing and graphical capabilities of <code>R</code>, and thus, they are best accessed from within <code>R</code> itself. As such there are multiple packages devoted to interfacing with the various software implementations:</p>
<ul>
<li><p><em>R2OpenBUGS</em> - interfaces with <code>OpenBUGS</code></p></li>
<li><p><em>R2jags</em> - interfaces with <code>JAGS</code></p></li>
<li><p><em>rstan</em> - interfaces with <code>STAN</code></p></li>
</ul>
<p>This tutorial will demonstrate how to fit models in <code>JAGS</code> (<span class="citation" data-cites="plummer2004jags">Plummer (<a href="#ref-plummer2004jags" role="doc-biblioref">2004</a>)</span>) using the package <code>R2jags</code> (<span class="citation" data-cites="su2015package">Su et al. (<a href="#ref-su2015package" role="doc-biblioref">2015</a>)</span>) as interface, which also requires to load some other packages.</p>
<section id="overview" class="level1">
<h1>Overview</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Whilst in many instances, count data can be approximated reasonably well by a normal distribution (particularly if the counts are all above zero and the mean count is greater than about <span class="math inline">\(20\)</span>), more typically, when count data are modelled via normal distribution certain undesirable characteristics arise that are a consequence of the nature of discrete non-negative data.</p>
<ul>
<li><p>Expected (predicted) values and confidence bands less than zero are illogical, yet these are entirely possible from a normal distribution</p></li>
<li><p>The distribution of count data are often skewed when their mean is low (in part because the distribution is truncated to the left by zero) and variance usually increases with increasing mean (variance is typically proportional to mean in count data). By contrast, the Gaussian (normal) distribution assumes that mean and variance are unrelated and thus estimates (particularly of standard error) might well be reasonable inaccurate.</p></li>
</ul>
<p>Poisson regression is a type of <strong>generalised linear model</strong> (GLM) in which a non-negative integer (natural number) response is modelled against a linear predictor via a specific link function. The linear predictor is typically a linear combination of effects parameters. The role of the link function is to transform the expected values of the response y (which is on the scale of (<span class="math inline">\(0;\infty\)</span>), as is the Poisson distribution from which expectations are drawn) into the scale of the linear predictor (which is <span class="math inline">\(-\infty;\infty\)</span>).</p>
<p>As implied in the name of this group of analyses, a Poisson rather than Gaussian (normal) distribution is used to represent the errors (residuals). Like count data (number of individuals, species etc), the Poisson distribution encapsulates positive integers and is bound by zero at one end. Consequently, the degree of variability is directly related the expected value (equivalent to the mean of a Gaussian distribution). Put differently, the variance is a function of the mean. Repeated observations from a Poisson distribution located close to zero will yield a much smaller spread of observations than will samples drawn from a Poisson distribution located a greater distance from zero. In the Poisson distribution, the variance has a 1:1 relationship with the mean. The canonical link function for the Poisson distribution is a log-link function.</p>
<p>Whilst the expectation that the mean=variance (<span class="math inline">\(\mu=\sigma\)</span>) is broadly compatible with actual count data (that variance increases at the same rate as the mean), under certain circumstances, this might not be the case. For example, when there are other unmeasured influences on the response variable, the distribution of counts might be somewhat clumped which can result in higher than expected variability (that is <span class="math inline">\(\sigma &gt; \mu\)</span>). The variance increases more rapidly than does the mean. This is referred to as <strong>overdispersion</strong>. The degree to which the variability is greater than the mean (and thus the expected degree of variability) is called <strong>dispersion</strong>. Effectively, the Poisson distribution has a dispersion parameter (or <strong>scaling factor</strong>) of <span class="math inline">\(1\)</span>.</p>
<p>It turns out that overdispersion is very common for count data and it typically underestimates variability, standard errors and thus deflated p-values. There are a number of ways of overcoming this limitation, the effectiveness of which depend on the causes of overdispersion.</p>
<p><strong>Quasi-Poisson models</strong> - these introduce the dispersion parameter (<span class="math inline">\(\phi\)</span>) into the model. This approach does not utilize an underlying error distribution to calculate the maximum likelihood (there is no quasi-Poisson distribution). Instead, if the Newton-Ralphson iterative reweighting least squares algorithm is applied using a direct specification of the relationship between mean and variance (<span class="math inline">\(\text{var}(y)=\phi\mu\)</span>, the estimates of the regression coefficients are identical to those of the maximum likelihood estimates from the Poisson model. This is analogous to fitting ordinary least squares on symmetrical, yet not normally distributed data - the parameter estimates are the same, however they won’t necessarily be as efficient. The standard errors of the coefficients are then calculated by multiplying the Poisson model coefficient standard errors by <span class="math inline">\(\sqrt{\phi}\)</span>. Unfortunately, because the quasi-poisson model is not estimated via maximum likelihood, properties such as AIC and log-likelihood cannot be derived. Consequently, quasi-poisson and Poisson model fits cannot be compared via either AIC or likelihood ratio tests (nor can they be compared via deviance as uasi-poisson and Poisson models have the same residual deviance). That said, quasi-likelihood can be obtained by dividing the likelihood from the Poisson model by the dispersion (scale) factor.</p>
<p><strong>Negative binomial model</strong> - technically, the negative binomial distribution is a probability distribution for the number of successes before a specified number of failures. However, the negative binomial can also be defined (parameterised) in terms of a mean (<span class="math inline">\(\mu\)</span>) and scale factor (<span class="math inline">\(\omega\)</span>),</p>
<p><span class="math display">\[
p(y_i) = \frac{\Gamma(y_i+\omega)}{\Gamma(\omega)y!} \times \frac{\mu^{y_i}_i\omega^\omega}{(\mu_i+\omega)^{\mu_i+\omega}},
\]</span></p>
<p>where the expectected value of the values <span class="math inline">\(y_i\)</span> (the means) are (<span class="math inline">\(\mu_i\)</span>) and the variance is <span class="math inline">\(y_i=\frac{\mu_i+\mu^2_i}{\omega}\)</span>. In this way, the negative binomial is a two-stage hierarchical process in which the response is modeled against a Poisson distribution whose expected count is in turn modeled by a Gamma distribution with a mean of <span class="math inline">\(\mu\)</span> and constant scale parameter (<span class="math inline">\(\omega\)</span>). Strictly, the negative binomial is not an exponential family distribution (unless <span class="math inline">\(\omega\)</span> is fixed as a constant), and thus negative binomial models cannot be fit via the usual GLM iterative reweighting algorithm. Instead estimates of the regression parameters along with the scale factor (<span class="math inline">\(\omega\)</span>) are obtained via maximum likelihood. The negative binomial model is useful for accommodating overdispersal when it is likely caused by clumping (due to the influence of other unmeasured factors) within the response.</p>
<p><strong>Zero-inflated Poisson model</strong> - overdispersion can also be caused by the presence of a greater number of zero’s than would otherwise be expected for a Poisson distribution. There are potentially two sources of zero counts - genuine zeros and false zeros. Firstly, there may genuinely be no individuals present. This would be the number expected by a Poisson distribution. Secondly, individuals may have been present yet not detected or may not even been possible. These are false zero’s and lead to zero inflated data (data with more zeros than expected). For example, the number of joeys accompanying an adult koala could be zero because the koala has no offspring (true zero) or because the koala is male or infertile (both of which would be examples of false zeros). Similarly, zero counts of the number of individual in a transect are due either to the absence of individuals or the inability of the observer to detect them. Whilst in the former example, the latent variable representing false zeros (sex or infertility) can be identified and those individuals removed prior to analysis, this is not the case for the latter example. That is, we cannot easily partition which counts of zero are due to detection issues and which are a true indication of the natural state.</p>
<p>Consistent with these two sources of zeros, zero-inflated models combine a binary logistic regression model (that models count membership according to a latent variable representing observations that can only be zeros - not detectable or male koalas) with a Poisson regression (that models count membership according to a latent variable representing observations whose values could be 0 or any positive integer - fertile female koalas).</p>
</section>
<section id="poisson-regression" class="level2">
<h2 class="anchored" data-anchor-id="poisson-regression">Poisson regression</h2>
<p>The following equations are provided since in Bayesian modelling, it is occasionally necessary to directly define the log-likelihood calculations (particularly for zero-inflated models and other mixture models).</p>
<p><span class="math display">\[
f(y \mid \lambda) = \frac{\lambda^ye^{-\lambda}}{y!},
\]</span></p>
<p>where <span class="math inline">\(E[Y]=Var(Y)=\lambda\)</span> and <span class="math inline">\(\lambda\)</span> is the mean.</p>
</section>
<section id="data-generation" class="level2">
<h2 class="anchored" data-anchor-id="data-generation">Data generation</h2>
<p>Lets say we wanted to model the abundance of an item (<span class="math inline">\(y\)</span>) against a continuous predictor (<span class="math inline">\(x\)</span>). As this section is mainly about the generation of artificial data (and not specifically about what to do with the data), understanding the actual details are optional and can be safely skipped.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#The number of samples</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>n.x <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Create x values that at uniformly distributed throughout the rate of 1 to 20</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">runif</span>(<span class="at">n =</span> n.x, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span><span class="dv">20</span>))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>slope<span class="ot">=</span><span class="fl">0.1</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">#The linear predictor</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>linpred <span class="ot">&lt;-</span> mm <span class="sc">%*%</span> <span class="fu">c</span>(intercept,slope)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Predicted y values</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(linpred)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Add some noise and make binomial</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n=</span>n.x, <span class="at">lambda=</span>lambda)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(y,x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With these sort of data, we are primarily interested in investigating whether there is a relationship between the binary response variable and the linear predictor (linear combination of one or more continuous or categorical predictors).</p>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory data analysis</h2>
<p>There are at least five main potential models we could consider fitting to these data:</p>
<ul>
<li><p><strong>Ordinary least squares regression (general linear model)</strong> - assumes normality of residuals</p></li>
<li><p><strong>Poisson regression</strong> - assumes mean=variance (dispersion<span class="math inline">\(=1\)</span>)</p></li>
<li><p><strong>Quasi-poisson regression</strong> - a general solution to overdispersion. Assumes variance is a function of mean, dispersion estimated, however likelihood based statistics unavailable</p></li>
<li><p><strong>Negative binomial regression</strong> - a specific solution to overdispersion caused by clumping (due to an unmeasured latent variable). Scaling factor (<span class="math inline">\(\omega\)</span>) is estimated along with the regression parameters.</p></li>
<li><p><strong>Zero-inflation model</strong> - a specific solution to overdispersion caused by excessive zeros (due to an unmeasured latent variable). Mixture of binomial and Poisson models.</p></li>
</ul>
<p>When counts are all very large (not close to <span class="math inline">\(0\)</span>) and their ranges do not span orders of magnitude, they take on very Gaussian properties (symmetrical distribution and variance independent of the mean). Given that models based on the Gaussian distribution are more optimized and recognized than Generalized Linear Models, it can be prudent to adopt Gaussian models for such data. Hence it is a good idea to first explore whether a Poisson model is likely to be more appropriate than a standard Gaussian model. The potential for overdispersion can be explored by adding a rug to boxplot. The rug is simply tick marks on the inside of an axis at the position corresponding to an observation. As multiple identical values result in tick marks drawn over one another, it is typically a good idea to apply a slight amount of jitter (random displacement) to the values used by the rug.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dat<span class="sc">$</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(dat<span class="sc">$</span>y, <span class="at">horizontal=</span><span class="cn">TRUE</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(<span class="fu">jitter</span>(dat<span class="sc">$</span>y), <span class="at">side=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is definitely signs of non-normality that would warrant Poisson models. The rug applied to the boxplots does not indicate a series degree of clumping and there appears to be few zero. Thus overdispersion is unlikely to be an issue. Lets now explore linearity by creating a histogram of the predictor variable (<span class="math inline">\(x\)</span>) and a scatterplot of the relationship between the response (<span class="math inline">\(y\)</span>) and the predictor (<span class="math inline">\(x\)</span>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#now for the scatterplot</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, dat, <span class="at">log=</span><span class="st">"y"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(dat, <span class="fu">lines</span>(<span class="fu">lowess</span>(y<span class="sc">~</span>x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Conclusions</strong>: the predictor (<span class="math inline">\(x\)</span>) does not display any skewness or other issues that might lead to non-linearity. The lowess smoother on the scatterplot does not display major deviations from a straight line and thus linearity is satisfied. Violations of linearity could be addressed by either:</p>
<ul>
<li><p>define a non-linear linear predictor (such as a polynomial, spline or other non-linear function).</p></li>
<li><p>transform the scale of the predictor variables.</p></li>
</ul>
<p>Although we have already established that there are few zeros in the data (and thus overdispersion is unlikely to be an issue), we can also explore this by comparing the number of zeros in the data to the number of zeros that would be expected from a Poisson distribution with a mean equal to the mean count of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#proportion of 0's in the data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dat.tab<span class="ot">&lt;-</span><span class="fu">table</span>(dat<span class="sc">$</span>y<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dat.tab<span class="sc">/</span><span class="fu">sum</span>(dat.tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA FALSE 
NA     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#proportion of 0's expected from a Poisson distribution</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>y)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>cnts <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1000</span>, mu)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>dat.tab <span class="ot">&lt;-</span> <span class="fu">table</span>(cnts <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>dat.tab<span class="sc">/</span><span class="fu">sum</span>(dat.tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA FALSE  TRUE 
NA 0.997 0.003</code></pre>
</div>
</div>
<p>In the above, the value under <code>FALSE</code> is the proportion of non-zero values in the data and the value under <code>TRUE</code> is the proportion of zeros in the data. In this example, there are no zeros in the observed data which corresponds closely to the very low proportion expected (<span class="math inline">\(0.003\)</span>).</p>
</section>
<section id="model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting">Model fitting</h2>
<p><span class="math display">\[
y_i \sim \text{Pois}(\lambda_i),
\]</span></p>
<p>where <span class="math inline">\(\log(\lambda_i)=\eta_i\)</span>, with <span class="math inline">\(\eta_i=\beta_0+\beta_1x_{i}\)</span> and <span class="math inline">\(\beta_0,\beta_1 \sim N(0, 10000)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dat.list <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>x,<span class="at">N=</span><span class="fu">nrow</span>(dat)))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="st">     Y[i] ~ dpois(lambda[i])</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="st">     log(lambda[i]) &lt;- beta0 + beta1*X[i]</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="st">  beta0 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="st">  beta1 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelpois.txt'</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R2jags)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>dat.P.jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.list,<span class="at">model.file=</span><span class="st">'modelpois.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 20
NA    Unobserved stochastic nodes: 2
NA    Total graph size: 105
NA 
NA Initializing model</code></pre>
</div>
</div>
</section>
<section id="model-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation">Model evaluation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mcmcplots)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">denplot</span>(dat.P.jags, <span class="at">parms =</span> <span class="fu">c</span>(<span class="st">"beta0"</span>,<span class="st">"beta1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traplot</span>(dat.P.jags, <span class="at">parms =</span> <span class="fu">c</span>(<span class="st">"beta0"</span>,<span class="st">"beta1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">raftery.diag</span>(<span class="fu">as.mcmc</span>(dat.P.jags))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [[1]]
NA 
NA Quantile (q) = 0.025
NA Accuracy (r) = +/- 0.005
NA Probability (s) = 0.95 
NA                                                 
NA           Burn-in  Total Lower bound  Dependence
NA           (M)      (N)   (Nmin)       factor (I)
NA  beta0    10       10830 3746         2.89      
NA  beta1    12       12612 3746         3.37      
NA  deviance 3        4410  3746         1.18      
NA 
NA 
NA [[2]]
NA 
NA Quantile (q) = 0.025
NA Accuracy (r) = +/- 0.005
NA Probability (s) = 0.95 
NA                                                 
NA           Burn-in  Total Lower bound  Dependence
NA           (M)      (N)   (Nmin)       factor (I)
NA  beta0    12       14878 3746         3.97      
NA  beta1    10       11942 3746         3.19      
NA  deviance 2        3995  3746         1.07</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autocorr.diag</span>(<span class="fu">as.mcmc</span>(dat.P.jags))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA              beta0         beta1     deviance
NA Lag 0   1.00000000  1.0000000000  1.000000000
NA Lag 1   0.83977964  0.8111423616  0.508803232
NA Lag 5   0.43884918  0.3859514845  0.118732714
NA Lag 10  0.22584100  0.1883831873  0.029775648
NA Lag 50 -0.01164622 -0.0003926876 -0.007507996</code></pre>
</div>
</div>
<p>One very important model validation procedure is to examine a plot of residuals against predicted or fitted values (the residual plot). Ideally, residual plots should show a random scatter of points without outliers. That is, there should be no patterns in the residuals. Patterns suggest inappropriate linear predictor (or scale) and/or inappropriate residual distribution/link function. The residuals used in such plots should be standardized (particularly if the model incorporated any variance-covariance structures - such as an autoregressive correlation structure) Pearsons’s residuals standardize residuals by division with the square-root of the variance. We can generate Pearson’s residuals within the <code>JAGS</code> model. Alternatively, we could use the parameters to generate the residuals outside of <code>JAGS</code>. Pearson’s residuals are calculated according to:</p>
<p><span class="math display">\[
\epsilon = \frac{y_i - \mu}{\sqrt{\text{var}(y)}},
\]</span></p>
<p>where <span class="math inline">\(\mu\)</span> is the expected value of <span class="math inline">\(Y\)</span> (<span class="math inline">\(=\lambda\)</span> for Poisson) and var(<span class="math inline">\(y\)</span>) is the variance of <span class="math inline">\(Y\)</span> (<span class="math inline">\(=\lambda\)</span> for Poisson).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the samples for the two model parameters</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">&lt;-</span> dat.P.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Expected value and variance are both equal to lambda</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>expY <span class="ot">&lt;-</span> varY <span class="ot">&lt;-</span> lambda</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">#sweep across rows and then divide by lambda</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>Resid <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">*</span><span class="fu">sweep</span>(expY,<span class="dv">2</span>,dat<span class="sc">$</span>y,<span class="st">'-'</span>)<span class="sc">/</span><span class="fu">sqrt</span>(varY)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">#plot residuals vs expected values</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(Resid,<span class="dv">2</span>,mean)<span class="sc">~</span><span class="fu">apply</span>(eta,<span class="dv">2</span>,mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we will compare the sum of squared residuals to the sum of squares residuals that would be expected from a Poisson distribution matching that estimated by the model. Essentially this is estimating how well the Poisson distribution, the log-link function and the linear model approximates the observed data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>SSres<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#generate a matrix of draws from a poisson distribution</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the matrix is the same dimensions as lambda and uses the probabilities of lambda</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>YNew <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(<span class="fu">length</span>(lambda),<span class="at">lambda=</span>lambda),<span class="at">nrow=</span><span class="fu">nrow</span>(lambda))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>Resid1<span class="ot">&lt;-</span>(lambda <span class="sc">-</span> YNew)<span class="sc">/</span><span class="fu">sqrt</span>(lambda)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>SSres.sim<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid1<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(SSres.sim<span class="sc">&gt;</span>SSres, <span class="at">na.rm =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 0.4697</code></pre>
</div>
</div>
</section>
<section id="goodness-of-fit" class="level2">
<h2 class="anchored" data-anchor-id="goodness-of-fit">Goodness of fit</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dat.list1 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>x,<span class="at">N=</span><span class="fu">nrow</span>(dat)))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">    #likelihood function</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="st">    Y[i] ~ dpois(lambda[i])</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="st">    eta[i] &lt;- beta0+beta1*X[i] #linear predictor</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="st">    log(lambda[i]) &lt;- eta[i]   #link function</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="st">    #E(Y) and var(Y)</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="st">    expY[i] &lt;- lambda[i]</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="st">    varY[i] &lt;- lambda[i]</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="st">    # Calculate RSS</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="st">    Resid[i] &lt;- (Y[i] - expY[i])/sqrt(varY[i])</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="st">    RSS[i] &lt;- pow(Resid[i],2)</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="st">    #Simulate data from a Poisson distribution</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="st">    Y1[i] ~ dpois(lambda[i])</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="st">    #Calculate RSS for simulated data</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="st">    Resid1[i] &lt;- (Y1[i] - expY[i])/sqrt(varY[i])</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="st">    RSS1[i] &lt;-pow(Resid1[i],2) </span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="st">  #Priors</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="st">  beta0 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="st">  beta1 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="st">  #Bayesian P-value</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="st">  Pvalue &lt;- mean(sum(RSS1)&gt;sum(RSS))</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelpois_gof.txt'</span>)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>, <span class="st">'Pvalue'</span>)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>dat.P.jags1 <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.list,<span class="at">model.file=</span><span class="st">'modelpois_gof.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 20
NA    Unobserved stochastic nodes: 22
NA    Total graph size: 272
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.P.jags1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelpois_gof.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA          mu.vect sd.vect   2.5%    25%    50%    75%  97.5%  Rhat n.eff
NA Pvalue     0.478   0.500  0.000  0.000  0.000  1.000  1.000 1.001 10000
NA beta0      0.546   0.254  0.015  0.381  0.559  0.719  1.013 1.001 10000
NA beta1      0.112   0.018  0.077  0.099  0.111  0.124  0.149 1.001  3200
NA deviance  88.372   3.041 86.373 86.883 87.671 89.075 93.868 1.006  2000
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 4.6 and DIC = 93.0
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: the Bayesian p-value is approximately <span class="math inline">\(0.5\)</span>, suggesting that there is a good fit of the model to the data.</p>
<p>Unfortunately, unlike with linear models (Gaussian family), the expected distribution of data (residuals) varies over the range of fitted values for numerous (often competing) ways that make diagnosing (and attributing causes thereof) miss-specified generalized linear models from standard residual plots very difficult. The use of standardized (Pearson) residuals or deviance residuals can partly address this issue, yet they still do not offer completely consistent diagnoses across all issues (miss-specified model, over-dispersion, zero-inflation). An alternative approach is to use simulated data from the model posteriors to calculate an empirical cumulative density function from which residuals are are generated as values corresponding to the observed data along the density function. Now we will compare the sum of squared residuals to the sum of squares residuals that would be expected from a Bernoulli distribution matching that estimated by the model. Essentially this is estimating how well the Bernoulli distribution and linear model approximates the observed data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the samples for the two model parameters</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">&lt;-</span> dat.P.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>simRes <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, data,<span class="at">n=</span><span class="dv">250</span>, <span class="at">plot=</span>T, <span class="at">family=</span><span class="st">'poisson'</span>) {</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">require</span>(gap)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a> N <span class="ot">=</span> <span class="fu">nrow</span>(data)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a> sim <span class="ot">=</span> <span class="cf">switch</span>(family,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'poisson'</span> <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(n<span class="sc">*</span>N,<span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean)),<span class="at">ncol=</span>N, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a> a <span class="ot">=</span> <span class="fu">apply</span>(sim <span class="sc">+</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>),<span class="dv">2</span>,ecdf)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a> resid<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)) resid<span class="ot">&lt;-</span><span class="fu">c</span>(resid,a[[i]](data<span class="sc">$</span>y[i] <span class="sc">+</span> <span class="fu">runif</span>(<span class="dv">1</span> ,<span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>)))</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (plot<span class="sc">==</span>T) {</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>   <span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>   gap<span class="sc">::</span><span class="fu">qqunif</span>(resid,<span class="at">pch =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>,</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>   <span class="at">logscale =</span> F, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.6</span>, <span class="at">main =</span> <span class="st">"QQ plot residuals"</span>,</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>   <span class="at">cex.main =</span> <span class="dv">1</span>, <span class="at">las=</span><span class="dv">1</span>)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(resid<span class="sc">~</span><span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean), <span class="at">xlab=</span><span class="st">'Predicted value'</span>, <span class="at">ylab=</span><span class="st">'Standardized residual'</span>, <span class="at">las=</span><span class="dv">1</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a> resid</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="fu">simRes</span>(lambda,dat, <span class="at">family=</span><span class="st">'poisson'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NA  [1] 0.220 0.544 0.532 0.344 0.812 0.980 0.048 0.592 0.548 0.728 0.164 0.492
NA [13] 0.856 0.096 0.240 0.292 0.876 0.880 0.148 0.748</code></pre>
</div>
</div>
<p>The trend (black symbols) in the qq-plot does not appear to be overly non-linear (matching the ideal red line well), suggesting that the model is not overdispersed. The spread of standardized (simulated) residuals in the residual plot do not appear overly non-uniform. That is there is not trend in the residuals. Furthermore, there is not a concentration of points close to <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span> (which would imply overdispersion).</p>
<p>Recall that the Poisson regression model assumes that variance=mean (var=μϕ where <span class="math inline">\(\phi=1\)</span>) and thus dispersion (<span class="math inline">\(\phi=\frac{\text{var}}{\mu}=1)\)</span>). However, we can also calculate approximately what the dispersion factor would be by using sum square of the residuals as a measure of variance and the model residual degrees of freedom as a measure of the mean (since the expected value of a Poisson distribution is the same as its degrees of freedom).</p>
<p><span class="math display">\[
\phi = \frac{RSS}{df},
\]</span></p>
<p>where <span class="math inline">\(df=n−k\)</span> and <span class="math inline">\(k\)</span> is the number of estimated model coefficients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>Resid <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">*</span><span class="fu">sweep</span>(lambda,<span class="dv">2</span>,dat<span class="sc">$</span>y,<span class="st">'-'</span>)<span class="sc">/</span><span class="fu">sqrt</span>(lambda)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>RSS<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>(df<span class="ot">&lt;-</span><span class="fu">nrow</span>(dat)<span class="sc">-</span><span class="fu">ncol</span>(coefs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 18</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>Disp <span class="ot">&lt;-</span> RSS<span class="sc">/</span>df</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(Disp), <span class="at">Mean=</span><span class="fu">mean</span>(Disp), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(Disp)),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(Disp),<span class="at">p=</span><span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA        Median     Mean     lower    upper   lower.1  upper.1
NA var1 1.053527 1.110853 0.9299722 1.449502 0.9300381 1.053579</code></pre>
</div>
</div>
<p>We can incorporate the dispersion statistic directly into <code>JAGS</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>dat.list <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>x,<span class="at">N=</span><span class="fu">nrow</span>(dat)))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="st">     Y[i] ~ dpois(lambda[i])</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="st">     eta[i] &lt;- beta0 + beta1*X[i]</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="st">     log(lambda[i]) &lt;- eta[i]</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="st">     expY[i] &lt;- lambda[i]</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="st">     varY[i] &lt;- lambda[i]</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="st">     Resid[i] &lt;- (Y[i] - expY[i])/sqrt(varY[i]) </span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="st">  beta0 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="st">  beta1 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="st">  RSS &lt;- sum(pow(Resid,2))</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="st">  df &lt;- N-2</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="st">  phi &lt;- RSS/df</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelpois_disp.txt'</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>,<span class="st">'phi'</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>dat.P.jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.list,<span class="at">model.file=</span><span class="st">'modelpois_disp.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 20
NA    Unobserved stochastic nodes: 2
NA    Total graph size: 171
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.P.jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelpois_disp.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA          mu.vect sd.vect   2.5%    25%    50%    75%  97.5%  Rhat n.eff
NA beta0      0.552   0.256  0.039  0.382  0.557  0.724  1.042 1.001 10000
NA beta1      0.111   0.019  0.074  0.099  0.112  0.124  0.147 1.001  2800
NA phi        1.105   0.246  0.934  0.977  1.048  1.169  1.581 1.001 10000
NA deviance  88.354   2.633 86.368 86.896 87.709 89.074 93.897 1.002  4300
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 3.5 and DIC = 91.8
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
<p>The dispersion statistic is close to <span class="math inline">\(1\)</span> and thus there is no evidence that the data were overdispersed. The Poisson distribution was therefore appropriate.</p>
</section>
<section id="exploring-the-model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-model-parameters">Exploring the model parameters</h2>
<p>If there was any evidence that the assumptions had been violated or the model was not an appropriate fit, then we would need to reconsider the model and start the process again. In this case, there is no evidence that the test will be unreliable so we can proceed to explore the test statistics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.P.jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelpois_disp.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA          mu.vect sd.vect   2.5%    25%    50%    75%  97.5%  Rhat n.eff
NA beta0      0.552   0.256  0.039  0.382  0.557  0.724  1.042 1.001 10000
NA beta1      0.111   0.019  0.074  0.099  0.112  0.124  0.147 1.001  2800
NA phi        1.105   0.246  0.934  0.977  1.048  1.169  1.581 1.001 10000
NA deviance  88.354   2.633 86.368 86.896 87.709 89.074 93.897 1.002  4300
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 3.5 and DIC = 91.8
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">adply</span>(dat.P.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x),<span class="at">p=</span><span class="fl">0.5</span>))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA      X1    Median      Mean      lower     upper    lower.1   upper.1
NA 1 beta0 0.5570252 0.5517525 0.03871735 1.0423628 0.39092213 0.7317579
NA 2 beta1 0.1115363 0.1113176 0.07499903 0.1484004 0.09893134 0.1239861</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#on original scale</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">adply</span>(<span class="fu">exp</span>(dat.P.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x),<span class="at">p=</span><span class="fl">0.5</span>))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA      X1   Median     Mean     lower    upper  lower.1  upper.1
NA 1 beta0 1.745472 1.793464 0.9803783 2.734057 1.423789 2.013575
NA 2 beta1 1.117994 1.117948 1.0778831 1.159977 1.101510 1.129458</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: We would reject the null hypothesis of no effect of <span class="math inline">\(x\)</span> on <span class="math inline">\(y\)</span>. An increase in x is associated with a significant linear increase (positive slope) in the abundance of y. Every <span class="math inline">\(1\)</span> unit increase in <span class="math inline">\(x\)</span> results in a log <span class="math inline">\(0.11\)</span> unit increase in <span class="math inline">\(y\)</span>. We usually express this in terms of abundance rather than log abundance, so every <span class="math inline">\(1\)</span> unit increase in <span class="math inline">\(x\)</span> results in a ($e^{ 0.11} = 1.12 $) <span class="math inline">\(1.12\)</span> unit increase in the abundance of <span class="math inline">\(y\)</span>.</p>
</section>
<section id="explorations-of-the-trends" class="level2">
<h2 class="anchored" data-anchor-id="explorations-of-the-trends">Explorations of the trends</h2>
<p>A measure of the strength of the relationship can be obtained according to:</p>
<p><span class="math display">\[
R^2 = 1 - \frac{\text{RSS}_{model}}{\text{RSS}_{null}}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate the raw SS residuals</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>SSres <span class="ot">&lt;-</span> <span class="fu">apply</span>((<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>(<span class="fu">sweep</span>(lambda,<span class="dv">2</span>,dat<span class="sc">$</span>y,<span class="st">'-'</span>)))<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>SSres.null <span class="ot">&lt;-</span> <span class="fu">sum</span>((dat<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>y))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">#OR </span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>SSres.null <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(dat<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>y))</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate the model r2</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">-</span><span class="fu">mean</span>(SSres)<span class="sc">/</span>SSres.null</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA           [,1]
NA [1,] 0.6569594</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: <span class="math inline">\(65\)</span>% of the variation in <span class="math inline">\(y\)</span> abundance can be explained by its relationship with <span class="math inline">\(x\)</span>. We can also do it directly into <code>JAGS</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>dat.list <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>x,<span class="at">N=</span><span class="fu">nrow</span>(dat)))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="st">     Y[i] ~ dpois(lambda[i])</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="st">     eta[i] &lt;- beta0 + beta1*X[i]</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="st">     log(lambda[i]) &lt;- eta[i]</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="st">     res[i] &lt;- Y[i] - lambda[i]</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="st">     resnull[i] &lt;- Y[i] - meanY</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="st">  meanY &lt;- mean(Y)</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="st">  beta0 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="st">  beta1 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="st">  RSS &lt;- sum(res^2)</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="st">  RSSnull &lt;- sum(resnull^2)</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="st">  r2 &lt;- 1-RSS/RSSnull</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelpois_disp_r2.txt'</span>)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>,<span class="st">'r2'</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>dat.P.jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.list,<span class="at">model.file=</span><span class="st">'modelpois_disp_r2.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 20
NA    Unobserved stochastic nodes: 2
NA    Total graph size: 150
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.P.jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelpois_disp_r2.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA          mu.vect sd.vect   2.5%    25%    50%    75%  97.5%  Rhat n.eff
NA beta0      0.547   0.257  0.024  0.379  0.556  0.721  1.032 1.001  3900
NA beta1      0.112   0.019  0.077  0.100  0.112  0.125  0.150 1.001  7000
NA r2         0.655   0.057  0.510  0.640  0.672  0.690  0.701 1.001 10000
NA deviance  88.383   2.776 86.372 86.904 87.733 89.122 93.692 1.003  6200
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 3.9 and DIC = 92.2
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
<p>Finally, we will create a summary plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat, <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">ann =</span> F, <span class="at">axes =</span> F)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat, <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>xs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>x,<span class="at">na.rm=</span><span class="cn">TRUE</span>),<span class="fu">max</span>(dat<span class="sc">$</span>x,<span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">l =</span> <span class="dv">1000</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>xs)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>ys <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>data.tab <span class="ot">&lt;-</span> <span class="fu">adply</span>(ys,<span class="dv">2</span>,<span class="cf">function</span>(x) {</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)))</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>data.tab <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">x=</span>xs,data.tab)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(Median <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(lower <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(upper <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"X"</span>, <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">las =</span> <span class="dv">2</span>)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"Abundance of Y"</span>, <span class="dv">2</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">bty =</span> <span class="st">"l"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="full-log-likelihood-function" class="level2">
<h2 class="anchored" data-anchor-id="full-log-likelihood-function">Full log-likelihood function</h2>
<p>Now lets try it by specifying log-likelihood and the zero trick. When applying this trick, we need to manually calculate the deviance as the inbuilt deviance will be based on the log-likelihood of estimating the zeros (as part of the zero trick) rather than the deviance of the intended model. The one advantage of the zero trick is that the Deviance and thus DIC, AIC provided by <code>R2jags</code> will be incorrect. Hence, they too need to be manually defined within <code>JAGS</code> I suspect that the AIC calculation I have used is incorrect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, dat)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>nX <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Xmat)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>dat.list2 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>Xmat,<span class="at">N=</span><span class="fu">nrow</span>(dat), <span class="at">mu=</span><span class="fu">rep</span>(<span class="dv">0</span>,nX),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Sigma=</span><span class="fu">diag</span>(<span class="fl">1.0E-06</span>,nX), <span class="at">zeros=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">nrow</span>(dat)), <span class="at">C=</span><span class="dv">10000</span>))</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="st">     zeros[i] ~ dpois(zeros.lambda[i])</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="st">     zeros.lambda[i] &lt;- -ll[i] + C     </span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="st">     ll[i] &lt;- Y[i]*log(lambda[i]) - lambda[i] - loggam(Y[i]+1)</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="st">     eta[i] &lt;- inprod(beta[], X[i,])</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="st">     log(lambda[i]) &lt;- eta[i]</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="st">    llm[i] &lt;- Y[i]*log(meanlambda) - meanlambda - loggam(Y[i]+1)</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="st">  meanlambda &lt;- mean(lambda)</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ dmnorm(mu[],Sigma[,])</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="st">  dev &lt;- sum(-2*ll)</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="st">  pD &lt;- mean(dev)-sum(-2*llm)</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="st">  AIC &lt;- min(dev+(2*pD))</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelpois_ll.txt'</span>)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta'</span>,<span class="st">'dev'</span>,<span class="st">'AIC'</span>)</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>dat.P.jags3 <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.list2,<span class="at">model.file=</span><span class="st">'modelpois_ll.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 20
NA    Unobserved stochastic nodes: 1
NA    Total graph size: 353
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.P.jags3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelpois_ll.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA             mu.vect sd.vect       2.5%        25%        50%        75%
NA AIC          13.728   4.725      9.624     10.548     11.952     15.158
NA beta[1]       0.481   0.259     -0.079      0.319      0.506      0.669
NA beta[2]       0.116   0.019      0.084      0.103      0.114      0.128
NA dev          88.382   2.009     86.361     86.883     87.731     89.265
NA deviance 400088.382   2.009 400086.361 400086.883 400087.731 400089.265
NA               97.5%  Rhat n.eff
NA AIC          26.878 1.016   180
NA beta[1]       0.922 1.037    49
NA beta[2]       0.155 1.029    60
NA dev          94.071 1.009   300
NA deviance 400094.071 1.000     1
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 2.0 and DIC = 400090.4
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
</section>
</section>
<section id="negative-binomial" class="level1">
<h1>Negative binomial</h1>
<p>The following equations are provided since in Bayesian modelling, it is occasionally necessary to directly define the log-likelihood calculations (particularly for zero-inflated models and other mixture models).</p>
<p><span class="math display">\[
f(y \mid r, p) = \frac{\Gamma(y+r)}{\Gamma(r)\Gamma(y+1)}p^r(1-p)^y,
\]</span></p>
<p>where <span class="math inline">\(p\)</span> is the probability of <span class="math inline">\(y\)</span> successes until <span class="math inline">\(r\)</span> failures. If, we make <span class="math inline">\(p=\frac{\text{size}}{\text{size}+\mu}\)</span>, then we can define the function in terms of <span class="math inline">\(\mu\)</span>:</p>
<p><span class="math display">\[
\mu = \frac{r(1-p)}{p},
\]</span></p>
<p>where <span class="math inline">\(E[Y]=\mu\)</span>, <span class="math inline">\(Var(Y)=\mu + \frac{\mu^2}{r}\)</span>.</p>
<section id="data-generation-1" class="level2">
<h2 class="anchored" data-anchor-id="data-generation-1">Data generation</h2>
<p>Lets say we wanted to model the abundance of an item (<span class="math inline">\(y\)</span>) against a continuous predictor (<span class="math inline">\(x\)</span>). As this section is mainly about the generation of artificial data (and not specifically about what to do with the data), understanding the actual details are optional and can be safely skipped.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">37</span>) <span class="co">#16 #35</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">#The number of samples</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>n.x <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Create x values that at uniformly distributed throughout the rate of 1 to 20</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">runif</span>(<span class="at">n =</span> n.x, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span><span class="dv">20</span>))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>slope<span class="ot">=</span><span class="fl">0.1</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">#The linear predictor</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>linpred <span class="ot">&lt;-</span> mm <span class="sc">%*%</span> <span class="fu">c</span>(intercept,slope)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Predicted y values</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(linpred)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Add some noise and make binomial</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnbinom</span>(<span class="at">n=</span>n.x, <span class="at">mu=</span>lambda, <span class="at">size=</span><span class="dv">1</span>)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>dat.nb <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(y,x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When counts are all very large (not close to <span class="math inline">\(0\)</span>) and their ranges do not span orders of magnitude, they take on very Gaussian properties (symmetrical distribution and variance independent of the mean). Given that models based on the Gaussian distribution are more optimized and recognized than Generalized Linear Models, it can be prudent to adopt Gaussian models for such data. Hence it is a good idea to first explore whether a Poisson or Negative Binomial model is likely to be more appropriate than a standard Gaussian model. Recall from Poisson regression, there are five main potential models that we could consider fitting to these data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dat<span class="sc">$</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#now for the scatterplot</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, dat.nb, <span class="at">log=</span><span class="st">"y"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(dat.nb, <span class="fu">lines</span>(<span class="fu">lowess</span>(y<span class="sc">~</span>x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Conclusions</strong>: the predictor (<span class="math inline">\(x\)</span>) does not display any skewness or other issues that might lead to non-linearity. The lowess smoother on the scatterplot does not display major deviations from a straight line and thus linearity is satisfied. Violations of linearity could be addressed by either:</p>
<ul>
<li><p>define a non-linear linear predictor (such as a polynomial, spline or other non-linear function).</p></li>
<li><p>transform the scale of the predictor variables.</p></li>
</ul>
<p>Although we have already established that there are few zeros in the data (and thus overdispersion is unlikely to be an issue), we can also explore this by comparing the number of zeros in the data to the number of zeros that would be expected from a Poisson distribution with a mean equal to the mean count of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#proportion of 0's in the data</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>dat.nb.tab<span class="ot">&lt;-</span><span class="fu">table</span>(dat.nb<span class="sc">$</span>y<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>dat.nb.tab<span class="sc">/</span><span class="fu">sum</span>(dat.nb.tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA FALSE  TRUE 
NA  0.95  0.05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#proportion of 0's expected from a Poisson distribution</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat.nb<span class="sc">$</span>y)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>cnts <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1000</span>, mu)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>dat.nb.tabE <span class="ot">&lt;-</span> <span class="fu">table</span>(cnts <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>dat.nb.tabE<span class="sc">/</span><span class="fu">sum</span>(dat.nb.tabE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA FALSE 
NA     1</code></pre>
</div>
</div>
<p>In the above, the value under <code>FALSE</code> is the proportion of non-zero values in the data and the value under <code>TRUE</code> is the proportion of zeros in the data. In this example, the proportion of zeros observed is similar to the proportion expected. Indeed, there was only a single zero observed. Hence it is likely that if there is overdispersion it is unlikely to be due to excessive zeros.</p>
</section>
<section id="model-fitting-1" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting-1">Model fitting</h2>
<p><span class="math display">\[
y_i \sim \text{NegBin}(p_i,r),
\]</span></p>
<p>where <span class="math inline">\(p_i=\frac{r}{r+\lambda_i}\)</span>, with <span class="math inline">\(\log(\lambda_i)=\beta_0+\beta_1x_{i}\)</span> and <span class="math inline">\(\beta_0,\beta_1 \sim N(0, 10000)\)</span>, <span class="math inline">\(r \sim \text{Unif}(0.001,1000)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>dat.nb.list <span class="ot">&lt;-</span> <span class="fu">with</span>(dat.nb,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>x,<span class="at">N=</span><span class="fu">nrow</span>(dat.nb)))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="st">     Y[i] ~ dnegbin(p[i],size)</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="st">     p[i] &lt;- size/(size+lambda[i])</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="st">     log(lambda[i]) &lt;- beta0 + beta1*X[i]</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="st">  beta0 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="st">  beta1 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="st">  size ~ dunif(0.001,1000)</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="st">  theta &lt;- pow(1/mean(p),2)</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="st">  scaleparam &lt;- mean((1-p)/p) </span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelnbin.txt'</span>)</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>, <span class="st">'size'</span>,<span class="st">'theta'</span>,<span class="st">'scaleparam'</span>)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>dat.NB.jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.nb.list,<span class="at">model.file=</span><span class="st">'modelnbin.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 20
NA    Unobserved stochastic nodes: 3
NA    Total graph size: 157
NA 
NA Initializing model</code></pre>
</div>
</div>
</section>
<section id="model-evaluation-1" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation-1">Model evaluation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">denplot</span>(dat.NB.jags, <span class="at">parms =</span> <span class="fu">c</span>(<span class="st">"beta0"</span>,<span class="st">"beta1"</span>,<span class="st">"size"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traplot</span>(dat.NB.jags, <span class="at">parms =</span> <span class="fu">c</span>(<span class="st">"beta0"</span>,<span class="st">"beta1"</span>,<span class="st">"size"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">raftery.diag</span>(<span class="fu">as.mcmc</span>(dat.NB.jags))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [[1]]
NA 
NA Quantile (q) = 0.025
NA Accuracy (r) = +/- 0.005
NA Probability (s) = 0.95 
NA                                                   
NA             Burn-in  Total Lower bound  Dependence
NA             (M)      (N)   (Nmin)       factor (I)
NA  beta0      16       17518 3746         4.68      
NA  beta1      24       28713 3746         7.66      
NA  deviance   3        4198  3746         1.12      
NA  scaleparam 16       16290 3746         4.35      
NA  size       4        5038  3746         1.34      
NA  theta      16       16244 3746         4.34      
NA 
NA 
NA [[2]]
NA 
NA Quantile (q) = 0.025
NA Accuracy (r) = +/- 0.005
NA Probability (s) = 0.95 
NA                                                   
NA             Burn-in  Total Lower bound  Dependence
NA             (M)      (N)   (Nmin)       factor (I)
NA  beta0      18       20025 3746         5.35      
NA  beta1      24       21072 3746         5.63      
NA  deviance   3        4267  3746         1.14      
NA  scaleparam 18       19920 3746         5.32      
NA  size       3        4375  3746         1.17      
NA  theta      20       20682 3746         5.52</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autocorr.diag</span>(<span class="fu">as.mcmc</span>(dat.NB.jags))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA               beta0        beta1     deviance  scaleparam        size
NA Lag 0   1.000000000  1.000000000  1.000000000  1.00000000 1.000000000
NA Lag 1   0.855250119  0.856542892  0.566377262  0.33360033 0.684520361
NA Lag 5   0.519024321  0.521535488  0.163024546  0.07618281 0.220180993
NA Lag 10  0.276801196  0.280283232  0.025179110  0.02814049 0.039259726
NA Lag 50 -0.008060569 -0.004454124 -0.003876422 -0.01103395 0.006904325
NA              theta
NA Lag 0   1.00000000
NA Lag 1   0.26024619
NA Lag 5   0.05872969
NA Lag 10  0.02940084
NA Lag 50 -0.01349378</code></pre>
</div>
</div>
<p>We now explore the goodness of fit of the models via the residuals and deviance. We could calculate the Pearsons’s residuals within the <code>JAGS</code> model. Alternatively, we could use the parameters to generate the residuals outside of <code>JAGS</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the samples for the two model parameters</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">&lt;-</span> dat.NB.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> dat.NB.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="st">'size'</span>]</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat.nb)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>varY <span class="ot">&lt;-</span> lambda <span class="sc">+</span> (lambda<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>size</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="co">#sweep across rows and then divide by lambda</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>Resid <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">*</span><span class="fu">sweep</span>(lambda,<span class="dv">2</span>,dat.nb<span class="sc">$</span>y,<span class="st">'-'</span>)<span class="sc">/</span><span class="fu">sqrt</span>(varY)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="co">#plot residuals vs expected values</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(Resid,<span class="dv">2</span>,mean)<span class="sc">~</span><span class="fu">apply</span>(eta,<span class="dv">2</span>,mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we will compare the sum of squared residuals to the sum of squares residuals that would be expected from a Negative binomial distribution matching that estimated by the model. Essentially this is estimating how well the Negative binomial distribution, the log-link function and the linear model approximates the observed data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>SSres<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co">#generate a matrix of draws from a negative binomial distribution</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the matrix is the same dimensions as pi and uses the probabilities of pi</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>YNew <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnbinom</span>(<span class="fu">length</span>(lambda),<span class="at">mu=</span>lambda, <span class="at">size=</span>size),<span class="at">nrow=</span><span class="fu">nrow</span>(lambda))</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>Resid1<span class="ot">&lt;-</span>(lambda <span class="sc">-</span> YNew)<span class="sc">/</span><span class="fu">sqrt</span>(varY)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>SSres.sim<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid1<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(SSres.sim<span class="sc">&gt;</span>SSres, <span class="at">na.rm =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 0.4163</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: the Bayesian p-value is approximately <span class="math inline">\(0.5\)</span>, suggesting that there is a good fit of the model to the data.</p>
<p>Unfortunately, unlike with linear models (Gaussian family), the expected distribution of data (residuals) varies over the range of fitted values for numerous (often competing) ways that make diagnosing (and attributing causes thereof) miss-specified generalized linear models from standard residual plots very difficult. The use of standardized (Pearson) residuals or deviance residuals can partly address this issue, yet they still do not offer completely consistent diagnoses across all issues (miss-specified model, over-dispersion, zero-inflation). An alternative approach is to use simulated data from the model posteriors to calculate an empirical cumulative density function from which residuals are are generated as values corresponding to the observed data along the density function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the samples for the two model parameters</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">&lt;-</span> dat.NB.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> dat.NB.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="st">'size'</span>]</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat.nb)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>simRes <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, data,<span class="at">n=</span><span class="dv">250</span>, <span class="at">plot=</span>T, <span class="at">family=</span><span class="st">'negbin'</span>, <span class="at">size=</span><span class="cn">NULL</span>) {</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a> <span class="fu">require</span>(gap)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a> N <span class="ot">=</span> <span class="fu">nrow</span>(data)</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a> sim <span class="ot">=</span> <span class="cf">switch</span>(family,</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'poisson'</span> <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(n<span class="sc">*</span>N,<span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean)),<span class="at">ncol=</span>N, <span class="at">byrow=</span><span class="cn">TRUE</span>),</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'negbin'</span> <span class="ot">=</span> <span class="fu">matrix</span>(MASS<span class="sc">:::</span><span class="fu">rnegbin</span>(n<span class="sc">*</span>N,<span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean),size),<span class="at">ncol=</span>N, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a> a <span class="ot">=</span> <span class="fu">apply</span>(sim <span class="sc">+</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>),<span class="dv">2</span>,ecdf)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a> resid<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)) resid<span class="ot">&lt;-</span><span class="fu">c</span>(resid,a[[i]](data<span class="sc">$</span>y[i] <span class="sc">+</span> <span class="fu">runif</span>(<span class="dv">1</span> ,<span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>)))</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (plot<span class="sc">==</span>T) {</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>   <span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>   gap<span class="sc">::</span><span class="fu">qqunif</span>(resid,<span class="at">pch =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>   <span class="at">logscale =</span> F, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.6</span>, <span class="at">main =</span> <span class="st">"QQ plot residuals"</span>,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>   <span class="at">cex.main =</span> <span class="dv">1</span>, <span class="at">las=</span><span class="dv">1</span>)</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(resid<span class="sc">~</span><span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean), <span class="at">xlab=</span><span class="st">'Predicted value'</span>, <span class="at">ylab=</span><span class="st">'Standardized residual'</span>, <span class="at">las=</span><span class="dv">1</span>)</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a> resid</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="fu">simRes</span>(lambda,dat.nb, <span class="at">family=</span><span class="st">'negbin'</span>, <span class="at">size=</span><span class="fu">mean</span>(size))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NA  [1] 0.368 0.944 0.456 0.788 0.148 0.928 0.136 0.704 0.164 0.800 0.500 0.464
NA [13] 0.100 0.216 0.680 0.212 0.000 0.676 0.924 0.852</code></pre>
</div>
</div>
<p>The trend (black symbols) in the qq-plot does not appear to be overly non-linear (matching the ideal red line well), suggesting that the model is not overdispersed. The spread of standardized (simulated) residuals in the residual plot do not appear overly non-uniform. That is there is not trend in the residuals. Furthermore, there is not a concentration of points close to <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span> (which would imply overdispersion).</p>
</section>
<section id="exploring-the-model-parameters-1" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-model-parameters-1">Exploring the model parameters</h2>
<p>If there was any evidence that the assumptions had been violated or the model was not an appropriate fit, then we would need to reconsider the model and start the process again. In this case, there is no evidence that the test will be unreliable so we can proceed to explore the test statistics. As with most Bayesian models, it is best to base conclusions on medians rather than means.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.NB.jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelnbin.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA            mu.vect sd.vect    2.5%     25%     50%     75%   97.5%  Rhat n.eff
NA beta0        0.731   0.395  -0.023   0.470   0.717   0.984   1.534 1.001 10000
NA beta1        0.097   0.032   0.034   0.077   0.098   0.118   0.158 1.001 10000
NA scaleparam   2.787   1.756   0.704   1.670   2.412   3.444   7.089 1.001 10000
NA size         3.255   2.190   1.055   1.941   2.697   3.853   9.050 1.001 10000
NA theta       12.548  12.474   2.669   5.892   9.157  14.790  43.249 1.001 10000
NA deviance   113.053   2.691 110.093 111.115 112.352 114.190 120.305 1.002  2000
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 3.6 and DIC = 116.7
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">adply</span>(dat.NB.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x),<span class="at">p=</span><span class="fl">0.5</span>))</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA           X1       Median         Mean        lower       upper     lower.1
NA 1      beta0   0.71693048   0.73121205  -0.05129743   1.5032427   0.4523583
NA 2      beta1   0.09800852   0.09730699   0.03509028   0.1591976   0.0789372
NA 3   deviance 112.35178835 113.05255254 109.86520971 118.4814291 110.0898498
NA 4 scaleparam   2.41198253   2.78665197   0.33094006   5.9583607   1.2865037
NA 5       size   2.69653197   3.25545915   0.68960555   7.2146030   1.4202953
NA 6      theta   9.15704708  12.54776430   1.61632232  32.9116959   3.6489231
NA       upper.1
NA 1   0.9610028
NA 2   0.1201659
NA 3 112.4668566
NA 4   2.8677393
NA 5   2.9988148
NA 6  10.3646959</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">#on original scale</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">adply</span>(<span class="fu">exp</span>(dat.NB.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x),<span class="at">p=</span><span class="fl">0.5</span>))</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA      X1   Median     Mean     lower    upper  lower.1  upper.1
NA 1 beta0 2.048137 2.249960 0.8335273 4.249614 1.340384 2.309801
NA 2 beta1 1.102972 1.102753 1.0357132 1.172570 1.080463 1.125944</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: We would reject the null hypothesis of no effect of <span class="math inline">\(x\)</span> on <span class="math inline">\(y\)</span>. An increase in x is associated with a significant linear increase (positive slope) in the abundance of <span class="math inline">\(y\)</span>. Every <span class="math inline">\(1\)</span> unit increase in <span class="math inline">\(x\)</span> results in a log <span class="math inline">\(0.09\)</span> unit increase in <span class="math inline">\(y\)</span>. We usually express this in terms of abundance rather than log abundance, so every <span class="math inline">\(1\)</span> unit increase in <span class="math inline">\(x\)</span> results in a ($e^{ 0.09} = 1.02 $) <span class="math inline">\(1.02\)</span> unit increase in the abundance of <span class="math inline">\(y\)</span>.</p>
</section>
<section id="explorations-of-the-trends-1" class="level2">
<h2 class="anchored" data-anchor-id="explorations-of-the-trends-1">Explorations of the trends</h2>
<p>A measure of the strength of the relationship can be obtained according to:</p>
<p><span class="math display">\[
R^2 = 1 - \frac{\text{RSS}_{model}}{\text{RSS}_{null}}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat.nb)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate the raw SS residuals</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>SSres <span class="ot">&lt;-</span> <span class="fu">apply</span>((<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>(<span class="fu">sweep</span>(lambda,<span class="dv">2</span>,dat.nb<span class="sc">$</span>y,<span class="st">'-'</span>)))<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>SSres.null <span class="ot">&lt;-</span> <span class="fu">sum</span>((dat.nb<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">mean</span>(dat.nb<span class="sc">$</span>y))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="co">#OR </span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>SSres.null <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(dat.nb<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">mean</span>(dat.nb<span class="sc">$</span>y))</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate the model r2</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">-</span><span class="fu">mean</span>(SSres)<span class="sc">/</span>SSres.null</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA          [,1]
NA [1,] 0.270553</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: <span class="math inline">\(27\)</span>% of the variation in <span class="math inline">\(y\)</span> abundance can be explained by its relationship with <span class="math inline">\(x\)</span>. We can also do it directly into <code>JAGS</code>.</p>
<p>Finally, we will create a summary plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat.nb, <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">ann =</span> F, <span class="at">axes =</span> F)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat.nb, <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>xs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat.nb<span class="sc">$</span>x,<span class="at">na.rm=</span><span class="cn">TRUE</span>),<span class="fu">max</span>(dat.nb<span class="sc">$</span>x,<span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">l =</span> <span class="dv">1000</span>)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>xs)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>ys <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>data.tab <span class="ot">&lt;-</span> <span class="fu">adply</span>(ys,<span class="dv">2</span>,<span class="cf">function</span>(x) {</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)))</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>data.tab <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">x=</span>xs,data.tab)</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(Median <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>)</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(lower <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(upper <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"X"</span>, <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">las =</span> <span class="dv">2</span>)</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"Abundance of Y"</span>, <span class="dv">2</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">bty =</span> <span class="st">"l"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="full-log-likelihood-function-1" class="level2">
<h2 class="anchored" data-anchor-id="full-log-likelihood-function-1">Full log-likelihood function</h2>
<p>Now lets try it by specifying log-likelihood and the zero trick. When applying this trick, we need to manually calculate the deviance as the inbuilt deviance will be based on the log-likelihood of estimating the zeros (as part of the zero trick) rather than the deviance of the intended model. The one advantage of the zero trick is that the Deviance and thus DIC, AIC provided by <code>R2jags</code> will be incorrect. Hence, they too need to be manually defined within <code>JAGS</code> I suspect that the AIC calculation I have used is incorrect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, dat.nb)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>nX <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Xmat)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>dat.nb.list2 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat.nb,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>Xmat,<span class="at">N=</span><span class="fu">nrow</span>(dat.nb), <span class="at">mu=</span><span class="fu">rep</span>(<span class="dv">0</span>,nX),</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Sigma=</span><span class="fu">diag</span>(<span class="fl">1.0E-06</span>,nX), <span class="at">zeros=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">nrow</span>(dat.nb)), <span class="at">C=</span><span class="dv">10000</span>))</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="st">     zeros[i] ~ dpois(zeros.lambda[i])</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="st">     zeros.lambda[i] &lt;- -ll[i] + C     </span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="st">     ll[i] &lt;- loggam(Y[i]+size) - loggam(Y[i]+1) - loggam(size) + size*(log(p[i]) - log(p[i]+1)) - </span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="st">              Y[i]*log(p[i]+1)</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="st">     p[i] &lt;- size/lambda[i]</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="st">     eta[i] &lt;- inprod(beta[], X[i,])</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="st">     log(lambda[i]) &lt;- eta[i]</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ dmnorm(mu[],Sigma[,])</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="st">  size ~ dunif(0.001,1000)</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="st">  dev &lt;- sum(-2*ll)</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelnbin_ll.txt'</span>)</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta'</span>,<span class="st">'dev'</span>)</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>dat.NB.jags3 <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.nb.list2,<span class="at">model.file=</span><span class="st">'modelnbin_ll.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 20
NA    Unobserved stochastic nodes: 2
NA    Total graph size: 453
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.NB.jags3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelnbin_ll.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA             mu.vect sd.vect       2.5%        25%        50%        75%
NA beta[1]       0.739   0.386      0.039      0.484      0.726      0.968
NA beta[2]       0.096   0.031      0.034      0.077      0.096      0.116
NA dev         112.830   2.548    110.074    111.037    112.105    113.842
NA deviance 400112.830   2.548 400110.074 400111.037 400112.105 400113.842
NA               97.5%  Rhat n.eff
NA beta[1]       1.536 1.015   160
NA beta[2]       0.153 1.010   230
NA dev         119.701 1.002  1200
NA deviance 400119.701 1.000     1
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 3.2 and DIC = 400116.1
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
</section>
</section>
<section id="zero-inflated-poisson" class="level1">
<h1>Zero inflated Poisson</h1>
<p>Zero-Inflation Poisson (ZIP) mixture model is defined as:</p>
<p><span class="math display">\[
p(y_i \mid \theta, \lambda) = \begin{cases}
  \theta + (1-\theta) \times \text{Pois}(0 \mid \lambda) &amp; \text{if } y_i = 0\\    
  (1-\theta) \times \text{Pois}(y_i \mid \lambda) &amp; \text{if } y_i &gt; 0,    
\end{cases}
\]</span></p>
<p>where <span class="math inline">\(\theta\)</span> is the probability of false values (zeros). Hence there is essentially two models coupled together (a mixture model) to yield an overall probability:</p>
<ul>
<li><p>when an observed response is zero (<span class="math inline">\(y_i=0\)</span>), it is the probability of getting a false value (zero) plus the probability of a true value multiplied probability of drawing a value of zero from a Poisson distribution of lambda.</p></li>
<li><p>when an observed response is greater than <span class="math inline">\(0\)</span>, it is the probability of a true value multiplied probability of drawing that value from a Poisson distribution of lambda</p></li>
</ul>
<p>The above formulation indicates the same <span class="math inline">\(\lambda\)</span> for both the zeros and non-zeros components. In the model of zero values, we are essentially investigating whether the likelihood of false zeros is related to the linear predictor and then the greater than zero model investigates whether the counts are related to the linear predictor. However, we are typically less interested in modelling determinants of false zeros. Indeed, it is better that the likelihood of false zeros be unrelated to the linear predictor. For example, if excess (false zeros) are due to issues of detectability (individuals are present, just not detected), it is better that the detectability is not related to experimental treatments. Ideally, any detectability issues should be equal across all treatment levels. The expected value of <span class="math inline">\(Y\)</span> and the variance in <span class="math inline">\(Y\)</span> for a ZIP model are:</p>
<p><span class="math display">\[
E[y_i] = \lambda \times (1-\theta),
\]</span></p>
<p><span class="math display">\[
\text{Var}(y_i) = \lambda \times (1-\theta) \times (1+\theta \times \lambda^2)
\]</span></p>
<section id="data-generation-2" class="level2">
<h2 class="anchored" data-anchor-id="data-generation-2">Data generation</h2>
<p>Lets say we wanted to model the abundance of an item (<span class="math inline">\(y\)</span>) against a continuous predictor (<span class="math inline">\(x\)</span>). As this section is mainly about the generation of artificial data (and not specifically about what to do with the data), understanding the actual details are optional and can be safely skipped.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">9</span>) <span class="co">#34.5  #4 #10 #16 #17 #26</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co">#The number of samples</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>n.x <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Create x values that at uniformly distributed throughout the rate of 1 to 20</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">runif</span>(<span class="at">n =</span> n.x, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span><span class="dv">20</span>))</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>slope<span class="ot">=</span><span class="fl">0.1</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co">#The linear predictor</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>linpred <span class="ot">&lt;-</span> mm <span class="sc">%*%</span> <span class="fu">c</span>(intercept,slope)</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Predicted y values</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(linpred)</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Add some noise and make binomial</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gamlss.dist)</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="co">#fixed latent binomial</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>y<span class="ot">&lt;-</span> <span class="fu">rZIP</span>(n.x,lambda, <span class="fl">0.4</span>)</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="co">#latent binomial influenced by the linear predictor </span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="co">#y&lt;- rZIP(n.x,lambda, 1-exp(linpred)/(1+exp(linpred)))</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>dat.zip <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(y,x)</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">glm</span>(y<span class="sc">~</span>x, dat.zip, <span class="at">family=</span><span class="st">"poisson"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA Call:
NA glm(formula = y ~ x, family = "poisson", data = dat.zip)
NA 
NA Coefficients:
NA             Estimate Std. Error z value Pr(&gt;|z|)    
NA (Intercept)  0.30200    0.25247   1.196    0.232    
NA x            0.10691    0.01847   5.789 7.09e-09 ***
NA ---
NA Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
NA 
NA (Dispersion parameter for poisson family taken to be 1)
NA 
NA     Null deviance: 111.495  on 19  degrees of freedom
NA Residual deviance:  79.118  on 18  degrees of freedom
NA AIC: 126.64
NA 
NA Number of Fisher Scoring iterations: 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">glm</span>(y<span class="sc">~</span>x, dat.zip, <span class="at">family=</span><span class="st">"poisson"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pscl)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">zeroinfl</span>(y <span class="sc">~</span> x <span class="sc">|</span> <span class="dv">1</span>, <span class="at">dist =</span> <span class="st">"poisson"</span>, <span class="at">data =</span> dat.zip))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA Call:
NA zeroinfl(formula = y ~ x | 1, data = dat.zip, dist = "poisson")
NA 
NA Pearson residuals:
NA     Min      1Q  Median      3Q     Max 
NA -1.1625 -0.9549  0.1955  0.8125  1.4438 
NA 
NA Count model coefficients (poisson with log link):
NA             Estimate Std. Error z value Pr(&gt;|z|)    
NA (Intercept)  0.88696    0.28825   3.077  0.00209 ** 
NA x            0.09374    0.02106   4.450 8.58e-06 ***
NA 
NA Zero-inflation model coefficients (binomial with logit link):
NA             Estimate Std. Error z value Pr(&gt;|z|)
NA (Intercept)  -0.4581     0.4725   -0.97    0.332
NA ---
NA Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
NA 
NA Number of iterations in BFGS optimization: 8 
NA Log-likelihood: -38.58 on 3 Df</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">resid</span>(<span class="fu">zeroinfl</span>(y <span class="sc">~</span> x <span class="sc">|</span> <span class="dv">1</span>, <span class="at">dist =</span> <span class="st">"poisson"</span>, <span class="at">data =</span> dat.zip))<span class="sc">~</span><span class="fu">fitted</span>(<span class="fu">zeroinfl</span>(y <span class="sc">~</span> x <span class="sc">|</span> <span class="dv">1</span>, <span class="at">dist =</span> <span class="st">"poisson"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gamlss)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">gamlss</span>(y<span class="sc">~</span>x,<span class="at">data=</span>dat.zip, <span class="at">family=</span>ZIP))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA GAMLSS-RS iteration 1: Global Deviance = 77.8434 
NA GAMLSS-RS iteration 2: Global Deviance = 77.1603 
NA GAMLSS-RS iteration 3: Global Deviance = 77.1598 
NA ******************************************************************
NA Family:  c("ZIP", "Poisson Zero Inflated") 
NA 
NA Call:  gamlss(formula = y ~ x, family = ZIP, data = dat.zip) 
NA 
NA Fitting method: RS() 
NA 
NA ------------------------------------------------------------------
NA Mu link function:  log
NA Mu Coefficients:
NA             Estimate Std. Error t value Pr(&gt;|t|)    
NA (Intercept)  0.88620    0.28819   3.075 0.006862 ** 
NA x            0.09387    0.02105   4.458 0.000345 ***
NA ---
NA Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
NA 
NA ------------------------------------------------------------------
NA Sigma link function:  logit
NA Sigma Coefficients:
NA             Estimate Std. Error t value Pr(&gt;|t|)
NA (Intercept)  -0.4582     0.4725   -0.97    0.346
NA 
NA ------------------------------------------------------------------
NA No. of observations in the fit:  20 
NA Degrees of Freedom for the fit:  3
NA       Residual Deg. of Freedom:  17 
NA                       at cycle:  3 
NA  
NA Global Deviance:     77.15981 
NA             AIC:     83.15981 
NA             SBC:     86.14701 
NA ******************************************************************</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(<span class="fu">gamlss</span>(y<span class="sc">~</span>x,<span class="at">data=</span>dat.zip, <span class="at">family=</span>ZIP), <span class="at">se.fit=</span><span class="cn">TRUE</span>, <span class="at">what=</span><span class="st">"mu"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA GAMLSS-RS iteration 1: Global Deviance = 77.8434 
NA GAMLSS-RS iteration 2: Global Deviance = 77.1603 
NA GAMLSS-RS iteration 3: Global Deviance = 77.1598</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NA $fit
NA         1         2         3         4         5         6         7         8 
NA 0.9952647 1.0233409 1.1897115 1.2189891 1.3490911 1.3644351 1.3748867 1.5164069 
NA         9        10        11        12        13        14        15        16 
NA 1.6184170 1.6379917 1.6760055 1.6962694 1.7705249 1.8559090 1.8578379 1.8718850 
NA        17        18        19        20 
NA 2.1712345 2.5536059 2.7205304 2.7472964 
NA 
NA $se.fit
NA         1         2         3         4         5         6         7         8 
NA 0.3826655 0.3724115 0.3131865 0.3031078 0.2601025 0.2552658 0.2520053 0.2112310 
NA         9        10        11        12        13        14        15        16 
NA 0.1872286 0.1833232 0.1765049 0.1733169 0.1646100 0.1610460 0.1610499 0.1611915 
NA        17        18        19        20 
NA 0.2055555 0.3248709 0.3848647 0.3947072</code></pre>
</div>
</div>
</section>
<section id="exploratory-data-analysis-1" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis-1">Exploratory data analysis</h2>
<p>Check the distribution of the <span class="math inline">\(y\)</span> abundances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dat.zip<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(dat.zip<span class="sc">$</span>y, <span class="at">horizontal=</span><span class="cn">TRUE</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(<span class="fu">jitter</span>(dat.zip<span class="sc">$</span>y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-31-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is definitely signs of non-normality that would warrant Poisson models. Further to that, there appears to be a large number of zeros that are likely to be the cause of overdispersion A zero-inflated Poisson model is likely to be one of the most effective for modeling these data. Lets now explore linearity by creating a histogram of the predictor variable (<span class="math inline">\(x\)</span>). Note, it is difficult to directly assess issues of linearity. Indeed, a scatterplot with lowess smoother will be largely influenced by the presence of zeros. One possible way of doing so is to explore the trend in the non-zero data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dat.zip<span class="sc">$</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">#now for the scatterplot</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, dat.zip)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(dat.zip,y<span class="sc">&gt;</span><span class="dv">0</span>), <span class="fu">lines</span>(<span class="fu">lowess</span>(y<span class="sc">~</span>x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-32-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Conclusions</strong>: the predictor (<span class="math inline">\(x\)</span>) does not display any skewness or other issues that might lead to non-linearity. The lowess smoother on the non-zero data cloud does not display major deviations from a straight line and thus linearity is likely to be satisfied. Violations of linearity (whilst difficult to be certain about due to the unknown influence of the zeros) could be addressed by either:</p>
<ul>
<li><p>define a non-linear linear predictor (such as a polynomial, spline or other non-linear function).</p></li>
<li><p>transform the scale of the predictor variables.</p></li>
</ul>
<p>Although we have already established that there are few zeros in the data (and thus overdispersion is unlikely to be an issue), we can also explore this by comparing the number of zeros in the data to the number of zeros that would be expected from a Poisson distribution with a mean equal to the mean count of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">#proportion of 0's in the data</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>dat.zip.tab<span class="ot">&lt;-</span><span class="fu">table</span>(dat.zip<span class="sc">$</span>y<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>dat.zip.tab<span class="sc">/</span><span class="fu">sum</span>(dat.zip.tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA FALSE  TRUE 
NA   0.6   0.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">#proportion of 0's expected from a Poisson distribution</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat.zip<span class="sc">$</span>y)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>cnts <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1000</span>, mu)</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>dat.zip.tabE <span class="ot">&lt;-</span> <span class="fu">table</span>(cnts <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>dat.zip.tabE<span class="sc">/</span><span class="fu">sum</span>(dat.zip.tabE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA FALSE  TRUE 
NA 0.982 0.018</code></pre>
</div>
</div>
<p>In the above, the value under <code>FALSE</code> is the proportion of non-zero values in the data and the value under TRUE is the proportion of zeros in the data. In this example, the proportion of zeros observed (<span class="math inline">\(45\)</span>%) far exceeds that that would have been expected (<span class="math inline">\(7.9\)</span>%). Hence it is highly likely that any models will be zero-inflated.</p>
</section>
<section id="model-fitting-2" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting-2">Model fitting</h2>
<p><span class="math display">\[
y_i \sim \text{ZIP}(\lambda_i, \theta),
\]</span></p>
<p>where <span class="math inline">\(\text{logit}(\theta) = \gamma_0\)</span>, <span class="math inline">\(\log(\lambda_i)=\eta_i\)</span>, with <span class="math inline">\(\eta_i=\beta_0+\beta_1x_{i}\)</span> and <span class="math inline">\(\beta_0,\beta_1,\gamma_0 \sim N(0, 10000)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>dat.zip.list <span class="ot">&lt;-</span> <span class="fu">with</span>(dat.zip,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>x,<span class="at">N=</span><span class="fu">nrow</span>(dat.nb), <span class="at">z=</span><span class="fu">ifelse</span>(y<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)))</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="st">     z[i] ~ dbern(one.minus.theta)</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="st">     Y[i] ~ dpois(lambda[i])</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="st">     lambda[i] &lt;- z[i]*eta[i]</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="st">     log(eta[i]) &lt;- beta0 + beta1*X[i]</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="st">  one.minus.theta &lt;- 1-theta</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="st">  logit(theta) &lt;- gamma0</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a><span class="st">  beta0 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a><span class="st">  beta1 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a><span class="st">  gamma0 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelzip.txt'</span>)</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>, <span class="st">'gamma0'</span>,<span class="st">'theta'</span>)</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a>dat.zip.jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.zip.list,<span class="at">model.file=</span><span class="st">'modelzip.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 40
NA    Unobserved stochastic nodes: 3
NA    Total graph size: 149
NA 
NA Initializing model</code></pre>
</div>
</div>
</section>
<section id="model-evaluation-2" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation-2">Model evaluation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">denplot</span>(dat.zip.jags, <span class="at">parms =</span> <span class="fu">c</span>(<span class="st">'beta'</span>, <span class="st">'gamma0'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traplot</span>(dat.zip.jags, <span class="at">parms =</span> <span class="fu">c</span>(<span class="st">'beta'</span>, <span class="st">'gamma0'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-35-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">raftery.diag</span>(<span class="fu">as.mcmc</span>(dat.zip.jags))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [[1]]
NA 
NA Quantile (q) = 0.025
NA Accuracy (r) = +/- 0.005
NA Probability (s) = 0.95 
NA                                                 
NA           Burn-in  Total Lower bound  Dependence
NA           (M)      (N)   (Nmin)       factor (I)
NA  beta0    20       20276 3746         5.41      
NA  beta1    22       24038 3746         6.42      
NA  deviance 4        4636  3746         1.24      
NA  gamma0   5        5908  3746         1.58      
NA  theta    5        5908  3746         1.58      
NA 
NA 
NA [[2]]
NA 
NA Quantile (q) = 0.025
NA Accuracy (r) = +/- 0.005
NA Probability (s) = 0.95 
NA                                                 
NA           Burn-in  Total Lower bound  Dependence
NA           (M)      (N)   (Nmin)       factor (I)
NA  beta0    20       21336 3746         5.70      
NA  beta1    20       22636 3746         6.04      
NA  deviance 3        4267  3746         1.14      
NA  gamma0   5        6078  3746         1.62      
NA  theta    5        6078  3746         1.62</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autocorr.diag</span>(<span class="fu">as.mcmc</span>(dat.zip.jags))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA              beta0       beta1    deviance      gamma0       theta
NA Lag 0   1.00000000  1.00000000  1.00000000 1.000000000 1.000000000
NA Lag 1   0.88627108  0.88426590  0.51799594 0.232408997 0.227686735
NA Lag 5   0.58998005  0.59775827  0.19471855 0.002321179 0.001571686
NA Lag 10  0.35846288  0.35888205  0.06697926 0.017561785 0.015598223
NA Lag 50 -0.01753582 -0.01936659 -0.01212528 0.022040872 0.021016755</code></pre>
</div>
</div>
</section>
<section id="goodness-of-fit-1" class="level2">
<h2 class="anchored" data-anchor-id="goodness-of-fit-1">Goodness of fit</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the samples for the two model parameters</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">&lt;-</span> dat.zip.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> dat.zip.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="st">'theta'</span>]</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat.zip)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>lambda<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>eta <span class="ot">&lt;-</span> <span class="fu">exp</span>(lambda)</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>expY <span class="ot">&lt;-</span> <span class="fu">sweep</span>(eta,<span class="dv">1</span>,(<span class="dv">1</span><span class="sc">-</span>theta),<span class="st">"*"</span>)</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>varY <span class="ot">&lt;-</span> eta<span class="sc">+</span><span class="fu">sweep</span>(eta<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,theta,<span class="st">"*"</span>)</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>varY <span class="ot">&lt;-</span> <span class="fu">sweep</span>(varY,<span class="dv">1</span>,(<span class="dv">1</span><span class="sc">-</span>theta),<span class="st">'*'</span>)</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a><span class="co">#sweep across rows and then divide by lambda</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>Resid <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">*</span><span class="fu">sweep</span>(expY,<span class="dv">2</span>,dat.zip<span class="sc">$</span>y,<span class="st">'-'</span>)<span class="sc">/</span><span class="fu">sqrt</span>(varY)</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="co">#plot residuals vs expected values</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(Resid,<span class="dv">2</span>,mean)<span class="sc">~</span><span class="fu">apply</span>(eta,<span class="dv">2</span>,mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we will compare the sum of squared residuals to the sum of squares residuals that would be expected from a Poisson distribution matching that estimated by the model. Essentially this is estimating how well the Poisson distribution, the log-link function and the linear model approximates the observed data. When doing so, we need to consider the expected value and variance of the zero-inflated poisson.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>SSres<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum, <span class="at">na.rm=</span>T)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co">#generate a matrix of draws from a zero-inflated poisson (ZIP) distribution</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the matrix is the same dimensions as lambda</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gamlss.dist)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="co">#YNew &lt;- matrix(rZIP(length(lambda),eta, theta),nrow=nrow(lambda))</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">sweep</span>(eta,<span class="dv">1</span>,<span class="fu">ifelse</span>(dat.zip<span class="sc">$</span>y<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="st">'*'</span>)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>YNew <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(<span class="fu">length</span>(lambda),lambda),<span class="at">nrow=</span><span class="fu">nrow</span>(lambda))</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>Resid1<span class="ot">&lt;-</span>(expY <span class="sc">-</span> YNew)<span class="sc">/</span><span class="fu">sqrt</span>(varY)</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>SSres.sim<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid1<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(SSres.sim<span class="sc">&gt;</span>SSres, <span class="at">na.rm =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 0.5619</code></pre>
</div>
</div>
<p>Since it is difficult to diagnose many issues from the typical residuals we will now explore simulated residuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the samples for the two model parameters</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">&lt;-</span> dat.zip.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> dat.zip.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="st">'theta'</span>]</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat.zip)</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>simRes <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, data,<span class="at">n=</span><span class="dv">250</span>, <span class="at">plot=</span>T, <span class="at">family=</span><span class="st">'negbin'</span>, <span class="at">size=</span><span class="cn">NULL</span>,<span class="at">theta=</span><span class="cn">NULL</span>) {</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a> <span class="fu">require</span>(gap)</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a> N <span class="ot">=</span> <span class="fu">nrow</span>(data)</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a> sim <span class="ot">=</span> <span class="cf">switch</span>(family,</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'poisson'</span> <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(n<span class="sc">*</span>N,<span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean)),<span class="at">ncol=</span>N, <span class="at">byrow=</span><span class="cn">TRUE</span>),</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'negbin'</span> <span class="ot">=</span> <span class="fu">matrix</span>(MASS<span class="sc">:::</span><span class="fu">rnegbin</span>(n<span class="sc">*</span>N,<span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean),size),<span class="at">ncol=</span>N, <span class="at">byrow=</span><span class="cn">TRUE</span>),</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'zip'</span> <span class="ot">=</span> <span class="fu">matrix</span>(gamlss.dist<span class="sc">:::</span><span class="fu">rZIP</span>(n<span class="sc">*</span>N,<span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean),theta),<span class="at">ncol=</span>N, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a> a <span class="ot">=</span> <span class="fu">apply</span>(sim <span class="sc">+</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>),<span class="dv">2</span>,ecdf)</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a> resid<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data)) resid<span class="ot">&lt;-</span><span class="fu">c</span>(resid,a[[i]](data<span class="sc">$</span>y[i] <span class="sc">+</span> <span class="fu">runif</span>(<span class="dv">1</span> ,<span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>)))</span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (plot<span class="sc">==</span>T) {</span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>   gap<span class="sc">::</span><span class="fu">qqunif</span>(resid,<span class="at">pch =</span> <span class="dv">2</span>, <span class="at">bty =</span> <span class="st">"n"</span>,</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>   <span class="at">logscale =</span> F, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.6</span>, <span class="at">main =</span> <span class="st">"QQ plot residuals"</span>,</span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>   <span class="at">cex.main =</span> <span class="dv">1</span>, <span class="at">las=</span><span class="dv">1</span>)</span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(resid<span class="sc">~</span><span class="fu">apply</span>(lambda,<span class="dv">2</span>,mean), <span class="at">xlab=</span><span class="st">'Predicted value'</span>, <span class="at">ylab=</span><span class="st">'Standardized residual'</span>, <span class="at">las=</span><span class="dv">1</span>)</span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a> resid</span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a><span class="fu">simRes</span>(lambda,dat.zip, <span class="at">family=</span><span class="st">'zip'</span>,<span class="at">theta=</span>theta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NA  [1] 0.718 0.212 0.106 0.050 0.476 0.778 0.248 0.060 0.878 0.704 0.090 0.890
NA [13] 0.416 0.764 0.282 0.752 0.602 0.848 0.154 0.656</code></pre>
</div>
</div>
<p>The trend (black symbols) in the qq-plot does not appear to be overly non-linear (matching the ideal red line well), suggesting that the model is not overdispersed. The spread of standardized (simulated) residuals in the residual plot do not appear overly non-uniform. That is there is not trend in the residuals. Furthermore, there is not a concentration of points close to <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span> (which would imply overdispersion). Hence, once zero-inflation is accounted for, the model does not display overdispersion. Although there is a slight hint of non-linearity in that the residuals are high for low and high fitted values and lower in the middle, this might well be an artifact of the small data set size. By change, most of the observed values in the middle range of the predictor were zero.</p>
</section>
<section id="exploring-the-model-parameters-2" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-model-parameters-2">Exploring the model parameters</h2>
<p>If there was any evidence that the assumptions had been violated or the model was not an appropriate fit, then we would need to reconsider the model and start the process again. In this case, there is no evidence that the test will be unreliable so we can proceed to explore the test statistics. As with most Bayesian models, it is best to base conclusions on medians rather than means.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.zip.jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelzip.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA          mu.vect sd.vect   2.5%    25%    50%    75%  97.5%  Rhat n.eff
NA beta0      0.930   0.282  0.365  0.742  0.933  1.128  1.468 1.003   860
NA beta1      0.090   0.021  0.049  0.076  0.090  0.104  0.132 1.002  1400
NA gamma0    -0.420   0.458 -1.349 -0.722 -0.417 -0.110  0.459 1.001 10000
NA theta      0.401   0.105  0.206  0.327  0.397  0.472  0.613 1.001  7600
NA deviance  80.674   2.501 77.856 78.867 80.008 81.801 87.064 1.001 10000
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 3.1 and DIC = 83.8
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">adply</span>(dat.zip.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x),<span class="at">p=</span><span class="fl">0.5</span>))</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA         X1      Median        Mean       lower      upper    lower.1
NA 1    beta0  0.93334635  0.92997411  0.37821529  1.4774189  0.7530788
NA 2    beta1  0.09005537  0.09005981  0.04864163  0.1313802  0.0749821
NA 3 deviance 80.00841187 80.67383245 77.63946567 85.5798539 77.8273778
NA 4   gamma0 -0.41667356 -0.41996110 -1.34903991  0.4586909 -0.7013225
NA 5    theta  0.39731301  0.40136809  0.19516803  0.6012233  0.3173026
NA       upper.1
NA 1  1.13629442
NA 2  0.10333030
NA 3 80.10544007
NA 4 -0.09258569
NA 5  0.46170971</code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">#on original scale</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">adply</span>(<span class="fu">exp</span>(dat.zip.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x),<span class="at">p=</span><span class="fl">0.5</span>))</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA      X1   Median     Mean    lower    upper  lower.1  upper.1
NA 1 beta0 2.543005 2.636434 1.280362 4.056990 1.911083 2.853498
NA 2 beta1 1.094235 1.094483 1.049844 1.140401 1.077865 1.108858</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: We would reject the null hypothesis of no effect of <span class="math inline">\(x\)</span> on <span class="math inline">\(y\)</span>. An increase in <span class="math inline">\(x\)</span> is associated with a significant linear increase (positive slope) in the abundance of <span class="math inline">\(y\)</span>. Every <span class="math inline">\(1\)</span> unit increase in <span class="math inline">\(x\)</span> results in a log <span class="math inline">\(0.09\)</span> unit increase in <span class="math inline">\(y\)</span>. We usually express this in terms of abundance rather than log abundance, so every <span class="math inline">\(1\)</span> unit increase in <span class="math inline">\(x\)</span> results in a (<span class="math inline">\(e^{0.09}=1.1\)</span>) <span class="math inline">\(1.1\)</span> unit increase in the abundance of <span class="math inline">\(y\)</span>.</p>
</section>
<section id="explorations-of-the-trends-2" class="level2">
<h2 class="anchored" data-anchor-id="explorations-of-the-trends-2">Explorations of the trends</h2>
<p>A measure of the strength of the relationship can be obtained according to:</p>
<p><span class="math display">\[
R^2 = 1 - \frac{\text{RSS}_{model}}{\text{RSS}_{null}}
\]</span></p>
<p>Alternatively, we could use McFadden’s psuedo</p>
<p><span class="math display">\[
R^2 = 1- \frac{LL(Model_{full})}{LL(Model_{reduced}}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">dat=</span>dat.zip)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>neta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>eta <span class="ot">&lt;-</span> <span class="fu">exp</span>(neta)</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">sweep</span>(eta,<span class="dv">2</span>,<span class="fu">ifelse</span>(dat.zip<span class="sc">$</span>y<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="st">'*'</span>)</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> dat.zip.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="st">'theta'</span>]</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>expY <span class="ot">&lt;-</span> <span class="fu">sweep</span>(lambda,<span class="dv">2</span>,<span class="dv">1</span><span class="sc">-</span>theta,<span class="st">'*'</span>)</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate the raw SS residuals</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>SSres <span class="ot">&lt;-</span> <span class="fu">apply</span>((<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>(<span class="fu">sweep</span>(expY,<span class="dv">2</span>,dat.zip<span class="sc">$</span>y,<span class="st">'-'</span>)))<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(SSres)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 168.3814</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>SSres.null <span class="ot">&lt;-</span> <span class="fu">sum</span>((dat.zip<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">mean</span>(dat.zip<span class="sc">$</span>y))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate the model r2</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">-</span><span class="fu">mean</span>(SSres)<span class="sc">/</span>SSres.null</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 0.5977029</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: <span class="math inline">\(50\)</span>% of the variation in <span class="math inline">\(y\)</span> abundance can be explained by its relationship with <span class="math inline">\(x\)</span>. Finally, we will create a summary plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat.zip, <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">ann =</span> F, <span class="at">axes =</span> F)</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat.zip, <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>xs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat.zip<span class="sc">$</span>x,<span class="at">na.rm=</span><span class="cn">TRUE</span>),<span class="fu">max</span>(dat.zip<span class="sc">$</span>x,<span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">l =</span> <span class="dv">1000</span>)</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>xs)</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>ys <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>data.tab <span class="ot">&lt;-</span> <span class="fu">adply</span>(ys,<span class="dv">2</span>,<span class="cf">function</span>(x) {</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)))</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>data.tab <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">x=</span>xs,data.tab)</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(Median <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>)</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(lower <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(upper <span class="sc">~</span> x, <span class="at">data=</span>data.tab,<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"X"</span>, <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">las =</span> <span class="dv">2</span>)</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"Abundance of Y"</span>, <span class="dv">2</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">line =</span> <span class="dv">3</span>)</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>(<span class="at">bty =</span> <span class="st">"l"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="full-log-likelihood-function-2" class="level2">
<h2 class="anchored" data-anchor-id="full-log-likelihood-function-2">Full log-likelihood function</h2>
<p>Now lets try it by specifying log-likelihood and the zero trick. When applying this trick, we need to manually calculate the deviance as the inbuilt deviance will be based on the log-likelihood of estimating the zeros (as part of the zero trick) rather than the deviance of the intended model. The one advantage of the zero trick is that the Deviance and thus DIC, AIC provided by <code>R2jags</code> will be incorrect. Hence, they too need to be manually defined within <code>JAGS</code> I suspect that the AIC calculation I have used is incorrect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, dat.zip)</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>nX <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Xmat)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>dat.zip.list2 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat.zip,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>Xmat,<span class="at">N=</span><span class="fu">nrow</span>(dat.zip), <span class="at">mu=</span><span class="fu">rep</span>(<span class="dv">0</span>,nX),</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Sigma=</span><span class="fu">diag</span>(<span class="fl">1.0E-06</span>,nX), <span class="at">zeros=</span><span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">nrow</span>(dat)), <span class="at">C=</span><span class="dv">10000</span>))</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a><span class="st">     zeros[i] ~ dpois(zeros.lambda[i])</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a><span class="st">     zeros.lambda[i] &lt;- -ll[i] + C     </span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a><span class="st">     ll[i] &lt;- Y[i]*log(lambda[i]) - lambda[i] - loggam(Y[i]+1)</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a><span class="st">     eta[i] &lt;- inprod(beta[], X[i,])</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a><span class="st">     log(lambda[i]) &lt;- eta[i]</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a><span class="st">    llm[i] &lt;- Y[i]*log(meanlambda) - meanlambda - loggam(Y[i]+1)</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a><span class="st">  meanlambda &lt;- mean(lambda)</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ dmnorm(mu[],Sigma[,])</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a><span class="st">  dev &lt;- sum(-2*ll)</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a><span class="st">  pD &lt;- mean(dev)-sum(-2*llm)</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a><span class="st">  AIC &lt;- min(dev+(2*pD))</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelzip_ll.txt'</span>)</span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta'</span>,<span class="st">'dev'</span>,<span class="st">'AIC'</span>)</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a>dat.ZIP.jags3  <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.zip.list2,<span class="at">model.file=</span><span class="st">'modelzip_ll.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 20
NA    Unobserved stochastic nodes: 1
NA    Total graph size: 328
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.ZIP.jags3 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelzip_ll.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA             mu.vect sd.vect       2.5%        25%        50%        75%
NA AIC          61.488   3.844     57.991     58.846     60.144     62.785
NA beta[1]       0.329   0.225     -0.122      0.176      0.331      0.475
NA beta[2]       0.104   0.017      0.070      0.093      0.104      0.116
NA dev         124.472   1.801    122.700    123.170    123.871    125.221
NA deviance 400124.472   1.801 400122.700 400123.170 400123.871 400125.221
NA               97.5%  Rhat n.eff
NA AIC          72.257 1.089    35
NA beta[1]       0.785 1.071    67
NA beta[2]       0.137 1.051    69
NA dev         129.054 1.042    53
NA deviance 400129.054 1.000     1
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 1.6 and DIC = 400126.1
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
</section>
</section>
<section id="zero-inflated-negative-binomial" class="level1">
<h1>Zero inflated Negative Binomial</h1>
<section id="data-generation-3" class="level2">
<h2 class="anchored" data-anchor-id="data-generation-3">Data generation</h2>
<p>Lets say we wanted to model the abundance of an item (<span class="math inline">\(y\)</span>) against a continuous predictor (<span class="math inline">\(x\)</span>). As this section is mainly about the generation of artificial data (and not specifically about what to do with the data), understanding the actual details are optional and can be safely skipped.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">37</span>) <span class="co">#34.5  #4 #10 #16 #17 #26</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="co">#The number of samples</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>n.x <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Create x values that at uniformly distributed throughout the rate of 1 to 20</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">runif</span>(<span class="at">n =</span> n.x, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span><span class="dv">20</span>))</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x)</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>slope<span class="ot">=</span><span class="fl">0.1</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="co">#The linear predictor</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>linpred <span class="ot">&lt;-</span> mm <span class="sc">%*%</span> <span class="fu">c</span>(intercept,slope)</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Predicted y values</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(linpred)</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Add some noise and make binomial</span></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gamlss.dist)</span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a><span class="co">#fixed latent binomial</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>y<span class="ot">&lt;-</span> <span class="fu">rZINBI</span>(n.x,lambda, <span class="fl">0.4</span>)</span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a><span class="co">#latent binomial influenced by the linear predictor </span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a><span class="co">#y&lt;- rZINB(n.x,lambda, 1-exp(linpred)/(1+exp(linpred)))</span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>dat.zinb <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(y,x)</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat.glm.nb<span class="ot">&lt;-</span><span class="fu">glm.nb</span>(y<span class="sc">~</span>x, dat.zinb))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA Call:
NA glm.nb(formula = y ~ x, data = dat.zinb, init.theta = 0.4646673144, 
NA     link = log)
NA 
NA Coefficients:
NA             Estimate Std. Error z value Pr(&gt;|z|)
NA (Intercept) 0.914191   0.796804   1.147    0.251
NA x           0.009149   0.067713   0.135    0.893
NA 
NA (Dispersion parameter for Negative Binomial(0.4647) family taken to be 1)
NA 
NA     Null deviance: 20.303  on 19  degrees of freedom
NA Residual deviance: 20.282  on 18  degrees of freedom
NA AIC: 90.365
NA 
NA Number of Fisher Scoring iterations: 1
NA 
NA 
NA               Theta:  0.465 
NA           Std. Err.:  0.218 
NA 
NA  2 x log-likelihood:  -84.365</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">glm.nb</span>(y<span class="sc">~</span>x, dat.zinb))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-43-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-43-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-43-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pscl)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat.zeroinfl<span class="ot">&lt;-</span><span class="fu">zeroinfl</span>(y <span class="sc">~</span> x <span class="sc">|</span> <span class="dv">1</span>, <span class="at">dist =</span> <span class="st">"negbin"</span>, <span class="at">data =</span> dat.zinb))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA Call:
NA zeroinfl(formula = y ~ x | 1, data = dat.zinb, dist = "negbin")
NA 
NA Pearson residuals:
NA     Min      1Q  Median      3Q     Max 
NA -0.9609 -0.9268 -0.4446  1.0425  1.7556 
NA 
NA Count model coefficients (negbin with log link):
NA             Estimate Std. Error z value Pr(&gt;|z|)   
NA (Intercept)  0.92733    0.32507   2.853  0.00433 **
NA x            0.06870    0.02755   2.494  0.01263 * 
NA Log(theta)   3.36066    3.59739   0.934  0.35020   
NA 
NA Zero-inflation model coefficients (binomial with logit link):
NA             Estimate Std. Error z value Pr(&gt;|z|)
NA (Intercept)  -0.2250     0.4559  -0.494    0.622
NA ---
NA Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
NA 
NA Theta = 28.8082 
NA Number of iterations in BFGS optimization: 17 
NA Log-likelihood: -38.54 on 4 Df</code></pre>
</div>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">resid</span>(<span class="fu">zeroinfl</span>(y <span class="sc">~</span> x <span class="sc">|</span> <span class="dv">1</span>, <span class="at">dist =</span> <span class="st">"negbin"</span>, <span class="at">data =</span> dat.zinb))<span class="sc">~</span><span class="fu">fitted</span>(<span class="fu">zeroinfl</span>(y <span class="sc">~</span> x <span class="sc">|</span> <span class="dv">1</span>, <span class="at">dist =</span> <span class="st">"negbin"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-43-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vuong</span>(dat.glm.nb, dat.zeroinfl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Vuong Non-Nested Hypothesis Test-Statistic: 
NA (test-statistic is asymptotically distributed N(0,1) under the
NA  null that the models are indistinguishible)
NA -------------------------------------------------------------
NA               Vuong z-statistic             H_A p-value
NA Raw                  -1.2809521 model2 &gt; model1 0.10011
NA AIC-corrected        -0.9296587 model2 &gt; model1 0.17627
NA BIC-corrected        -0.7547616 model2 &gt; model1 0.22520</code></pre>
</div>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gamlss)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">gamlss</span>(y<span class="sc">~</span>x, <span class="at">data=</span>dat.zinb, <span class="at">family=</span><span class="st">'ZINBI'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA GAMLSS-RS iteration 1: Global Deviance = 82.35 
NA GAMLSS-RS iteration 2: Global Deviance = 82.0176 
NA GAMLSS-RS iteration 3: Global Deviance = 81.8115 
NA GAMLSS-RS iteration 4: Global Deviance = 81.6241 
NA GAMLSS-RS iteration 5: Global Deviance = 81.5175 
NA GAMLSS-RS iteration 6: Global Deviance = 81.5429 
NA GAMLSS-RS iteration 7: Global Deviance = 81.6384 
NA GAMLSS-RS iteration 8: Global Deviance = 81.6956 
NA GAMLSS-RS iteration 9: Global Deviance = 81.702 
NA GAMLSS-RS iteration 10: Global Deviance = 81.6899 
NA GAMLSS-RS iteration 11: Global Deviance = 81.644 
NA GAMLSS-RS iteration 12: Global Deviance = 81.4995 
NA GAMLSS-RS iteration 13: Global Deviance = 81.4366 
NA GAMLSS-RS iteration 14: Global Deviance = 81.4913 
NA GAMLSS-RS iteration 15: Global Deviance = 81.583 
NA GAMLSS-RS iteration 16: Global Deviance = 81.6803 
NA GAMLSS-RS iteration 17: Global Deviance = 81.7197 
NA GAMLSS-RS iteration 18: Global Deviance = 81.7177 
NA GAMLSS-RS iteration 19: Global Deviance = 81.6711 
NA GAMLSS-RS iteration 20: Global Deviance = 81.5165 
NA ******************************************************************
NA Family:  c("ZINBI", "Zero inflated negative binomial type I") 
NA 
NA Call:  gamlss(formula = y ~ x, family = "ZINBI", data = dat.zinb) 
NA 
NA Fitting method: RS() 
NA 
NA ------------------------------------------------------------------
NA Mu link function:  log
NA Mu Coefficients:
NA             Estimate Std. Error t value Pr(&gt;|t|)
NA (Intercept)  0.94930    0.93174   1.019    0.322
NA x            0.03794    0.07030   0.540    0.596
NA 
NA ------------------------------------------------------------------
NA Sigma link function:  log
NA Sigma Coefficients:
NA             Estimate Std. Error t value Pr(&gt;|t|)
NA (Intercept)  -0.2866     0.7254  -0.395    0.697
NA 
NA ------------------------------------------------------------------
NA Nu link function:  logit 
NA Nu Coefficients:
NA             Estimate Std. Error t value Pr(&gt;|t|)
NA (Intercept)  -0.8664     0.6832  -1.268     0.22
NA 
NA ------------------------------------------------------------------
NA No. of observations in the fit:  20 
NA Degrees of Freedom for the fit:  4
NA       Residual Deg. of Freedom:  16 
NA                       at cycle:  20 
NA  
NA Global Deviance:     81.51652 
NA             AIC:     89.51652 
NA             SBC:     93.49945 
NA ******************************************************************</code></pre>
</div>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">gamlss</span>(y<span class="sc">~</span>x, <span class="at">nu.fo=</span>y<span class="sc">~</span>x,<span class="at">data=</span>dat.zinb, <span class="at">family=</span><span class="st">'ZINBI'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA GAMLSS-RS iteration 1: Global Deviance = 79.3063 
NA GAMLSS-RS iteration 2: Global Deviance = 77.6325 
NA GAMLSS-RS iteration 3: Global Deviance = 77.4263 
NA GAMLSS-RS iteration 4: Global Deviance = 77.1265 
NA GAMLSS-RS iteration 5: Global Deviance = 77.0111 
NA GAMLSS-RS iteration 6: Global Deviance = 76.9765 
NA GAMLSS-RS iteration 7: Global Deviance = 76.9662 
NA GAMLSS-RS iteration 8: Global Deviance = 76.9626 
NA GAMLSS-RS iteration 9: Global Deviance = 76.9583 
NA GAMLSS-RS iteration 10: Global Deviance = 76.9579 
NA ******************************************************************
NA Family:  c("ZINBI", "Zero inflated negative binomial type I") 
NA 
NA Call:  gamlss(formula = y ~ x, nu.formula = y ~ x, family = "ZINBI",  
NA     data = dat.zinb) 
NA 
NA Fitting method: RS() 
NA 
NA ------------------------------------------------------------------
NA Mu link function:  log
NA Mu Coefficients:
NA             Estimate Std. Error t value Pr(&gt;|t|)
NA (Intercept)  0.80319    0.49858   1.611    0.128
NA x            0.05928    0.05851   1.013    0.327
NA 
NA ------------------------------------------------------------------
NA Sigma link function:  log
NA Sigma Coefficients:
NA             Estimate Std. Error t value Pr(&gt;|t|)
NA (Intercept)  -0.6147     1.8864  -0.326    0.749
NA 
NA ------------------------------------------------------------------
NA Nu link function:  logit 
NA Nu Coefficients:
NA             Estimate Std. Error t value Pr(&gt;|t|)
NA (Intercept)  -3.4494     2.7228  -1.267    0.225
NA x             0.2298     0.1700   1.352    0.196
NA 
NA ------------------------------------------------------------------
NA No. of observations in the fit:  20 
NA Degrees of Freedom for the fit:  5
NA       Residual Deg. of Freedom:  15 
NA                       at cycle:  10 
NA  
NA Global Deviance:     76.95789 
NA             AIC:     86.95789 
NA             SBC:     91.93655 
NA ******************************************************************</code></pre>
</div>
</div>
</section>
<section id="exploratory-data-analysis-2" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis-2">Exploratory data analysis</h2>
<p>Check the distribution of the <span class="math inline">\(y\)</span> abundances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dat.zinb<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(dat.zinb<span class="sc">$</span>y, <span class="at">horizontal=</span><span class="cn">TRUE</span>)</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(<span class="fu">jitter</span>(dat.zinb<span class="sc">$</span>y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-44-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is definitely signs of non-normality that would warrant Poisson or negative binomial models. Further to that, there appears to be a large number of zeros and a possible clumpiness that are likely to be the cause of overdispersion A zero-inflated negative binomial model is likely to be one of the most effective for modeling these data. Lets now explore linearity by creating a histogram of the predictor variable (<span class="math inline">\(x\)</span>). Note, it is difficult to directly assess issues of linearity. Indeed, a scatterplot with lowess smoother will be largely influenced by the presence of zeros. One possible way of doing so is to explore the trend in the non-zero data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dat.zinb<span class="sc">$</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co">#now for the scatterplot</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, dat.zinb, <span class="at">log=</span><span class="st">"y"</span>)</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(dat.zinb,y<span class="sc">&gt;</span><span class="dv">0</span>), <span class="fu">lines</span>(<span class="fu">lowess</span>(y<span class="sc">~</span>x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-45-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Conclusions</strong>: the predictor (<span class="math inline">\(x\)</span>) does not display any skewness or other issues that might lead to non-linearity. The lowess smoother on the non-zero data cloud does not display major deviations from a straight line and thus linearity is likely to be satisfied. Violations of linearity (whilst difficult to be certain about due to the unknown influence of the zeros) could be addressed by either:</p>
<ul>
<li><p>define a non-linear linear predictor (such as a polynomial, spline or other non-linear function).</p></li>
<li><p>transform the scale of the predictor variables.</p></li>
</ul>
<p>Although we have already established that there are few zeros in the data (and thus overdispersion is unlikely to be an issue), we can also explore this by comparing the number of zeros in the data to the number of zeros that would be expected from a Poisson distribution with a mean equal to the mean count of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co">#proportion of 0's in the data</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>dat.zinb.tab<span class="ot">&lt;-</span><span class="fu">table</span>(dat.zinb<span class="sc">$</span>y<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>dat.zinb.tab<span class="sc">/</span><span class="fu">sum</span>(dat.zinb.tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA FALSE  TRUE 
NA  0.55  0.45</code></pre>
</div>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">#proportion of 0's expected from a Poisson distribution</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat.zinb<span class="sc">$</span>y)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">var</span>(dat.zinb<span class="sc">$</span>y)</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> mu <span class="sc">+</span> (mu<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>v</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>cnts <span class="ot">&lt;-</span> <span class="fu">rnbinom</span>(<span class="dv">1000</span>, <span class="at">mu=</span>mu, <span class="at">size=</span>size)</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>dat.zinb.tabE <span class="ot">&lt;-</span> <span class="fu">table</span>(cnts <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>dat.zinb.tabE<span class="sc">/</span><span class="fu">sum</span>(dat.zinb.tabE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA FALSE  TRUE 
NA 0.861 0.139</code></pre>
</div>
</div>
<p>In the above, the value under <code>FALSE</code> is the proportion of non-zero values in the data and the value under TRUE is the proportion of zeros in the data. In this example, the proportion of zeros observed (<span class="math inline">\(45\)</span>%) far exceeds that that would have been expected (<span class="math inline">\(14\)</span>%). Hence it is highly likely that any models will be zero-inflated.</p>
</section>
<section id="model-fitting-3" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting-3">Model fitting</h2>
<p><span class="math display">\[
y_i \sim \text{ZINB}(\lambda_i, \theta),
\]</span></p>
<p>where <span class="math inline">\(\text{logit}(\theta) = \gamma_0\)</span>, <span class="math inline">\(\log(\lambda_i)=\eta_i\)</span>, with <span class="math inline">\(\eta_i=\beta_0+\beta_1x_{i}\)</span> and <span class="math inline">\(\beta_0,\beta_1,\gamma_0 \sim N(0, 10000)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>dat.zinb.list <span class="ot">&lt;-</span> <span class="fu">with</span>(dat.zinb,<span class="fu">list</span>(<span class="at">Y=</span>y, <span class="at">X=</span>x,<span class="at">N=</span><span class="fu">nrow</span>(dat.zinb),<span class="at">z=</span><span class="fu">ifelse</span>(y<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)))</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>modelString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N) {</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="st">     z[i] ~ dbern(psi.min)</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="st">     Y[i] ~ dnegbin(p[i],size)</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a><span class="st">     p[i] &lt;- size/(size+mu.eff[i])</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a><span class="st">     mu.eff[i] &lt;- z[i]*mu[i]</span></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a><span class="st">     eta[i] &lt;- beta0 + beta1*X[i]</span></span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a><span class="st">     log(mu[i]) &lt;- eta[i]</span></span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a><span class="st">  gamma ~ dnorm(0,0.001)</span></span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a><span class="st">  psi.min &lt;- min(0.9999, max(0.00001, (1-psi)))</span></span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a><span class="st">  logit(psi) &lt;- max(-20, min(20, gamma))</span></span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a><span class="st">  size ~ dunif(0.001, 5)</span></span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a><span class="st">  theta &lt;- pow(1/mean(p),2)</span></span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a><span class="st">  beta0 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a><span class="st">  beta1 ~ dnorm(0,1.0E-06)</span></span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelString, <span class="at">con=</span><span class="st">'modelzinb.txt'</span>)</span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>, <span class="st">'size'</span>, <span class="st">'theta'</span>)</span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">20000</span></span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb151-29"><a href="#cb151-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-30"><a href="#cb151-30" aria-hidden="true" tabindex="-1"></a>dat.zinb.jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data=</span>dat.zinb.list,<span class="at">model.file=</span><span class="st">'modelzinb.txt'</span>, <span class="at">param=</span>params,</span>
<span id="cb151-31"><a href="#cb151-31" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.chains=</span>nChains, <span class="at">n.iter=</span>nIter, <span class="at">n.burnin=</span>burnInSteps, <span class="at">n.thin=</span>thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 40
NA    Unobserved stochastic nodes: 4
NA    Total graph size: 205
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.zinb.jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelzinb.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA          mu.vect sd.vect   2.5%    25%    50%    75%  97.5%  Rhat n.eff
NA beta0      0.971   0.460  0.055  0.678  0.963  1.273  1.868 1.007   250
NA beta1      0.067   0.042 -0.016  0.039  0.066  0.094  0.151 1.008   200
NA size       3.501   1.015  1.389  2.763  3.644  4.351  4.935 1.001 10000
NA theta      2.200   0.367  1.721  1.937  2.115  2.371  3.145 1.001  3300
NA deviance  82.769   2.843 79.139 80.663 82.139 84.254 89.891 1.001 10000
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 4.0 and DIC = 86.8
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
</section>
<section id="model-evaluation-3" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation-3">Model evaluation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">denplot</span>(dat.zinb.jags, <span class="at">parms =</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>, <span class="st">'size'</span>, <span class="st">'theta'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traplot</span>(dat.zinb.jags, <span class="at">parms =</span> <span class="fu">c</span>(<span class="st">'beta0'</span>,<span class="st">'beta1'</span>, <span class="st">'size'</span>, <span class="st">'theta'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-48-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">raftery.diag</span>(<span class="fu">as.mcmc</span>(dat.zinb.jags))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [[1]]
NA 
NA Quantile (q) = 0.025
NA Accuracy (r) = +/- 0.005
NA Probability (s) = 0.95 
NA                                                 
NA           Burn-in  Total Lower bound  Dependence
NA           (M)      (N)   (Nmin)       factor (I)
NA  beta0    15       16236 3746         4.33      
NA  beta1    14       15725 3746         4.20      
NA  deviance 3        4484  3746         1.20      
NA  size     5        5771  3746         1.54      
NA  theta    3        4338  3746         1.16      
NA 
NA 
NA [[2]]
NA 
NA Quantile (q) = 0.025
NA Accuracy (r) = +/- 0.005
NA Probability (s) = 0.95 
NA                                                 
NA           Burn-in  Total Lower bound  Dependence
NA           (M)      (N)   (Nmin)       factor (I)
NA  beta0    27       27564 3746         7.36      
NA  beta1    18       21057 3746         5.62      
NA  deviance 3        4410  3746         1.18      
NA  size     5        5771  3746         1.54      
NA  theta    2        3995  3746         1.07</code></pre>
</div>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autocorr.diag</span>(<span class="fu">as.mcmc</span>(dat.zinb.jags))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA              beta0       beta1    deviance        size       theta
NA Lag 0   1.00000000  1.00000000  1.00000000 1.000000000 1.000000000
NA Lag 1   0.82187294  0.82300377  0.55172222 0.391115803 0.387289605
NA Lag 5   0.44679310  0.44494849  0.13559995 0.045297725 0.067379632
NA Lag 10  0.19928140  0.20123773  0.05371302 0.008341721 0.013304093
NA Lag 50 -0.04037202 -0.04473554 -0.02496182 0.011474420 0.007333003</code></pre>
</div>
</div>
</section>
<section id="goodness-of-fit-2" class="level2">
<h2 class="anchored" data-anchor-id="goodness-of-fit-2">Goodness of fit</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the samples for the two model parameters</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">&lt;-</span> dat.zinb.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> dat.zinb.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="st">'theta'</span>]</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>x, <span class="at">data=</span>dat.zinb)</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="co">#expected values on a log scale</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>lambda<span class="ot">&lt;-</span>coefs <span class="sc">%*%</span> <span class="fu">t</span>(Xmat)</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="co">#expected value on response scale</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>eta <span class="ot">&lt;-</span> <span class="fu">exp</span>(lambda)</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>expY <span class="ot">&lt;-</span> <span class="fu">sweep</span>(eta,<span class="dv">1</span>,(<span class="dv">1</span><span class="sc">-</span>theta),<span class="st">"*"</span>)</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>varY <span class="ot">&lt;-</span> eta<span class="sc">+</span><span class="fu">sweep</span>(eta<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,theta,<span class="st">"*"</span>)</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(varY)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA              1         2        3        4        5        6        7        8
NA [1,] 10.844323 13.189501 15.47499 15.73287 18.21519 26.87133 28.14742 29.27065
NA [2,] 71.832694 61.952112 54.97632 54.30484 48.72535 36.70113 35.49495 34.51074
NA [3,] 24.764991 24.273552 23.88302 23.84316 23.49392 22.60135 22.49799 22.41131
NA [4,]  6.397443  8.786249 11.40150 11.71375 14.89149 28.26188 30.51610 32.55772
NA [5,] 27.048585 28.561484 29.85015 29.98628 31.21706 34.70423 35.14294 35.51685
NA [6,] 32.911549 36.163316 39.03708 39.34619 42.18864 50.70280 51.82155 52.78337
NA             9       10       11       12        13        14        15
NA [1,] 32.48606 39.45733 45.43874 50.02645  59.31437  71.66019  73.00520
NA [2,] 32.02933 27.89750 25.25717 23.61192  20.97369  18.40930  18.17586
NA [3,] 22.18262 21.76433 21.46712 21.26761  20.92017  20.54281  20.50616
NA [4,] 38.69312 53.42044 67.53693 79.24793 105.19992 144.10581 148.63604
NA [5,] 36.53055 38.49254 39.97741 41.01961  42.92731  45.14296  45.36660
NA [6,] 55.42928 60.70818 64.84042 67.81058  73.39529  80.11924  80.81199
NA             16        17        18        19        20
NA [1,]  89.37583  90.29710  93.03697  99.45044 121.73297
NA [2,]  15.83105  15.72115  15.40547  14.72560  12.85289
NA [3,]  20.11263  20.09293  20.03565  19.90863  19.52937
NA [4,] 208.15726 211.74132 222.54395 248.66128 348.12988
NA [5,]  47.86864  47.99890  48.38049  49.24196  51.94528
NA [6,]  88.73695  89.15824  90.39740  93.22189 102.32692</code></pre>
</div>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co">#varY &lt;- sweep(varY,1,(1-theta),'*')</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="co">#sweep across rows and then divide by lambda</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>Resid <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">*</span><span class="fu">sweep</span>(expY,<span class="dv">2</span>,dat.zinb<span class="sc">$</span>y,<span class="st">'-'</span>)<span class="sc">/</span><span class="fu">sqrt</span>(varY)</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a><span class="co">#plot residuals vs expected values</span></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(Resid,<span class="dv">2</span>,mean)<span class="sc">~</span><span class="fu">apply</span>(eta,<span class="dv">2</span>,mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we will compare the sum of squared residuals to the sum of squares residuals that would be expected from a Poisson distribution matching that estimated by the model. Essentially this is estimating how well the Poisson distribution, the log-link function and the linear model approximates the observed data. When doing so, we need to consider the expected value and variance of the zero-inflated poisson.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>SSres<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum, <span class="at">na.rm=</span>T)</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="co">#generate a matrix of draws from a zero-inflated poisson (ZINB) distribution</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the matrix is the same dimensions as lambda</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gamlss.dist)</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="co">#YNew &lt;- matrix(rZINB(length(lambda),eta, theta),nrow=nrow(lambda))</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">sweep</span>(eta,<span class="dv">1</span>,<span class="fu">ifelse</span>(dat.zinb<span class="sc">$</span>y<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="st">'*'</span>)</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>YNew <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(<span class="fu">length</span>(lambda),lambda),<span class="at">nrow=</span><span class="fu">nrow</span>(lambda))</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>Resid1<span class="ot">&lt;-</span>(expY <span class="sc">-</span> YNew)<span class="sc">/</span><span class="fu">sqrt</span>(varY)</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>SSres.sim<span class="ot">&lt;-</span><span class="fu">apply</span>(Resid1<span class="sc">^</span><span class="dv">2</span>,<span class="dv">1</span>,sum)</span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(SSres.sim<span class="sc">&gt;</span>SSres, <span class="at">na.rm =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 0.5212</code></pre>
</div>
</div>
</section>
<section id="exploring-the-model-parameters-3" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-model-parameters-3">Exploring the model parameters</h2>
<p>If there was any evidence that the assumptions had been violated or the model was not an appropriate fit, then we would need to reconsider the model and start the process again. In this case, there is no evidence that the test will be unreliable so we can proceed to explore the test statistics. As with most Bayesian models, it is best to base conclusions on medians rather than means.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dat.zinb.jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "modelzinb.txt", fit using jags,
NA  2 chains, each with 10000 iterations (first 5000 discarded)
NA  n.sims = 10000 iterations saved
NA          mu.vect sd.vect   2.5%    25%    50%    75%  97.5%  Rhat n.eff
NA beta0      0.971   0.460  0.055  0.678  0.963  1.273  1.868 1.007   250
NA beta1      0.067   0.042 -0.016  0.039  0.066  0.094  0.151 1.008   200
NA size       3.501   1.015  1.389  2.763  3.644  4.351  4.935 1.001 10000
NA theta      2.200   0.367  1.721  1.937  2.115  2.371  3.145 1.001  3300
NA deviance  82.769   2.843 79.139 80.663 82.139 84.254 89.891 1.001 10000
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 4.0 and DIC = 86.8
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">adply</span>(dat.zinb.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x),<span class="at">p=</span><span class="fl">0.5</span>))</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA         X1      Median        Mean       lower      upper     lower.1
NA 1    beta0  0.96339931  0.97060322  0.05196655  1.8646388  0.68771701
NA 2    beta1  0.06565837  0.06658472 -0.01850221  0.1478933  0.03570031
NA 3 deviance 82.13938661 82.76912313 78.75619568 88.5891138 79.69050804
NA 4     size  3.64385931  3.50054311  1.63847682  4.9995959  3.62583688
NA 5    theta  2.11463918  2.19954948  1.65289052  2.9565781  1.83698278
NA       upper.1
NA 1  1.28169341
NA 2  0.09027889
NA 3 82.76458253
NA 4  4.98121591
NA 5  2.20696839</code></pre>
</div>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co">#on original scale</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="fu">adply</span>(<span class="fu">exp</span>(dat.zinb.jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x)), <span class="fu">HPDinterval</span>(<span class="fu">as.mcmc</span>(x),<span class="at">p=</span><span class="fl">0.5</span>))</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA      X1   Median     Mean     lower    upper  lower.1  upper.1
NA 1 beta0 2.620590 2.935935 0.7910564 5.701997 1.628127 3.096623
NA 2 beta1 1.067862 1.069796 0.9816679 1.159389 1.036345 1.094479</code></pre>
</div>
</div>
<p><strong>Conclusions</strong>: We would reject the null hypothesis of no effect of <span class="math inline">\(x\)</span> on <span class="math inline">\(y\)</span>. An increase in <span class="math inline">\(x\)</span> is associated with a significant linear increase (positive slope) in the abundance of <span class="math inline">\(y\)</span>. Every <span class="math inline">\(1\)</span> unit increase in <span class="math inline">\(x\)</span> results in a log <span class="math inline">\(0.06\)</span> unit increase in <span class="math inline">\(y\)</span>. We usually express this in terms of abundance rather than log abundance, so every <span class="math inline">\(1\)</span> unit increase in <span class="math inline">\(x\)</span> results in a (<span class="math inline">\(e^{0.06}=1.07\)</span>) <span class="math inline">\(1.07\)</span> unit increase in the abundance of <span class="math inline">\(y\)</span>.</p>
</section>
</section>
<section id="references" class="level1">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-plummer2004jags" class="csl-entry" role="listitem">
Plummer, Martyn. 2004. <span>“JAGS: Just Another Gibbs Sampler.”</span>
</div>
<div id="ref-su2015package" class="csl-entry" role="listitem">
Su, Yu-Sung, Masanao Yajima, Maintainer Yu-Sung Su, and JAGS SystemRequirements. 2015. <span>“Package <span>‘R2jags’</span>.”</span> <em>R Package Version 0.03-08, URL Http://CRAN. R-Project. Org/Package= R2jags</em>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Andrea Gabrio</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>