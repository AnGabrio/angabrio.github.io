<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrea Gabrio">
<meta name="dcterms.date" content="2020-02-15">
<meta name="keywords" content="Software, Statistics, Stan">

<title>angabrio.github.io - Generalised Linear Mixed Models (JAGS)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">angabrio.github.io</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../missing_data.html"> 
<span class="menu-text">Missing Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#hierarchical-poisson-regression" id="toc-hierarchical-poisson-regression" class="nav-link" data-scroll-target="#hierarchical-poisson-regression">Hierarchical Poisson regression</a></li>
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data">Loading the data</a></li>
  <li><a href="#modeling-match-results" id="toc-modeling-match-results" class="nav-link" data-scroll-target="#modeling-match-results">Modeling Match Results</a>
  <ul class="collapse">
  <li><a href="#data-check" id="toc-data-check" class="nav-link" data-scroll-target="#data-check">Data check</a></li>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model fitting</a></li>
  <li><a href="#mcmc-diagnostics" id="toc-mcmc-diagnostics" class="nav-link" data-scroll-target="#mcmc-diagnostics">MCMC diagnostics</a></li>
  <li><a href="#model-validation" id="toc-model-validation" class="nav-link" data-scroll-target="#model-validation">Model validation</a></li>
  </ul></li>
  <li><a href="#accounting-for-home-advantage" id="toc-accounting-for-home-advantage" class="nav-link" data-scroll-target="#accounting-for-home-advantage">Accounting for home advantage</a>
  <ul class="collapse">
  <li><a href="#model-fitting-1" id="toc-model-fitting-1" class="nav-link" data-scroll-target="#model-fitting-1">Model fitting</a></li>
  <li><a href="#mcmc-diagnostics-1" id="toc-mcmc-diagnostics-1" class="nav-link" data-scroll-target="#mcmc-diagnostics-1">MCMC diagnostics</a></li>
  <li><a href="#model-validation-1" id="toc-model-validation-1" class="nav-link" data-scroll-target="#model-validation-1">Model validation</a></li>
  </ul></li>
  <li><a href="#allowing-for-skill-variation-over-the-season" id="toc-allowing-for-skill-variation-over-the-season" class="nav-link" data-scroll-target="#allowing-for-skill-variation-over-the-season">Allowing for skill variation over the season</a>
  <ul class="collapse">
  <li><a href="#data-check-1" id="toc-data-check-1" class="nav-link" data-scroll-target="#data-check-1">Data check</a></li>
  <li><a href="#mcmc-diagnostics-2" id="toc-mcmc-diagnostics-2" class="nav-link" data-scroll-target="#mcmc-diagnostics-2">MCMC diagnostics</a></li>
  </ul></li>
  <li><a href="#ranking-the-teams-of-la-liga" id="toc-ranking-the-teams-of-la-liga" class="nav-link" data-scroll-target="#ranking-the-teams-of-la-liga">Ranking the teams of La Liga</a></li>
  <li><a href="#predicting-the-end-game-of-la-liga-20122013" id="toc-predicting-the-end-game-of-la-liga-20122013" class="nav-link" data-scroll-target="#predicting-the-end-game-of-la-liga-20122013">Predicting the End Game of La Liga 2012/2013</a></li>
  <li><a href="#calculating-the-predicted-payout-for-sevilla-vs-valencia-2013-06-01" id="toc-calculating-the-predicted-payout-for-sevilla-vs-valencia-2013-06-01" class="nav-link" data-scroll-target="#calculating-the-predicted-payout-for-sevilla-vs-valencia-2013-06-01">Calculating the Predicted Payout for Sevilla vs Valencia, 2013-06-01</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Generalised Linear Mixed Models (JAGS)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Quarto</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Academia</div>
    <div class="quarto-category">Software</div>
    <div class="quarto-category">Statistics</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://angabrio.github.io/agabriosite2/">Andrea Gabrio</a> <a href="mailto:a.gabrio@maastrichtuniversity.nl" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-7650-4534" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://www.maastrichtuniversity.nl/research/methodology-and-statistics">
            Maastricht University
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 15, 2020</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p><span style="font-size: 85%">This tutorial will focus on the use of Bayesian estimation to fit simple linear regression models …</span></p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Software, Statistics, Stan</p>
  </div>
</div>

</header>


<p>This tutorial will focus on the use of Bayesian estimation to fit simple linear regression models. <code>BUGS</code> (Bayesian inference Using <em>Gibbs Sampling</em>) is an algorithm and supporting language (resembling <code>R</code>) dedicated to performing the Gibbs sampling implementation of <em>Markov Chain Monte Carlo</em> (MCMC) method. Dialects of the <code>BUGS</code> language are implemented within three main projects:</p>
<ol type="1">
<li><p><strong>OpenBUGS</strong> - written in component pascal.</p></li>
<li><p><strong>JAGS</strong> - (Just Another Gibbs Sampler) - written in <code>C++</code>.</p></li>
<li><p><strong>STAN</strong> - a dedicated Bayesian modelling framework written in <code>C++</code> and implementing <em>Hamiltonian</em> MCMC samplers.</p></li>
</ol>
<p>Whilst the above programs can be used stand-alone, they do offer the rich data pre-processing and graphical capabilities of <code>R</code>, and thus, they are best accessed from within <code>R</code> itself. As such there are multiple packages devoted to interfacing with the various software implementations:</p>
<ul>
<li><p><em>R2OpenBUGS</em> - interfaces with <code>OpenBUGS</code></p></li>
<li><p><em>R2jags</em> - interfaces with <code>JAGS</code></p></li>
<li><p><em>rstan</em> - interfaces with <code>STAN</code></p></li>
</ul>
<p>This tutorial will demonstrate how to fit models in <code>JAGS</code> (<span class="citation" data-cites="plummer2004jags">Plummer (<a href="#ref-plummer2004jags" role="doc-biblioref">2004</a>)</span>) using the package <code>R2jags</code> (<span class="citation" data-cites="su2015package">Su et al. (<a href="#ref-su2015package" role="doc-biblioref">2015</a>)</span>) as interface, which also requires to load some other packages.</p>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>In some respects, <em>Generalized Linear Mixed effects Models</em> (GLMM) are a hierarchical extension of <em>Generalized linear models</em> (GLM) in a similar manner that Linear Mixed effects Models (LMM) are a hierarchical extension of Linear Models (LM). However, whilst the Gaussian (normal) distribution facilitates a relatively straight way of generating the marginal likelihood of the observed response by integrating likelihoods across all possible (and unobserved) levels of a random effect to yield parameter estimates, the same cannot be said for other distributions. Consequently various approximations have been developed to estimate the fixed and random parameters for GLMM’s:</p>
<ol type="1">
<li><p><strong>Penalized quasi-likelihood</strong> (PQL). This method approximates a quasi-likelihood by iterative fitting of (re)weighted linear mixed effects models based on the fit of GLM fit. Specifically, it estimates the fixed effects parameters by fitting a GLM that incorporates a correlation (variance-covariance) structure resulting from a LMM and then refits a LMM to re-estimate the variance-covariance structure by using the variance structure from the previous GLM. The cycle continues to iterate until either the fit improvement is below a threshold or a defined number of iterations has occurred. Whilst this is a relatively simple approach, that enables us to leverage methodologies for accommodating heterogeneity and spatial/temporal autocorrelation, it is known to perform poorly (estimates biased towards large variance) for Poisson distributions when the expected value is less than <span class="math inline">\(5\)</span> and for binary data when the expected number of successes or failures are less than <span class="math inline">\(5\)</span>. Moreover, as it approximates quasi-likelihood rather than likelihood, likelihood based inference and information criterion methods (such as likelihood ratio tests and AIC) are not appropriate with this approach. Instead, Wald tests are required for inference.</p></li>
<li><p><strong>Laplace approximation</strong>. This approach utilises a second-order Taylor series expansion to approximate (a mathematical technique for approximating the properties of a function around a point by taking multiple derivatives of the function and summing them together) the likelihood function. If we assume that the likelihood function is approximately normal and thus a quadratic function on a log scale, we can use second-order Taylor series expansion to approximate this likelihood. Whilst this approach is considered to be more accurate than PQL, it is considerably slower and unable to accommodate alternative variance and correlation structures.</p></li>
<li><p><strong>Gauss-Hermite quadrature</strong> (GHQ). This approach approximates the marginal likelihood by approximating the value of integrals at specific points (quadratures). This technique can be further adapted by allowing the number of quadratures and their weights to be optimized via a set of rules.</p></li>
<li><p><strong>Markov-chain Monte-Carlo</strong> (MCMC). This takes a bruit force approach by recreating the likelihood by traversing the likelihood function with sequential sampling proportional to the likelihood. Although this approach is very robust (when the posteriors have converged), they are computationally very intense. Interestingly, some (including Andrew Gelman) argue that PQL, Laplace and GHQ do not yield estimates. Rather they are only approximations of estimates. By contrast, as MCMC methods are able to integrate over all levels by bruit force, the resulting parameters are indeed true estimates.</p></li>
</ol>
<p>We will focus on the last approach which is the more general among the ones considered here and which is based on a Bayesian approach, which can be very flexible and accurate, yet very slow and complex.</p>
</section>
<section id="hierarchical-poisson-regression" class="level1">
<h1>Hierarchical Poisson regression</h1>
<p>The model I will be developing is a Bayesian hierarchical Poisson regression model which I borrow from a very interesting work about modelling match results in soccer, available both as a <a href="http://www.sumsar.net/papers/baath_2015_modeling_match_resluts_in_soccer.pdf">technical report</a> and as a series of <a href="http://www.sumsar.net/blog/2013/07/modeling-match-results-in-la-liga-part-one/">online posts</a>. The objective of the analysis was to model the match results from the last five seasons of <em>La Liga</em>, the premium Spanish football (soccer) league. In total there were <span class="math inline">\(1900\)</span> rows in the dataset each with information regarding which was the home and away team, what these teams scored and what season it was. The goal outcomes of the teams are assumed to be distributed according to a Poisson distribution, while also taking into account the dependence between the goals scored by the attacking and defensive teams in each match.</p>
</section>
<section id="loading-the-data" class="level1">
<h1>Loading the data</h1>
<p>I start by loading libraries, reading in the data and preprocessing it for <code>JAGS</code>. The last <span class="math inline">\(50\)</span> matches have unknown outcomes and I create a new data frame <code>d</code> holding only matches with known outcomes. I will come back to the unknown outcomes later when it is time to use the model for prediction. I also load a <code>R</code> function called <code>plotPost</code> which was previously coded in order to facilitate the plotting of the posterior results of the model. All information about the model structure, data and functions can be found on the webpage of the original post of the author or in his technical report (<span class="citation" data-cites="baaaath2015modeling">Bååth (<a href="#ref-baaaath2015modeling" role="doc-biblioref">2015</a>)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R2jags)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mcmcplots)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xtable)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"plotPost.R"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"laliga.RData"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># -1 = Away win, 0 = Draw, 1 = Home win</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>laliga<span class="sc">$</span>MatchResult <span class="ot">&lt;-</span> <span class="fu">sign</span>(laliga<span class="sc">$</span>HomeGoals <span class="sc">-</span> laliga<span class="sc">$</span>AwayGoals)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a data frame d with only the complete match results</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(laliga)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>teams <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(d<span class="sc">$</span>HomeTeam, d<span class="sc">$</span>AwayTeam))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>seasons <span class="ot">&lt;-</span> <span class="fu">unique</span>(d<span class="sc">$</span>Season)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># A list for JAGS with the data from d where the strings are coded as</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># integers</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">HomeGoals =</span> d<span class="sc">$</span>HomeGoals, <span class="at">AwayGoals =</span> d<span class="sc">$</span>AwayGoals, <span class="at">HomeTeam =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(d<span class="sc">$</span>HomeTeam,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">levels =</span> teams)), <span class="at">AwayTeam =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(d<span class="sc">$</span>AwayTeam, <span class="at">levels =</span> teams)),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">Season =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(d<span class="sc">$</span>Season, <span class="at">levels =</span> seasons)), <span class="at">n_teams =</span> <span class="fu">length</span>(teams),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_games =</span> <span class="fu">nrow</span>(d), <span class="at">n_seasons =</span> <span class="fu">length</span>(seasons))</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Convenience function to generate the type of column names Jags outputs.</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>col_name <span class="ot">&lt;-</span> <span class="cf">function</span>(name, ...) {</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(name, <span class="st">"["</span>, <span class="fu">paste</span>(..., <span class="at">sep =</span> <span class="st">","</span>), <span class="st">"]"</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>data_list<span class="sc">$</span>n_seasons<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>data_list<span class="sc">$</span>Season<span class="ot">&lt;-</span><span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="modeling-match-results" class="level1">
<h1>Modeling Match Results</h1>
<section id="data-check" class="level2">
<h2 class="anchored" data-anchor-id="data-check">Data check</h2>
<p>How are the number of goals for each team in a football match distributed? Well, let’s start by assuming that all football matches are roughly equally long, that both teams have many chances at making a goal and that each team have the same probability of making a goal each goal chance. Given these assumptions the distribution of the number of goals for each team should be well captured by a Poisson distribution. A quick and dirty comparison between the actual distribution of the number of scored goals and a Poisson distribution having the same mean number of scored goals support this notion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="fl">2.2</span>, <span class="dv">4</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">c</span>(d<span class="sc">$</span>AwayGoals, d<span class="sc">$</span>HomeGoals), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">8</span>), <span class="at">breaks =</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">:</span><span class="dv">9</span> <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">main =</span> <span class="st">"Distribution of the number of goals</span><span class="sc">\n</span><span class="st">scored by a team in a match."</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>mean_goals <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">c</span>(d<span class="sc">$</span>AwayGoals, d<span class="sc">$</span>HomeGoals))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">rpois</span>(<span class="dv">9999</span>, mean_goals), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">8</span>), <span class="at">breaks =</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">:</span><span class="dv">9</span> <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">main =</span> <span class="st">"Random draw from a Poisson distribution with</span><span class="sc">\n</span><span class="st">the same mean as the distribution above."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting">Model fitting</h2>
<p>All teams aren’t equally good and it will be assumed that all teams have a latent skill variable and the skill of a team minus the skill of the opposing team defines the predicted outcome of a game. As the number of goals are assumed to be Poisson distributed it is natural that the skills of the teams are on the log scale of the mean of the distribution. The distribution of the number of goals for team <span class="math inline">\(i\)</span> when facing team <span class="math inline">\(j\)</span> is then</p>
<p><span class="math display">\[
\text{Goals} \sim \text{Pois}(\lambda)
\]</span></p>
<p>where <span class="math inline">\(\log(\lambda)=\text{baseline} + \text{skill}_i - \text{skill}_j\)</span>. Baseline is the log average number of goals when both teams are equally good. The goal outcome of a match between home team <span class="math inline">\(i\)</span> and away team <span class="math inline">\(j\)</span> is modeled as:</p>
<p><span class="math display">\[
\text{HomeGoals}_{ij} \sim \text{Pois}(\lambda_{\text{home},ij}),
\]</span></p>
<p><span class="math display">\[
\text{AwayGoals}_{ij} \sim \text{Pois}(\lambda_{\text{away},ij}),
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\log(\lambda_{\text{home},ij}) = \text{baseline} + \text{skill}_i - \text{skill}_j,
\]</span></p>
<p><span class="math display">\[
\log(\lambda_{\text{away},ij}) = \text{baseline} + \text{skill}_j - \text{skill}_i.
\]</span></p>
<p>Add some priors to that and you’ve got a Bayesian model going! I set the prior distributions over the baseline to:</p>
<p><span class="math display">\[
\text{baseline} \sim N(0, 4^2),
\]</span></p>
<p>and the skill of all <span class="math inline">\(n\)</span> teams using a hierarchical approach to :</p>
<p><span class="math display">\[
\text{skill}_{1,\ldots,n} \sim N(\mu_{\text{teams}}, \sigma^2_{\text{teams}}),
\]</span></p>
<p>so that teams are assumed to have similar but not identical mean and variance parameters for thier skill parameters. These priors are made vague. For example, the prior on the baseline have a SD of <code>4</code> but since this is on the log scale of the mean number of goals it corresponds to one SD from the mean <code>0</code> covering the range of <code>[0.02,54.6]</code> goals. Turning this into a <code>JAGS</code> model requires some minor adjustments. The model have to loop over all the match results, which adds some for-loops. <code>JAGS</code> parameterises the normal distribution with precision (the reciprocal of the variance) instead of variance so the hyperpriors have to be converted. Finally I have to “anchor” the skill of one team to a constant otherwise the mean skill can drift away freely (<em>conrner constraint</em>) and the model cannot be identified. Doing these adjustments results in the following model description:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>m1_string <span class="ot">&lt;-</span> <span class="st">"model {</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">for(i in 1:n_games) {</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">  HomeGoals[i] ~ dpois(lambda_home[HomeTeam[i],AwayTeam[i]])</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">  AwayGoals[i] ~ dpois(lambda_away[HomeTeam[i],AwayTeam[i]])</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="st">for(home_i in 1:n_teams) {</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">  for(away_i in 1:n_teams) {</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">    lambda_home[home_i, away_i] &lt;- exp(baseline + skill[home_i] - skill[away_i])</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="st">    lambda_away[home_i, away_i] &lt;- exp(baseline + skill[away_i] - skill[home_i])</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="st">skill[1] &lt;- 0</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="st">for(j in 2:n_teams) {</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="st">  skill[j] ~ dnorm(group_skill, group_tau)</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="st">}  </span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="st">group_skill ~ dnorm(0, 0.0625)</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="st">group_tau &lt;- 1 / pow(group_sigma, 2)</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="st">group_sigma ~ dunif(0, 3)</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="st">baseline ~ dnorm(0, 0.0625)</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(m1_string, <span class="at">con =</span> <span class="st">"model1.txt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we define the nodes (parameters and derivatives) to monitor and the chain parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"baseline"</span>, <span class="st">"skill"</span>, <span class="st">"group_skill"</span>, <span class="st">"group_sigma"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">15000</span>  <span class="co">#across all chains</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>(burnInSteps <span class="sc">+</span> (numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>nIter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 10500</code></pre>
</div>
</div>
<p>Start the <code>JAGS</code> model (check the model, load data into the model, specify the number of chains and compile the model). Run the <code>JAGS</code> code via the <code>R2jags</code> interface and the <code>jags</code> function. Note that the first time jags is run after the <code>R2jags</code> package is loaded, it is often necessary to run any kind of randomisation function just to initiate the .Random.seed variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>m1.r2jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data =</span> data_list, <span class="at">inits =</span> <span class="cn">NULL</span>, <span class="at">parameters.to.save =</span> params,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">model.file =</span> <span class="st">"model1.txt"</span>, <span class="at">n.chains =</span> nChains, <span class="at">n.iter =</span> nIter,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.burnin =</span> burnInSteps, <span class="at">n.thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 3700
NA    Unobserved stochastic nodes: 31
NA    Total graph size: 9151
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m1.r2jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "model1.txt", fit using jags,
NA  2 chains, each with 10500 iterations (first 3000 discarded)
NA  n.sims = 15000 iterations saved
NA               mu.vect sd.vect      2.5%       25%       50%       75%     97.5%
NA baseline        0.281   0.014     0.253     0.271     0.281     0.291     0.309
NA group_sigma     0.225   0.034     0.169     0.201     0.222     0.246     0.302
NA group_skill     0.016   0.062    -0.104    -0.026     0.016     0.057     0.136
NA skill[1]        0.000   0.000     0.000     0.000     0.000     0.000     0.000
NA skill[2]        0.185   0.061     0.064     0.145     0.185     0.226     0.307
NA skill[3]        0.017   0.069    -0.117    -0.030     0.017     0.064     0.154
NA skill[4]       -0.013   0.061    -0.132    -0.054    -0.013     0.028     0.109
NA skill[5]       -0.180   0.098    -0.376    -0.247    -0.179    -0.113     0.008
NA skill[6]       -0.048   0.063    -0.170    -0.090    -0.049    -0.007     0.081
NA skill[7]       -0.013   0.058    -0.128    -0.051    -0.013     0.025     0.103
NA skill[8]        0.199   0.060     0.084     0.159     0.199     0.240     0.317
NA skill[9]       -0.077   0.063    -0.200    -0.119    -0.076    -0.034     0.046
NA skill[10]      -0.110   0.062    -0.230    -0.152    -0.110    -0.068     0.011
NA skill[11]       0.698   0.057     0.588     0.658     0.696     0.736     0.811
NA skill[12]       0.133   0.060     0.017     0.092     0.133     0.174     0.249
NA skill[13]       0.017   0.059    -0.096    -0.023     0.016     0.057     0.132
NA skill[14]       0.038   0.061    -0.078    -0.003     0.037     0.080     0.160
NA skill[15]      -0.008   0.060    -0.124    -0.048    -0.009     0.033     0.108
NA skill[16]      -0.117   0.099    -0.305    -0.186    -0.118    -0.051     0.080
NA skill[17]       0.606   0.058     0.495     0.566     0.606     0.646     0.720
NA skill[18]      -0.071   0.070    -0.205    -0.118    -0.072    -0.026     0.071
NA skill[19]      -0.115   0.069    -0.247    -0.162    -0.115    -0.068     0.022
NA skill[20]       0.075   0.064    -0.045     0.032     0.074     0.117     0.204
NA skill[21]      -0.104   0.065    -0.231    -0.148    -0.105    -0.060     0.027
NA skill[22]      -0.212   0.099    -0.403    -0.281    -0.213    -0.146    -0.017
NA skill[23]      -0.161   0.101    -0.360    -0.230    -0.159    -0.094     0.036
NA skill[24]      -0.118   0.101    -0.319    -0.186    -0.118    -0.050     0.085
NA skill[25]       0.009   0.071    -0.131    -0.037     0.010     0.057     0.147
NA skill[26]       0.058   0.069    -0.079     0.011     0.058     0.104     0.195
NA skill[27]      -0.061   0.080    -0.218    -0.115    -0.060    -0.005     0.088
NA skill[28]      -0.118   0.079    -0.272    -0.170    -0.119    -0.065     0.037
NA skill[29]      -0.059   0.105    -0.260    -0.130    -0.062     0.011     0.155
NA deviance    10912.856   7.406 10900.319 10907.610 10912.214 10917.514 10928.852
NA              Rhat n.eff
NA baseline    1.001 15000
NA group_sigma 1.002  1500
NA group_skill 1.002  1600
NA skill[1]    1.000     1
NA skill[2]    1.005   410
NA skill[3]    1.009   180
NA skill[4]    1.007   670
NA skill[5]    1.002  2400
NA skill[6]    1.001  4400
NA skill[7]    1.002  2400
NA skill[8]    1.001 11000
NA skill[9]    1.001 15000
NA skill[10]   1.009   190
NA skill[11]   1.001  4700
NA skill[12]   1.005   340
NA skill[13]   1.001 14000
NA skill[14]   1.006   310
NA skill[15]   1.002  2600
NA skill[16]   1.003 12000
NA skill[17]   1.001 15000
NA skill[18]   1.002  2700
NA skill[19]   1.003   880
NA skill[20]   1.002  1800
NA skill[21]   1.002  1000
NA skill[22]   1.001  2800
NA skill[23]   1.001 15000
NA skill[24]   1.005   380
NA skill[25]   1.001 15000
NA skill[26]   1.002  2300
NA skill[27]   1.001 15000
NA skill[28]   1.001 15000
NA skill[29]   1.001 13000
NA deviance    1.001  3900
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 27.4 and DIC = 10940.3
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
</section>
<section id="mcmc-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="mcmc-diagnostics">MCMC diagnostics</h2>
<p>Using the generated MCMC samples I can now look at the credible skill values of any team. Let’s look at the trace plot and the distribution of the skill parameters for FC Sevilla and FC Valencia.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>team_par<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">which</span>(teams <span class="sc">==</span> <span class="fu">c</span>(<span class="st">"FC Sevilla"</span>)), <span class="fu">which</span>(teams <span class="sc">==</span> <span class="st">"FC Valencia"</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">denplot</span>(m1.r2jags, <span class="at">parms =</span> team_par, <span class="at">style =</span> <span class="st">"plain"</span>, <span class="at">main =</span> <span class="fu">c</span>(<span class="st">"Sevilla"</span>,<span class="st">"Valenica"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traplot</span>(m1.r2jags, <span class="at">parms =</span> team_par, <span class="at">style =</span> <span class="st">"plain"</span>, <span class="at">main =</span> <span class="fu">c</span>(<span class="st">"Sevilla"</span>,<span class="st">"Valenica"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-validation" class="level2">
<h2 class="anchored" data-anchor-id="model-validation">Model validation</h2>
<p>Seems like Sevilla and Valencia have similar skill with Valencia being slightly better. Using the MCMC samples it is not only possible to look at the distribution of parameter values but it is also straight forward to simulate matches between teams and look at the credible distribution of number of goals scored and the probability of a win for the home team, a win for the away team or a draw. The following functions simulates matches with one team as home team and one team as away team and plots the predicted result together with the actual outcomes of any matches in the <code>laliga</code> data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plots histograms over home_goals, away_goals, the difference in goals</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and a barplot over match results.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>plot_goals <span class="ot">&lt;-</span> <span class="cf">function</span>(home_goals, away_goals) {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    n_matches <span class="ot">&lt;-</span> <span class="fu">length</span>(home_goals)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    goal_diff <span class="ot">&lt;-</span> home_goals <span class="sc">-</span> away_goals</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    match_result <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(goal_diff <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="st">"away_win"</span>, <span class="fu">ifelse</span>(goal_diff <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"home_win"</span>, <span class="st">"equal"</span>))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(home_goals, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">10</span>), <span class="at">breaks =</span> (<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>) <span class="sc">-</span> <span class="fl">0.5</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(away_goals, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">10</span>), <span class="at">breaks =</span> (<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>) <span class="sc">-</span> <span class="fl">0.5</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(goal_diff, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>), <span class="at">breaks =</span> (<span class="sc">-</span><span class="dv">100</span><span class="sc">:</span><span class="dv">100</span>) <span class="sc">-</span> <span class="fl">0.5</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">barplot</span>(<span class="fu">table</span>(match_result)<span class="sc">/</span>n_matches, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>plot_pred_comp1 <span class="ot">&lt;-</span> <span class="cf">function</span>(home_team, away_team, ms) {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulates and plots game goals scores using the MCMC samples from the m1</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model.</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    baseline <span class="ot">&lt;-</span> ms[, <span class="st">"baseline"</span>]</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    home_skill <span class="ot">&lt;-</span> ms[, <span class="fu">which</span>(teams <span class="sc">==</span> home_team)]</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    away_skill <span class="ot">&lt;-</span> ms[, <span class="fu">which</span>(teams <span class="sc">==</span> away_team)]</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    home_goals <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="fu">nrow</span>(ms), <span class="fu">exp</span>(baseline <span class="sc">+</span> home_skill <span class="sc">-</span> away_skill))</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    away_goals <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="fu">nrow</span>(ms), <span class="fu">exp</span>(baseline <span class="sc">+</span> away_skill <span class="sc">-</span> home_skill))</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_goals</span>(home_goals, away_goals)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plots the actual distribution of goals between the two teams</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    home_goals <span class="ot">&lt;-</span> d<span class="sc">$</span>HomeGoals[d<span class="sc">$</span>HomeTeam <span class="sc">==</span> home_team <span class="sc">&amp;</span> d<span class="sc">$</span>AwayTeam <span class="sc">==</span> away_team]</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    away_goals <span class="ot">&lt;-</span> d<span class="sc">$</span>AwayGoals[d<span class="sc">$</span>HomeTeam <span class="sc">==</span> home_team <span class="sc">&amp;</span> d<span class="sc">$</span>AwayTeam <span class="sc">==</span> away_team]</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_goals</span>(home_goals, away_goals)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s look at Valencia (home team) vs.&nbsp;Sevilla (away team). The graph below shows the simulation on the first row and the historical data on the second row.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ms1<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(m1.r2jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pred_comp1</span>(<span class="st">"FC Valencia"</span>, <span class="st">"FC Sevilla"</span>, ms1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here we discover a problem with the current model. While the simulated data looks the same, except that the home team and the away team swapped places, the historical data now shows that Sevilla often wins against Valencia when being the home team. Our model doesn’t predict this because it doesn’t considers the advantage of being the home team.</p>
</section>
</section>
<section id="accounting-for-home-advantage" class="level1">
<h1>Accounting for home advantage</h1>
<p>The only change to the model needed to account for the home advantage is to split the baseline into two components, a home baseline and an away baseline. The following <code>JAGS</code> model implements this change by splitting <code>baseline</code> into <code>home_baseline</code> and <code>away_baseline</code>.</p>
<section id="model-fitting-1" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting-1">Model fitting</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model 2</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>m2_string <span class="ot">&lt;-</span> <span class="st">"model {</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="st">for(i in 1:n_games) {</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="st">  HomeGoals[i] ~ dpois(lambda_home[HomeTeam[i],AwayTeam[i]])</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="st">  AwayGoals[i] ~ dpois(lambda_away[HomeTeam[i],AwayTeam[i]])</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="st">for(home_i in 1:n_teams) {</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="st">  for(away_i in 1:n_teams) {</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="st">    lambda_home[home_i, away_i] &lt;- exp( home_baseline + skill[home_i] - skill[away_i])</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="st">    lambda_away[home_i, away_i] &lt;- exp( away_baseline + skill[away_i] - skill[home_i])</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="st">skill[1] &lt;- 0 </span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="st">for(j in 2:n_teams) {</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="st">  skill[j] ~ dnorm(group_skill, group_tau)</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="st">group_skill ~ dnorm(0, 0.0625)</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="st">group_tau &lt;- 1/pow(group_sigma, 2)</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="st">group_sigma ~ dunif(0, 3)</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="st">home_baseline ~ dnorm(0, 0.0625)</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="st">away_baseline ~ dnorm(0, 0.0625)</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(m2_string, <span class="at">con =</span> <span class="st">"model2.txt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now re-fit the model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"home_baseline"</span>, <span class="st">"away_baseline"</span>, <span class="st">"skill"</span>, <span class="st">"group_sigma"</span>, <span class="st">"group_skill"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">15000</span>  <span class="co">#across all chains</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>(burnInSteps <span class="sc">+</span> (numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>m2.r2jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data =</span> data_list, <span class="at">inits =</span> <span class="cn">NULL</span>, <span class="at">parameters.to.save =</span> params,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">model.file =</span> <span class="st">"model2.txt"</span>, <span class="at">n.chains =</span> nChains, <span class="at">n.iter =</span> nIter,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.burnin =</span> burnInSteps, <span class="at">n.thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 3700
NA    Unobserved stochastic nodes: 32
NA    Total graph size: 10863
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m2.r2jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "model2.txt", fit using jags,
NA  2 chains, each with 10500 iterations (first 3000 discarded)
NA  n.sims = 15000 iterations saved
NA                 mu.vect sd.vect      2.5%       25%       50%       75%
NA away_baseline     0.081   0.022     0.038     0.067     0.082     0.096
NA group_sigma       0.226   0.035     0.169     0.201     0.221     0.246
NA group_skill       0.019   0.061    -0.102    -0.022     0.019     0.060
NA home_baseline     0.449   0.019     0.413     0.436     0.449     0.462
NA skill[1]          0.000   0.000     0.000     0.000     0.000     0.000
NA skill[2]          0.187   0.061     0.066     0.147     0.187     0.228
NA skill[3]          0.017   0.068    -0.120    -0.030     0.017     0.063
NA skill[4]         -0.011   0.058    -0.126    -0.050    -0.011     0.028
NA skill[5]         -0.179   0.100    -0.375    -0.246    -0.178    -0.111
NA skill[6]         -0.044   0.062    -0.167    -0.087    -0.045    -0.002
NA skill[7]         -0.009   0.061    -0.127    -0.050    -0.009     0.033
NA skill[8]          0.199   0.059     0.081     0.159     0.201     0.240
NA skill[9]         -0.078   0.063    -0.205    -0.121    -0.077    -0.035
NA skill[10]        -0.108   0.064    -0.234    -0.151    -0.108    -0.066
NA skill[11]         0.699   0.057     0.583     0.661     0.699     0.737
NA skill[12]         0.132   0.059     0.019     0.092     0.132     0.173
NA skill[13]         0.025   0.061    -0.097    -0.016     0.025     0.065
NA skill[14]         0.041   0.059    -0.074     0.000     0.041     0.081
NA skill[15]        -0.006   0.060    -0.125    -0.046    -0.005     0.035
NA skill[16]        -0.115   0.099    -0.311    -0.181    -0.116    -0.049
NA skill[17]         0.611   0.059     0.494     0.571     0.612     0.653
NA skill[18]        -0.068   0.070    -0.204    -0.115    -0.069    -0.020
NA skill[19]        -0.114   0.070    -0.252    -0.162    -0.113    -0.065
NA skill[20]         0.077   0.062    -0.047     0.035     0.077     0.118
NA skill[21]        -0.102   0.064    -0.228    -0.145    -0.101    -0.058
NA skill[22]        -0.202   0.098    -0.399    -0.266    -0.201    -0.138
NA skill[23]        -0.167   0.098    -0.361    -0.233    -0.167    -0.102
NA skill[24]        -0.115   0.099    -0.306    -0.183    -0.116    -0.049
NA skill[25]         0.010   0.071    -0.132    -0.035     0.010     0.057
NA skill[26]         0.061   0.069    -0.075     0.014     0.062     0.109
NA skill[27]        -0.059   0.078    -0.211    -0.112    -0.060    -0.007
NA skill[28]        -0.113   0.082    -0.274    -0.167    -0.113    -0.058
NA skill[29]        -0.051   0.105    -0.265    -0.121    -0.050     0.021
NA deviance      10742.730   7.596 10729.548 10737.288 10742.120 10747.534
NA                   97.5%  Rhat n.eff
NA away_baseline     0.126 1.002  1600
NA group_sigma       0.305 1.001 15000
NA group_skill       0.138 1.006   330
NA home_baseline     0.486 1.001 15000
NA skill[1]          0.000 1.000     1
NA skill[2]          0.306 1.005   380
NA skill[3]          0.149 1.006   310
NA skill[4]          0.102 1.002  1900
NA skill[5]          0.013 1.002  1100
NA skill[6]          0.076 1.005   400
NA skill[7]          0.110 1.004   440
NA skill[8]          0.312 1.008   240
NA skill[9]          0.045 1.003   620
NA skill[10]         0.014 1.005   330
NA skill[11]         0.811 1.004   580
NA skill[12]         0.245 1.008   200
NA skill[13]         0.144 1.003   840
NA skill[14]         0.154 1.003   700
NA skill[15]         0.111 1.008   210
NA skill[16]         0.078 1.006   300
NA skill[17]         0.722 1.005   420
NA skill[18]         0.070 1.005   360
NA skill[19]         0.019 1.007   290
NA skill[20]         0.200 1.006   310
NA skill[21]         0.025 1.010   170
NA skill[22]        -0.009 1.002  1600
NA skill[23]         0.028 1.003   900
NA skill[24]         0.078 1.006   330
NA skill[25]         0.151 1.007   240
NA skill[26]         0.196 1.003   770
NA skill[27]         0.097 1.001  3900
NA skill[28]         0.051 1.002  1800
NA skill[29]         0.153 1.003   620
NA deviance      10759.025 1.004   460
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 28.8 and DIC = 10771.5
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
</section>
<section id="mcmc-diagnostics-1" class="level2">
<h2 class="anchored" data-anchor-id="mcmc-diagnostics-1">MCMC diagnostics</h2>
<p>Looking at the trace plots and distributions of <code>home_baseline</code> and <code>away_baseline</code> shows that there is a considerable home advantage.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>team_par<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"home_baseline"</span>, <span class="st">"away_baseline"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">denplot</span>(m2.r2jags, <span class="at">parms =</span> team_par, <span class="at">style =</span> <span class="st">"plain"</span>, <span class="at">main =</span> <span class="fu">c</span>(<span class="st">"home_baseline"</span>,<span class="st">"away_baseline"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traplot</span>(m2.r2jags, <span class="at">parms =</span> team_par, <span class="at">style =</span> <span class="st">"plain"</span>, <span class="at">main =</span> <span class="fu">c</span>(<span class="st">"home_baseline"</span>,<span class="st">"away_baseline"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-validation-1" class="level2">
<h2 class="anchored" data-anchor-id="model-validation-1">Model validation</h2>
<p>Looking at the difference between <code>exp(home_baseline)</code> and <code>exp(away_baseline)</code> shows that the home advantage is realised as roughly <span class="math inline">\(0.5\)</span> more goals for the home team.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ms2<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(m2.r2jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotPost</span>(<span class="fu">exp</span>(ms2[, <span class="st">"home_baseline"</span>]) <span class="sc">-</span> <span class="fu">exp</span>(ms2[, <span class="st">"away_baseline"</span>]), <span class="at">compVal =</span> <span class="dv">0</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Home advantage in number of goals"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NA                                        mean    median      mode hdiMass
NA Home advantage in number of goals 0.4822046 0.4822645 0.4831489    0.95
NA                                      hdiLow   hdiHigh compVal pcGTcompVal
NA Home advantage in number of goals 0.4096975 0.5549439       0           1
NA                                   ROPElow ROPEhigh pcInROPE
NA Home advantage in number of goals      NA       NA       NA</code></pre>
</div>
</div>
<p>Comparing the DIC of the of the two models also indicates that the new model is better.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dic_m1<span class="ot">&lt;-</span>m1.r2jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>DIC</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dic_m2<span class="ot">&lt;-</span>m2.r2jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>DIC</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>diff_dic<span class="ot">&lt;-</span>dic_m1 <span class="sc">-</span> dic_m2</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>diff_dic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 168.7556</code></pre>
</div>
</div>
<p>Finally we’ll look at the simulated results for Valencia (home team) vs Sevilla (away team) using the estimates from the new model with the first row of the graph showing the predicted outcome and the second row showing the actual data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plot_pred_comp2 <span class="ot">&lt;-</span> <span class="cf">function</span>(home_team, away_team, ms) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    home_baseline <span class="ot">&lt;-</span> ms[, <span class="st">"home_baseline"</span>]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    away_baseline <span class="ot">&lt;-</span> ms[, <span class="st">"away_baseline"</span>]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    home_skill <span class="ot">&lt;-</span> ms[, <span class="fu">col_name</span>(<span class="st">"skill"</span>, <span class="fu">which</span>(teams <span class="sc">==</span> home_team))]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    away_skill <span class="ot">&lt;-</span> ms[, <span class="fu">col_name</span>(<span class="st">"skill"</span>, <span class="fu">which</span>(teams <span class="sc">==</span> away_team))]</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    home_goals <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="fu">nrow</span>(ms), <span class="fu">exp</span>(home_baseline <span class="sc">+</span> home_skill <span class="sc">-</span> away_skill))</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    away_goals <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="fu">nrow</span>(ms), <span class="fu">exp</span>(away_baseline <span class="sc">+</span> away_skill <span class="sc">-</span> home_skill))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_goals</span>(home_goals, away_goals)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    home_goals <span class="ot">&lt;-</span> d<span class="sc">$</span>HomeGoals[d<span class="sc">$</span>HomeTeam <span class="sc">==</span> home_team <span class="sc">&amp;</span> d<span class="sc">$</span>AwayTeam <span class="sc">==</span> away_team]</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    away_goals <span class="ot">&lt;-</span> d<span class="sc">$</span>AwayGoals[d<span class="sc">$</span>HomeTeam <span class="sc">==</span> home_team <span class="sc">&amp;</span> d<span class="sc">$</span>AwayTeam <span class="sc">==</span> away_team]</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_goals</span>(home_goals, away_goals)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pred_comp2</span>(<span class="st">"FC Valencia"</span>, <span class="st">"FC Sevilla"</span>, ms2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And similarly Sevilla (home team) vs Valencia (away team).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pred_comp2</span>(<span class="st">"FC Sevilla"</span>, <span class="st">"FC Valencia"</span>, ms2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now the results are closer to the historical data as both Sevilla and Valencia are more likely to win when playing as the home team. At this point in the modeling process I decided to try to split the skill parameter into two components, offence skill and defense skill, thinking that some teams might be good at scoring goals but at the same time be bad at keeping the opponent from scoring. This didn’t seem to result in any better fit however, perhaps because the offensive and defensive skill of a team tend to be highly related. There is however one more thing I would like to change with the model.</p>
</section>
</section>
<section id="allowing-for-skill-variation-over-the-season" class="level1">
<h1>Allowing for skill variation over the season</h1>
<p>The data set <code>laliga</code> contains data from five different seasons and an assumption of the current model is that a team has the same skill during all seasons. This is probably not a realistic assumption, teams probably differ in their year-to-year performance. And what more, some teams do not even participate in all seasons in the <code>laliga</code> data set, as a result of dropping out of the first division, as the following diagram shows:</p>
<section id="data-check-1" class="level2">
<h2 class="anchored" data-anchor-id="data-check-1">Data check</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qplot</span>(Season, HomeTeam, <span class="at">data =</span> d, <span class="at">ylab =</span> <span class="st">"Team"</span>, <span class="at">xlab =</span> <span class="st">"Particicipation by Season"</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The second iteration of the model was therefore modified to include the year-to-year variability in team skill. This was done by allowing each team to have one skill parameter per season but to connect the skill parameters by using a team’s skill parameter for season <span class="math inline">\(t\)</span> in the prior distribution for that team’s skill parameter for season <span class="math inline">\(t+1\)</span> so that</p>
<p><span class="math display">\[
\text{skill}_{t+1} \sim N(\text{skill}_t,\sigma^2_{\text{season}})
\]</span></p>
<p>for all different <span class="math inline">\(t\)</span>, except the first season which is given a vague prior. Here <span class="math inline">\(\sigma^2_{\text{season}}\)</span> is a parameter estimated using the whole data set. The home and away baselines are given the same kind of priors and below is the resulting <code>JAGS</code> model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model 3</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>m3_string <span class="ot">&lt;-</span> <span class="st">"model {</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="st">for(i in 1:n_games) {</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="st">  HomeGoals[i] ~ dpois(lambda_home[Season[i], HomeTeam[i],AwayTeam[i]])</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="st">  AwayGoals[i] ~ dpois(lambda_away[Season[i], HomeTeam[i],AwayTeam[i]])</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="st">for(season_i in 1:n_seasons) {</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="st">  for(home_i in 1:n_teams) {</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="st">    for(away_i in 1:n_teams) {</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="st">      lambda_home[season_i, home_i, away_i] &lt;- exp( home_baseline[season_i] + skill[season_i, home_i] - skill[season_i, away_i])</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="st">      lambda_away[season_i, home_i, away_i] &lt;- exp( away_baseline[season_i] + skill[season_i, away_i] - skill[season_i, home_i])</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="st">skill[1, 1] &lt;- 0 </span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="st">for(j in 2:n_teams) {</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="st">  skill[1, j] ~ dnorm(group_skill, group_tau)</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="st">group_skill ~ dnorm(0, 0.0625)</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="st">group_tau &lt;- 1/pow(group_sigma, 2)</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="st">group_sigma ~ dunif(0, 3)</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="st">home_baseline[1] ~ dnorm(0, 0.0625)</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="st">away_baseline[1] ~ dnorm(0, 0.0625)</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="st">for(season_i in 2:n_seasons) {</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="st">  skill[season_i, 1] &lt;- 0 </span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="st">  for(j in 2:n_teams) {</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="st">    skill[season_i, j] ~ dnorm(skill[season_i - 1, j], season_tau)</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="st">  home_baseline[season_i] ~ dnorm(home_baseline[season_i - 1], season_tau)</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="st">  away_baseline[season_i] ~ dnorm(away_baseline[season_i - 1], season_tau)</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="st">season_tau &lt;- 1/pow(season_sigma, 2) </span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="st">season_sigma ~ dunif(0, 3) </span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(m3_string, <span class="at">con =</span> <span class="st">"model3.txt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now re-fit the model. These changes to the model unfortunately introduce quite a lot of autocorrelation when running the MCMC sampler. Also, I re-define the data list to include information for the season parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>data_list_m3 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">HomeGoals =</span> d<span class="sc">$</span>HomeGoals, <span class="at">AwayGoals =</span> d<span class="sc">$</span>AwayGoals, <span class="at">HomeTeam =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(d<span class="sc">$</span>HomeTeam,</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">levels =</span> teams)), <span class="at">AwayTeam =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(d<span class="sc">$</span>AwayTeam, <span class="at">levels =</span> teams)),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Season =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(d<span class="sc">$</span>Season, <span class="at">levels =</span> seasons)), <span class="at">n_teams =</span> <span class="fu">length</span>(teams),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_games =</span> <span class="fu">nrow</span>(d), <span class="at">n_seasons =</span> <span class="fu">length</span>(seasons))</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"home_baseline"</span>, <span class="st">"away_baseline"</span>, <span class="st">"skill"</span>, <span class="st">"season_sigma"</span>, <span class="st">"group_sigma"</span>, <span class="st">"group_skill"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">15000</span>  <span class="co">#across all chains</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> <span class="fu">ceiling</span>(burnInSteps <span class="sc">+</span> (numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>m3.r2jags <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data =</span> data_list_m3, <span class="at">inits =</span> <span class="cn">NULL</span>, <span class="at">parameters.to.save =</span> params,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">model.file =</span> <span class="st">"model3.txt"</span>, <span class="at">n.chains =</span> nChains, <span class="at">n.iter =</span> nIter,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.burnin =</span> burnInSteps, <span class="at">n.thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Compiling model graph
NA    Resolving undeclared variables
NA    Allocating nodes
NA Graph information:
NA    Observed stochastic nodes: 3700
NA    Unobserved stochastic nodes: 153
NA    Total graph size: 26525
NA 
NA Initializing model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m3.r2jags)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Bugs model at "model3.txt", fit using jags,
NA  2 chains, each with 10500 iterations (first 3000 discarded)
NA  n.sims = 15000 iterations saved
NA                    mu.vect sd.vect      2.5%       25%       50%       75%
NA away_baseline[1]     0.105   0.038     0.030     0.079     0.103     0.130
NA away_baseline[2]     0.078   0.030     0.018     0.059     0.079     0.099
NA away_baseline[3]     0.067   0.031     0.005     0.047     0.069     0.089
NA away_baseline[4]     0.064   0.032    -0.001     0.043     0.065     0.087
NA away_baseline[5]     0.079   0.035     0.011     0.056     0.080     0.101
NA group_sigma          0.217   0.035     0.158     0.193     0.214     0.238
NA group_skill          0.018   0.060    -0.090    -0.023     0.015     0.057
NA home_baseline[1]     0.447   0.029     0.392     0.428     0.446     0.466
NA home_baseline[2]     0.437   0.026     0.383     0.421     0.438     0.454
NA home_baseline[3]     0.443   0.026     0.389     0.427     0.443     0.459
NA home_baseline[4]     0.452   0.027     0.400     0.434     0.451     0.469
NA home_baseline[5]     0.454   0.031     0.394     0.434     0.452     0.474
NA season_sigma         0.033   0.019     0.001     0.016     0.032     0.048
NA skill[1,1]           0.000   0.000     0.000     0.000     0.000     0.000
NA skill[2,1]           0.000   0.000     0.000     0.000     0.000     0.000
NA skill[3,1]           0.000   0.000     0.000     0.000     0.000     0.000
NA skill[4,1]           0.000   0.000     0.000     0.000     0.000     0.000
NA skill[5,1]           0.000   0.000     0.000     0.000     0.000     0.000
NA skill[1,2]           0.178   0.067     0.047     0.136     0.175     0.218
NA skill[2,2]           0.169   0.065     0.039     0.129     0.167     0.207
NA skill[3,2]           0.181   0.064     0.061     0.139     0.177     0.219
NA skill[4,2]           0.195   0.065     0.076     0.148     0.189     0.235
NA skill[5,2]           0.216   0.075     0.090     0.161     0.209     0.265
NA skill[1,3]           0.015   0.074    -0.126    -0.033     0.013     0.060
NA skill[2,3]           0.017   0.075    -0.127    -0.030     0.014     0.063
NA skill[3,3]           0.020   0.074    -0.121    -0.027     0.017     0.066
NA skill[4,3]           0.022   0.071    -0.111    -0.024     0.018     0.066
NA skill[5,3]           0.027   0.075    -0.111    -0.021     0.023     0.074
NA skill[1,4]          -0.008   0.066    -0.122    -0.053    -0.012     0.035
NA skill[2,4]          -0.011   0.063    -0.118    -0.053    -0.015     0.031
NA skill[3,4]          -0.010   0.063    -0.120    -0.052    -0.015     0.031
NA skill[4,4]          -0.020   0.065    -0.136    -0.064    -0.024     0.022
NA skill[5,4]          -0.022   0.069    -0.151    -0.069    -0.025     0.023
NA skill[1,5]          -0.174   0.098    -0.370    -0.238    -0.173    -0.107
NA skill[2,5]          -0.174   0.104    -0.384    -0.242    -0.174    -0.104
NA skill[3,5]          -0.174   0.111    -0.394    -0.247    -0.174    -0.102
NA skill[4,5]          -0.174   0.117    -0.408    -0.251    -0.174    -0.098
NA skill[5,5]          -0.174   0.123    -0.420    -0.254    -0.175    -0.095
NA skill[1,6]          -0.034   0.074    -0.161    -0.085    -0.039     0.017
NA skill[2,6]          -0.048   0.068    -0.167    -0.096    -0.052    -0.004
NA skill[3,6]          -0.058   0.067    -0.176    -0.106    -0.060    -0.015
NA skill[4,6]          -0.065   0.072    -0.193    -0.117    -0.067    -0.019
NA skill[5,6]          -0.071   0.075    -0.207    -0.125    -0.072    -0.025
NA skill[1,7]          -0.006   0.069    -0.124    -0.054    -0.013     0.038
NA skill[2,7]          -0.014   0.065    -0.129    -0.058    -0.021     0.027
NA skill[3,7]          -0.009   0.064    -0.120    -0.054    -0.016     0.031
NA skill[4,7]          -0.006   0.066    -0.117    -0.052    -0.013     0.035
NA skill[5,7]          -0.001   0.071    -0.122    -0.051    -0.009     0.044
NA skill[1,8]           0.200   0.067     0.069     0.155     0.198     0.242
NA skill[2,8]           0.206   0.063     0.086     0.162     0.203     0.246
NA skill[3,8]           0.209   0.063     0.090     0.164     0.206     0.250
NA skill[4,8]           0.204   0.064     0.082     0.158     0.202     0.244
NA skill[5,8]           0.195   0.069     0.059     0.151     0.194     0.239
NA skill[1,9]          -0.055   0.073    -0.193    -0.102    -0.057    -0.005
NA skill[2,9]          -0.074   0.068    -0.203    -0.119    -0.077    -0.026
NA skill[3,9]          -0.087   0.068    -0.219    -0.133    -0.088    -0.040
NA skill[4,9]          -0.105   0.074    -0.254    -0.155    -0.101    -0.057
NA skill[5,9]          -0.105   0.083    -0.279    -0.159    -0.100    -0.049
NA skill[1,10]         -0.121   0.072    -0.246    -0.175    -0.125    -0.072
NA skill[2,10]         -0.109   0.070    -0.224    -0.163    -0.113    -0.061
NA skill[3,10]         -0.102   0.071    -0.219    -0.156    -0.106    -0.051
NA skill[4,10]         -0.111   0.073    -0.234    -0.168    -0.116    -0.060
NA skill[5,10]         -0.111   0.083    -0.259    -0.173    -0.116    -0.055
NA skill[1,11]          0.676   0.072     0.526     0.629     0.680     0.726
NA skill[2,11]          0.696   0.063     0.571     0.654     0.699     0.738
NA skill[3,11]          0.712   0.060     0.600     0.672     0.712     0.750
NA skill[4,11]          0.728   0.061     0.617     0.688     0.725     0.761
NA skill[5,11]          0.727   0.064     0.606     0.686     0.725     0.763
NA skill[1,12]          0.146   0.064     0.025     0.106     0.144     0.186
NA skill[2,12]          0.143   0.060     0.028     0.105     0.141     0.180
NA skill[3,12]          0.131   0.058     0.019     0.094     0.130     0.168
NA skill[4,12]          0.127   0.059     0.010     0.089     0.126     0.164
NA skill[5,12]          0.127   0.064     0.002     0.086     0.126     0.166
NA skill[1,13]          0.031   0.065    -0.087    -0.014     0.028     0.071
NA skill[2,13]          0.035   0.062    -0.077    -0.008     0.032     0.073
NA skill[3,13]          0.023   0.061    -0.091    -0.019     0.020     0.062
NA skill[4,13]          0.017   0.062    -0.101    -0.026     0.015     0.057
NA skill[5,13]          0.015   0.067    -0.117    -0.030     0.014     0.057
NA skill[1,14]          0.028   0.064    -0.095    -0.015     0.025     0.069
NA skill[2,14]          0.027   0.061    -0.091    -0.014     0.024     0.065
NA skill[3,14]          0.030   0.059    -0.085    -0.010     0.027     0.067
NA skill[4,14]          0.046   0.062    -0.067     0.004     0.040     0.085
NA skill[5,14]          0.055   0.068    -0.064     0.008     0.049     0.099
NA skill[1,15]          0.015   0.065    -0.106    -0.029     0.009     0.055
NA skill[2,15]          0.019   0.063    -0.095    -0.024     0.012     0.058
NA skill[3,15]         -0.003   0.061    -0.115    -0.043    -0.005     0.034
NA skill[4,15]         -0.014   0.062    -0.132    -0.055    -0.015     0.024
NA skill[5,15]         -0.037   0.071    -0.182    -0.082    -0.034     0.009
NA skill[1,16]         -0.120   0.096    -0.304    -0.187    -0.122    -0.055
NA skill[2,16]         -0.121   0.103    -0.319    -0.192    -0.122    -0.051
NA skill[3,16]         -0.121   0.109    -0.329    -0.195    -0.121    -0.047
NA skill[4,16]         -0.121   0.116    -0.342    -0.197    -0.122    -0.044
NA skill[5,16]         -0.120   0.121    -0.357    -0.201    -0.121    -0.041
NA skill[1,17]          0.543   0.083     0.372     0.491     0.544     0.600
NA skill[2,17]          0.588   0.067     0.470     0.541     0.586     0.631
NA skill[3,17]          0.621   0.068     0.495     0.575     0.617     0.666
NA skill[4,17]          0.646   0.075     0.501     0.593     0.644     0.697
NA skill[5,17]          0.640   0.077     0.497     0.586     0.637     0.694
NA skill[1,18]         -0.068   0.075    -0.209    -0.122    -0.069    -0.021
NA skill[2,18]         -0.075   0.074    -0.219    -0.126    -0.075    -0.029
NA skill[3,18]         -0.068   0.078    -0.218    -0.122    -0.067    -0.019
NA skill[4,18]         -0.061   0.081    -0.217    -0.117    -0.060    -0.011
NA skill[5,18]         -0.054   0.081    -0.208    -0.110    -0.054    -0.002
NA skill[1,19]         -0.099   0.066    -0.220    -0.144    -0.101    -0.057
NA skill[2,19]         -0.106   0.065    -0.227    -0.151    -0.108    -0.064
NA skill[3,19]         -0.122   0.070    -0.260    -0.170    -0.121    -0.074
NA skill[4,19]         -0.122   0.080    -0.290    -0.174    -0.119    -0.069
NA skill[5,19]         -0.122   0.089    -0.312    -0.176    -0.118    -0.065
NA skill[1,20]          0.086   0.068    -0.034     0.038     0.083     0.130
NA skill[2,20]          0.083   0.065    -0.031     0.036     0.079     0.126
NA skill[3,20]          0.082   0.065    -0.033     0.034     0.078     0.125
NA skill[4,20]          0.065   0.070    -0.068     0.017     0.063     0.110
NA skill[5,20]          0.065   0.079    -0.094     0.014     0.064     0.115
NA skill[1,21]         -0.097   0.081    -0.245    -0.154    -0.103    -0.042
NA skill[2,21]         -0.101   0.073    -0.234    -0.152    -0.104    -0.048
NA skill[3,21]         -0.100   0.071    -0.230    -0.149    -0.103    -0.050
NA skill[4,21]         -0.107   0.070    -0.237    -0.155    -0.110    -0.059
NA skill[5,21]         -0.108   0.074    -0.245    -0.158    -0.114    -0.058
NA skill[1,22]         -0.197   0.106    -0.391    -0.269    -0.198    -0.126
NA skill[2,22]         -0.204   0.100    -0.389    -0.272    -0.205    -0.138
NA skill[3,22]         -0.204   0.107    -0.401    -0.278    -0.204    -0.134
NA skill[4,22]         -0.205   0.114    -0.418    -0.282    -0.205    -0.131
NA skill[5,22]         -0.205   0.120    -0.432    -0.287    -0.206    -0.127
NA skill[1,23]         -0.158   0.099    -0.343    -0.228    -0.160    -0.092
NA skill[2,23]         -0.164   0.094    -0.340    -0.232    -0.165    -0.102
NA skill[3,23]         -0.163   0.102    -0.357    -0.235    -0.165    -0.097
NA skill[4,23]         -0.164   0.108    -0.373    -0.239    -0.165    -0.094
NA skill[5,23]         -0.164   0.114    -0.386    -0.241    -0.165    -0.092
NA skill[1,24]         -0.102   0.105    -0.310    -0.171    -0.105    -0.033
NA skill[2,24]         -0.107   0.102    -0.306    -0.174    -0.108    -0.041
NA skill[3,24]         -0.112   0.097    -0.301    -0.177    -0.112    -0.049
NA skill[4,24]         -0.112   0.104    -0.317    -0.181    -0.113    -0.044
NA skill[5,24]         -0.112   0.111    -0.329    -0.185    -0.112    -0.041
NA skill[1,25]          0.009   0.086    -0.149    -0.046     0.007     0.066
NA skill[2,25]          0.009   0.081    -0.145    -0.044     0.006     0.061
NA skill[3,25]          0.008   0.074    -0.140    -0.042     0.006     0.055
NA skill[4,25]          0.013   0.074    -0.139    -0.038     0.011     0.060
NA skill[5,25]          0.003   0.077    -0.143    -0.047     0.001     0.053
NA skill[1,26]          0.048   0.088    -0.117    -0.019     0.046     0.108
NA skill[2,26]          0.049   0.083    -0.104    -0.013     0.047     0.104
NA skill[3,26]          0.049   0.076    -0.083    -0.009     0.047     0.099
NA skill[4,26]          0.068   0.075    -0.063     0.014     0.066     0.118
NA skill[5,26]          0.091   0.082    -0.057     0.034     0.091     0.145
NA skill[1,27]         -0.051   0.093    -0.236    -0.108    -0.049     0.000
NA skill[2,27]         -0.054   0.088    -0.231    -0.108    -0.050    -0.003
NA skill[3,27]         -0.055   0.084    -0.224    -0.108    -0.052    -0.006
NA skill[4,27]         -0.057   0.077    -0.213    -0.107    -0.054    -0.012
NA skill[5,27]         -0.053   0.079    -0.211    -0.104    -0.051    -0.007
NA skill[1,28]         -0.110   0.099    -0.292    -0.188    -0.112    -0.039
NA skill[2,28]         -0.113   0.094    -0.288    -0.188    -0.115    -0.046
NA skill[3,28]         -0.117   0.088    -0.282    -0.186    -0.120    -0.052
NA skill[4,28]         -0.121   0.081    -0.274    -0.186    -0.123    -0.063
NA skill[5,28]         -0.124   0.082    -0.278    -0.188    -0.127    -0.066
NA skill[1,29]         -0.057   0.129    -0.272    -0.154    -0.066     0.028
NA skill[2,29]         -0.059   0.127    -0.270    -0.155    -0.067     0.022
NA skill[3,29]         -0.061   0.124    -0.268    -0.154    -0.068     0.019
NA skill[4,29]         -0.062   0.121    -0.268    -0.152    -0.069     0.014
NA skill[5,29]         -0.063   0.117    -0.267    -0.149    -0.068     0.010
NA deviance         10731.636  11.981 10708.084 10723.239 10732.002 10740.556
NA                      97.5%  Rhat n.eff
NA away_baseline[1]     0.185 1.056    34
NA away_baseline[2]     0.135 1.004   500
NA away_baseline[3]     0.123 1.001  7800
NA away_baseline[4]     0.121 1.001  3300
NA away_baseline[5]     0.148 1.006   280
NA group_sigma          0.297 1.008   210
NA group_skill          0.146 1.015  5000
NA home_baseline[1]     0.508 1.018   260
NA home_baseline[2]     0.487 1.005 15000
NA home_baseline[3]     0.493 1.004 15000
NA home_baseline[4]     0.506 1.007   390
NA home_baseline[5]     0.516 1.011   260
NA season_sigma         0.069 1.323    11
NA skill[1,1]           0.000 1.000     1
NA skill[2,1]           0.000 1.000     1
NA skill[3,1]           0.000 1.000     1
NA skill[4,1]           0.000 1.000     1
NA skill[5,1]           0.000 1.000     1
NA skill[1,2]           0.323 1.003  5900
NA skill[2,2]           0.315 1.003 15000
NA skill[3,2]           0.323 1.008   880
NA skill[4,2]           0.338 1.012   290
NA skill[5,2]           0.377 1.016   130
NA skill[1,3]           0.170 1.017   110
NA skill[2,3]           0.174 1.014   150
NA skill[3,3]           0.175 1.013   180
NA skill[4,3]           0.173 1.011   250
NA skill[5,3]           0.185 1.004   470
NA skill[1,4]           0.130 1.005   510
NA skill[2,4]           0.121 1.004   680
NA skill[3,4]           0.123 1.006   380
NA skill[4,4]           0.117 1.003   820
NA skill[5,4]           0.121 1.002  1200
NA skill[1,5]           0.015 1.002  1400
NA skill[2,5]           0.033 1.002  1500
NA skill[3,5]           0.046 1.002  1800
NA skill[4,5]           0.060 1.002  2000
NA skill[5,5]           0.074 1.002  1900
NA skill[1,6]           0.116 1.008   620
NA skill[2,6]           0.092 1.010 15000
NA skill[3,6]           0.084 1.012  3500
NA skill[4,6]           0.085 1.011  1200
NA skill[5,6]           0.086 1.012   710
NA skill[1,7]           0.145 1.005 11000
NA skill[2,7]           0.133 1.011 15000
NA skill[3,7]           0.134 1.015 15000
NA skill[4,7]           0.142 1.012 15000
NA skill[5,7]           0.154 1.007 15000
NA skill[1,8]           0.337 1.001 15000
NA skill[2,8]           0.339 1.003 15000
NA skill[3,8]           0.341 1.001  6700
NA skill[4,8]           0.340 1.003 15000
NA skill[5,8]           0.338 1.003  1400
NA skill[1,9]           0.090 1.019   140
NA skill[2,9]           0.059 1.010   520
NA skill[3,9]           0.046 1.007 13000
NA skill[4,9]           0.035 1.004   790
NA skill[5,9]           0.047 1.003   790
NA skill[1,10]          0.027 1.011   150
NA skill[2,10]          0.032 1.016   110
NA skill[3,10]          0.040 1.021    98
NA skill[4,10]          0.037 1.011   170
NA skill[5,10]          0.057 1.008   200
NA skill[1,11]          0.815 1.035    59
NA skill[2,11]          0.825 1.019   110
NA skill[3,11]          0.839 1.006   320
NA skill[4,11]          0.860 1.002  1100
NA skill[5,11]          0.866 1.002  1000
NA skill[1,12]          0.279 1.002  1900
NA skill[2,12]          0.267 1.002  1300
NA skill[3,12]          0.247 1.009   300
NA skill[4,12]          0.244 1.012   190
NA skill[5,12]          0.255 1.006   280
NA skill[1,13]          0.168 1.002  4300
NA skill[2,13]          0.167 1.004 15000
NA skill[3,13]          0.153 1.009   350
NA skill[4,13]          0.148 1.014   170
NA skill[5,13]          0.152 1.012   210
NA skill[1,14]          0.159 1.007   240
NA skill[2,14]          0.153 1.007   240
NA skill[3,14]          0.156 1.006   410
NA skill[4,14]          0.176 1.001 15000
NA skill[5,14]          0.202 1.002  1400
NA skill[1,15]          0.155 1.001  4000
NA skill[2,15]          0.154 1.001  4000
NA skill[3,15]          0.122 1.008   210
NA skill[4,15]          0.113 1.013   130
NA skill[5,15]          0.100 1.030    58
NA skill[1,16]          0.071 1.004   970
NA skill[2,16]          0.084 1.002  1200
NA skill[3,16]          0.095 1.002  1000
NA skill[4,16]          0.108 1.002   970
NA skill[5,16]          0.121 1.002  1000
NA skill[1,17]          0.704 1.009   190
NA skill[2,17]          0.721 1.002 15000
NA skill[3,17]          0.759 1.023   100
NA skill[4,17]          0.800 1.049    48
NA skill[5,17]          0.796 1.039    58
NA skill[1,18]          0.086 1.011   160
NA skill[2,18]          0.077 1.008   220
NA skill[3,18]          0.089 1.010   170
NA skill[4,18]          0.099 1.011   160
NA skill[5,18]          0.108 1.014   120
NA skill[1,19]          0.039 1.013   130
NA skill[2,19]          0.028 1.016   100
NA skill[3,19]          0.017 1.028    62
NA skill[4,19]          0.036 1.020    83
NA skill[5,19]          0.054 1.017    98
NA skill[1,20]          0.229 1.006   280
NA skill[2,20]          0.221 1.006   300
NA skill[3,20]          0.220 1.004   510
NA skill[4,20]          0.207 1.001 15000
NA skill[5,20]          0.223 1.001 15000
NA skill[1,21]          0.063 1.006   320
NA skill[2,21]          0.043 1.005   390
NA skill[3,21]          0.042 1.007   240
NA skill[4,21]          0.037 1.007   250
NA skill[5,21]          0.044 1.009   190
NA skill[1,22]          0.014 1.011   150
NA skill[2,22]         -0.001 1.012   160
NA skill[3,22]          0.010 1.010   180
NA skill[4,22]          0.026 1.008   220
NA skill[5,22]          0.038 1.006   270
NA skill[1,23]          0.043 1.003   710
NA skill[2,23]          0.026 1.002  1200
NA skill[3,23]          0.042 1.002  1900
NA skill[4,23]          0.054 1.001  2600
NA skill[5,23]          0.070 1.002  2300
NA skill[1,24]          0.109 1.001 15000
NA skill[2,24]          0.096 1.001  5000
NA skill[3,24]          0.085 1.001  2700
NA skill[4,24]          0.098 1.001  3600
NA skill[5,24]          0.109 1.002  3300
NA skill[1,25]          0.186 1.021   480
NA skill[2,25]          0.174 1.030   410
NA skill[3,25]          0.163 1.041   410
NA skill[4,25]          0.169 1.041   230
NA skill[5,25]          0.162 1.023   310
NA skill[1,26]          0.228 1.010   240
NA skill[2,26]          0.220 1.015   170
NA skill[3,26]          0.203 1.026   120
NA skill[4,26]          0.224 1.052    49
NA skill[5,26]          0.257 1.078    31
NA skill[1,27]          0.143 1.001  3900
NA skill[2,27]          0.129 1.001  9900
NA skill[3,27]          0.118 1.001 15000
NA skill[4,27]          0.103 1.002  1600
NA skill[5,27]          0.112 1.001  3800
NA skill[1,28]          0.087 1.003   720
NA skill[2,28]          0.068 1.004   470
NA skill[3,28]          0.052 1.006   310
NA skill[4,28]          0.035 1.009   190
NA skill[5,28]          0.035 1.012   140
NA skill[1,29]          0.235 1.058   160
NA skill[2,29]          0.230 1.061   160
NA skill[3,29]          0.224 1.068   150
NA skill[4,29]          0.215 1.076   130
NA skill[5,29]          0.204 1.085   110
NA deviance         10752.921 1.060    31
NA 
NA For each parameter, n.eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
NA 
NA DIC info (using the rule, pD = var(deviance)/2)
NA pD = 69.4 and DIC = 10801.0
NA DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
</div>
</div>
</section>
<section id="mcmc-diagnostics-2" class="level2">
<h2 class="anchored" data-anchor-id="mcmc-diagnostics-2">MCMC diagnostics</h2>
<p>The following graph shows the trace plot and distribution of the <code>season_sigma</code> parameter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">denplot</span>(m3.r2jags, <span class="at">parms =</span> <span class="st">"season_sigma"</span>, <span class="at">style =</span> <span class="st">"plain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traplot</span>(m3.r2jags, <span class="at">parms =</span> <span class="st">"season_sigma"</span>, <span class="at">style =</span> <span class="st">"plain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Calculating and comparing the DIC of this model with the former model show no substantial difference.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>dic_m2<span class="ot">&lt;-</span>m2.r2jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>DIC</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>dic_m3<span class="ot">&lt;-</span>m3.r2jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>DIC</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>diff_dic<span class="ot">&lt;-</span>dic_m2 <span class="sc">-</span> dic_m3</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>diff_dic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] -29.50679</code></pre>
</div>
</div>
<p>However, I believe the assumptions of the current model (m3) are more reasonable so I’ll stick with this model.</p>
</section>
</section>
<section id="ranking-the-teams-of-la-liga" class="level1">
<h1>Ranking the teams of La Liga</h1>
<p>We’ll start by ranking the teams of La Liga using the estimated skill parameters from the 2012/2013 season. The values of the skill parameters are difficult to interpret as they are relative to the skill of the team that had its skill parameter “anchored” at zero. To put them on a more interpretable scale I’ll first zero center the skill parameters by subtracting the mean skill of all teams, I then add the home baseline and exponentiate the resulting values. These rescaled skill parameters are now on the scale of expected number of goals when playing home team. Below is a caterpillar plot of the median of the rescaled skill parameters together with the <span class="math inline">\(68\)</span>% and <span class="math inline">\(95\)</span>% credible intervals. The plot is ordered according to the median skill and thus also gives the ranking of the teams.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The ranking of the teams for the 2012/13 season.</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>ms3<span class="ot">&lt;-</span>m3.r2jags<span class="sc">$</span>BUGSoutput<span class="sc">$</span>sims.matrix</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>team_skill <span class="ot">&lt;-</span> ms3[, <span class="fu">str_detect</span>(<span class="at">string =</span> <span class="fu">colnames</span>(ms3), <span class="st">"skill</span><span class="sc">\\</span><span class="st">[5,"</span>)]</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>team_skill <span class="ot">&lt;-</span> (team_skill <span class="sc">-</span> <span class="fu">rowMeans</span>(team_skill)) <span class="sc">+</span> ms3[, <span class="st">"home_baseline[5]"</span>]</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>team_skill <span class="ot">&lt;-</span> <span class="fu">exp</span>(team_skill)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(team_skill) <span class="ot">&lt;-</span> teams</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>team_skill <span class="ot">&lt;-</span> team_skill[, <span class="fu">order</span>(<span class="fu">colMeans</span>(team_skill), <span class="at">decreasing =</span> T)]</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>), <span class="at">xaxs =</span> <span class="st">"i"</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">caterplot</span>(team_skill, <span class="at">labels.loc =</span> <span class="st">"above"</span>, <span class="at">val.lim =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">3.8</span>), <span class="at">style =</span> <span class="st">"plain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Two teams are clearly ahead of the rest, FC Barcelona and Real Madrid CF. Let’s look at the credible difference between the two teams.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotPost</span>(team_skill[, <span class="st">"FC Barcelona"</span>] <span class="sc">-</span> team_skill[, <span class="st">"Real Madrid CF"</span>], <span class="at">compVal =</span> <span class="dv">0</span>,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"← Real Madrid     vs     Barcelona →"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NA                                         mean    median      mode hdiMass
NA ← Real Madrid     vs     Barcelona → 0.26639 0.2657129 0.2950102    0.95
NA                                          hdiLow  hdiHigh compVal pcGTcompVal
NA ← Real Madrid     vs     Barcelona → -0.1863186 0.785901       0   0.8660667
NA                                      ROPElow ROPEhigh pcInROPE
NA ← Real Madrid     vs     Barcelona →      NA       NA       NA</code></pre>
</div>
</div>
<p>FC Barcelona is the better team with a probability of <span class="math inline">\(82\)</span>%</p>
</section>
<section id="predicting-the-end-game-of-la-liga-20122013" class="level1">
<h1>Predicting the End Game of La Liga 2012/2013</h1>
<p>In the laliga data set the results of the <span class="math inline">\(50\)</span> last games of the 2012/2013 season was missing. Using our model we can now both predict and simulate the outcomes of these <span class="math inline">\(50\)</span> games. The R code below calculates a number of measures for each game (both the games with known and unknown outcomes):</p>
<ul>
<li><p>The mode of the simulated number of goals, that is, the most likely number of scored goals. If we were asked to bet on the number of goals in a game this is what we would use.</p></li>
<li><p>The mean of the simulated number of goals, this is our best guess of the average number of goals in a game.</p></li>
<li><p>The most likely match result for each game.</p></li>
<li><p>A random sample from the distributions of credible home scores, away scores and match results. This is how La Liga actually could have played out in an alternative reality.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(ms3)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>m3_pred <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(laliga), <span class="cf">function</span>(i) {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  home_team <span class="ot">&lt;-</span> <span class="fu">which</span>(teams <span class="sc">==</span> laliga<span class="sc">$</span>HomeTeam[i])</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  away_team <span class="ot">&lt;-</span> <span class="fu">which</span>(teams <span class="sc">==</span> laliga<span class="sc">$</span>AwayTeam[i])</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  season <span class="ot">&lt;-</span> <span class="fu">which</span>(seasons <span class="sc">==</span> laliga<span class="sc">$</span>Season[i])</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  home_skill <span class="ot">&lt;-</span> ms3[, <span class="fu">col_name</span>(<span class="st">"skill"</span>, season, home_team)]</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  away_skill <span class="ot">&lt;-</span> ms3[, <span class="fu">col_name</span>(<span class="st">"skill"</span>, season, away_team)]</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  home_baseline <span class="ot">&lt;-</span> ms3[, <span class="fu">col_name</span>(<span class="st">"home_baseline"</span>, season)]</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  away_baseline <span class="ot">&lt;-</span> ms3[, <span class="fu">col_name</span>(<span class="st">"away_baseline"</span>, season)]</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  home_goals <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="fu">exp</span>(home_baseline <span class="sc">+</span> home_skill <span class="sc">-</span> away_skill))</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  away_goals <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="fu">exp</span>(away_baseline <span class="sc">+</span> away_skill <span class="sc">-</span> home_skill))</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  home_goals_table <span class="ot">&lt;-</span> <span class="fu">table</span>(home_goals)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  away_goals_table <span class="ot">&lt;-</span> <span class="fu">table</span>(away_goals)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  match_results <span class="ot">&lt;-</span> <span class="fu">sign</span>(home_goals <span class="sc">-</span> away_goals)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  match_results_table <span class="ot">&lt;-</span> <span class="fu">table</span>(match_results)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  mode_home_goal <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">names</span>(home_goals_table)[ <span class="fu">which.max</span>(home_goals_table)])</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  mode_away_goal <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">names</span>(away_goals_table)[ <span class="fu">which.max</span>(away_goals_table)])</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>  match_result <span class="ot">&lt;-</span>  <span class="fu">as.numeric</span>(<span class="fu">names</span>(match_results_table)[<span class="fu">which.max</span>(match_results_table)])</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>  rand_i <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq_along</span>(home_goals), <span class="dv">1</span>)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">mode_home_goal =</span> mode_home_goal, <span class="at">mode_away_goal =</span> mode_away_goal, <span class="at">match_result =</span> match_result,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_home_goal =</span> <span class="fu">mean</span>(home_goals), <span class="at">mean_away_goal =</span> <span class="fu">mean</span>(away_goals),</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">rand_home_goal =</span> home_goals[rand_i], <span class="at">rand_away_goal =</span> away_goals[rand_i],</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">rand_match_result =</span> match_results[rand_i])</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>m3_pred <span class="ot">&lt;-</span> <span class="fu">t</span>(m3_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First let’s compare the distribution of the number of goals in the data with the predicted mode, mean and randomised number of goals for all the games (focusing on the number of goals for the home team). First the actual distribution of the number of goals for the home teams.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(laliga<span class="sc">$</span>HomeGoals, <span class="at">breaks =</span> (<span class="sc">-</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">10</span>), <span class="at">main =</span> <span class="st">"Distribution of the number of goals</span><span class="sc">\n</span><span class="st">scored by a home team in a match."</span>, <span class="at">xlab =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This next plot shows the distribution of the modes from the predicted distribution of home goals from each game. That is, what is the most probable outcome, for the home team, in each game.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(m3_pred[, <span class="st">"mode_home_goal"</span>], <span class="at">breaks =</span> (<span class="sc">-</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">10</span>),</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Distribution of predicted most</span><span class="sc">\n</span><span class="st">probable scoreby a home team in</span><span class="sc">\n</span><span class="st">a match."</span>, <span class="at">xlab =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For almost all games the single most likely number of goals is one. Actually, if you know nothing about a La Liga game betting on one goal for the home team is <span class="math inline">\(78\)</span>% of the times the best bet. Lest instead look at the distribution of the predicted mean number of home goals in each game.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(m3_pred[, <span class="st">"mean_home_goal"</span>], <span class="at">breaks =</span> (<span class="sc">-</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">10</span>),</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Distribution of predicted mean </span><span class="sc">\n</span><span class="st"> score by a home team in a match."</span>, <span class="at">xlab =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For most games the expected number of goals are <span class="math inline">\(2\)</span>. That is, even if your safest bet is one goal you would expect to see around two goals. The distribution of the mode and the mean number of goals doesn’t look remotely like the actual number of goals. This was not to be expected, we would however expect the distribution of randomized goals (where for each match the number of goals has been randomly drawn from that match’s predicted home goal distribution) to look similar to the actual number of home goals. Looking at the histogram below, this seems to be the case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(m3_pred[, <span class="st">"rand_home_goal"</span>], <span class="at">breaks =</span> (<span class="sc">-</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">10</span>),</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Distribution of randomly draw </span><span class="sc">\n</span><span class="st"> score by a home team in a match."</span>, <span class="at">xlab =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also look at how well the model predicts the data. This should probably be done using cross validation, but as the number of effective parameters are much smaller than the number of data points a direct comparison should at least give an estimated prediction accuracy in the right ballpark.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(laliga<span class="sc">$</span>HomeGoals <span class="sc">==</span> m3_pred[, <span class="st">"mode_home_goal"</span>], <span class="at">na.rm =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 0.3318919</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>((laliga<span class="sc">$</span>HomeGoals <span class="sc">-</span> m3_pred[, <span class="st">"mean_home_goal"</span>])<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 1.457061</code></pre>
</div>
</div>
<p>So on average the model predicts the correct number of home goals <span class="math inline">\(34\)</span>% of the time and guesses the average number of goals with a mean squared error of <span class="math inline">\(1.45\)</span>. Now we’ll look at the actual and predicted match outcomes. The graph below shows the match outcomes in the data with <span class="math inline">\(1\)</span> being a home win, <span class="math inline">\(0\)</span> being a draw and <span class="math inline">\(-1\)</span> being a win for the away team.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(laliga<span class="sc">$</span>MatchResult, <span class="at">breaks =</span> (<span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">main =</span> <span class="st">"Actual match results."</span>, <span class="at">xlab =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now looking at the most probable outcomes of the matches according to the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(m3_pred[, <span class="st">"match_result"</span>], <span class="at">breaks =</span> (<span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">main =</span> <span class="st">"Predicted match results."</span>, <span class="at">xlab =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For almost all matches the safest bet is to bet on the home team. While draws are not uncommon it is never the safest bet. As in the case with the number of home goals, the randomized match outcomes have a distribution similar to the actual match outcomes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(m3_pred[, <span class="st">"rand_match_result"</span>], <span class="at">breaks =</span> (<span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">main =</span> <span class="st">"Randomized match results."</span>, <span class="at">xlab =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(laliga<span class="sc">$</span>MatchResult <span class="sc">==</span> m3_pred[, <span class="st">"match_result"</span>], <span class="at">na.rm =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA [1] 0.5637838</code></pre>
</div>
</div>
<p>The model predicts the correct match outcome <span class="math inline">\(56\)</span>% of the time. Pretty good! Now that we’ve checked that the model reasonably predicts the La Liga history let’s predict the La Liga endgame! The code below displays the predicted mode and mean number of goals for the endgame and the predicted winner of each game.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>laliga_forecast <span class="ot">&lt;-</span> laliga[<span class="fu">is.na</span>(laliga<span class="sc">$</span>HomeGoals), <span class="fu">c</span>(<span class="st">"Season"</span>, <span class="st">"Week"</span>, <span class="st">"HomeTeam"</span>,</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AwayTeam"</span>)]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>m3_forecast <span class="ot">&lt;-</span> m3_pred[<span class="fu">is.na</span>(laliga<span class="sc">$</span>HomeGoals), ]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>laliga_forecast<span class="sc">$</span>mean_home_goals <span class="ot">&lt;-</span> <span class="fu">round</span>(m3_forecast[, <span class="st">"mean_home_goal"</span>], <span class="dv">1</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>laliga_forecast<span class="sc">$</span>mean_away_goals <span class="ot">&lt;-</span> <span class="fu">round</span>(m3_forecast[, <span class="st">"mean_away_goal"</span>], <span class="dv">1</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>laliga_forecast<span class="sc">$</span>mode_home_goals <span class="ot">&lt;-</span> m3_forecast[, <span class="st">"mode_home_goal"</span>]</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>laliga_forecast<span class="sc">$</span>mode_away_goals <span class="ot">&lt;-</span> m3_forecast[, <span class="st">"mode_away_goal"</span>]</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>laliga_forecast<span class="sc">$</span>predicted_winner <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(m3_forecast[, <span class="st">"match_result"</span>] <span class="sc">==</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, laliga_forecast<span class="sc">$</span>HomeTeam, <span class="fu">ifelse</span>(m3_forecast[, <span class="st">"match_result"</span>] <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    laliga_forecast<span class="sc">$</span>AwayTeam, <span class="st">"Draw"</span>))</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(laliga_forecast) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(laliga_forecast, <span class="st">"pandoc"</span>, <span class="at">align =</span> <span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Season</th>
<th style="text-align: center;">Week</th>
<th style="text-align: center;">HomeTeam</th>
<th style="text-align: center;">AwayTeam</th>
<th style="text-align: center;">mean_home_goals</th>
<th style="text-align: center;">mean_away_goals</th>
<th style="text-align: center;">mode_home_goals</th>
<th style="text-align: center;">mode_away_goals</th>
<th style="text-align: center;">predicted_winner</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Celta Vigo</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Atlético Madrid</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">3.2</td>
<td style="text-align: center;">0.5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">1.8</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Sevilla</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">2.0</td>
<td style="text-align: center;">0.9</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Valencia</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Getafe CF</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">1.3</td>
<td style="text-align: center;">1.3</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Granada CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">RCD Mallorca</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">3.2</td>
<td style="text-align: center;">0.5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Real Zaragoza</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">1.6</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1.8</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">1.7</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Betis Sevilla</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">CA Osasuna</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">0.8</td>
<td style="text-align: center;">2.1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">1.8</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Levante U.D.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Málaga CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">FC Valencia</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">2.0</td>
<td style="text-align: center;">0.9</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">1.6</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Real Valladolid</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Atlético Madrid</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">3.5</td>
<td style="text-align: center;">0.5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">1.6</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">FC Sevilla</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">1.3</td>
<td style="text-align: center;">1.3</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Getafe CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Granada CF</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">1.7</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Levante U.D.</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">RCD Mallorca</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">2.9</td>
<td style="text-align: center;">0.6</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Real Zaragoza</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">1.6</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">2.0</td>
<td style="text-align: center;">0.8</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Atlético Madrid</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">1.8</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Betis Sevilla</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">1.3</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">CA Osasuna</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">0.8</td>
<td style="text-align: center;">2.3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">2.2</td>
<td style="text-align: center;">0.8</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Valencia</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">1.7</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Getafe CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">1.8</td>
<td style="text-align: center;">0.9</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Málaga CF</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">0.9</td>
<td style="text-align: center;">1.9</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">1.6</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Real Valladolid</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Celta Vigo</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">1.3</td>
<td style="text-align: center;">1.3</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">3.1</td>
<td style="text-align: center;">0.6</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">FC Sevilla</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">1.4</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Granada CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Levante U.D.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">1.6</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">RCD Mallorca</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1.2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Rayo Vallecano</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">3.1</td>
<td style="text-align: center;">0.6</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">1.1</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Atlético Madrid</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>While these predictions are good if you want to bet on the likely winner they do not reflect how the actual endgame will play out, e.g., there is not a single draw in the predicted_winner column. So at last let’s look at a possible version of the La Liga endgame by displaying the simulated match results calculated earlier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>laliga_sim <span class="ot">&lt;-</span> laliga[<span class="fu">is.na</span>(laliga<span class="sc">$</span>HomeGoals), <span class="fu">c</span>(<span class="st">"Season"</span>, <span class="st">"Week"</span>, <span class="st">"HomeTeam"</span>,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AwayTeam"</span>)]</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>laliga_sim<span class="sc">$</span>home_goals <span class="ot">&lt;-</span> m3_forecast[, <span class="st">"rand_home_goal"</span>]</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>laliga_sim<span class="sc">$</span>away_goals <span class="ot">&lt;-</span> m3_forecast[, <span class="st">"rand_away_goal"</span>]</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>laliga_sim<span class="sc">$</span>winner <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(m3_forecast[, <span class="st">"rand_match_result"</span>] <span class="sc">==</span> <span class="dv">1</span>, laliga_forecast<span class="sc">$</span>HomeTeam,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(m3_forecast[, <span class="st">"rand_match_result"</span>] <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>, laliga_forecast<span class="sc">$</span>AwayTeam,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Draw"</span>))</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(laliga_sim) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(laliga_sim, <span class="st">"pandoc"</span>, <span class="at">align =</span> <span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Season</th>
<th style="text-align: center;">Week</th>
<th style="text-align: center;">HomeTeam</th>
<th style="text-align: center;">AwayTeam</th>
<th style="text-align: center;">home_goals</th>
<th style="text-align: center;">away_goals</th>
<th style="text-align: center;">winner</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Draw</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">Atlético Madrid</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Sevilla</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">CA Osasuna</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Getafe CF</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Málaga CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Levante U.D.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">34</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Rayo Vallecano</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Betis Sevilla</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">CA Osasuna</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Levante U.D.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">FC Sevilla</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">FC Valencia</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">Granada CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Real Valladolid</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Draw</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Sevilla</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Getafe CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">Draw</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Levante U.D.</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">RCD Mallorca</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Draw</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Real Zaragoza</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Draw</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">Real Zaragoza</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">CA Osasuna</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Valencia</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Rayo Vallecano</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Draw</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">37</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Real Valladolid</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Celta Vigo</td>
<td style="text-align: center;">Espanyol Barcelona</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Draw</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Deportivo de La Coruña</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">Real Sociedad San Sebastian</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">FC Barcelona</td>
<td style="text-align: center;">Málaga CF</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">FC Barcelona</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">FC Sevilla</td>
<td style="text-align: center;">FC Valencia</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">FC Sevilla</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Granada CF</td>
<td style="text-align: center;">Getafe CF</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Getafe CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Levante U.D.</td>
<td style="text-align: center;">Betis Sevilla</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Betis Sevilla</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">RCD Mallorca</td>
<td style="text-align: center;">Real Valladolid</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">RCD Mallorca</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Rayo Vallecano</td>
<td style="text-align: center;">Athletic Club Bilbao</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Rayo Vallecano</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Real Madrid CF</td>
<td style="text-align: center;">CA Osasuna</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Real Madrid CF</td>
</tr>
<tr class="even">
<td style="text-align: center;">2012/13</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">Real Zaragoza</td>
<td style="text-align: center;">Atlético Madrid</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Atlético Madrid</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now we see a number of games resulting in a draw. We also see that Malaga manages to beat Real Madrid in week <span class="math inline">\(36\)</span>, against all odds, even though playing as the away team.</p>
</section>
<section id="calculating-the-predicted-payout-for-sevilla-vs-valencia-2013-06-01" class="level1">
<h1>Calculating the Predicted Payout for Sevilla vs Valencia, 2013-06-01</h1>
<p>At the time when this model was developed (2013-05-28) most of the matches in the 2012/2013 season had been played and Barcelona was already the winner (and the most skilled team as predicted by my model). There were however some matches left, for example, Sevilla (home team) vs Valencia (away team) at the <span class="math inline">\(1\)</span>st of June, 2013. One of the powers with using Bayesian modeling and MCMC sampling is that once you have the MCMC samples of the parameters it is straight forward to calculate any quantity resulting from these estimates while still retaining the uncertainty of the parameter estimates. So let’s look at the predicted distribution of the number of goals for the Sevilla vs Valencia game and see if I can use my model to make some money. I’ll start by using the MCMC samples to calculate the distribution of the number of goals for Sevilla and Valencia.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(ms3)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>home_team <span class="ot">&lt;-</span> <span class="fu">which</span>(teams <span class="sc">==</span> <span class="st">"FC Sevilla"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>away_team <span class="ot">&lt;-</span> <span class="fu">which</span>(teams <span class="sc">==</span> <span class="st">"FC Valencia"</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>season <span class="ot">&lt;-</span> <span class="fu">which</span>(seasons <span class="sc">==</span> <span class="st">"2012/13"</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>home_skill <span class="ot">&lt;-</span> ms3[, <span class="fu">col_name</span>(<span class="st">"skill"</span>, season, home_team)]</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>away_skill <span class="ot">&lt;-</span> ms3[, <span class="fu">col_name</span>(<span class="st">"skill"</span>, season, away_team)]</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>home_baseline <span class="ot">&lt;-</span> ms3[, <span class="fu">col_name</span>(<span class="st">"home_baseline"</span>, season)]</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>away_baseline <span class="ot">&lt;-</span> ms3[, <span class="fu">col_name</span>(<span class="st">"away_baseline"</span>, season)]</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>home_goals <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="fu">exp</span>(home_baseline <span class="sc">+</span> home_skill <span class="sc">-</span> away_skill))</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>away_goals <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="fu">exp</span>(away_baseline <span class="sc">+</span> away_skill <span class="sc">-</span> home_skill))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looking at summary of these two distributions shows that it will be a close game but with a slight advantage for the home team Sevilla.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="fl">2.2</span>, <span class="dv">4</span>))</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_goals</span>(home_goals, away_goals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When developing the model (2013-05-28) the author got the specific payouts (that is, how much would I get back if my bet was successful) for betting on the outcome of this game on a betting site. Using my simulated distribution of the number of goals I can calculate the predicted payouts of my model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span><span class="fu">c</span>(<span class="at">Sevilla =</span> <span class="fu">mean</span>(home_goals <span class="sc">&gt;</span> away_goals), <span class="at">Draw =</span> <span class="fu">mean</span>(home_goals <span class="sc">==</span> away_goals),</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">Valencia =</span> <span class="fu">mean</span>(home_goals <span class="sc">&lt;</span> away_goals))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA  Sevilla     Draw Valencia 
NA 2.281369 3.841229 3.318584</code></pre>
</div>
</div>
<p>I should clearly bet on Sevilla as my model predicts a payout of <span class="math inline">\(2.24\)</span> (that is, a likely win for Sevilla) while betsson.com gives me the much higher payout of <span class="math inline">\(3.2\)</span>. It is also possible to bet on the final goal outcome so let’s calculate what payouts my model predicts for different goal outcomes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>goals_payout <span class="ot">&lt;-</span> <span class="fu">laply</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>, <span class="cf">function</span>(home_goal) {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">laply</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>, <span class="cf">function</span>(away_goal) {</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span><span class="sc">/</span><span class="fu">mean</span>(home_goals <span class="sc">==</span> home_goal <span class="sc">&amp;</span> away_goals <span class="sc">==</span> away_goal)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(goals_payout) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Valencia"</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">sep =</span> <span class="st">" - "</span>)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(goals_payout) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Sevilla"</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">sep =</span> <span class="st">" - "</span>)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>goals_payout <span class="ot">&lt;-</span> <span class="fu">round</span>(goals_payout, <span class="dv">1</span>)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(goals_payout, <span class="st">"pandoc"</span>, <span class="at">align =</span> <span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">Valencia - 0</th>
<th style="text-align: center;">Valencia - 1</th>
<th style="text-align: center;">Valencia - 2</th>
<th style="text-align: center;">Valencia - 3</th>
<th style="text-align: center;">Valencia - 4</th>
<th style="text-align: center;">Valencia - 5</th>
<th style="text-align: center;">Valencia - 6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sevilla - 0</td>
<td style="text-align: center;">13.8</td>
<td style="text-align: center;">11.9</td>
<td style="text-align: center;">21.5</td>
<td style="text-align: center;">47.3</td>
<td style="text-align: center;">161.3</td>
<td style="text-align: center;">714.3</td>
<td style="text-align: center;">2500.0</td>
</tr>
<tr class="even">
<td>Sevilla - 1</td>
<td style="text-align: center;">9.5</td>
<td style="text-align: center;">8.0</td>
<td style="text-align: center;">13.4</td>
<td style="text-align: center;">36.9</td>
<td style="text-align: center;">122.0</td>
<td style="text-align: center;">441.2</td>
<td style="text-align: center;">1666.7</td>
</tr>
<tr class="odd">
<td>Sevilla - 2</td>
<td style="text-align: center;">12.8</td>
<td style="text-align: center;">11.5</td>
<td style="text-align: center;">19.4</td>
<td style="text-align: center;">56.4</td>
<td style="text-align: center;">176.5</td>
<td style="text-align: center;">625.0</td>
<td style="text-align: center;">1875.0</td>
</tr>
<tr class="even">
<td>Sevilla - 3</td>
<td style="text-align: center;">26.5</td>
<td style="text-align: center;">22.9</td>
<td style="text-align: center;">39.8</td>
<td style="text-align: center;">97.4</td>
<td style="text-align: center;">500.0</td>
<td style="text-align: center;">1363.6</td>
<td style="text-align: center;">Inf</td>
</tr>
<tr class="odd">
<td>Sevilla - 4</td>
<td style="text-align: center;">81.5</td>
<td style="text-align: center;">58.8</td>
<td style="text-align: center;">101.4</td>
<td style="text-align: center;">306.1</td>
<td style="text-align: center;">1071.4</td>
<td style="text-align: center;">3000.0</td>
<td style="text-align: center;">Inf</td>
</tr>
<tr class="even">
<td>Sevilla - 5</td>
<td style="text-align: center;">211.3</td>
<td style="text-align: center;">223.9</td>
<td style="text-align: center;">319.1</td>
<td style="text-align: center;">1000.0</td>
<td style="text-align: center;">2500.0</td>
<td style="text-align: center;">15000.0</td>
<td style="text-align: center;">Inf</td>
</tr>
<tr class="odd">
<td>Sevilla - 6</td>
<td style="text-align: center;">750.0</td>
<td style="text-align: center;">483.9</td>
<td style="text-align: center;">1500.0</td>
<td style="text-align: center;">3000.0</td>
<td style="text-align: center;">7500.0</td>
<td style="text-align: center;">Inf</td>
<td style="text-align: center;">Inf</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The most likely result is 1 - 1 with a predicted payout of <span class="math inline">\(8.4\)</span> and the beeting site agrees with this also offering their lowest payout for this bet, <span class="math inline">\(5.3\)</span>. Not good enough! Looking at the payouts at the beeting site I can see that Sevilla - Valencia: 2 - 0 gives me a payout of <span class="math inline">\(16.0\)</span>, that’s much better than my predicted payout of <span class="math inline">\(13.1\)</span>. I’ll go for that!</p>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>I believe the model has a lot things going for it. It is conceptually quite simple and easy to understand, implement and extend. It captures the patterns in and distribution of the data well. It allows me to easily calculate the probability of any outcome, from a game with whichever teams from any La Liga season. Want to calculate the probability that RCD Mallorca (home team) vs Malaga CF (away team) in the Season 2009/2010 would result in a draw? Easy! What’s the probability of the total number of goals in Granada CF vs Athletic Club Bilbao being a prime number? No problemo! What if Real Madrid from 2008/2009 met Barcelona from 2012/2013 in 2010/2011 and both teams had the home advantage? Well, that’s possible. There are also a couple of things that could be improved (many which are not too hard to address). Currently there is assumed to be no dependency between the goal distributions of the home and away teams, but this might not be realistic. Maybe if one team have scored more goals the other team “looses steam” (a negative correlation between the teams’ scores) or instead maybe the other team tries harder (a positive correlation). Such dependencies could maybe be added to the model using copulas. * One of the advantages of Bayesian statistics is the possibility to used informative priors. As I have no knowledge of football I’ve been using vague priors but with the help of a more knowledgeable football fan the model could be given more informative priors. Also, the predictive performance of the model has not been as thoroughly examined and this could be remedied with a healthy dose of cross validation.</p>
</section>
<section id="references" class="level1">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-baaaath2015modeling" class="csl-entry" role="listitem">
Bååth, Rasmus. 2015. <span>“Modeling Match Results in Soccer Using a Hierarchical Bayesian Poisson Model.”</span> Technical Report LUCS minor 18, Lund University Cognitive Science, Lund, Sweden.
</div>
<div id="ref-plummer2004jags" class="csl-entry" role="listitem">
Plummer, Martyn. 2004. <span>“JAGS: Just Another Gibbs Sampler.”</span>
</div>
<div id="ref-su2015package" class="csl-entry" role="listitem">
Su, Yu-Sung, Masanao Yajima, Maintainer Yu-Sung Su, and JAGS SystemRequirements. 2015. <span>“Package <span>‘R2jags’</span>.”</span> <em>R Package Version 0.03-08, URL Http://CRAN. R-Project. Org/Package= R2jags</em>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Andrea Gabrio</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>