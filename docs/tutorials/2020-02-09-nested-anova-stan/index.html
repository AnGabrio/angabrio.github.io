<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrea Gabrio">
<meta name="dcterms.date" content="2020-02-09">
<meta name="keywords" content="Software, Statistics, Stan">

<title>Andrea Gabrio - Nested Anova (Stan)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andrea Gabrio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../missing_data.html"> 
<span class="menu-text">Missing Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#linear-models-frequentist" id="toc-linear-models-frequentist" class="nav-link" data-scroll-target="#linear-models-frequentist">Linear models (frequentist)</a></li>
  <li><a href="#linear-models-bayesian" id="toc-linear-models-bayesian" class="nav-link" data-scroll-target="#linear-models-bayesian">Linear models (Bayesian)</a></li>
  <li><a href="#null-hypotheses" id="toc-null-hypotheses" class="nav-link" data-scroll-target="#null-hypotheses">Null hypotheses</a></li>
  <li><a href="#analysis-of-variance" id="toc-analysis-of-variance" class="nav-link" data-scroll-target="#analysis-of-variance">Analysis of variance</a></li>
  <li><a href="#variance-components" id="toc-variance-components" class="nav-link" data-scroll-target="#variance-components">Variance components</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions">Assumptions</a></li>
  <li><a href="#unbalanced-nested-designs" id="toc-unbalanced-nested-designs" class="nav-link" data-scroll-target="#unbalanced-nested-designs">Unbalanced nested designs</a></li>
  <li><a href="#linear-mixed-effects-models" id="toc-linear-mixed-effects-models" class="nav-link" data-scroll-target="#linear-mixed-effects-models">Linear mixed effects models</a></li>
  </ul></li>
  <li><a href="#data-generation" id="toc-data-generation" class="nav-link" data-scroll-target="#data-generation">Data generation</a>
  <ul class="collapse">
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory data analysis</a></li>
  </ul></li>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model fitting</a>
  <ul class="collapse">
  <li><a href="#full-means-parameterisation" id="toc-full-means-parameterisation" class="nav-link" data-scroll-target="#full-means-parameterisation">Full means parameterisation</a></li>
  <li><a href="#full-effect-parameterisation" id="toc-full-effect-parameterisation" class="nav-link" data-scroll-target="#full-effect-parameterisation">Full effect parameterisation</a></li>
  <li><a href="#matrix-parameterisation" id="toc-matrix-parameterisation" class="nav-link" data-scroll-target="#matrix-parameterisation">Matrix parameterisation</a></li>
  <li><a href="#hierarchical-parameterisation" id="toc-hierarchical-parameterisation" class="nav-link" data-scroll-target="#hierarchical-parameterisation">Hierarchical parameterisation</a></li>
  </ul></li>
  <li><a href="#data-generation---second-example" id="toc-data-generation---second-example" class="nav-link" data-scroll-target="#data-generation---second-example">Data generation - second example</a>
  <ul class="collapse">
  <li><a href="#exploratory-data-analysis-1" id="toc-exploratory-data-analysis-1" class="nav-link" data-scroll-target="#exploratory-data-analysis-1">Exploratory data analysis</a></li>
  </ul></li>
  <li><a href="#model-fitting-1" id="toc-model-fitting-1" class="nav-link" data-scroll-target="#model-fitting-1">Model fitting</a>
  <ul class="collapse">
  <li><a href="#frequentist-for-comparison" id="toc-frequentist-for-comparison" class="nav-link" data-scroll-target="#frequentist-for-comparison">Frequentist for comparison</a></li>
  <li><a href="#full-effect-parameterisation-1" id="toc-full-effect-parameterisation-1" class="nav-link" data-scroll-target="#full-effect-parameterisation-1">Full effect parameterisation</a></li>
  <li><a href="#matrix-parameterisation-1" id="toc-matrix-parameterisation-1" class="nav-link" data-scroll-target="#matrix-parameterisation-1">Matrix parameterisation</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Nested Anova (Stan)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Quarto</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Academia</div>
    <div class="quarto-category">Software</div>
    <div class="quarto-category">Statistics</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://angabrio.github.io/agabriosite2/">Andrea Gabrio</a> <a href="mailto:a.gabrio@maastrichtuniversity.nl" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-7650-4534" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://www.maastrichtuniversity.nl/research/methodology-and-statistics">
            Maastricht University
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 9, 2020</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p><span style="font-size: 85%">This tutorial will focus on the use of Bayesian estimation to fit simple linear regression models …</span></p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Software, Statistics, Stan</p>
  </div>
</div>

</header>


<p>This tutorial will focus on the use of Bayesian estimation to fit simple linear regression models. <code>BUGS</code> (Bayesian inference Using <em>Gibbs Sampling</em>) is an algorithm and supporting language (resembling <code>R</code>) dedicated to performing the Gibbs sampling implementation of <em>Markov Chain Monte Carlo</em> (MCMC) method. Dialects of the <code>BUGS</code> language are implemented within three main projects:</p>
<ol type="1">
<li><p><strong>OpenBUGS</strong> - written in component pascal.</p></li>
<li><p><strong>JAGS</strong> - (Just Another Gibbs Sampler) - written in <code>C++</code>.</p></li>
<li><p><strong>Stan</strong> - a dedicated Bayesian modelling framework written in <code>C++</code> and implementing <em>Hamiltonian</em> MCMC samplers.</p></li>
</ol>
<p>Whilst the above programs can be used stand-alone, they do offer the rich data pre-processing and graphical capabilities of <code>R</code>, and thus, they are best accessed from within <code>R</code> itself. As such there are multiple packages devoted to interfacing with the various software implementations:</p>
<ul>
<li><p><em>R2OpenBUGS</em> - interfaces with <code>OpenBUGS</code></p></li>
<li><p><em>R2jags</em> - interfaces with <code>JAGS</code></p></li>
<li><p><em>rstan</em> - interfaces with <code>Stan</code></p></li>
</ul>
<p>This tutorial will demonstrate how to fit models in <code>Stan</code> (<span class="citation" data-cites="gelman2015stan">Gelman, Lee, and Guo (<a href="#ref-gelman2015stan" role="doc-biblioref">2015</a>)</span>) using the package <code>rstan</code> (<span class="citation" data-cites="rstanpackage">Stan Development Team (<a href="#ref-rstanpackage" role="doc-biblioref">2018</a>)</span>) as interface, which also requires to load some other packages.</p>
<section id="overview" class="level1">
<h1>Overview</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>When single sampling units are selected amongst highly heterogeneous conditions, it is unlikely that these single units will adequately represent the populations and repeated sampling is likely to yield very different outcomes. For example, if we were investigating the impacts of fuel reduction burning across a highly heterogeneous landscape, our ability to replicate adequately might be limited by the number of burn sites available.</p>
<p>Alternatively, sub-replicates within each of the sampling units (e.g.&nbsp;sites) can be collected (and averaged) so as to provided better representatives for each of the units and ultimately reduce the unexplained variability of the test of treatments. In essence, the sub-replicates are the replicates of an additional nested factor whose levels are nested within the main treatment factor. A nested factor refers to a factor whose levels are unique within each level of the factor it is nested within and each level is only represented once. For example, the fuel reduction burn study design could consist of three burnt sites and three un-burnt (control) sites each containing four quadrats (replicates of site and sub-replicates of the burn treatment). Each site represents a unique level of a random factor (any given site cannot be both burnt and un-burnt) that is nested within the fire treatment (burned or not).</p>
<p>A nested design can be thought of as a hierarchical arrangement of factors (hence the alternative name hierarchical designs) whereby a treatment is progressively sub-replicated. As an additional example, imagine an experiment designed to comparing the leaf toughness of a number of tree species. Working down the hierarchy, five individual trees were randomly selected within (nested within) each species, three branches were randomly selected within each tree, two leaves were randomly selected within each branch and the force required to shear the leaf material in half (transversely) was measured in four random locations along the leaf. Clearly any given leaf can only be from a single branch, tree and species. Each level of sub-replication is introduced to further reduce the amount of unexplained variation and thereby increasing the power of the test for the main treatment effect. Additionally, it is possible to investigate which scale has the greatest (or least, etc) degree of variability - the level of the species, individual tree, branch, leaf, leaf region etc.</p>
<ul>
<li><p>Nested factors are typically random factors, of which the levels are randomly selected to represent all possible levels (e.g.&nbsp;sites). When the main treatment effect (often referred to as Factor A) is a fixed factor, such designs are referred to as a <em>mixed model nested ANOVA</em>, whereas when Factor A is random, the design is referred to as a <em>Model II nested ANOVA</em>.</p></li>
<li><p>Fixed nested factors are also possible. For example, specific dates (corresponding to particular times during a season) could be nested within season. When all factors are fixed, the design is referred to as a <em>Model I mixed model</em>.</p></li>
<li><p>Fully nested designs (the topic of this chapter) differ from other multi-factor designs in that all factors within (below) the main treatment factor are nested and thus interactions are un-replicated and cannot be tested. Indeed, interaction effects (interaction between Factor A and site) are assumed to be zero.</p></li>
</ul>
</section>
<section id="linear-models-frequentist" class="level2">
<h2 class="anchored" data-anchor-id="linear-models-frequentist">Linear models (frequentist)</h2>
<p>The linear models for two and three factor nested design are:</p>
<p><span class="math display">\[
y_{ijk} = \mu + \alpha_i + \beta_{j(i)} + \epsilon_{ijk},
\]</span></p>
<p><span class="math display">\[
y_{ijkl} = \mu + \alpha_i + \beta_{j(i)} + gamma_{k(j(i))}  + \epsilon_{ijkl},
\]</span></p>
<p>where <span class="math inline">\(\mu\)</span> is the overall mean, <span class="math inline">\(\alpha\)</span> is the effect of Factor A, <span class="math inline">\(\beta\)</span> is the effect of Factor B, <span class="math inline">\(\gamma\)</span> is the effect of Factor C and <span class="math inline">\(\epsilon\)</span> is the random unexplained or residual component.</p>
</section>
<section id="linear-models-bayesian" class="level2">
<h2 class="anchored" data-anchor-id="linear-models-bayesian">Linear models (Bayesian)</h2>
<p>So called “random effects” are modelled differently from “fixed effects” in that rather than estimate their individual effects, we instead estimate the variability due to these “random effects”. Since technically all variables in a Bayesian framework are random, some prefer to use the terms ‘fixed effects’ and ‘varying effects’. As random factors typically represent “random” selections of levels (such as a set of randomly selected sites), incorporated in order to account for the dependency structure (observations within sites are more likely to be correlated to one another - not strickly independent) to the data, we are not overly interested in the individual differences between levels of the ‘varying’ (random) factor. Instead (in addition to imposing a separate correlation structure within each nest), we want to know how much variability is attributed to this level of the design. The linear models for two and three factor nested design are:</p>
<p><span class="math display">\[
y_{ijk} = \mu + \alpha_i + \beta_{j(i)} + \epsilon_{ijk}, \;\;\; \epsilon_{ijk} \sim N(0, \sigma^2), \;\;\; \beta_{j(i)} \sim N(0, \sigma^2_{B})
\]</span></p>
<p><span class="math display">\[
y_{ijkl} = \mu + \alpha_i + \beta_{j(i)} + \gamma_{k(j(i))} + \epsilon_{ijkl}, \;\;\; \epsilon_{ijkl} \sim N(0, \sigma^2), \;\;\; \beta_{j(i)} \sim N(0, \sigma^2_{B}) \;\;\; \gamma_{k(j(i))} \sim N(0, \sigma^2_C)
\]</span></p>
<p>where <span class="math inline">\(\mu\)</span> is the overall mean, <span class="math inline">\(\alpha\)</span> is the effect of Factor A, <span class="math inline">\(\beta\)</span> is the variability of Factor B (nested within Factor A), <span class="math inline">\(\gamma\)</span> is the variability of Factor C (nested within Factor B) and <span class="math inline">\(\epsilon\)</span> is the random unexplained or residual component that is assumed to be normally distributed with a mean of zero and a constant amount of standard deviation (<span class="math inline">\(\sigma^2\)</span>). The subscripts are iterators. For example, the <span class="math inline">\(i\)</span> represents the number of effects to be estimated for Factor A. Thus the first formula can be read as the <span class="math inline">\(k\)</span>-th observation of <span class="math inline">\(y\)</span> is drawn from a normal distribution (with a specific level of variability) and mean proposed to be determined by a base mean (<span class="math inline">\(\mu\)</span> - mean of the first treatment across all nests) plus the effect of the <span class="math inline">\(i\)</span>-th treatment effect plus the variabilitythe model proposes that, given a base mean (<span class="math inline">\(\mu\)</span>) and knowing the effect of the <span class="math inline">\(i\)</span>-th treatment (factor A) and which of the <span class="math inline">\(j\)</span>-th nests within the treatment the <span class="math inline">\(k\)</span>-th observation from Block <span class="math inline">\(j\)</span> (factor B) within treatment effect.</p>
</section>
<section id="null-hypotheses" class="level2">
<h2 class="anchored" data-anchor-id="null-hypotheses">Null hypotheses</h2>
<p>Separate null hypotheses are associated with each of the factors, however, nested factors are typically only added to absorb some of the unexplained variability and thus, specific hypotheses tests associated with nested factors are of lesser biological importance. Hence, rather than estimate the effects of random effects, we instead estimate how much variability they contribute.</p>
<p><strong>Factor A: the main treatment effect (fixed)</strong></p>
<ul>
<li><p><span class="math inline">\(H_0(A): \mu_1=\mu_2=\ldots=\mu_i=\mu\)</span> (the population group means are all equal). That is, that the mean of population <span class="math inline">\(1\)</span> is equal to that of population <span class="math inline">\(2\)</span> and so on, and thus all population means are equal to one another - no effect of the factor on the response. If the effect of the <span class="math inline">\(i\)</span>-th group is the difference between the <span class="math inline">\(i\)</span>-th group mean and the mean of the first group (<span class="math inline">\(\alpha_i=\mu_i-\mu_1\)</span>) then the <span class="math inline">\(H_0\)</span> can alternatively be written as:</p></li>
<li><p><span class="math inline">\(H_0(A) : \alpha_1=\alpha_2=\ldots=\alpha_i=0\)</span> (the effect of each group equals zero). If one or more of the <span class="math inline">\(\alpha_i\)</span> are different from zero (the response mean for this treatment differs from the overall response mean), there is evidence that the null hypothesis is not true indicating that the factor does affect the response variable.</p></li>
</ul>
<p><strong>Factor A: the main treatment effect (random)</strong></p>
<ul>
<li><span class="math inline">\(H_0(A) : \sigma^2_{\alpha}=0\)</span> (population variance equals zero). There is no added variance due to all possible levels of A.</li>
</ul>
<p><strong>Factor B: the nested effect (random)</strong></p>
<ul>
<li><span class="math inline">\(H_0(B) : \sigma^2_{\beta}=0\)</span> (population variance equals zero). There is no added variance due to all possible levels of B within the (set or all possible) levels of A.</li>
</ul>
<p><strong>Factor B: the nested effect (fixed)</strong></p>
<ul>
<li><p><span class="math inline">\(H_0(B): \mu_{1(1)}=\mu_{2(1)}=\ldots=\mu_{j(i)}=\mu\)</span> (the population group means of B (within A) are all equal).</p></li>
<li><p><span class="math inline">\(H_0(B): \beta_{1(1)}=\beta_{2(1)}=\ldots=\beta_{j(i)}=0\)</span> (the effect of each chosen B group equals zero).</p></li>
</ul>
</section>
<section id="analysis-of-variance" class="level2">
<h2 class="anchored" data-anchor-id="analysis-of-variance">Analysis of variance</h2>
<p>Analysis of variance sequentially partitions the total variability in the response variable into components explained by each of the factors (starting with the factors lowest down in the hierarchy - the most deeply nested) and the components unexplained by each factor. Explained variability is calculated by subtracting the amount unexplained by the factor from the amount unexplained by a reduced model that does not contain the factor. When the null hypothesis for a factor is true (no effect or added variability), the ratio of explained and unexplained components for that factor (F-ratio) should follow a theoretical F-distribution with an expected value less than 1. The appropriate unexplained residuals and therefore the appropriate F-ratios for each factor differ according to the different null hypotheses associated with different combinations of fixed and random factors in a nested linear model (see Table below).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>fact_anova_table</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA       df        MS         F-ratio (B random)    Var comp (B random)        
NA A     "a-1"     "MS A"     "(MS A)/(MS B'(A))"   "((MS A) - (MS B'(A)))/nb" 
NA B'(A) "(b-1)a"  "MS B'(A)" "(MS B'(A))/(MS res)" "((MS B'(A)) - (MS res))/n"
NA Res   "(n-1)ba" "MS res"   ""                    ""                         
NA       F-ratio (B fixed)     Var comp (B fixed)         
NA A     "(MS A)/(MS res)"     "((MS A) - (MS res))/nb"   
NA B'(A) "(MS B'(A))/(MS res)" "((MS B'(A)) - (MS res))/n"
NA Res   ""                    ""</code></pre>
</div>
</div>
<p>The corresponding <code>R</code> syntax is given below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#A fixed/random, B random (balanced)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">aov</span>(y<span class="sc">~</span>A<span class="sc">+</span><span class="fu">Error</span>(B), data))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(<span class="fu">lme</span>(y<span class="sc">~</span>A,<span class="at">random=</span><span class="dv">1</span><span class="sc">|</span>B, data))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#A fixed/random, B random (unbalanced)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(<span class="fu">lme</span>(y<span class="sc">~</span>A,<span class="at">random=</span><span class="dv">1</span><span class="sc">|</span>B, data), <span class="at">type=</span><span class="st">'marginal'</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#A fixed/random, B fixed(balanced)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">aov</span>(y<span class="sc">~</span>A<span class="sc">+</span>B, data))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">#A fixed/random, B fixed (unbalanced)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(data<span class="sc">$</span>B) <span class="ot">&lt;-</span> contr.sum</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(<span class="fu">aov</span>(y<span class="sc">~</span>A<span class="sc">/</span>B, data), <span class="at">type=</span><span class="st">'III'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="variance-components" class="level2">
<h2 class="anchored" data-anchor-id="variance-components">Variance components</h2>
<p>As previously alluded to, it can often be useful to determine the relative contribution (to explaining the unexplained variability) of each of the factors as this provides insights into the variability at each different scales. These contributions are known as <strong>Variance components</strong> and are estimates of the added variances due to each of the factors. For consistency with leading texts on this topic, I have included estimated variance components for various balanced nested ANOVA designs in the above table. However, variance components based on a modified version of the maximum likelihood iterative model fitting procedure (<em>REML</em>) is generally recommended as this accommodates both balanced and unbalanced designs. While there are no numerical differences in the calculations of variance components for fixed and random factors, fixed factors are interpreted very differently and arguably have little clinical meaning (other to infer relative contribution). For fixed factors, variance components estimate the variance between the means of the specific populations that are represented by the selected levels of the factor and therefore represent somewhat arbitrary and artificial populations. For random factors, variance components estimate the variance between means of all possible populations that could have been selected and thus represents the true population variance.</p>
</section>
<section id="assumptions" class="level2">
<h2 class="anchored" data-anchor-id="assumptions">Assumptions</h2>
<p>An F-distribution represents the relative frequencies of all the possible F-ratio’s when a given null hypothesis is true and certain assumptions about the residuals (denominator in the F-ratio calculation) hold. Consequently, it is also important that diagnostics associated with a particular hypothesis test reflect the denominator for the appropriate F-ratio. For example, when testing the null hypothesis that there is no effect of Factor A (<span class="math inline">\(H_0(A):\alpha_i=0\)</span>) in a mixed nested ANOVA, the means of each level of Factor B are used as the replicates of Factor A. As with single factor anova, hypothesis testing for nested ANOVA assumes the residuals are:</p>
<ul>
<li><p>normally distributed. Factors higher up in the hierarchy of a nested model are based on means (or means of means) of lower factors and thus the <em>Central Limit Theory</em> would predict that normality will usually be satisfied for the higher level factors. Nevertheless, boxplots using the appropriate scale of replication should be used to explore normality. Scale transformations are often useful.</p></li>
<li><p>equally varied. Boxplots and plots of means against variance (using the appropriate scale of replication) should be used to explore the spread of values. Residual plots should reveal no patterns. Scale transformations are often useful.</p></li>
<li><p>independent of one another - this requires special consideration so as to ensure that the scale at which sub-replicates are measured is still great enough to enable observations to be independent.</p></li>
</ul>
</section>
<section id="unbalanced-nested-designs" class="level2">
<h2 class="anchored" data-anchor-id="unbalanced-nested-designs">Unbalanced nested designs</h2>
<p>Designs that incorporate fixed and random factors (either nested or factorial), involve F-ratio calculations in which the denominators are themselves random factors other than the overall residuals. Many statisticians argue that when such denominators are themselves not statistically significant (at the <span class="math inline">\(0.25\)</span> level), there are substantial power benefits from pooling together successive non-significant denominator terms. Thus an F-ratio for a particular factor might be recalculated after pooling together its original denominator with its denominators denominator and so on. The conservative <span class="math inline">\(0.25\)</span> is used instead of the usual 0.05 to reduce further the likelihood of Type II errors (falsely concluding an effect is non-significant - that might result from insufficient power).</p>
<p>For a simple completely balanced nested ANOVA, it is possible to pool together (calculate their mean) each of the sub-replicates within each nest (site) and then perform single factor ANOVA on those aggregates. Indeed, for a <em>balanced design</em>, the estimates and hypothesis for Factor A will be identical to that produced via nested ANOVA. However, if there are an unequal number of sub-replicates within each nest, then the single factor ANOVA will be less powerful that a proper nested ANOVA. <em>Unbalanced designs</em> are those designs in which sample (subsample) sizes for each level of one or more factors differ. These situations are relatively common in biological research, however such imbalance has some important implications for nested designs.</p>
<p>Firstly, hypothesis tests are more robust to the assumptions of normality and equal variance when the design is balanced. Secondly (and arguably, more importantly), the model contrasts are not orthogonal (independent) and the sums of squares component attributed to each of the model terms cannot be calculated by simple additive partitioning of the total sums of squares. In such situations, exact F-ratios cannot be constructed (at least in theory), variance components calculations are more complicated and significance tests cannot be computed. The denominator MS in an <em>F-ratio</em> is determined by examining the expected value of the mean squares of each term in a model. Unequal sample sizes result in expected means squares for which there are no obvious logical comparators that enable the impact of an individual model term to be isolated. The severity of this issue depends on which scale of the sub-sampling hierarchy the unbalance(s) occurs as well whether the unbalance occurs in the replication of a fixed or random factor. For example, whilst unequal levels of the first nesting factor (e.g.&nbsp;unequal number of burn vs un-burnt sites) has no effect on F-ratio construction or hypothesis testing for the top level factor (irrespective of whether either of the factors are fixed or random), unequal sub-sampling (replication) at the level of a random (but not fixed) nesting factor will impact on the ability to construct F-ratios and variance components of all terms above it in the hierarchy. There are a number of alternative ways of dealing with unbalanced nested designs. All alternatives assume that the imbalance is not a direct result of the treatments themselves. Such outcomes are more appropriately analysed by modelling the counts of surviving observations via frequency analysis.</p>
<ul>
<li>Split the analysis up into separate smaller simple ANOVA’s each using the means of the nesting factor to reflect the appropriate scale of replication. As the resulting sums of squares components are thereby based on an aggregated dataset the analyses then inherit the procedures and requirements of single ANOVA.</li>
<li>Adopt mixed-modelling techniques.</li>
</ul>
<p>We note that, in a Bayesian framework, issues of design balance essentially evaporate.</p>
</section>
<section id="linear-mixed-effects-models" class="level2">
<h2 class="anchored" data-anchor-id="linear-mixed-effects-models">Linear mixed effects models</h2>
<p>Although the term “mixed-effects” can be used to refer to any design that incorporates both fixed and random predictors, its use is more commonly restricted to designs in which factors are nested or grouped within other factors. Typical examples include nested, longitudinal (measurements repeated over time) data, repeated measures and blocking designs. Furthermore, rather than basing parameter estimations on observed and expected mean squares or error strata (as outline above), mixed-effects models estimate parameters via <strong>maximum likelihood</strong> (ML) or <strong>residual maximum likelihood</strong> (REML). In so doing, mixed-effects models more appropriately handle estimation of parameters, effects and variance components of unbalanced designs (particularly for random effects). Resulting fitted (or expected) values of each level of a factor (for example, the expected population site means) are referred to as <em>Best Linear Unbiased Predictors</em> (BLUP’s). As an acknowledgement that most estimated site means will be more extreme than the underlying true population means they estimate (based on the principle that smaller sample sizes result in greater chances of more extreme observations and that nested sub-replicates are also likely to be highly intercorrelated), BLUP’s are less spread from the overall mean than are simple site means. In addition, mixed-effects models naturally model the “within-block” correlation structure that complicates many longitudinal designs.</p>
<p>Whilst the basic concepts of mixed-effects models have been around for a long time, recent computing advances and adoptions have greatly boosted the popularity of these procedures. Linear mixed effects models are currently at the forefront of statistical development, and as such, are very much a work in progress - both in theory and in practice. Recent developments have seen a further shift away from the traditional practices associated with degrees of freedom, probability distribution and p-value calculations. The traditional approach to inference testing is to compare the fit of an alternative (full) model to a null (reduced) model (via an F-ratio). When assumptions of normality and homogeneity of variance apply, the degrees of freedom are easily computed and the F-ratio has an exact F-distribution to which it can be compared. However, this approach introduces two additional problematic assumptions when estimating fixed effects in a mixed effects model. Firstly, when estimating the effects of one factor, the parameter estimates associated with other factor(s) are assumed to be the true values of those parameters (not estimates). Whilst this assumption is reasonable when all factors are fixed, as random factors are selected such that they represent one possible set of levels drawn from an entire population of possible levels for the random factor, it is unlikely that the associated parameter estimates accurately reflect the true values. Consequently, there is not necessarily an appropriate F-distribution. Furthermore, determining the appropriate degrees of freedom (nominally, the number of independent observations on which estimates are based) for models that incorporate a hierarchical structure is only possible under very specific circumstances (such as completely balanced designs). Degrees of freedom is a somewhat arbitrary defined concept used primarily to select a theoretical probability distribution on which a statistic can be compared. Arguably, however, it is a concept that is overly simplistic for complex hierarchical designs. Most statistical applications continue to provide the “approximate” solutions (as did earlier versions within <code>R</code>). However, <code>R</code> linear mixed effects development leaders argue strenuously that given the above shortcomings, such approximations are variably inappropriate and are thus omitted.</p>
<p><strong>Markov chain Monte Carlo</strong> (MCMC) sampling methods provide a Bayesian-like alternative for inference testing. Markov chains use the mixed model parameter estimates to generate posterior probability distributions of each parameter from which Monte Carlo sampling methods draw a large set of parameter samples. These parameter samples can then be used to calculate <em>highest posterior density</em> (HPD) intervals (also known as Bayesian credible intervals). Such intervals indicate the interval in which there is a specified probability (typically <span class="math inline">\(95\)</span>%) that the true population parameter lies. Furthermore, whilst technically against the spirit of the Bayesian philosophy, it is also possible to generate P values on which to base inferences.</p>
</section>
</section>
<section id="data-generation" class="level1">
<h1>Data generation</h1>
<p>Imagine we has designed an experiment in which we intend to measure a response (<span class="math inline">\(y\)</span>) to one of treatments (three levels; “a1”, “a2” and “a3”). The treatments occur at a spatial scale (over an area) that far exceeds the logistical scale of sampling units (it would take too long to sample at the scale at which the treatments were applied). The treatments occurred at the scale of hectares whereas it was only feasible to sample y using 1m quadrats. Given that the treatments were naturally occurring (such as soil type), it was not possible to have more than five sites of each treatment type, yet prior experience suggested that the sites in which you intended to sample were very uneven and patchy with respect to <span class="math inline">\(y\)</span>. In an attempt to account for this inter-site variability (and thus maximize the power of the test for the effect of treatment, you decided to employ a nested design in which 10 quadrats were randomly located within each of the five replicate sites per three treatments. As this section is mainly about the generation of artificial data (and not specifically about what to do with the data), understanding the actual details are optional and can be safely skipped.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>nTreat <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>nSites <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>nSitesPerTreat <span class="ot">&lt;-</span> nSites<span class="sc">/</span>nTreat</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>nQuads <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>site.sigma <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> nSites <span class="sc">*</span> nQuads</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>sites <span class="ot">&lt;-</span> <span class="fu">gl</span>(<span class="at">n=</span>nSites,<span class="at">k=</span>nQuads, <span class="at">lab=</span><span class="fu">paste0</span>(<span class="st">'S'</span>,<span class="dv">1</span><span class="sc">:</span>nSites))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">gl</span>(nTreat, nSitesPerTreat<span class="sc">*</span>nQuads, n, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">'a1'</span>,<span class="st">'a2'</span>,<span class="st">'a3'</span>))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>a.means <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">70</span>,<span class="dv">80</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="do">## the site means (treatment effects) are drawn from normal distributions</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="do">## with means of 40, 70 and 80 and standard deviations of 12</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>A.effects <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nSites, <span class="fu">rep</span>(a.means,<span class="at">each=</span>nSitesPerTreat),site.sigma)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">#A.effects &lt;- a.means %*% t(model.matrix(~A, data.frame(A=gl(nTreat,nSitesPerTreat,nSites))))+rnorm(nSites,0,site.sigma)</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>sites <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>lin.pred <span class="ot">&lt;-</span> Xmat <span class="sc">%*%</span> <span class="fu">c</span>(A.effects)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="do">## the quadrat observations (within sites) are drawn from</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="do">## normal distributions with means according to the site means</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="do">## and standard deviations of 5</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,lin.pred,sigma)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>data.nest <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y=</span>y, <span class="at">A=</span>A, <span class="at">Sites=</span>sites,<span class="at">Quads=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(y))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest)  <span class="co">#print out the first six rows of the data set</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA          y  A Sites Quads
NA 1 42.20886 a1    S1     1
NA 2 35.76354 a1    S1     2
NA 3 23.44121 a1    S1     3
NA 4 36.78107 a1    S1     4
NA 5 30.91034 a1    S1     5
NA 6 27.93517 a1    S1     6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.nest, <span class="fu">aes</span>(<span class="at">y=</span>y, <span class="at">x=</span><span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">geom_boxplot</span>() <span class="sc">+</span> <span class="fu">facet_grid</span>(.<span class="sc">~</span>Sites)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory data analysis</h2>
<p><strong>Normality and Homogeneity of variance</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Effects of treatment</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(y<span class="sc">~</span>A, <span class="fu">ddply</span>(data.nest, <span class="sc">~</span>A<span class="sc">+</span>Sites,<span class="fu">numcolwise</span>(mean, <span class="at">na.rm=</span>T)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Site effects</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(y<span class="sc">~</span>Sites, <span class="fu">ddply</span>(data.nest, <span class="sc">~</span>A<span class="sc">+</span>Sites<span class="sc">+</span>Quads,<span class="fu">numcolwise</span>(mean, <span class="at">na.rm=</span>T)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## with ggplot2</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">ddply</span>(data.nest, <span class="sc">~</span>A<span class="sc">+</span>Sites,<span class="fu">numcolwise</span>(mean, <span class="at">na.rm=</span>T)), <span class="fu">aes</span>(<span class="at">y=</span>y, <span class="at">x=</span>A)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Conclusions</strong>:</p>
<ul>
<li><p>there is no evidence that the response variable is consistently non-normal across all populations - each boxplot is approximately symmetrical.</p></li>
<li><p>there is no evidence that variance (as estimated by the height of the boxplots) differs between the five populations. More importantly, there is no evidence of a relationship between mean and variance - the height of boxplots does not increase with increasing position along the y-axis. Hence it there is no evidence of non-homogeneity.</p></li>
</ul>
<p>Obvious violations could be addressed either by:</p>
<ul>
<li>transform the scale of the response variables (to address normality, etc). Note transformations should be applied to the entire response variable (not just those populations that are skewed).</li>
</ul>
</section>
</section>
<section id="model-fitting" class="level1">
<h1>Model fitting</h1>
<p>For non-hierarchical linear models, uniform priors on variance (standard deviation) parameters seem to work reasonably well. <span class="citation" data-cites="gelman2006prior">Gelman et al. (<a href="#ref-gelman2006prior" role="doc-biblioref">2006</a>)</span> warns that the use of the inverse-gamma family of non-informative priors are very sensitive to ϵ particularly when variance is close to zero and this may lead to unintentionally informative priors. When the number of groups (treatments or varying/random effects) is large (more than <span class="math inline">\(5\)</span>), <span class="citation" data-cites="gelman2006prior">Gelman et al. (<a href="#ref-gelman2006prior" role="doc-biblioref">2006</a>)</span> advocated the use of either uniform or half-cauchy priors. Yet when the number of groups is low, <span class="citation" data-cites="gelman2006prior">Gelman et al. (<a href="#ref-gelman2006prior" role="doc-biblioref">2006</a>)</span> indicates that uniform priors have a tendency to result in inflated variance estimates. Consequently, half-cauchy priors are generally recommended for variances.</p>
<p><strong>Full parameterisation</strong></p>
<p><span class="math display">\[
y_{ijk} \sim N(\mu_{ij}, \sigma^2), \;\;\; \mu_{ij}=\alpha_0 + \alpha_i + \beta_{j(i)},
\]</span></p>
<p>where <span class="math inline">\(\beta_{ij)} \sim N(0, \sigma^2_B)\)</span>, <span class="math inline">\(\alpha_0, \alpha_i \sim N(0, 1000000)\)</span>, and <span class="math inline">\(\sigma^2, \sigma^2_B \sim \text{Cauchy(0, 25)}\)</span>. The <em>full parameterisation</em>, shows the effects parameterisation in which there is an intercept (<span class="math inline">\(\alpha_0\)</span>) and two treatment effects (<span class="math inline">\(\alpha_i\)</span>, where <span class="math inline">\(i\)</span> is <span class="math inline">\(1,2\)</span>).</p>
<p><strong>Matrix parameterisation</strong></p>
<p><span class="math display">\[
y_{ijk} \sim N(\mu_{ij}, \sigma^2), \;\;\; \mu_{ij}=\boldsymbol \alpha \boldsymbol X + \beta_{j(i)},
\]</span></p>
<p>where <span class="math inline">\(\beta_{ij} \sim N(0, \sigma^2_B)\)</span>, <span class="math inline">\(\boldsymbol \alpha \sim MVN(0, 1000000)\)</span>, and <span class="math inline">\(\sigma^2, \sigma^2_B \sim \text{Cauchy(0, 25)}\)</span>. The full parameterisation, shows the effects parameterisation in which there is an intercept (<span class="math inline">\(\alpha_0\)</span>) and two treatment effects (<span class="math inline">\(\alpha_i\)</span>, where <span class="math inline">\(i\)</span> is <span class="math inline">\(1,2\)</span>). The <em>matrix parameterisation</em> is a compressed notation, In this parameterisation, there are three alpha parameters (one representing the mean of treatment a1, and the other two representing the treatment effects (differences between a2 and a1 and a3 and a1). In generating priors for each of these three alpha parameters, we could loop through each and define a non-informative normal prior to each (as in the Full parameterisation version). However, it turns out that it is more efficient (in terms of mixing and thus the number of necessary iterations) to define the priors from a multivariate normal distribution. This has as many means as there are parameters to estimate (<span class="math inline">\(3\)</span>) and a <span class="math inline">\(3\times3\)</span> matrix of zeros and <span class="math inline">\(100\)</span> in the diagonals.</p>
<p><span class="math display">\[
\boldsymbol \mu =
  \begin{bmatrix} 0  \\ 0  \\ 0 \end{bmatrix}, \;\;\; \sigma^2 \sim   
  \begin{bmatrix}
   1000000 &amp; 0 &amp; 0 \\
   0 &amp; 1000000 &amp; 0 \\
   0 &amp; 0 &amp; 1000000
   \end{bmatrix}.
\]</span></p>
<p><strong>Hierarchical parameterisation</strong></p>
<p><span class="math display">\[
y_{ijk} \sim N(\beta_{i(j)}, \sigma^2), \;\;\; \beta_{i(j)}\sim N(\mu_i, \sigma^2_B),
\]</span></p>
<p>where <span class="math inline">\(\mu_i = \boldsymbol \alpha \boldsymbol X\)</span>, <span class="math inline">\(\alpha_i \sim N(0, 1000000)\)</span>, and <span class="math inline">\(\sigma^2, \sigma^2_B \sim \text{Cauchy(0, 25)}\)</span>. In the <em>heirarchical parameterisation</em>, we are indicating two residual layers - one representing the variability in the observed data between individual observations (within sites) and the second representing the variability between site means (within the three treatments).</p>
<section id="full-means-parameterisation" class="level2">
<h2 class="anchored" data-anchor-id="full-means-parameterisation">Full means parameterisation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>rstanString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int n;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int nA;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="st">   int nB;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [n] y;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">   int A[n];</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="st">   int B[n];</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha[nA];</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nB] beta;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_B;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="st"> </span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="st">    real mu[n];</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="st">    // Priors</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha ~ normal( 0 , 100 );</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal( 0 , sigma_B );</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_B ~ cauchy( 0 , 25 );</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma ~ cauchy( 0 , 25 );</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="st">    for ( i in 1:n ) {</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="st">        mu[i] = alpha[A[i]] + beta[B[i]];</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="st">    y ~ normal( mu , sigma );</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(rstanString, <span class="at">con =</span> <span class="st">"fullModel.stan"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Arrange the data as a list (as required by <code>Stan</code>). As input, <code>Stan</code> will need to be supplied with: the response variable, the predictor matrix, the number of predictors, the total number of observed items. This all needs to be contained within a list object. We will create two data lists, one for each of the hypotheses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data.nest.list <span class="ot">&lt;-</span> <span class="fu">with</span>(data.nest, <span class="fu">list</span>(<span class="at">y=</span>y, <span class="at">A=</span><span class="fu">as.numeric</span>(A), <span class="at">B=</span><span class="fu">as.numeric</span>(Sites),</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">n=</span><span class="fu">nrow</span>(data.nest), <span class="at">nB=</span><span class="fu">length</span>(<span class="fu">levels</span>(Sites)),<span class="at">nA=</span><span class="fu">length</span>(<span class="fu">levels</span>(A))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the nodes (parameters and derivatives) to monitor and the chain parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"alpha"</span>,<span class="st">"sigma"</span>,<span class="st">"sigma_B"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> burnInSteps<span class="sc">+</span><span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Start the <code>Stan</code> model (check the model, load data into the model, specify the number of chains and compile the model). Load the <code>rstan</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now run the <code>Stan</code> code via the <code>rstan</code> interface.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.c <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">data =</span> data.nest.list, <span class="at">file =</span> <span class="st">"fullModel.stan"</span>, <span class="at">chains =</span> nChains, <span class="at">pars =</span> params, <span class="at">iter =</span> nIter, <span class="at">warmup =</span> burnInSteps, <span class="at">thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
NA Chain 1: 
NA Chain 1: Gradient evaluation took 3.3e-05 seconds
NA Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.33 seconds.
NA Chain 1: Adjust your expectations accordingly!
NA Chain 1: 
NA Chain 1: 
NA Chain 1: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 1: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 1: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 1: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 1: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 1: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 1: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 1: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 1: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 1: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 1: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 1: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 1: 
NA Chain 1:  Elapsed Time: 0.682 seconds (Warm-up)
NA Chain 1:                0.37 seconds (Sampling)
NA Chain 1:                1.052 seconds (Total)
NA Chain 1: 
NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
NA Chain 2: 
NA Chain 2: Gradient evaluation took 8e-06 seconds
NA Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.08 seconds.
NA Chain 2: Adjust your expectations accordingly!
NA Chain 2: 
NA Chain 2: 
NA Chain 2: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 2: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 2: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 2: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 2: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 2: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 2: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 2: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 2: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 2: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 2: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 2: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 2: 
NA Chain 2:  Elapsed Time: 0.659 seconds (Warm-up)
NA Chain 2:                0.377 seconds (Sampling)
NA Chain 2:                1.036 seconds (Total)
NA Chain 2:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data.nest.rstan.c, <span class="at">par =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_B"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Stan model: anon_model.
NA 2 chains, each with iter=4500; warmup=3000; thin=1; 
NA post-warmup draws per chain=1500, total post-warmup draws=3000.
NA 
NA           mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
NA alpha[1] 41.90    0.19 5.62 30.38 38.19 41.93 45.39 53.23   866    1
NA alpha[2] 69.63    0.18 5.43 59.38 66.03 69.66 73.13 80.67   865    1
NA alpha[3] 82.69    0.17 5.49 71.08 79.24 82.76 86.26 93.08  1020    1
NA sigma     5.04    0.01 0.30  4.49  4.82  5.03  5.23  5.66  1693    1
NA sigma_B  11.73    0.08 2.78  7.76  9.78 11.22 13.12 18.49  1174    1
NA 
NA Samples were drawn using NUTS(diag_e) at Mon Jul 22 12:41:33 2024.
NA For each parameter, n_eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor on split chains (at 
NA convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.c.df <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">extract</span>(data.nest.rstan.c))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest.rstan.c.df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA    alpha.1  alpha.2  alpha.3    sigma   sigma_B      lp__
NA 1 34.66394 74.84391 83.33568 4.783857 11.030622 -355.9341
NA 2 38.10838 72.29916 82.46015 5.186627 10.425868 -355.7169
NA 3 33.98648 69.14414 95.22563 5.515138 11.765572 -360.1139
NA 4 35.26812 65.90908 84.96725 4.967946  7.948799 -354.9913
NA 5 30.38241 77.09534 84.52162 4.453866 12.540387 -358.2463
NA 6 40.79643 65.72887 86.83717 4.993259  8.487666 -353.6030</code></pre>
</div>
</div>
</section>
<section id="full-effect-parameterisation" class="level2">
<h2 class="anchored" data-anchor-id="full-effect-parameterisation">Full effect parameterisation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>rstan2String<span class="ot">=</span><span class="st">"</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int n;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int nB;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [n] y;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="st">   int A2[n];</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="st">   int A3[n];</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="st">   int B[n];</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha0;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha2;</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha3;</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nB] beta;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_B;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="st"> </span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="st">    real mu[n];</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="st">    // Priors</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha0 ~ normal( 0 , 100 );</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha2 ~ normal( 0 , 100 );</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha3 ~ normal( 0 , 100 );</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal( 0 , sigma_B );</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_B ~ cauchy( 0 , 25 );</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma ~ cauchy( 0 , 25 );</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="st">    for ( i in 1:n ) {</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="st">        mu[i] = alpha0 + alpha2*A2[i] + </span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="st">               alpha3*A3[i] + beta[B[i]];</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="st">    y ~ normal( mu , sigma );</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(rstan2String, <span class="at">con =</span> <span class="st">"full2Model.stan"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Arrange the data as a list (as required by <code>Stan</code>). As input, <code>Stan</code> will need to be supplied with: the response variable, the predictor matrix, the number of predictors, the total number of observed items. This all needs to be contained within a list object. We will create two data lists, one for each of the hypotheses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>A2 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data.nest<span class="sc">$</span>A<span class="sc">==</span><span class="st">'a2'</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>A3 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data.nest<span class="sc">$</span>A<span class="sc">==</span><span class="st">'a3'</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>data.nest.list <span class="ot">&lt;-</span> <span class="fu">with</span>(data.nest, <span class="fu">list</span>(<span class="at">y=</span>y, <span class="at">A2=</span>A2, <span class="at">A3=</span>A3, <span class="at">B=</span><span class="fu">as.numeric</span>(Sites),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">n=</span><span class="fu">nrow</span>(data.nest), <span class="at">nB=</span><span class="fu">length</span>(<span class="fu">levels</span>(Sites))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the nodes (parameters and derivatives) to monitor and the chain parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"alpha0"</span>,<span class="st">"alpha2"</span>,<span class="st">"alpha3"</span>,<span class="st">"sigma"</span>,<span class="st">"sigma_B"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> burnInSteps<span class="sc">+</span><span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now run the <code>Stan</code> code via the <code>rstan</code> interface.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.c2 <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">data =</span> data.nest.list, <span class="at">file =</span> <span class="st">"full2Model.stan"</span>, <span class="at">chains =</span> nChains, <span class="at">pars =</span> params, <span class="at">iter =</span> nIter, <span class="at">warmup =</span> burnInSteps, <span class="at">thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
NA Chain 1: 
NA Chain 1: Gradient evaluation took 3.3e-05 seconds
NA Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.33 seconds.
NA Chain 1: Adjust your expectations accordingly!
NA Chain 1: 
NA Chain 1: 
NA Chain 1: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 1: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 1: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 1: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 1: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 1: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 1: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 1: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 1: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 1: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 1: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 1: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 1: 
NA Chain 1:  Elapsed Time: 1.48 seconds (Warm-up)
NA Chain 1:                0.731 seconds (Sampling)
NA Chain 1:                2.211 seconds (Total)
NA Chain 1: 
NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
NA Chain 2: 
NA Chain 2: Gradient evaluation took 1.4e-05 seconds
NA Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.14 seconds.
NA Chain 2: Adjust your expectations accordingly!
NA Chain 2: 
NA Chain 2: 
NA Chain 2: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 2: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 2: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 2: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 2: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 2: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 2: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 2: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 2: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 2: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 2: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 2: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 2: 
NA Chain 2:  Elapsed Time: 1.632 seconds (Warm-up)
NA Chain 2:                1.047 seconds (Sampling)
NA Chain 2:                2.679 seconds (Total)
NA Chain 2:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data.nest.rstan.c2, <span class="at">par =</span> <span class="fu">c</span>(<span class="st">"alpha0"</span>, <span class="st">"alpha2"</span>, <span class="st">"alpha3"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_B"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Stan model: anon_model.
NA 2 chains, each with iter=4500; warmup=3000; thin=1; 
NA post-warmup draws per chain=1500, total post-warmup draws=3000.
NA 
NA          mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
NA alpha0  42.46    0.19 5.30 32.37 39.01 42.53 45.80 52.98   792    1
NA alpha2  27.25    0.28 7.67 11.75 22.68 27.36 32.25 41.95   750    1
NA alpha3  40.71    0.26 7.55 25.57 35.91 40.46 45.42 55.99   850    1
NA sigma    5.04    0.01 0.31  4.47  4.81  5.03  5.25  5.70  1239    1
NA sigma_B 11.54    0.09 2.65  7.69  9.70 11.09 12.92 18.04   779    1
NA 
NA Samples were drawn using NUTS(diag_e) at Mon Jul 22 12:42:12 2024.
NA For each parameter, n_eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor on split chains (at 
NA convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.c2.df <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">extract</span>(data.nest.rstan.c2))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest.rstan.c2.df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA     alpha0   alpha2   alpha3    sigma  sigma_B      lp__
NA 1 47.83462 26.07003 29.50999 5.543406 13.06805 -355.4811
NA 2 45.27770 25.90933 37.47072 5.470879 12.19998 -353.8504
NA 3 40.49191 35.16179 39.21332 5.767743 11.64687 -358.2453
NA 4 45.51317 26.64989 36.41803 5.613998 10.87368 -360.0820
NA 5 47.70665 21.64392 33.10168 4.785280 11.33905 -353.9069
NA 6 31.05164 43.27888 45.95428 4.722624 12.17590 -356.0434</code></pre>
</div>
</div>
</section>
<section id="matrix-parameterisation" class="level2">
<h2 class="anchored" data-anchor-id="matrix-parameterisation">Matrix parameterisation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>rstanString2<span class="ot">=</span><span class="st">"</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int n;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int nB;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="st">   int nA;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [n] y;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="st">   matrix [n,nA] X;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="st">   int B[n];</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [nA] a0;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="st">   matrix [nA,nA] A0;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nA] alpha;</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nB] beta;</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_B;</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="st"> </span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="st">    real mu[n];</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="st">    // Priors</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="st">    //alpha ~ normal( 0 , 100 );</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha ~ multi_normal(a0,A0);</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal( 0 , sigma_B );</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_B ~ cauchy( 0 , 25);</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma ~ cauchy( 0 , 25 );</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="st">    for ( i in 1:n ) {</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="st">        mu[i] = dot_product(X[i],alpha) + beta[B[i]];</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="st">    y ~ normal( mu , sigma );</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(rstanString2, <span class="at">con =</span> <span class="st">"matrixModel.stan"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Arrange the data as a list (as required by <code>Stan</code>). As input, <code>Stan</code> will need to be supplied with: the response variable, the predictor matrix, the number of predictors, the total number of observed items. This all needs to be contained within a list object. We will create two data lists, one for each of the hypotheses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>A, data.nest)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>nA <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>data.nest.list <span class="ot">&lt;-</span> <span class="fu">with</span>(data.nest, <span class="fu">list</span>(<span class="at">y=</span>y, <span class="at">X=</span>X, <span class="at">B=</span><span class="fu">as.numeric</span>(Sites),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">n=</span><span class="fu">nrow</span>(data.nest), <span class="at">nB=</span><span class="fu">length</span>(<span class="fu">levels</span>(Sites)), <span class="at">nA=</span>nA,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">a0=</span><span class="fu">rep</span>(<span class="dv">0</span>,nA), <span class="at">A0=</span><span class="fu">diag</span>(<span class="dv">100000</span>,nA)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the nodes (parameters and derivatives) to monitor and the chain parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"alpha"</span>,<span class="st">"sigma"</span>,<span class="st">"sigma_B"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> burnInSteps<span class="sc">+</span><span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now run the <code>Stan</code> code via the <code>rstan</code> interface.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.m <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">data =</span> data.nest.list, <span class="at">file =</span> <span class="st">"matrixModel.stan"</span>, <span class="at">chains =</span> nChains, <span class="at">pars =</span> params, <span class="at">iter =</span> nIter, <span class="at">warmup =</span> burnInSteps, <span class="at">thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
NA Chain 1: 
NA Chain 1: Gradient evaluation took 4.1e-05 seconds
NA Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.41 seconds.
NA Chain 1: Adjust your expectations accordingly!
NA Chain 1: 
NA Chain 1: 
NA Chain 1: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 1: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 1: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 1: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 1: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 1: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 1: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 1: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 1: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 1: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 1: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 1: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 1: 
NA Chain 1:  Elapsed Time: 1.714 seconds (Warm-up)
NA Chain 1:                1.076 seconds (Sampling)
NA Chain 1:                2.79 seconds (Total)
NA Chain 1: 
NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
NA Chain 2: 
NA Chain 2: Gradient evaluation took 1.4e-05 seconds
NA Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.14 seconds.
NA Chain 2: Adjust your expectations accordingly!
NA Chain 2: 
NA Chain 2: 
NA Chain 2: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 2: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 2: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 2: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 2: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 2: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 2: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 2: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 2: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 2: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 2: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 2: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 2: 
NA Chain 2:  Elapsed Time: 2.052 seconds (Warm-up)
NA Chain 2:                1.185 seconds (Sampling)
NA Chain 2:                3.237 seconds (Total)
NA Chain 2:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data.nest.rstan.m, <span class="at">par =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_B"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Stan model: anon_model.
NA 2 chains, each with iter=4500; warmup=3000; thin=1; 
NA post-warmup draws per chain=1500, total post-warmup draws=3000.
NA 
NA           mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
NA alpha[1] 41.97    0.21 5.56 30.65 38.51 41.99 45.45 53.17   700    1
NA alpha[2] 27.79    0.27 7.79 12.57 22.80 27.76 32.78 43.27   860    1
NA alpha[3] 41.44    0.28 7.77 25.51 36.54 41.54 46.56 56.74   782    1
NA sigma     5.04    0.01 0.32  4.47  4.81  5.03  5.24  5.71  1484    1
NA sigma_B  11.58    0.08 2.63  7.53  9.70 11.16 13.06 17.69  1012    1
NA 
NA Samples were drawn using NUTS(diag_e) at Mon Jul 22 12:42:50 2024.
NA For each parameter, n_eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor on split chains (at 
NA convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.m.df <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">extract</span>(data.nest.rstan.m))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest.rstan.m.df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA    alpha.1  alpha.2  alpha.3    sigma   sigma_B      lp__
NA 1 38.51260 28.65160 45.31224 5.234954  9.437163 -352.1193
NA 2 42.44434 27.88099 30.81416 4.885081 10.432388 -354.4981
NA 3 45.66044 15.23036 31.42478 4.916171 18.635395 -357.9730
NA 4 38.10635 29.53828 46.86861 4.890449  9.377387 -363.9728
NA 5 45.01428 21.53882 31.16592 4.814843  9.749733 -355.6716
NA 6 37.51673 39.07947 51.74908 4.770156  8.408097 -359.3753</code></pre>
</div>
</div>
</section>
<section id="hierarchical-parameterisation" class="level2">
<h2 class="anchored" data-anchor-id="hierarchical-parameterisation">Hierarchical parameterisation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>rstanString3<span class="ot">=</span><span class="st">"</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int n;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int nA;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="st">   int nSites;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [n] y;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="st">   matrix [nSites,nA] X;</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="st">   matrix [n,nSites] Z;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="st">   vector[nA] beta;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="st">   vector[nSites] gamma;</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="st">   real&lt;lower=0&gt; sigma;</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="st">   real&lt;lower=0&gt; sigma_S;</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="st"> </span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="st">    vector [n] mu_site;</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="st">    vector [nSites] mu;</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="st">    // Priors</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal( 0 , 1000 );</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="st">    gamma ~ normal( 0 , 1000 );</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma ~ cauchy( 0 , 25 );</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_S~ cauchy( 0 , 25 );</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="st">    mu_site = Z*gamma;</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="st">    y ~ normal( mu_site , sigma );</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="st">    mu = X*beta;</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="st">    gamma ~ normal(mu, sigma_S);</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(rstanString3, <span class="at">con =</span> <span class="st">"hierarchicalModel.stan"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Arrange the data as a list (as required by <code>Stan</code>). As input, <code>Stan</code> will need to be supplied with: the response variable, the predictor matrix, the number of predictors, the total number of observed items. This all needs to be contained within a list object. We will create two data lists, one for each of the hypotheses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>dt.A <span class="ot">&lt;-</span> <span class="fu">ddply</span>(data.nest,<span class="sc">~</span>Sites,<span class="fu">catcolwise</span>(unique))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>X<span class="ot">&lt;-</span><span class="fu">model.matrix</span>(<span class="sc">~</span>A, dt.A)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>Z<span class="ot">&lt;-</span><span class="fu">model.matrix</span>(<span class="sc">~</span>Sites<span class="dv">-1</span>, data.nest)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>data.nest.list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y=</span>data.nest<span class="sc">$</span>y, <span class="at">X=</span>X, <span class="at">Z=</span>Z, <span class="at">n=</span><span class="fu">nrow</span>(data.nest),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">nSites=</span><span class="fu">nrow</span>(X),<span class="at">nA=</span><span class="fu">ncol</span>(X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the nodes (parameters and derivatives) to monitor and the chain parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"beta"</span>,<span class="st">"sigma"</span>,<span class="st">"sigma_S"</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> burnInSteps<span class="sc">+</span><span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now run the <code>Stan</code> code via the <code>rstan</code> interface.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.h <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">data =</span> data.nest.list, <span class="at">file =</span> <span class="st">"hierarchicalModel.stan"</span>, <span class="at">chains =</span> nChains, <span class="at">pars =</span> params, <span class="at">iter =</span> nIter, <span class="at">warmup =</span> burnInSteps, <span class="at">thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
NA Chain 1: 
NA Chain 1: Gradient evaluation took 3.3e-05 seconds
NA Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.33 seconds.
NA Chain 1: Adjust your expectations accordingly!
NA Chain 1: 
NA Chain 1: 
NA Chain 1: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 1: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 1: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 1: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 1: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 1: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 1: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 1: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 1: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 1: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 1: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 1: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 1: 
NA Chain 1:  Elapsed Time: 0.248 seconds (Warm-up)
NA Chain 1:                0.089 seconds (Sampling)
NA Chain 1:                0.337 seconds (Total)
NA Chain 1: 
NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
NA Chain 2: 
NA Chain 2: Gradient evaluation took 1e-05 seconds
NA Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.1 seconds.
NA Chain 2: Adjust your expectations accordingly!
NA Chain 2: 
NA Chain 2: 
NA Chain 2: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 2: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 2: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 2: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 2: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 2: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 2: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 2: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 2: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 2: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 2: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 2: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 2: 
NA Chain 2:  Elapsed Time: 0.242 seconds (Warm-up)
NA Chain 2:                0.103 seconds (Sampling)
NA Chain 2:                0.345 seconds (Total)
NA Chain 2:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data.nest.rstan.h, <span class="at">par =</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_S"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Stan model: anon_model.
NA 2 chains, each with iter=4500; warmup=3000; thin=1; 
NA post-warmup draws per chain=1500, total post-warmup draws=3000.
NA 
NA          mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
NA beta[1] 42.39    0.13 5.42 31.60 38.77 42.40 45.95 52.81  1758    1
NA beta[2] 27.34    0.17 7.66 12.31 22.48 27.20 32.26 42.77  2089    1
NA beta[3] 40.91    0.17 7.74 25.75 35.93 40.89 45.73 56.32  2100    1
NA sigma    5.04    0.01 0.31  4.49  4.83  5.03  5.24  5.69  3058    1
NA sigma_S 11.51    0.05 2.62  7.59  9.65 11.13 12.86 17.92  2297    1
NA 
NA Samples were drawn using NUTS(diag_e) at Mon Jul 22 12:43:22 2024.
NA For each parameter, n_eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor on split chains (at 
NA convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.h.df <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">extract</span>(data.nest.rstan.h))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest.rstan.h.df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA     beta.1   beta.2   beta.3    sigma   sigma_S      lp__
NA 1 37.97267 19.74559 46.25986 4.486942 11.265958 -355.4335
NA 2 43.04120 22.90106 41.98754 5.236119  9.358648 -350.9895
NA 3 41.08867 34.12170 42.33801 5.183215 12.442448 -354.5326
NA 4 50.68459 16.02613 25.41038 5.002917 10.957330 -357.6446
NA 5 47.11724 15.21674 35.28746 5.426139 11.288743 -357.4966
NA 6 43.36194 26.12687 34.56285 5.336729  8.833431 -355.4301</code></pre>
</div>
</div>
<p>If you want to include finite-population standard deviations in the model you can use the following code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>rstanString4<span class="ot">=</span><span class="st">"</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int n;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int nA;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="st">   int nSites;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [n] y;</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="st">   matrix [nSites,nA] X;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="st">   matrix [n,nSites] Z;</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="st">   vector[nA] beta;</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="st">   vector[nSites] gamma;</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="st">   real&lt;lower=0&gt; sigma;</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="st">   real&lt;lower=0&gt; sigma_S;</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="st">    vector [n] mu_site;</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="st">    vector [nSites] mu;</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="st">    // Priors</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal( 0 , 1000 );</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="st">    gamma ~ normal( 0 , 1000 );</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma ~ cauchy( 0 , 25 );</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_S~ cauchy( 0 , 25 );</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="st">    mu_site = Z*gamma;</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="st">    y ~ normal( mu_site , sigma );</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="st">    mu = X*beta;</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="st">    gamma ~ normal(mu, sigma_S);</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a><span class="st">    vector [n] mu_site;</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="st">    vector [nSites] mu;</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="st">    vector [n] y_err;</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a><span class="st">    real sd_y;</span></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a><span class="st">    vector [nSites] mu_site_err;</span></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="st">    real sd_site;</span></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a><span class="st">    real sd_A;</span></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a><span class="st">    mu_site = Z*gamma;</span></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="st">    y_err = mu_site - y;</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a><span class="st">    sd_y = sd(y_err);</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="st">    mu = X*beta;</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a><span class="st">    mu_site_err = mu - gamma;</span></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a><span class="st">    sd_site = sd(mu_site_err);</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a><span class="st">    sd_A = sd(beta);</span></span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(rstanString4, <span class="at">con =</span> <span class="st">"SDModel.stan"</span>)</span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a><span class="co">#data list</span></span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>dt.A <span class="ot">&lt;-</span> <span class="fu">ddply</span>(data.nest,<span class="sc">~</span>Sites,<span class="fu">catcolwise</span>(unique))</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>X<span class="ot">&lt;-</span><span class="fu">model.matrix</span>(<span class="sc">~</span>A, dt.A)</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>Z<span class="ot">&lt;-</span><span class="fu">model.matrix</span>(<span class="sc">~</span>Sites<span class="dv">-1</span>, data.nest)</span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>data.nest.list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y=</span>data.nest<span class="sc">$</span>y, <span class="at">X=</span>X, <span class="at">Z=</span>Z, <span class="at">n=</span><span class="fu">nrow</span>(data.nest),</span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>   <span class="at">nSites=</span><span class="fu">nrow</span>(X),<span class="at">nA=</span><span class="fu">ncol</span>(X))</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a><span class="co">#parameters and chain details</span></span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'beta'</span>,<span class="st">'sigma'</span>,<span class="st">'sigma_S'</span>,<span class="st">'sd_A'</span>,<span class="st">'sd_site'</span>,<span class="st">'sd_y'</span>)</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a>adaptSteps <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> burnInSteps<span class="sc">+</span><span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.SD <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">data =</span> data.nest.list, <span class="at">file =</span> <span class="st">"SDModel.stan"</span>, <span class="at">chains =</span> nChains, <span class="at">pars =</span> params, <span class="at">iter =</span> nIter, <span class="at">warmup =</span> burnInSteps, <span class="at">thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
NA Chain 1: 
NA Chain 1: Gradient evaluation took 3.3e-05 seconds
NA Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.33 seconds.
NA Chain 1: Adjust your expectations accordingly!
NA Chain 1: 
NA Chain 1: 
NA Chain 1: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 1: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 1: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 1: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 1: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 1: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 1: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 1: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 1: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 1: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 1: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 1: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 1: 
NA Chain 1:  Elapsed Time: 0.249 seconds (Warm-up)
NA Chain 1:                0.115 seconds (Sampling)
NA Chain 1:                0.364 seconds (Total)
NA Chain 1: 
NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
NA Chain 2: 
NA Chain 2: Gradient evaluation took 1.1e-05 seconds
NA Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.11 seconds.
NA Chain 2: Adjust your expectations accordingly!
NA Chain 2: 
NA Chain 2: 
NA Chain 2: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 2: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 2: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 2: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 2: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 2: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 2: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 2: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 2: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 2: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 2: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 2: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 2: 
NA Chain 2:  Elapsed Time: 0.247 seconds (Warm-up)
NA Chain 2:                0.113 seconds (Sampling)
NA Chain 2:                0.36 seconds (Total)
NA Chain 2:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data.nest.rstan.SD, <span class="at">par =</span> <span class="fu">c</span>(<span class="st">'beta'</span>,<span class="st">'sigma'</span>,<span class="st">'sigma_S'</span>,<span class="st">'sd_A'</span>,<span class="st">'sd_site'</span>,<span class="st">'sd_y'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Stan model: anon_model.
NA 2 chains, each with iter=4500; warmup=3000; thin=1; 
NA post-warmup draws per chain=1500, total post-warmup draws=3000.
NA 
NA          mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
NA beta[1] 42.38    0.10 5.21 31.59 39.13 42.35 45.65 52.59  2861    1
NA beta[2] 27.42    0.13 7.35 12.38 22.67 27.53 32.19 42.08  3205    1
NA beta[3] 40.80    0.14 7.63 25.26 36.06 40.92 45.51 55.99  3090    1
NA sigma    5.04    0.01 0.31  4.48  4.83  5.03  5.25  5.70  3330    1
NA sigma_S 11.53    0.05 2.61  7.70  9.61 11.11 12.96 17.74  2592    1
NA sd_A    10.20    0.09 4.36  2.89  7.14  9.79 12.63 20.38  2148    1
NA sd_site 10.67    0.03 1.08  9.27  9.95 10.43 11.12 13.40  1385    1
NA sd_y     5.00    0.00 0.10  4.85  4.93  4.99  5.06  5.23  1269    1
NA 
NA Samples were drawn using NUTS(diag_e) at Mon Jul 22 12:43:55 2024.
NA For each parameter, n_eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor on split chains (at 
NA convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>data.nest.rstan.SD.df <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">extract</span>(data.nest.rstan.SD))</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest.rstan.SD.df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA     beta.1   beta.2   beta.3    sigma  sigma_S     sd_A   sd_site     sd_y
NA 1 44.26601 29.36915 37.10326 5.296506 13.05594 7.450252  9.905245 4.890486
NA 2 42.18142 32.66489 37.72024 5.022314 12.72271 4.761357 10.325405 4.927700
NA 3 39.63720 28.41220 44.19112 4.902748  8.36598 8.121100  9.584279 4.940438
NA 4 39.76594 39.67555 47.83435 4.457138 13.66167 4.684609 11.376652 4.976266
NA 5 35.87241 34.38392 37.95117 5.496118 12.26217 1.791749 10.397791 4.946690
NA 6 38.79789 31.78442 45.31698 5.063085 10.51038 6.767781 10.070051 4.980664
NA        lp__
NA 1 -352.4128
NA 2 -352.8046
NA 3 -352.5025
NA 4 -357.9645
NA 5 -356.4320
NA 6 -354.2973</code></pre>
</div>
</div>
</section>
</section>
<section id="data-generation---second-example" class="level1">
<h1>Data generation - second example</h1>
<p>Now imagine a similar experiment in which we intend to measure a response (<span class="math inline">\(y\)</span>) to one of treatments (three levels; “a1”, “a2” and “a3”). As with the previous design, we decided to establish a nested design in which there are sub-replicate (<span class="math inline">\(1\)</span>m Quadrats) within each Site. In the current design, we have decided to further sub-replicate. Within each of the <span class="math inline">\(5\)</span> Quadrats, we are going to randomly place <span class="math inline">\(2\times10\)</span>cm pit traps. Now we have Sites nested within Treatments, Quadrats nested within Sites AND, Pits nested within Sites. The latter of these (Pits nested within Sites) are the observations (<span class="math inline">\(y\)</span>). As this section is mainly about the generation of artificial data (and not specifically about what to do with the data), understanding the actual details are optional and can be safely skipped.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>nTreat <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>nSites <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>nSitesPerTreat <span class="ot">&lt;-</span> nSites<span class="sc">/</span>nTreat</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>nQuads <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>nPits <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>site.sigma <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># sd within between sites within treatment</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>quad.sigma <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fl">7.5</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> nSites <span class="sc">*</span> nQuads <span class="sc">*</span> nPits</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>sites <span class="ot">&lt;-</span> <span class="fu">gl</span>(<span class="at">n=</span>nSites,n<span class="sc">/</span>nSites,n, <span class="at">lab=</span><span class="fu">paste</span>(<span class="st">"site"</span>,<span class="dv">1</span><span class="sc">:</span>nSites))</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">gl</span>(nTreat, n<span class="sc">/</span>nTreat, n, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">'a1'</span>,<span class="st">'a2'</span>,<span class="st">'a3'</span>))</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>a.means <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">70</span>,<span class="dv">80</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co">#A&lt;-gl(nTreat,nSites/nTreat,nSites,labels=c('a1','a2','a3'))</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>a<span class="ot">&lt;-</span><span class="fu">gl</span>(nTreat,<span class="dv">1</span>,nTreat,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">'a1'</span>,<span class="st">'a2'</span>,<span class="st">'a3'</span>))</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>a.X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>a, <span class="fu">expand.grid</span>(a))</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>a.eff <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">solve</span>(a.X,a.means))</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>site.means <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nSites,a.X <span class="sc">%*%</span> a.eff,site.sigma)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">gl</span>(nTreat,nSites<span class="sc">/</span>nTreat,nSites,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">'a1'</span>,<span class="st">'a2'</span>,<span class="st">'a3'</span>))</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>A.X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>A, <span class="fu">expand.grid</span>(A))</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="co">#a.X &lt;- model.matrix(~A, expand.grid(A=gl(nTreat,nSites/nTreat,nSites,labels=c('a1','a2','a3'))))</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>site.means <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nSites,A.X <span class="sc">%*%</span> a.eff,site.sigma)</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>SITES <span class="ot">&lt;-</span> <span class="fu">gl</span>(nSites,(nSites<span class="sc">*</span>nQuads)<span class="sc">/</span>nSites,nSites<span class="sc">*</span>nQuads,<span class="at">labels=</span><span class="fu">paste</span>(<span class="st">'site'</span>,<span class="dv">1</span><span class="sc">:</span>nSites))</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>sites.X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>SITES<span class="dv">-1</span>)</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>quad.means <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nSites<span class="sc">*</span>nQuads,sites.X <span class="sc">%*%</span> site.means,quad.sigma)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="co">#SITES &lt;- gl(nSites,1,nSites,labels=paste('site',1:nSites))</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a><span class="co">#sites.X &lt;- model.matrix(~SITES-1)</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="co">#quad.means &lt;- rnorm(nSites*nQuads,sites.X %*% site.means,quad.sigma)</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>QUADS <span class="ot">&lt;-</span> <span class="fu">gl</span>(nSites<span class="sc">*</span>nQuads,n<span class="sc">/</span>(nSites<span class="sc">*</span>nQuads),n,<span class="at">labels=</span><span class="fu">paste</span>(<span class="st">'quad'</span>,<span class="dv">1</span><span class="sc">:</span>(nSites<span class="sc">*</span>nQuads)))</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>quads.X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>QUADS<span class="dv">-1</span>)</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="co">#quads.eff &lt;- as.vector(solve(quads.X,quad.means))</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="co">#pit.means &lt;- rnorm(n,quads.eff %*% t(quads.X),sigma)</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>pit.means <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,quads.X <span class="sc">%*%</span> quad.means,sigma)</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>PITS <span class="ot">&lt;-</span> <span class="fu">gl</span>(nPits<span class="sc">*</span>nSites<span class="sc">*</span>nQuads,<span class="dv">1</span>, n, <span class="at">labels=</span><span class="fu">paste</span>(<span class="st">'pit'</span>,<span class="dv">1</span><span class="sc">:</span>(nPits<span class="sc">*</span>nSites<span class="sc">*</span>nQuads)))</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>data.nest1<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Pits=</span>PITS,<span class="at">Quads=</span>QUADS,<span class="at">Sites=</span><span class="fu">rep</span>(SITES,<span class="at">each=</span><span class="dv">2</span>), <span class="at">A=</span><span class="fu">rep</span>(A,<span class="at">each=</span>nQuads<span class="sc">*</span>nPits),<span class="at">y=</span>pit.means)</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="co">#data.nest1&lt;-data.nest1[order(data.nest1$A,data.nest1$Sites,data.nest1$Quads),]</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest1)  <span class="co">#print out the first six rows of the data set</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA    Pits  Quads  Sites  A        y
NA 1 pit 1 quad 1 site 1 a1 61.79607
NA 2 pit 2 quad 1 site 1 a1 56.24699
NA 3 pit 3 quad 2 site 1 a1 42.40885
NA 4 pit 4 quad 2 site 1 a1 52.06672
NA 5 pit 5 quad 3 site 1 a1 73.71286
NA 6 pit 6 quad 3 site 1 a1 62.50529</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.nest1, <span class="fu">aes</span>(<span class="at">y=</span>y, <span class="at">x=</span><span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">geom_boxplot</span>() <span class="sc">+</span> <span class="fu">facet_grid</span>(.<span class="sc">~</span>Quads)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="exploratory-data-analysis-1" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis-1">Exploratory data analysis</h2>
<p><strong>Normality and Homogeneity of variance</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Effects of treatment</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(y<span class="sc">~</span>A, <span class="fu">ddply</span>(data.nest1, <span class="sc">~</span>A<span class="sc">+</span>Sites,<span class="fu">numcolwise</span>(mean, <span class="at">na.rm=</span>T)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Site effects</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(y<span class="sc">~</span>Sites, <span class="fu">ddply</span>(data.nest1, <span class="sc">~</span>A<span class="sc">+</span>Sites<span class="sc">+</span>Quads,<span class="fu">numcolwise</span>(mean, <span class="at">na.rm=</span>T)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-25-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Quadrat effects</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(y<span class="sc">~</span>Quads, <span class="fu">ddply</span>(data.nest1, <span class="sc">~</span>A<span class="sc">+</span>Sites<span class="sc">+</span>Quads<span class="sc">+</span>Pits,<span class="fu">numcolwise</span>(mean, <span class="at">na.rm=</span>T)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-25-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Conclusions</strong>:</p>
<ul>
<li><p>there is no evidence that the response variable is consistently non-normal across all populations - each boxplot is approximately symmetrical.</p></li>
<li><p>there is no evidence that variance (as estimated by the height of the boxplots) differs between the five populations. More importantly, there is no evidence of a relationship between mean and variance - the height of boxplots does not increase with increasing position along the <span class="math inline">\(y\)</span>-axis. Hence it there is no evidence of non-homogeneity.</p></li>
<li><p>it is a little difficult to assess normality/homogeneity of variance of quadrats since there are only two pits per quadrat. Nevertheless, there is no suggestion that variance increases with increasing mean.</p></li>
</ul>
<p>Obvious violations could be addressed either by:</p>
<ul>
<li>transform the scale of the response variables (to address normality, etc). Note transformations should be applied to the entire response variable (not just those populations that are skewed).</li>
</ul>
</section>
</section>
<section id="model-fitting-1" class="level1">
<h1>Model fitting</h1>
<section id="frequentist-for-comparison" class="level2">
<h2 class="anchored" data-anchor-id="frequentist-for-comparison">Frequentist for comparison</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>d.lme <span class="ot">&lt;-</span> <span class="fu">lme</span>(y <span class="sc">~</span> A, <span class="at">random=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>Sites<span class="sc">/</span>Quads,<span class="at">data=</span>data.nest1)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(d.lme)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Linear mixed-effects model fit by REML
NA   Data: data.nest1 
NA        AIC      BIC   logLik
NA   1137.994 1155.937 -562.997
NA 
NA Random effects:
NA  Formula: ~1 | Sites
NA         (Intercept)
NA StdDev:    10.38249
NA 
NA  Formula: ~1 | Quads %in% Sites
NA         (Intercept) Residual
NA StdDev:    8.441617 7.161177
NA 
NA Fixed effects:  y ~ A 
NA                Value Std.Error DF  t-value p-value
NA (Intercept) 41.38646  5.043341 75 8.206159  0.0000
NA Aa2         21.36271  7.132361 12 2.995180  0.0112
NA Aa3         39.14584  7.132361 12 5.488482  0.0001
NA  Correlation: 
NA     (Intr) Aa2   
NA Aa2 -0.707       
NA Aa3 -0.707  0.500
NA 
NA Standardized Within-Group Residuals:
NA         Min          Q1         Med          Q3         Max 
NA -2.11852502 -0.54600753 -0.03428581  0.53382436  2.26256392 
NA 
NA Number of Observations: 150
NA Number of Groups: 
NA            Sites Quads %in% Sites 
NA               15               75</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(d.lme)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA             numDF denDF  F-value p-value
NA (Intercept)     1    75 446.9150  &lt;.0001
NA A               2    12  15.1037   5e-04</code></pre>
</div>
</div>
</section>
<section id="full-effect-parameterisation-1" class="level2">
<h2 class="anchored" data-anchor-id="full-effect-parameterisation-1">Full effect parameterisation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>rstanString<span class="ot">=</span><span class="st">"</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int n;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int nSite;</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="st">   int nQuad;</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [n] y;</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="st">   int A2[n];</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="st">   int A3[n];</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="st">   int Site[n];</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="st">   int Quad[n];</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha0;</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha2;</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha3;</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nSite] beta_Site;</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_Site;</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nQuad] beta_Quad;</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_Quad;</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="st"> </span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="st">    real mu[n];</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="st">    // Priors</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha0 ~ normal( 0 , 100 );</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha2 ~ normal( 0 , 100 );</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha3 ~ normal( 0 , 100 );</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="st">    beta_Site~ normal( 0 , sigma_Site );</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_Site ~ cauchy( 0 , 25 );</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a><span class="st">    beta_Quad~ normal( 0 , sigma_Quad );</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_Quad ~ cauchy( 0 , 25 );</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma ~ cauchy( 0 , 25 );</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a><span class="st">    for ( i in 1:n ) {</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a><span class="st">        mu[i] = alpha0 + alpha2*A2[i] + </span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a><span class="st">               alpha3*A3[i] + beta_Site[Site[i]] + beta_Quad[Quad[i]];</span></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a><span class="st">    y ~ normal( mu , sigma );</span></span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(rstanString, <span class="at">con =</span> <span class="st">"fullModel2.stan"</span>)</span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>A2 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data.nest1<span class="sc">$</span>A<span class="sc">==</span><span class="st">'a2'</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>A3 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data.nest1<span class="sc">$</span>A<span class="sc">==</span><span class="st">'a3'</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>data.nest.list <span class="ot">&lt;-</span> <span class="fu">with</span>(data.nest1, <span class="fu">list</span>(<span class="at">y=</span>y, <span class="at">A2=</span>A2, <span class="at">A3=</span>A3, <span class="at">Site=</span><span class="fu">as.numeric</span>(Sites),</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>   <span class="at">n=</span><span class="fu">nrow</span>(data.nest1), <span class="at">nSite=</span><span class="fu">length</span>(<span class="fu">levels</span>(Sites)),</span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>   <span class="at">nQuad=</span><span class="fu">length</span>(<span class="fu">levels</span>(Quads)), <span class="at">Quad=</span><span class="fu">as.numeric</span>(Quads)))</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'alpha0'</span>,<span class="st">'alpha2'</span>,<span class="st">'alpha3'</span>,<span class="st">'sigma'</span>,<span class="st">'sigma_Site'</span>, <span class="st">'sigma_Quad'</span>)</span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> burnInSteps<span class="sc">+</span><span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>data.nest1.rstan.f <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">data =</span> data.nest.list, <span class="at">file =</span> <span class="st">"fullModel2.stan"</span>, <span class="at">chains =</span> nChains, <span class="at">pars =</span> params, <span class="at">iter =</span> nIter, <span class="at">warmup =</span> burnInSteps, <span class="at">thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
NA Chain 1: 
NA Chain 1: Gradient evaluation took 3.4e-05 seconds
NA Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.34 seconds.
NA Chain 1: Adjust your expectations accordingly!
NA Chain 1: 
NA Chain 1: 
NA Chain 1: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 1: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 1: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 1: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 1: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 1: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 1: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 1: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 1: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 1: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 1: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 1: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 1: 
NA Chain 1:  Elapsed Time: 3.081 seconds (Warm-up)
NA Chain 1:                2.472 seconds (Sampling)
NA Chain 1:                5.553 seconds (Total)
NA Chain 1: 
NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
NA Chain 2: 
NA Chain 2: Gradient evaluation took 1.9e-05 seconds
NA Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds.
NA Chain 2: Adjust your expectations accordingly!
NA Chain 2: 
NA Chain 2: 
NA Chain 2: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 2: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 2: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 2: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 2: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 2: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 2: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 2: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 2: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 2: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 2: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 2: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 2: 
NA Chain 2:  Elapsed Time: 2.708 seconds (Warm-up)
NA Chain 2:                2.875 seconds (Sampling)
NA Chain 2:                5.583 seconds (Total)
NA Chain 2:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data.nest1.rstan.f, <span class="at">par =</span> <span class="fu">c</span>(<span class="st">'alpha0'</span>,<span class="st">'alpha2'</span>,<span class="st">'alpha3'</span>,<span class="st">'sigma'</span>,<span class="st">'sigma_Site'</span>, <span class="st">'sigma_Quad'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Stan model: anon_model.
NA 2 chains, each with iter=4500; warmup=3000; thin=1; 
NA post-warmup draws per chain=1500, total post-warmup draws=3000.
NA 
NA             mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
NA alpha0     41.57    0.14 5.72 30.27 37.98 41.42 45.26 52.74  1614    1
NA alpha2     21.23    0.21 8.21  5.01 16.18 21.30 26.33 37.63  1515    1
NA alpha3     38.58    0.19 7.88 21.98 33.85 38.54 43.57 54.66  1750    1
NA sigma       7.28    0.01 0.61  6.18  6.86  7.25  7.69  8.56  1892    1
NA sigma_Site 11.33    0.07 3.00  6.76  9.28 10.96 12.94 18.46  1937    1
NA sigma_Quad  8.60    0.03 1.16  6.53  7.80  8.54  9.34 11.06  1688    1
NA 
NA Samples were drawn using NUTS(diag_e) at Mon Jul 22 12:44:39 2024.
NA For each parameter, n_eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor on split chains (at 
NA convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>data.nest1.rstan.f.df <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">extract</span>(data.nest1.rstan.f))</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest1.rstan.f.df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA     alpha0   alpha2   alpha3    sigma sigma_Site sigma_Quad      lp__
NA 1 42.75689 18.78058 40.83975 6.864756   9.238436   8.184025 -599.4890
NA 2 38.59912 22.03675 41.22345 7.177420   8.068274   7.236541 -601.9102
NA 3 49.30184 16.27629 25.40227 7.029283  12.095883   9.013823 -605.9202
NA 4 35.43777 24.99815 41.62737 8.155809  10.740356   9.575282 -610.5900
NA 5 46.74108 16.50691 35.65499 6.641079  10.477957   8.424534 -592.3729
NA 6 45.12399 15.84058 38.70849 6.232023  13.835963   7.301801 -610.0283</code></pre>
</div>
</div>
</section>
<section id="matrix-parameterisation-1" class="level2">
<h2 class="anchored" data-anchor-id="matrix-parameterisation-1">Matrix parameterisation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>rstanString2<span class="ot">=</span><span class="st">"</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="st">   int n;</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="st">   int nSite;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="st">   int nQuad;</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="st">   int nA;</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [n] y;</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="st">   matrix [n,nA] X;</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="st">   int Site[n];</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="st">   int Quad[n];</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="st">   vector [nA] a0;</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="st">   matrix [nA,nA] A0;</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="st">parameters{</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nA] alpha;</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nSite] beta_Site;</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_Site;</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a><span class="st">  vector [nQuad] beta_Quad;</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_Quad;</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a><span class="st"> </span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a><span class="st">    real mu[n];</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a><span class="st">    // Priors</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a><span class="st">    //alpha ~ normal( 0 , 100 );</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha ~ multi_normal(a0,A0);</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="st">    beta_Site ~ normal( 0 , sigma_Site );</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_Site ~ cauchy( 0 , 25);</span></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a><span class="st">    beta_Quad ~ normal( 0 , sigma_Quad );</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_Quad ~ cauchy( 0 , 25);</span></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma ~ cauchy( 0 , 25 );</span></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a><span class="st">    for ( i in 1:n ) {</span></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a><span class="st">        mu[i] = dot_product(X[i],alpha) + beta_Site[Site[i]] + beta_Quad[Quad[i]];</span></span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a><span class="st">    y ~ normal( mu , sigma );</span></span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a><span class="do">## write the model to a text file</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(rstanString2, <span class="at">con =</span> <span class="st">"matrixModel2.stan"</span>)</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>A, data.nest)</span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>nA <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>data.nest.list <span class="ot">&lt;-</span> <span class="fu">with</span>(data.nest1, <span class="fu">list</span>(<span class="at">y=</span>y, <span class="at">X=</span>X, <span class="at">Site=</span><span class="fu">as.numeric</span>(Sites),</span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>   <span class="at">Quad=</span><span class="fu">as.numeric</span>(Quads),</span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>   <span class="at">n=</span><span class="fu">nrow</span>(data.nest1), <span class="at">nSite=</span><span class="fu">length</span>(<span class="fu">levels</span>(Sites)),</span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>   <span class="at">nQuad=</span><span class="fu">length</span>(<span class="fu">levels</span>(Quads)),</span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>   <span class="at">nA=</span>nA,</span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a>   <span class="at">a0=</span><span class="fu">rep</span>(<span class="dv">0</span>,nA), <span class="at">A0=</span><span class="fu">diag</span>(<span class="dv">100000</span>,nA)))</span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'alpha'</span>,<span class="st">'sigma'</span>,<span class="st">'sigma_Site'</span>, <span class="st">'sigma_Quad'</span>)</span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a>burnInSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a>nChains <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a>numSavedSteps <span class="ot">=</span> <span class="dv">3000</span></span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a>thinSteps <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>nIter <span class="ot">=</span> burnInSteps<span class="sc">+</span><span class="fu">ceiling</span>((numSavedSteps <span class="sc">*</span> thinSteps)<span class="sc">/</span>nChains)</span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a>data.nest1.rstan.m2 <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">data =</span> data.nest.list, <span class="at">file =</span> <span class="st">"matrixModel2.stan"</span>, <span class="at">chains =</span> nChains, <span class="at">pars =</span> params, <span class="at">iter =</span> nIter, <span class="at">warmup =</span> burnInSteps, <span class="at">thin =</span> thinSteps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
NA Chain 1: 
NA Chain 1: Gradient evaluation took 4.7e-05 seconds
NA Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.47 seconds.
NA Chain 1: Adjust your expectations accordingly!
NA Chain 1: 
NA Chain 1: 
NA Chain 1: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 1: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 1: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 1: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 1: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 1: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 1: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 1: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 1: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 1: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 1: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 1: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 1: 
NA Chain 1:  Elapsed Time: 2.162 seconds (Warm-up)
NA Chain 1:                1.431 seconds (Sampling)
NA Chain 1:                3.593 seconds (Total)
NA Chain 1: 
NA 
NA SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
NA Chain 2: 
NA Chain 2: Gradient evaluation took 1.4e-05 seconds
NA Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.14 seconds.
NA Chain 2: Adjust your expectations accordingly!
NA Chain 2: 
NA Chain 2: 
NA Chain 2: Iteration:    1 / 4500 [  0%]  (Warmup)
NA Chain 2: Iteration:  450 / 4500 [ 10%]  (Warmup)
NA Chain 2: Iteration:  900 / 4500 [ 20%]  (Warmup)
NA Chain 2: Iteration: 1350 / 4500 [ 30%]  (Warmup)
NA Chain 2: Iteration: 1800 / 4500 [ 40%]  (Warmup)
NA Chain 2: Iteration: 2250 / 4500 [ 50%]  (Warmup)
NA Chain 2: Iteration: 2700 / 4500 [ 60%]  (Warmup)
NA Chain 2: Iteration: 3001 / 4500 [ 66%]  (Sampling)
NA Chain 2: Iteration: 3450 / 4500 [ 76%]  (Sampling)
NA Chain 2: Iteration: 3900 / 4500 [ 86%]  (Sampling)
NA Chain 2: Iteration: 4350 / 4500 [ 96%]  (Sampling)
NA Chain 2: Iteration: 4500 / 4500 [100%]  (Sampling)
NA Chain 2: 
NA Chain 2:  Elapsed Time: 2.231 seconds (Warm-up)
NA Chain 2:                1.191 seconds (Sampling)
NA Chain 2:                3.422 seconds (Total)
NA Chain 2:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(data.nest1.rstan.m2, <span class="at">par =</span> <span class="fu">c</span>(<span class="st">'alpha'</span>,<span class="st">'sigma'</span>,<span class="st">'sigma_Site'</span>, <span class="st">'sigma_Quad'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA Inference for Stan model: anon_model.
NA 2 chains, each with iter=4500; warmup=3000; thin=1; 
NA post-warmup draws per chain=1500, total post-warmup draws=3000.
NA 
NA             mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
NA alpha[1]   41.39    0.16 5.62 29.81 38.00 41.41 44.96 52.01  1183    1
NA alpha[2]   21.23    0.21 7.88  5.61 16.10 21.25 26.34 36.70  1399    1
NA alpha[3]   39.05    0.22 8.01 23.57 34.01 39.05 44.01 54.87  1303    1
NA sigma       7.29    0.01 0.61  6.23  6.87  7.26  7.68  8.54  1638    1
NA sigma_Site 11.44    0.08 3.14  6.76  9.34 11.00 12.98 18.57  1509    1
NA sigma_Quad  8.56    0.03 1.13  6.54  7.76  8.48  9.29 10.93  1704    1
NA 
NA Samples were drawn using NUTS(diag_e) at Mon Jul 22 12:45:19 2024.
NA For each parameter, n_eff is a crude measure of effective sample size,
NA and Rhat is the potential scale reduction factor on split chains (at 
NA convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>data.nest1.rstan.m2.df <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">extract</span>(data.nest1.rstan.m2))</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.nest1.rstan.m2.df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NA    alpha.1  alpha.2  alpha.3    sigma sigma_Site sigma_Quad      lp__
NA 1 45.46429 15.67815 32.24059 8.029760  15.517948   8.471629 -611.0464
NA 2 43.55070 13.67668 34.26886 8.049030  12.398252   6.753086 -605.1953
NA 3 46.52918 16.82928 35.08262 8.001375  14.637084   6.799795 -613.9694
NA 4 47.98525 21.02618 28.33026 6.677800   8.867418   9.866074 -604.2998
NA 5 50.02583 18.74219 29.08627 6.694833  14.597826   6.932240 -593.2225
NA 6 40.88942 22.87433 39.15047 8.547485   9.473757   8.468906 -599.5212</code></pre>
</div>
</div>
</section>
</section>
<section id="references" class="level1">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-gelman2006prior" class="csl-entry" role="listitem">
Gelman, Andrew et al. 2006. <span>“Prior Distributions for Variance Parameters in Hierarchical Models (Comment on Article by Browne and Draper).”</span> <em>Bayesian Analysis</em> 1 (3): 515–34.
</div>
<div id="ref-gelman2015stan" class="csl-entry" role="listitem">
Gelman, Andrew, Daniel Lee, and Jiqiang Guo. 2015. <span>“Stan: A Probabilistic Programming Language for Bayesian Inference and Optimization.”</span> <em>Journal of Educational and Behavioral Statistics</em> 40 (5): 530–43.
</div>
<div id="ref-rstanpackage" class="csl-entry" role="listitem">
Stan Development Team. 2018. <span>“<span>RStan</span>: The <span>R</span> Interface to <span>Stan</span>.”</span> <a href="http://mc-stan.org/">http://mc-stan.org/</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Andrea Gabrio</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>