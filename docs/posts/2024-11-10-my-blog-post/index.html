<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrea Gabrio">
<meta name="dcterms.date" content="2024-11-10">

<title>Markov Models in Economic Evaluations – Andrea Gabrio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andrea Gabrio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../missing_data.html"> 
<span class="menu-text">Missing Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#markov-models" id="toc-markov-models" class="nav-link active" data-scroll-target="#markov-models">Markov Models</a></li>
  <li><a href="#a-simple-example" id="toc-a-simple-example" class="nav-link" data-scroll-target="#a-simple-example">A simple example</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Markov Models in Economic Evaluations</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Quarto</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Academia</div>
    <div class="quarto-category">Health Economics</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://angabrio.github.io/agabriosite2/">Andrea Gabrio</a> <a href="https://orcid.org/0000-0002-7650-4534" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://www.maastrichtuniversity.nl/research/methodology-and-statistics">
            Maastricht University
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 10, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="featured.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Hello dear readers and welcome to a new post of my blog. Today, I would like to continue the discussion initiated with the last post about modelling in health economic evaluations, particularly with respect to the construction and implementation of decision analytic models or DAMs, such as the <em>Decision Tree Models</em> that were introduced last time. Picking up on this trend, in this post I would like to introduce and talk about <em>Markov Models</em> in economic evaluation, mostly drawing inspiration and references from the book <span class="citation" data-cites="khan2015design">Khan (<a href="#ref-khan2015design" role="doc-biblioref">2015</a>)</span> (Chapter 6) which contains a nice introduction and overview on this topic. As usual warning for the casual reader: in this post I may use some terms that are specific to the health economics literature and field without diving into too many explanations; when this is the case, please bear with me and perhaps make a quick online search (or check my previous posts) to check if anything is unclear to you. For a look at how to implement more complex types of markov models, I recommend checking this nice <a href="https://rpubs.com/mbounthavong/markov_model_using_excel">post</a>, although it is mostly focussed on the implementation of such models in <code>Excel</code>, and <code>heemod</code> package <a href="https://cran.r-project.org/web/packages/heemod/vignettes/c_homogeneous.html">vignette</a> for <code>R</code>.</p>
<section id="markov-models" class="level2">
<h2 class="anchored" data-anchor-id="markov-models">Markov Models</h2>
<p>When the complexity of the modelling task for disease progression increases considerably, e.g.&nbsp;because of many possible mutually exclusive outcomes or the need to repeat the analysis at given time intervals, the use and implementation of decision tree (explored in the previous post) may become quite burdensome. Rather than creating very complex branches and estimate the costs and effects associated with each possible outcome within each branch of the decision tree, it is often more useful to specify the modelling task with respect to the transition of the patients through different (and more limited) health states via <em>Markov Models</em>. More specifically, a Markov model in economic evaluation aims at modelling the transition of patients from one health state to another, and estimate the costs and effects expected to accrue as a result of transitions between health states over a period of time. The period of time over which these transitions are observed (denoted as cycle) may vary depending on the context and the type of disease being modelled, e.g.&nbsp;a week, a month, a year, or even a lifetime.</p>
<p>In Markov Models, the probabilities of moving between health states are captured as a matrix of probabilities called a <em>transition matrix</em>, where chance of moving to a different health state depends only on the current health state (and not on health states prior to the current state). This is called the <strong>Markov property</strong>: <span class="math inline">\(X_{t+1} = X_t + \varepsilon\)</span>, where <span class="math inline">\(X_{t+1}\)</span> is the health state at time <span class="math inline">\(t+1\)</span> and is dependent only on the current health state <span class="math inline">\(X_t\)</span>. An example of a simple Markov model is shown in the thumbnail figure of this post and formed by three health states (well, sick, dead) and arrows denoting the direction of the possible transitions between states. Since Markov Models are mostly simulation-based methods, no individual-level data are used to fit the models which are instead based on some aggregated data obtained from the literature or expert elicitation. This also includes the choice for the values of the transition probabilities, whose identification and selection should go through a rigorous process to ensure its reliability and appropriateness.</p>
</section>
<section id="a-simple-example" class="level2">
<h2 class="anchored" data-anchor-id="a-simple-example">A simple example</h2>
<p>As a demonstrative example, let’s consider the transition matrix shown in <a href="#tbl-example" class="quarto-xref">Table&nbsp;1</a>, which displays the assumed transition probabilities for three health states (Well, Sick and Dead) from baseline (rows) to 1 month follow-up (columns), for an hypothetical experimental treatment.</p>
<div class="cell">
<div id="tbl-example" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Example Transition Matrix on Experimental Treatment after 1 Month Post-Randomisation
</figcaption>
<div aria-describedby="tbl-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Well</th>
<th style="text-align: right;">Sick</th>
<th style="text-align: right;">Dead</th>
<th style="text-align: right;">Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Well</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sick</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dead</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Let’s also assume that patients were randomised to one of two treatments, namely Experimental vs Control, and they were considered to be in either a Well or Sick state. From <a href="#tbl-example" class="quarto-xref">Table&nbsp;1</a>, we can see that the proportion of patients who started the hypothetical trial at baseline in a Well state and then remained in the same state after treatment was <span class="math inline">\(45\%\)</span>, very few patients (<span class="math inline">\(5\%\)</span>) who started the trial in a Sick state improved into a Well state at follow up, and <span class="math inline">\(60\%\)</span> of patients who were in the Sick state did not change states after starting treatment. In order to compute what the transition matrix will look like after <span class="math inline">\(1\)</span> month, we need to know the initial probabilities (or the probabilities at baseline), say equal to the first row of <a href="#tbl-example" class="quarto-xref">Table&nbsp;1</a>. After <span class="math inline">\(1\)</span> month of treatment, the transition matrix is updated by multiplying the initial probabilities by the <span class="math inline">\(3\times3\)</span> transition matrix in <a href="#tbl-example" class="quarto-xref">Table&nbsp;1</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>tm_update <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.45</span>,<span class="fl">0.05</span>,<span class="dv">0</span>,<span class="fl">0.35</span>,<span class="fl">0.6</span>,<span class="dv">0</span>,<span class="fl">0.2</span>,<span class="fl">0.35</span>,<span class="dv">1</span>),<span class="dv">3</span>,<span class="dv">3</span>) </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>tm_init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.45</span>,<span class="fl">0.35</span>,<span class="fl">0.2</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>tm_1m <span class="ot">&lt;-</span> tm_init<span class="sc">%*%</span>tm_update</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>tm_1m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]   [,2]   [,3]
[1,] 0.22 0.3675 0.4125</code></pre>
</div>
</div>
<p>The above <span class="math inline">\(1\times3\)</span> “matrix” denotes the probabilities in each of the three health states of the model at 1 month after treatment and becomes the initial matrix needed for further calculations. After <span class="math inline">\(2\)</span> months (second cycle of the process), the updated transition matrix is obtained by multiplying the above matrix again by the <span class="math inline">\(3 \times 3\)</span> transition matrix in <a href="#tbl-example" class="quarto-xref">Table&nbsp;1</a>, and so on. In general, one can compute the proportion of patients for the <span class="math inline">\(n+1\)</span>-th step in any of these three health states by simply multiplying the updated transition matrix at step <span class="math inline">\(n\)</span> by the given transition matrix:</p>
<p><span class="math display">\[
M_n = M_{n-1}\times P,
\]</span> where <span class="math inline">\(M_n\)</span> and <span class="math inline">\(M_{n-1}\)</span> denote the <span class="math inline">\(1\times 3\)</span> transition matrix at step <span class="math inline">\(n\)</span> and <span class="math inline">\(n-1\)</span>, while <span class="math inline">\(P\)</span> denotes the constant <span class="math inline">\(3\times3\)</span> transition matrix used to update the probabilities at each step. Finally, the last important factor associated with the Markov model is the duration of the interval of time, termed a <em>cycle</em>, set to <span class="math inline">\(1\)</span> month in the example above. In general, the length of the cycle could be longer or shorter, with shorter cycles needing more computations since they imply a more frequent update of the transition probabilities, i.e.&nbsp;more steps to run.</p>
<p>To continue our example, let’s now consider a more realistic scenario where the transition matrix and initial probabilities are provided for both an experimental group and a control group form an hypothetical trial assessing the cost-effectiveness of the two treatments. The <span class="math inline">\(3\times3\)</span> transition matrices associated with the two treatments (<span class="math inline">\(P^{exp},P^{ctr}\)</span>) are shown in <a href="#tbl-example2" class="quarto-xref">Table&nbsp;2</a>, while the <span class="math inline">\(1\times3\)</span> matrices of the initial probabilities (<span class="math inline">\(M^{exp}_0,M^{ctr}_{0}\)</span>) of the two groups are assumed to be equal to the first row of their respective transition matrices.</p>
<div class="cell">
<div id="tbl-example2" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-example2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Example Transition Matrices on Experimental and Control Treatment after 1 Month Post-Randomisation
</figcaption>
<div aria-describedby="tbl-example2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Well</th>
<th style="text-align: right;">Sick</th>
<th style="text-align: right;">Dead</th>
<th style="text-align: right;">Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Well</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sick</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dead</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>We can therefore update the transition matrices of the two treatments over <span class="math inline">\(5\)</span> cycles, each of <span class="math inline">\(1\)</span> month, by doing the following</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#experimental treatment</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>tm_exp_update <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.45</span>,<span class="fl">0.05</span>,<span class="dv">0</span>,<span class="fl">0.35</span>,<span class="fl">0.6</span>,<span class="dv">0</span>,<span class="fl">0.2</span>,<span class="fl">0.35</span>,<span class="dv">1</span>),<span class="dv">3</span>,<span class="dv">3</span>) </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>tm_exp_init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.45</span>,<span class="fl">0.35</span>,<span class="fl">0.2</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#update over 5 cycles</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>tm_exp_1m <span class="ot">&lt;-</span> tm_exp_init<span class="sc">%*%</span>tm_exp_update</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>tm_exp_2m <span class="ot">&lt;-</span> tm_exp_1m<span class="sc">%*%</span>tm_exp_update</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>tm_exp_3m <span class="ot">&lt;-</span> tm_exp_2m<span class="sc">%*%</span>tm_exp_update</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>tm_exp_4m <span class="ot">&lt;-</span> tm_exp_3m<span class="sc">%*%</span>tm_exp_update</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>tm_exp_5m <span class="ot">&lt;-</span> tm_exp_4m<span class="sc">%*%</span>tm_exp_update</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">#control treatment</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>tm_ctr_update <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.10</span>,<span class="dv">0</span>,<span class="fl">0.25</span>,<span class="fl">0.45</span>,<span class="dv">0</span>,<span class="fl">0.50</span>,<span class="fl">0.45</span>,<span class="dv">1</span>),<span class="dv">3</span>,<span class="dv">3</span>) </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>tm_ctr_init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.25</span>,<span class="fl">0.50</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">#update over 5 cycles</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>tm_ctr_1m <span class="ot">&lt;-</span> tm_ctr_init<span class="sc">%*%</span>tm_ctr_update</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>tm_ctr_2m <span class="ot">&lt;-</span> tm_ctr_1m<span class="sc">%*%</span>tm_ctr_update</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>tm_ctr_3m <span class="ot">&lt;-</span> tm_ctr_2m<span class="sc">%*%</span>tm_ctr_update</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>tm_ctr_4m <span class="ot">&lt;-</span> tm_ctr_3m<span class="sc">%*%</span>tm_ctr_update</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>tm_ctr_5m <span class="ot">&lt;-</span> tm_ctr_4m<span class="sc">%*%</span>tm_ctr_update</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">#experimental TM at the end of 5th cycle</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>tm_exp_5m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]      [,2]    [,3]
[1,] 0.02642064 0.1077694 0.86581</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#control TM at the end of 5th cycle</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>tm_ctr_5m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            [,1]       [,2]      [,3]
[1,] 0.005600547 0.01602453 0.9783749</code></pre>
</div>
</div>
<p>Once the transition probabilities over the desired number of cycles are estimated, further data manipulation can be carried out to estimate the expected costs and effects, which can be included in an additional vector and then multiplied with the elements of the matrices after each cycle to generate the expected total costs and effects. As an example, let’s assume that patients were treated for <span class="math inline">\(3\)</span> months but followed up for <span class="math inline">\(12\)</span> months during the trial and that costs were collected from patients files and measured in euros, while effects were collected via self-reported questionnaires (e.g.&nbsp;EQ-5D) and measured via utilities. We need to associate to each health state and treatment in the model a corresponding value for each of the outcomes that we want to measure, i.e.&nbsp;costs and utilities. Thus, we may assume that (monthly) utilities for each health state are <span class="math inline">\(u^{well}=0.78\)</span>, <span class="math inline">\(u^{sick}=0.40\)</span>, and <span class="math inline">\(u^{dead}=0\)</span>, but are constant across treatments. Conversely, we may assume that (monthly) costs are constant across health states but vary between treatment groups, i.e.&nbsp;<span class="math inline">\(c_{exp}=954\)</span> and <span class="math inline">\(c^{ctr}=435\)</span>. Next, we need to determine the number of cycles of the model. In this case, we will use <span class="math inline">\(12\)</span> cycles given that we focus over a <span class="math inline">\(1\)</span> year follow-up, with each cycle being <span class="math inline">\(1\)</span> month long. Hence, the expected costs and QALYs for each month will be generated and then added up.</p>
<p>The proportion of patients in each of the health states at the start of the model needs to be determined, typically an arbitrary large number, e.g.&nbsp;<span class="math inline">\(10000\)</span>, since the idea is to estimate the cumulative costs and effects over the <span class="math inline">\(10000\)</span> patients for each group. We can now proceed to calculate the transition matrices and total costs and QALYs associated with both treatment groups over <span class="math inline">\(12\)</span> months via our Markov Model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set up initial values for the model</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#initial transition probs by arm</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>tm_exp_init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.45</span>,<span class="fl">0.35</span>,<span class="fl">0.2</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>tm_ctr_init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.25</span>,<span class="fl">0.50</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#transition matrices by arm</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>tm_exp_update <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.45</span>,<span class="fl">0.05</span>,<span class="dv">0</span>,<span class="fl">0.35</span>,<span class="fl">0.6</span>,<span class="dv">0</span>,<span class="fl">0.2</span>,<span class="fl">0.35</span>,<span class="dv">1</span>),<span class="dv">3</span>,<span class="dv">3</span>) </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>tm_ctr_update <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.10</span>,<span class="dv">0</span>,<span class="fl">0.25</span>,<span class="fl">0.45</span>,<span class="dv">0</span>,<span class="fl">0.50</span>,<span class="fl">0.45</span>,<span class="dv">1</span>),<span class="dv">3</span>,<span class="dv">3</span>) </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">#utilities by health state</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>u_well <span class="ot">&lt;-</span> <span class="fl">0.78</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>u_sick <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>u_dead <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">#costs by arm</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>c_exp <span class="ot">&lt;-</span> <span class="dv">954</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>c_ctr <span class="ot">&lt;-</span> <span class="dv">435</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">#number of cycles</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>n_cycle <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">#initial number of patients in the cohort</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>n_pat <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co">#end of cycle 1 TP</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>trans_mat_cycle1_exp <span class="ot">&lt;-</span> tm_exp_init<span class="sc">%*%</span>tm_exp_update</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>trans_mat_cycle1_ctr <span class="ot">&lt;-</span> tm_ctr_init<span class="sc">%*%</span>tm_ctr_update</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co">#lists to store TP results by cycle</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>trans_mat_cycles_exp <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>trans_mat_cycles_ctr <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co">#create function to run the model</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>mm_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(tm_exp_init,tm_ctr_init,tm_exp_update,tm_ctr_update,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                   u_well,u_sick,u_dead,c_exp,c_ctr,n_cycle,n_pat){</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  res_list <span class="ot">&lt;-</span> res_list_exp <span class="ot">&lt;-</span> res_list_ctr <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#set up matrices to contain results from all TP over each cycle by group</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  tm_exp <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_cycle<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(tm_exp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Well"</span>,<span class="st">"Sick"</span>,<span class="st">"Dead"</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  tm_ctr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_cycle<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(tm_ctr) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Well"</span>,<span class="st">"Sick"</span>,<span class="st">"Dead"</span>)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">#assign first row to be initial TP</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  tm_exp[<span class="dv">1</span>,] <span class="ot">&lt;-</span> tm_exp_init</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  tm_ctr[<span class="dv">1</span>,] <span class="ot">&lt;-</span> tm_ctr_init</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">#loop through cycles and update TM at each cycle</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">c</span>(n_cycle<span class="sc">+</span><span class="dv">1</span>)){</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    tm_exp[i,] <span class="ot">&lt;-</span> tm_exp[i<span class="dv">-1</span>,]<span class="sc">%*%</span>tm_exp_update</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    tm_ctr[i,] <span class="ot">&lt;-</span> tm_ctr[i<span class="dv">-1</span>,]<span class="sc">%*%</span>tm_ctr_update</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remove intial TP from matrices</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  tm_exp <span class="ot">&lt;-</span> tm_exp[<span class="sc">-</span><span class="dv">1</span>,]</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  tm_ctr <span class="ot">&lt;-</span> tm_ctr[<span class="sc">-</span><span class="dv">1</span>,]</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">#using obtained TM to compute number of patients in each health state at each cycle</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  npat_cycle_exp <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_cycle<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(npat_cycle_exp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Well"</span>,<span class="st">"Sick"</span>,<span class="st">"Dead"</span>)</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  npat_cycle_ctr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_cycle<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(npat_cycle_ctr) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Well"</span>,<span class="st">"Sick"</span>,<span class="st">"Dead"</span>)</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  npat_cycle_exp <span class="ot">&lt;-</span> tm_exp<span class="sc">*</span>n_pat</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  npat_cycle_ctr <span class="ot">&lt;-</span> tm_ctr<span class="sc">*</span>n_pat</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">#and number still alive</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>  nailive_cycle_exp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rowSums</span>(npat_cycle_exp[,<span class="sc">-</span><span class="dv">3</span>]))</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(nailive_cycle_exp) <span class="ot">&lt;-</span> <span class="st">"nalive"</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>  nailive_cycle_ctr <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rowSums</span>(npat_cycle_ctr[,<span class="sc">-</span><span class="dv">3</span>]))</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(nailive_cycle_ctr) <span class="ot">&lt;-</span> <span class="st">"nalive"</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>  <span class="co">#use obtained number of patients at each cycle to get the same for costs and QALYs</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  costs_cycle_exp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rowSums</span>(<span class="fu">as.matrix</span>(tm_exp<span class="sc">*</span>c_exp)[,<span class="sc">-</span><span class="dv">3</span>]))</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(costs_cycle_exp) <span class="ot">&lt;-</span> <span class="st">"costs"</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>  costs_cycle_ctr <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rowSums</span>(<span class="fu">as.matrix</span>(tm_ctr<span class="sc">*</span>c_ctr)[,<span class="sc">-</span><span class="dv">3</span>]))</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(costs_cycle_ctr) <span class="ot">&lt;-</span> <span class="st">"costs"</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>  QALY_cycle_exp <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_cycle<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(QALY_cycle_exp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Well"</span>,<span class="st">"Sick"</span>,<span class="st">"Dead"</span>)</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>  QALY_cycle_ctr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_cycle<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(QALY_cycle_ctr) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Well"</span>,<span class="st">"Sick"</span>,<span class="st">"Dead"</span>)</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>  u_well_v <span class="ot">&lt;-</span> <span class="fu">rep</span>(u_well,n_cycle)</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>  u_sick_v <span class="ot">&lt;-</span> <span class="fu">rep</span>(u_sick,n_cycle)</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  u_dead_v <span class="ot">&lt;-</span> <span class="fu">rep</span>(u_dead,n_cycle)</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  u_M <span class="ot">&lt;-</span> <span class="fu">cbind</span>(u_well_v,u_sick_v,u_dead_v)</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  QALY_cycle_exp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rowSums</span>(<span class="fu">as.matrix</span>(tm_exp<span class="sc">*</span>u_M)[,<span class="sc">-</span><span class="dv">3</span>]))</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(QALY_cycle_exp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"QALYs"</span>)</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>  QALY_cycle_ctr <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rowSums</span>(<span class="fu">as.matrix</span>(tm_ctr<span class="sc">*</span>u_M)[,<span class="sc">-</span><span class="dv">3</span>]))</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(QALY_cycle_ctr) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"QALYs"</span>)</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save output</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>  res_list_exp[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> tm_exp</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  res_list_exp[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> npat_cycle_exp</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>  res_list_exp[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> nailive_cycle_exp</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>  res_list_exp[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> costs_cycle_exp</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>  res_list_exp[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> QALY_cycle_exp</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>  res_list_ctr[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> tm_ctr</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>  res_list_ctr[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> npat_cycle_ctr</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>  res_list_ctr[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> nailive_cycle_ctr</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>  res_list_ctr[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> costs_cycle_ctr</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>  res_list_ctr[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> QALY_cycle_ctr</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(res_list_exp)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"TM"</span>,<span class="st">"npatients"</span>,<span class="st">"nalive"</span>,<span class="st">"costs"</span>,<span class="st">"QALYs"</span>)</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(res_list_ctr)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"TM"</span>,<span class="st">"npatients"</span>,<span class="st">"nalive"</span>,<span class="st">"costs"</span>,<span class="st">"QALYs"</span>)</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>  res_list[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> res_list_exp</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>  res_list[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> res_list_ctr</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(res_list)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Experimental"</span>,<span class="st">"Control"</span>)</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res_list)</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a><span class="co">#run the function and get the output</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>mm_res <span class="ot">&lt;-</span> <span class="fu">mm_sim</span>(<span class="at">tm_exp_init =</span> tm_exp_init, <span class="at">tm_ctr_init =</span> tm_ctr_init, <span class="at">tm_exp_update =</span> tm_exp_update,</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>       <span class="at">tm_ctr_update =</span> tm_ctr_update, <span class="at">u_well =</span> u_well, <span class="at">u_sick =</span> u_sick, <span class="at">u_dead =</span> u_dead, <span class="at">c_exp =</span> c_exp,</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>       <span class="at">c_ctr =</span> c_ctr, <span class="at">n_cycle =</span> n_cycle, <span class="at">n_pat =</span> n_pat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, we can extract information regarding the number of patients associated with each health state at each cycle of the model for both intervention groups:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#experimental</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>mm_res<span class="sc">$</span>Experimental<span class="sc">$</span>npatients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Well       Sick     Dead
 [1,] 2200.00000 3675.00000 4125.000
 [2,] 1173.75000 2975.00000 5851.250
 [3,]  676.93750 2195.81250 7127.250
 [4,]  414.41250 1554.41562 8031.172
 [5,]  264.20641 1077.69375 8658.100
 [6,]  172.77757  739.08849 9088.134
 [7,]  114.70433  503.92524 9381.370
 [8,]   76.81321  342.50166 9580.685
 [9,]   51.69103  232.38562 9715.923
[10,]   34.88024  157.52323 9807.597
[11,]   23.57227  106.72203 9869.706
[12,]   15.94362   72.28351 9911.773</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#control</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mm_res<span class="sc">$</span>Control<span class="sc">$</span>npatients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Well        Sick     Dead
 [1,] 875.0000000 1750.000000 7375.000
 [2,] 393.7500000 1006.250000 8600.000
 [3,] 199.0625000  551.250000 9249.688
 [4,] 104.8906250  297.828125 9597.281
 [5,]  56.0054687  160.245313 9783.749
 [6,]  30.0258984   86.111758 9883.862
 [7,]  16.1176504   46.256766 9937.626
 [8,]   8.6550892   24.844957 9966.500
 [9,]   4.6482680   13.344003 9982.008
[10,]   2.4964673    7.166868 9990.337
[11,]   1.3408037    3.849208 9994.810
[12,]   0.7201217    2.067344 9997.213</code></pre>
</div>
</div>
<p>or the costs and QALYs accrued at each cycle across the alive patients</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#experimental</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>mm_res<span class="sc">$</span>Experimental<span class="sc">$</span>costs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           costs
 [1,] 560.475000
 [2,] 395.790750
 [3,] 274.060350
 [4,] 187.826203
 [5,] 128.017275
 [6,]  86.992022
 [7,]  59.017262
 [8,]  40.002639
 [9,]  27.100912
[10,]  18.355292
[11,]  12.430076
[12,]   8.416869</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mm_res<span class="sc">$</span>Experimental<span class="sc">$</span>QALYs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            QALYs
 [1,] 0.318600000
 [2,] 0.210552500
 [3,] 0.140633625
 [4,] 0.094500800
 [5,] 0.063715850
 [6,] 0.043040190
 [7,] 0.029103948
 [8,] 0.019691497
 [9,] 0.013327325
[10,] 0.009021588
[11,] 0.006107518
[12,] 0.004134943</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#control</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>mm_res<span class="sc">$</span>Control<span class="sc">$</span>costs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            costs
 [1,] 114.1875000
 [2,]  60.9000000
 [3,]  32.6385937
 [4,]  17.5182656
 [5,]   9.4069090
 [6,]   5.0519880
 [7,]   2.7132871
 [8,]   1.4572520
 [9,]   0.7826638
[10,]   0.4203551
[11,]   0.2257655
[12,]   0.1212548</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>mm_res<span class="sc">$</span>Control<span class="sc">$</span>QALYs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             QALYs
 [1,] 0.1382500000
 [2,] 0.0709625000
 [3,] 0.0375768750
 [4,] 0.0200945938
 [5,] 0.0107782391
 [6,] 0.0057864904
 [7,] 0.0031074474
 [8,] 0.0016688952
 [9,] 0.0008963250
[10,] 0.0004813992
[11,] 0.0002585510
[12,] 0.0001388633</code></pre>
</div>
</div>
<p>from which an estimate of the mean costs and QALYs (and the group differences) over the <span class="math inline">\(12\)</span> months period (without discounting) can be obtained by taking the sum across these accrued expected values at each cycle</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#experimental</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mu_c_exp <span class="ot">&lt;-</span> <span class="fu">sum</span>(mm_res<span class="sc">$</span>Experimental<span class="sc">$</span>costs)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>mu_e_exp <span class="ot">&lt;-</span> <span class="fu">sum</span>(mm_res<span class="sc">$</span>Experimental<span class="sc">$</span>QALYs)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#control</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>mu_c_ctr <span class="ot">&lt;-</span> <span class="fu">sum</span>(mm_res<span class="sc">$</span>Control<span class="sc">$</span>costs)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>mu_e_ctr <span class="ot">&lt;-</span> <span class="fu">sum</span>(mm_res<span class="sc">$</span>Control<span class="sc">$</span>QALYs)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>mu_c_diff <span class="ot">&lt;-</span> mu_c_exp<span class="sc">-</span>mu_c_ctr</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>mu_e_diff <span class="ot">&lt;-</span> mu_e_exp<span class="sc">-</span>mu_e_ctr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and from this an estimate of the ICER can be obtained:</p>
<p><span class="math display">\[
\text{ICER} = \frac{1798.4846494 - 245.4238347}{0.9524298-0.2900002} =\frac{1553.0608148}{0.6624296} = 2344.49
\]</span></p>
<p>I hope you enjoyed today’s topic as it was quite interesting, at least for me. I always want to learn more about this stuff and rarely have the time do so. By going through the coding, I think things become much easier to understand, especially when these types of models can be quite complex and difficult to grasp by just reading it on a paper. Probably next time I will dive into the uncertainty assessment for these models, which at the moment I neglected due to time constraints. Well, I hope to see you back on my next post to learn how to do that as well (if you are interested).</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-khan2015design" class="csl-entry" role="listitem">
Khan, Iftekhar. 2015. <em>Design &amp; Analysis of Clinical Trials for Economic Evaluation &amp; Reimbursement: An Applied Approach Using SAS &amp; STATA</em>. CRC Press.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024, Andrea Gabrio</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>