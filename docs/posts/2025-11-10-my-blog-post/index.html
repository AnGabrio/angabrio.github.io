<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrea Gabrio">
<meta name="dcterms.date" content="2025-11-10">

<title>Conducting trial-based cost-effectiveness analyses: â€“ Andrea Gabrio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andrea Gabrio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../missing_data.html"> 
<span class="menu-text">Missing Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#combine-mi-and-bootstrapping-in-cea" id="toc-combine-mi-and-bootstrapping-in-cea" class="nav-link active" data-scroll-target="#combine-mi-and-bootstrapping-in-cea">Combine MI and bootstrapping in CEA</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Conducting trial-based cost-effectiveness analyses:</h1>
<p class="subtitle lead">A tutorial - II</p>
  <div class="quarto-categories">
    <div class="quarto-category">Quarto</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Academia</div>
    <div class="quarto-category">HTA</div>
    <div class="quarto-category">Cost-Effectiveness</div>
    <div class="quarto-category">Tutorial</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://angabrio.github.io/agabriosite2/">Andrea Gabrio</a> <a href="https://orcid.org/0000-0002-7650-4534" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://www.maastrichtuniversity.nl/research/methodology-and-statistics">
            Maastricht University
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 10, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Hello dear readers, and welcome back to my blog as usual. Today I would like to provide a quick update as I am in the middle of my heavy teaching period and therefore I do not have much time to write extensive stuff here, my apologies. Mainly a couple of updates:</p>
<ol type="1">
<li><p>Last month I attended the <a href="https://www.bayes-pharma.org/bayes-2025/">Bayes Conference 2025</a>, where I presented my latest work related to handling missing data in trial-based CEA with a focus on how to specify Bayesian models to handle missing healthcare resource use. The work has also been recently published on MDM and, if you are interested, you arr welcome to have a free look at it <a href="https://journals.sagepub.com/doi/full/10.1177/0272989X251376026">here</a>. As for the conference, I found it really interesting as it has a heavy focus on pharmaceutical and consultancy companies interests and topics, mostly related to satisfying requirements of regulatory HTA bodies for the submission of HTA assessments or related statistical analyses. Many important statisticians in the field were also present there, either working in academia or in the industry, who brought up a series of interesting theoretical and practical matters related to statistical analyses of clinical and health data. Unfortunately for me, my session was not particularly attractive to this audience as my focus was specifically on trial-based analyses for which, especially pharmas, there is not much of an interest. Regardless I am happy that I was able to join the conference after a long absence (I think since 2015!) and see how things have evolved and how big of an event it has now become.</p></li>
<li><p>Right before leaving for the conference I had the pleasure to give a presentation about trial-based CEA and the importance of using adequate statistical methods in these analyses for the <a href="https://www.maastrichtuniversity.nl/research/health-services-research">Health Services Research</a> department here at UM. I have collaborated on a series of projects with a few people from this department in the last years, mostly related to the analyses of HTA data, and I have been asked to provide a sort of workshop to PhD students and interested analysts on key analysis methods for trial-based CEAs and how to implement them in <code>R</code>. The workshop went well, although I did not manage to cover all topics I intended, as the people present were really interested in the topic and asked a few questions on what they would like to see in a future session. I have provided all material discussed in the last workshop on my <a href="https://github.com/AnGabrio/Code/tree/master/RHTAmethods">GitHub repository</a> to allow people to play around with the examples, slides, <code>R</code> scripts and functions I created to illustrate how different statistical issues typical of CEA data may be handled in practice. I really hope this was helpful for them. Given the interest in the topic, we have decided to double down and give a second workshop this month on another requested topics, namely conducting HTA using decision-based models. I plan to have a similar session to the last one, perhaps with a little more emphasis on the coding aspect since I noted that all attendees last time had their laptops with them and seemed somewhat familiar with <code>R</code>.</p></li>
</ol>
<p>Apart from the previous news, I would also like to provide an update to the code I shared on my last post with respect to the analyses of trial-based CEA data. In particular, due to limited time, last time I provided examples on implementing a series of alternative methods to handle issues such as skewness, correlation, clustering and missing data. One aspect that I skipped at the end was specifically on how to combine missing data methods, namely multiple imputation, with non-parametric bootstrapping approaches for the generation of bootstrap samples that can be used to quantify the level of uncertainty around CE quantities while also appropriately taking into account missingness uncertainty. So, to fill in this gap, today I wanted to complete the code and include a function that can be used to combine the two methods, something that is usually needed when conducting the analyses in practice.</p>
<section id="combine-mi-and-bootstrapping-in-cea" class="level1">
<h1>Combine MI and bootstrapping in CEA</h1>
<p>The following (folded) code is a copy of what I used in my last post to generate some artificial CEA data for exemplary purposes to demonstrate how MICE and non-parametric bootstrapping may be combined in <code>R</code>. If not of interest, you may skip the folded code and jump to the actual implementation code in the next section. In this simulation I will make things easy and generate data assuming normal distributions and limited number of covariate data. However, the implementation of the methods shown in the following sections is general and can be applied to more realistic data too.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#simulate data and missing under different mechanisms</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#set rng for reproducibility</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2345</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#set up parameter values to generate data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>n_full <span class="ot">&lt;-</span> <span class="dv">250</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>mu_x1 <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>sd_x1 <span class="ot">&lt;-</span> <span class="fl">0.15</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>x1_data <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_full, mu_x1, sd_x1) <span class="co">#simulate covariate values</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>n_full <span class="ot">&lt;-</span> <span class="dv">250</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>mu_x2 <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>sd_x2 <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>x2_data <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_full, mu_x2, sd_x2) <span class="co">#simulate covariate values</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>p_trt <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>trt_data <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_full, p_trt, <span class="at">size =</span> <span class="dv">1</span>)<span class="co">#simulate trt indicator</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>beta0_data <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>beta1_data <span class="ot">&lt;-</span> <span class="fl">0.15</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>beta2_data <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">#simulate outcome values</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>y1_data <span class="ot">&lt;-</span> beta0_data <span class="sc">+</span> beta1_data<span class="sc">*</span>trt_data <span class="sc">+</span> beta2_data<span class="sc">*</span>x1_data <span class="sc">+</span> <span class="fu">rnorm</span>(n_full, <span class="dv">0</span>, <span class="fl">0.1</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>alpha0_data <span class="ot">&lt;-</span> <span class="dv">250</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>alpha1_data <span class="ot">&lt;-</span> <span class="dv">35</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>alpha2_data <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>alpha3_data <span class="ot">&lt;-</span> <span class="dv">55</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">#simulate outcome values</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>y2_data <span class="ot">&lt;-</span> alpha0_data <span class="sc">+</span> alpha1_data<span class="sc">*</span>trt_data <span class="sc">+</span> alpha2_data<span class="sc">*</span>x2_data <span class="sc">+</span> alpha3_data<span class="sc">*</span>y1_data <span class="sc">+</span> <span class="fu">rnorm</span>(n_full, <span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">#generate fully-observed datset and assign names to variables</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>full.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(y1_data,y2_data,trt_data,x1_data,x2_data)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(full.df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"QALY"</span>,<span class="st">"TC"</span>,<span class="st">"trt"</span>,<span class="st">"u"</span>,<span class="st">"c"</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>full.df<span class="sc">$</span>trt <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(full.df<span class="sc">$</span>trt<span class="sc">==</span><span class="dv">0</span>,<span class="st">"old"</span>,<span class="st">"new"</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>full.df<span class="sc">$</span>trt <span class="ot">&lt;-</span> <span class="fu">factor</span>(full.df<span class="sc">$</span>trt, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"old"</span>,<span class="st">"new"</span>))</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">#introduce MAR missingness in QALY given u</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">#set rng for reproducibility</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2345</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">#set parameter values for mechanisms</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>eta0_mar <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">9</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>eta_1_mar <span class="ot">&lt;-</span> <span class="fl">14.5</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>eta_2_mar <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>eta_3_mar <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>p_mar_e <span class="ot">&lt;-</span> <span class="fu">inv.logit</span>(eta0_mar <span class="sc">+</span> eta_1_mar<span class="sc">*</span>full.df<span class="sc">$</span>u <span class="sc">+</span> eta_2_mar<span class="sc">*</span>full.df<span class="sc">$</span>QALY <span class="sc">+</span> eta_3_mar<span class="sc">*</span><span class="fu">as.numeric</span>(full.df<span class="sc">$</span>trt))</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>iota0_mar <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">4</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>iota_1_mar <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>iota_2_mar <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>iota_3_mar <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>p_mar_c <span class="ot">&lt;-</span> <span class="fu">inv.logit</span>(iota0_mar <span class="sc">+</span> iota_1_mar<span class="sc">*</span>full.df<span class="sc">$</span>c<span class="sc">/</span><span class="dv">100</span> <span class="sc">+</span> iota_2_mar<span class="sc">*</span>full.df<span class="sc">$</span>TC <span class="sc">+</span> iota_3_mar<span class="sc">*</span><span class="fu">as.numeric</span>(full.df<span class="sc">$</span>trt))</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co">#generate missing data indicators (0=observed,1=missing)</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>m_mar_e <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_full, p_mar_e, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>m_mar_c <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_full, p_mar_c, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>full.mar <span class="ot">&lt;-</span> full.df</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co">#introduce MAR missing QALY data and distinguish between a variable showing only the observed QALY values (QALY_obs) and another showing only the missing QALY values (QALY_mis)</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>full.mar<span class="sc">$</span>m_QALY <span class="ot">&lt;-</span> m_mar_e</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>full.mar<span class="sc">$</span>m_TC <span class="ot">&lt;-</span> m_mar_c</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>full.mar<span class="sc">$</span>QALY_obs <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(full.mar<span class="sc">$</span>m_QALY<span class="sc">==</span><span class="dv">0</span>,full.mar<span class="sc">$</span>QALY,<span class="cn">NA</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>full.mar<span class="sc">$</span>TC_obs <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(full.mar<span class="sc">$</span>m_TC<span class="sc">==</span><span class="dv">0</span>,full.mar<span class="sc">$</span>TC,<span class="cn">NA</span>)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co">#randomly shuffle rows of the MAR dataset</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>full.mar <span class="ot">&lt;-</span> full.mar[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(full.mar)), ]</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co">#keep only relevant variables and rename them</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>dataset.mis <span class="ot">&lt;-</span> full.mar[,<span class="fu">c</span>(<span class="st">"QALY_obs"</span>,<span class="st">"TC_obs"</span>,<span class="st">"trt"</span>,<span class="st">"u"</span>,<span class="st">"c"</span>)]</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dataset.mis) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"QALY"</span>,<span class="st">"TC"</span>,<span class="st">"trt"</span>,<span class="st">"u"</span>,<span class="st">"c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can inspect the first few rows of the generated data stored in the <code>R</code> object <code>full.mar</code> to see the variable showing the observed QALY values (<code>QALY</code>) and TC values (<code>TC</code>), which were generated under a MAR mechanism conditional on the fully observed baseline utilities (<code>u</code>) and costs (<code>c</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dataset.mis, <span class="at">n=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         QALY       TC trt         u         c
34  0.6891580 378.6541 new 0.3518463  91.95314
48  0.8021310       NA new 0.5254678  93.04074
193 0.4477710 455.1781 new 0.2485247 126.63579
188 0.8710712 471.2896 new 0.4307028 110.27430
58  0.7926060       NA new 0.4134793 103.14698
87         NA 458.9715 new 0.6311773 114.55390
135 0.6656135 423.3912 new 0.3820836 132.51559
107 0.6320513 320.8635 new 0.3455197 116.77745</code></pre>
</div>
</div>
<p>Here, I will skip descriptions and presentations of MI and bootstrapping as these were given in my previous post, so I will assume that readers will already be familiar with these methods and what they do. If you are not sure, check my previous post for a refresher.</p>
<p>First, I will use the following <code>R</code> code to implement MICE (under a MAR assumption) to the generated data. The following MI specification is used: number of imputations <span class="math inline">\(M=5\)</span>; PMM as imputation method for all missing variables (<code>QALY</code> and <code>TC</code>) using corresponding observed baseline values (<code>u</code> and <code>c</code>) as the only variables included in their respective imputation models.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice) <span class="co">#load package to implement MICE</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#split data by treatment group (Old and New)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>dataset.mis_Old <span class="ot">&lt;-</span> dataset.mis[dataset.mis<span class="sc">$</span>trt<span class="sc">==</span><span class="st">"old"</span>,]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>dataset.mis_New <span class="ot">&lt;-</span> dataset.mis[dataset.mis<span class="sc">$</span>trt<span class="sc">==</span><span class="st">"new"</span>,]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#set up MICE inputs for old group</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>mice_Old <span class="ot">&lt;-</span> <span class="fu">mice</span>(dataset.mis_Old, <span class="at">print =</span> <span class="cn">FALSE</span>, <span class="at">method =</span> <span class="st">'pmm'</span>, <span class="at">maxit =</span> <span class="dv">0</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>pM_Old <span class="ot">&lt;-</span> mice_Old<span class="sc">$</span>predictorMatrix <span class="co">#extract default predictor matrix</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#customise pred matrix to your needs (row=variable to be imputed, column=variable used as predictor)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#in the matrix an entry of 1 means that the corresponding column variable is used as predictor for the corresponding row variable</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>pM_Old[<span class="st">"QALY"</span>,<span class="fu">c</span>(<span class="st">"TC"</span>,<span class="st">"u"</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#require that QALY always imputed using TC and u</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>pM_Old[<span class="st">"QALY"</span>,<span class="fu">c</span>(<span class="st">"c"</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#require that QALY is never imputed using c</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>pM_Old[<span class="st">"TC"</span>,<span class="fu">c</span>(<span class="st">"u"</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#require that TC is never imputed using u</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>pM_Old[,<span class="fu">c</span>(<span class="st">"trt"</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#require that any variable is never imputed using trt</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>meth_Old <span class="ot">&lt;-</span> mice_Old<span class="sc">$</span>method <span class="co">#extract default imputation methods</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#by default PMM assumed as imputation methods for numeric variables</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">#set up MICE inputs for new group</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>mice_New <span class="ot">&lt;-</span> <span class="fu">mice</span>(dataset.mis_New, <span class="at">print =</span> <span class="cn">FALSE</span>, <span class="at">method =</span> <span class="st">'pmm'</span>, <span class="at">maxit =</span> <span class="dv">0</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>pM_New <span class="ot">&lt;-</span> mice_New<span class="sc">$</span>predictorMatrix <span class="co">#extract default predictor matrix</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>pM_New[<span class="st">"QALY"</span>,<span class="fu">c</span>(<span class="st">"TC"</span>,<span class="st">"u"</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#require that QALY always imputed using TC and u</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>pM_New[<span class="st">"QALY"</span>,<span class="fu">c</span>(<span class="st">"c"</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#require that QALY is never imputed using c</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>pM_New[<span class="st">"TC"</span>,<span class="fu">c</span>(<span class="st">"u"</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#require that TC is never imputed using u</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>pM_New[,<span class="fu">c</span>(<span class="st">"trt"</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#require that any variable is never imputed using trt</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>meth_New <span class="ot">&lt;-</span> mice_New<span class="sc">$</span>method <span class="co">#extract default imputation methods</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co">#number of imputations</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co">#set rng for reproducibility</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2345</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">#implement MICE to old and new group</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>mice_Old_fit <span class="ot">&lt;-</span> <span class="fu">mice</span>(dataset.mis_Old, <span class="at">predictorMatrix =</span> pM_Old, <span class="at">method=</span>meth_Old, <span class="at">m =</span> M, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>mice_New_fit <span class="ot">&lt;-</span> <span class="fu">mice</span>(dataset.mis_New, <span class="at">predictorMatrix =</span> pM_New, <span class="at">method=</span>meth_New, <span class="at">m =</span> M, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">#combine the imputed datasets across groups</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>mice_fit <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mice_Old_fit, mice_New_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, rather then simply fitting the analysis model to each imputed data sets and summarise the output, as it would be the normal approach from statistical analyses, it is necessary to specify how the bootstrapping technique should be combined with MICE in order to generate bootstrapped and multiply-imputed estimates for the CE quantities of interest, i.e.&nbsp;mean incrementals for QLAYs and Total costs between groups. As I briefly mention at the end of my last post, combination of MI with bootstrapping or other non-standard analysis methods can be very challenging and clear guidelines about the performance of the methods when combined together is still lacking <span class="citation" data-cites="schomaker2018bootstrap brand2019combining">(<a href="#ref-schomaker2018bootstrap" role="doc-biblioref">Schomaker and Heumann 2018</a>; <a href="#ref-brand2019combining" role="doc-biblioref">Brand et al. 2019</a>)</span>. In particular, two main distinct combination strategies may be considered:</p>
<ol type="1">
<li><p><strong>Multiple Imputation for the inner loop) &amp; Bootstrapping for the outer loop</strong> (MB). The general idea behind this strategy is to first apply MI to the original data set to generate <span class="math inline">\(M\)</span> replications of the imputed data set; then non-parametric bootstrapping is applied to each of these <span class="math inline">\(M\)</span> data sets to generate <span class="math inline">\(B\)</span> bootstrap replications for each of the multiply-imputed data sets, thus producing a total of <span class="math inline">\(M\times B\)</span> different data sets. Next, the analysis model of interest is fitted to each of these data sets and associated <span class="math inline">\(M\times B\)</span> estimates for the parameters of interest are derived.</p></li>
<li><p><strong>Multiple Imputation for the outer loop) &amp; Bootstrapping for the inner loop</strong> (BM). The general idea behind this strategy is to first apply non-parametric bootstrapping to the original data set to generate <span class="math inline">\(B\)</span> bootstrap replications of the original data set (including missing values); then MI is applied to each of these <span class="math inline">\(B\)</span> data sets to generate <span class="math inline">\(M\)</span> multiply-imputed data sets for each of the bootstrapped data sets, thus producing a total of <span class="math inline">\(B\times M\)</span> different data sets. Next, the analysis model of interest is fitted to each of these data sets and associated <span class="math inline">\(B\times M\)</span> estimates for the parameters of interest are derived.</p></li>
</ol>
<p>Regardless of the strategy used to combine MI and bootstrapping, it is then necessary to decide how to summarise the relevant parameter estimates after <span class="math inline">\(M \times B\)</span> replications have been produced. Also here different approaches have been considered. One option would be to use the entire <span class="math inline">\(M \times B\)</span> set of parameter estimate replications in order to quantify the level of uncertainty around them. This means that the entire distribution is used to generate standard CE output, such as CE plane and CEAC and related CE quantities with associated intervals. A second option would be to first average parameter estimates across the <span class="math inline">\(M\)</span> multiply-imputed replications in order to obtain a distribution of <span class="math inline">\(B\)</span> estimates, which would then represent the values to be used for generating the CE output.</p>
<p>Although the relative performance of these approaches have been examined under some simulation scenarios, where no large differences across these methods have been detected, their actual performance under general situations still needs to be fully assessed. Thus, no general guidelines exist that can recommend one approach over the other in all cases, especially given that these results are based on simulation methods. As a practical guideline, it may be important to outline that <em>BM</em> can be computationally much more intensive to implement with respect to <em>MB</em>, since the number of bootstrap iterations is typically required to be much higher compared to the number of imputations.</p>
<p>The following (folded) code part shows how to construct a function which allows the implementation of either MB or BM strategies in the context of trial-based CEA when fitting either a OLS or SUR as the main analysis model for CE data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#function and needed packages to generate bootstrap estimates for mean QALY/TC and incremental</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#differences when running a OLS/SUR model after applying MICE to handle missing data</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#note: different ways to combine MI and bootstrapping estimates can be obtained based on the inputs provided</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(systemfit)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bootstrap)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>boot_mi_ec <span class="ot">&lt;-</span> <span class="cf">function</span>(x, B, QALYreg, TCreg, <span class="at">method =</span> <span class="st">"OLS"</span>, </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">profile_QALY=</span><span class="st">"default"</span>, <span class="at">profile_TC=</span><span class="st">"default"</span>, </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">trt_pos =</span> <span class="dv">2</span>, <span class="at">combine=</span><span class="st">"MB"</span>){</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#the following lines are needed to make sure proper inputs are given</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(x, <span class="fu">c</span>(<span class="st">"mids"</span>))) {<span class="fu">stop</span>(<span class="st">"Only objects of class 'mids' can be used"</span>)}</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.data.frame</span>(x<span class="sc">$</span>data)){<span class="fu">stop</span>(<span class="st">"data needs to be a data frame object"</span>)}</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(B)){<span class="fu">stop</span>(<span class="st">"please provide number of bootstrap iterations"</span>)}</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(B<span class="sc">&lt;=</span><span class="dv">0</span> <span class="sc">|</span> <span class="sc">!</span>B<span class="sc">%%</span><span class="dv">1</span><span class="sc">==</span><span class="dv">0</span>){<span class="fu">stop</span>(<span class="st">"please provide number of bootstrap iterations"</span>)}</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is_formula</span>(QALYreg)){<span class="fu">stop</span>(<span class="st">"please provide formula for QALY model"</span>)}</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is_formula</span>(TCreg)){<span class="fu">stop</span>(<span class="st">"please provide formula for TC model"</span>)}</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>method <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"OLS"</span>,<span class="st">"SUR"</span>)){<span class="fu">stop</span>(<span class="st">"please provide valid method name"</span>)}</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>combine <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"MB"</span>,<span class="st">"BM"</span>)){<span class="fu">stop</span>(<span class="st">"please provide valid combination name"</span>)}</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.numeric</span>(trt_pos) <span class="sc">|</span> <span class="fu">length</span>(trt_pos)<span class="sc">!=</span><span class="dv">1</span> <span class="sc">|</span> trt_pos<span class="sc">&lt;=</span><span class="dv">0</span>){<span class="fu">stop</span>(<span class="st">"please provide valid trt indicator position in regressions"</span>)}</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> x<span class="sc">$</span>data <span class="co">#original data set</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">dim</span>(data)[<span class="dv">1</span>] <span class="co">#original sample size</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">#n covariates </span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  nX_e <span class="ot">&lt;-</span> <span class="fu">dim</span>(<span class="fu">model.matrix</span>(QALYreg, data))[<span class="dv">2</span>]</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  nX_c <span class="ot">&lt;-</span> <span class="fu">dim</span>(<span class="fu">model.matrix</span>(TCreg, data))[<span class="dv">2</span>]</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#extract name of trt indicator and outcomes from provided formula</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  trt_name_e <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(QALYreg)[trt_pos]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  trt_name_c <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(TCreg)[trt_pos]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(trt_name_e <span class="sc">!=</span> trt_name_c){<span class="fu">stop</span>(<span class="st">"please provide same trt variable name and position in QALY and TC formuale"</span>)}</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  QALY_name <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(QALYreg)[<span class="dv">1</span>]</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  TC_name <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(TCreg)[<span class="dv">1</span>]</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#check if trt indicator is factor and store its levels</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.factor</span>(data[,trt_name_e])){</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    trt_fact <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    trt_lev <span class="ot">&lt;-</span> <span class="fu">levels</span>(data[,trt_name_e])} <span class="cf">else</span> {</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      trt_fact <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      trt_lev <span class="ot">&lt;-</span> <span class="fu">unique</span>(data[,trt_name_e])}</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(trt_lev)<span class="sc">!=</span><span class="dv">2</span>){<span class="fu">stop</span>(<span class="st">"The function only allows comparison between two trt groups"</span>)}  </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">#check that correct profile provided or set default</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(profile_QALY <span class="sc">!=</span> <span class="st">"default"</span>){</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.vector</span>(profile_QALY) <span class="sc">|</span> <span class="fu">length</span>(profile_QALY)<span class="sc">!=</span>nX_e){<span class="fu">stop</span>(<span class="st">"provide valid profile for QALYreg"</span>)}}</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(profile_TC <span class="sc">!=</span> <span class="st">"default"</span>){</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.vector</span>(profile_TC) <span class="sc">|</span> <span class="fu">length</span>(profile_TC)<span class="sc">!=</span>nX_c){<span class="fu">stop</span>(<span class="st">"provide valid profile for TCreg"</span>)}}</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">#extract MI infor from input object</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> x<span class="sc">$</span>m <span class="co">#n imputations</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  pm <span class="ot">&lt;-</span> x<span class="sc">$</span>predictorMatrix <span class="co">#predictor matrix</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">#remove trt as predictor</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  pm[,trt_name_e] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">#pm &lt;- pm[-which(colnames(pm)==trt_name_e),-which(colnames(pm)==trt_name_e)]</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  meth <span class="ot">&lt;-</span> x<span class="sc">$</span>method <span class="co">#imputation methods</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  niter <span class="ot">&lt;-</span> x<span class="sc">$</span>iteration <span class="co">#n iterations before sampling</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">#split original data by treatment group </span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>  x_trt1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x<span class="sc">$</span>data[x<span class="sc">$</span>data[,trt_name_e]<span class="sc">==</span><span class="fu">unique</span>(data[,trt_name_e])[<span class="dv">1</span>],])</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>  x_trt2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x<span class="sc">$</span>data[x<span class="sc">$</span>data[,trt_name_e]<span class="sc">==</span><span class="fu">unique</span>(data[,trt_name_e])[<span class="dv">2</span>],])</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">#generate imputations and bootstrap estimates based on inputs</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(combine <span class="sc">==</span> <span class="st">"MB"</span>){ <span class="co">#outer loop=MI + inner loop=Boot</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">#prepare empty objects to contain bootstrapped estimates</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    data_MB_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    coeff_c <span class="ot">&lt;-</span> coeff_e <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> M, <span class="at">ncol =</span> B)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    em_c_ctr <span class="ot">&lt;-</span> em_e_ctr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> M, <span class="at">ncol =</span> B)</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    em_c_int <span class="ot">&lt;-</span> em_e_int <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> M, <span class="at">ncol =</span> B)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    data_imp <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>      <span class="co">#apply MI to each arm based on arguments from mice objects provided as input</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>      mice_data_trt1 <span class="ot">&lt;-</span> <span class="fu">mice</span>(x_trt1, <span class="at">predictorMatrix =</span> pm, </span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">method=</span>meth,<span class="at">m =</span> M, <span class="at">maxit =</span> niter, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>      mice_data_trt2 <span class="ot">&lt;-</span> <span class="fu">mice</span>(x_trt2, <span class="at">predictorMatrix =</span> pm, </span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">method=</span>meth,<span class="at">m =</span> M, <span class="at">maxit =</span> niter, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>      <span class="co">#combine the imputed datasets across groups</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>      data_imp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mice_data_trt1, mice_data_trt2)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>      <span class="co">#extract imputed data sets</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>      data_imp[[m]] <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="fu">complete</span>(data_imp,m))</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">#sample with replacement for each imputed data set</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>        data_MB_list[[i]] <span class="ot">&lt;-</span> data_imp[[m]][<span class="fu">sample</span>(.N, n, <span class="at">replace =</span> T)]</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>        <span class="co">#fit model</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>        model_MB_ec <span class="ot">&lt;-</span> <span class="fu">systemfit</span>(<span class="fu">list</span>(<span class="at">QALYreg =</span> QALYreg, <span class="at">TCreg =</span> TCreg), </span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>                              <span class="at">method=</span>method, <span class="at">data=</span>data_MB_list[[i]])        </span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">#extract covariate values</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>        X_e <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(model_MB_ec<span class="sc">$</span>eq[[<span class="dv">1</span>]])</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>        X_c <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(model_MB_ec<span class="sc">$</span>eq[[<span class="dv">2</span>]])        </span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        <span class="co">#define QALYreg profile</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(profile_QALY <span class="sc">==</span> <span class="st">"default"</span>){</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>          profile_b_QALY <span class="ot">&lt;-</span> <span class="fu">apply</span>(X_e, <span class="dv">2</span>, mean, <span class="at">na.rm=</span>T)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {profile_b_QALY <span class="ot">&lt;-</span> profile_QALY}</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>        profile_b_QALY_ctr <span class="ot">&lt;-</span> profile_b_QALY_int <span class="ot">&lt;-</span> profile_b_QALY</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>        profile_b_QALY_ctr[trt_pos] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#set profile for comparator</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        profile_b_QALY_int[trt_pos] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#set profile for reference</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">#define TCreg profile</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(profile_TC <span class="sc">==</span> <span class="st">"default"</span>){</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>          profile_b_TC <span class="ot">&lt;-</span> <span class="fu">apply</span>(X_c, <span class="dv">2</span>, mean, <span class="at">na.rm=</span>T)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {profile_b_TC <span class="ot">&lt;-</span> profile_TC}</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>        profile_b_TC_ctr <span class="ot">&lt;-</span> profile_b_TC_int <span class="ot">&lt;-</span> profile_b_TC</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>        profile_b_TC_ctr[trt_pos] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#set profile for comparator</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        profile_b_TC_int[trt_pos] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#set profile for reference</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>        <span class="co">#extract coefficient estimates from each model</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>        coeff_e[m,i] <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_MB_ec<span class="sc">$</span>eq[[<span class="dv">1</span>]])<span class="sc">$</span>coefficients[trt_pos,<span class="st">"Estimate"</span>]</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>        coeff_c[m,i] <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_MB_ec<span class="sc">$</span>eq[[<span class="dv">2</span>]])<span class="sc">$</span>coefficients[trt_pos,<span class="st">"Estimate"</span>]        </span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>        <span class="co">#compute linear combination of parameters</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>        em_e_ctr[m,i] <span class="ot">&lt;-</span> <span class="fu">t</span>(profile_b_QALY_ctr) <span class="sc">%*%</span> <span class="fu">summary</span>(model_MB_ec<span class="sc">$</span>eq[[<span class="dv">1</span>]])<span class="sc">$</span>coefficients[,<span class="st">"Estimate"</span>] </span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>        em_e_int[m,i] <span class="ot">&lt;-</span> <span class="fu">t</span>(profile_b_QALY_int) <span class="sc">%*%</span> <span class="fu">summary</span>(model_MB_ec<span class="sc">$</span>eq[[<span class="dv">1</span>]])<span class="sc">$</span>coefficients[,<span class="st">"Estimate"</span>] </span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>        em_c_ctr[m,i] <span class="ot">&lt;-</span> <span class="fu">t</span>(profile_b_TC_ctr) <span class="sc">%*%</span> <span class="fu">summary</span>(model_MB_ec<span class="sc">$</span>eq[[<span class="dv">2</span>]])<span class="sc">$</span>coefficients[,<span class="st">"Estimate"</span>] </span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>        em_c_int[m,i] <span class="ot">&lt;-</span> <span class="fu">t</span>(profile_b_TC_int) <span class="sc">%*%</span> <span class="fu">summary</span>(model_MB_ec<span class="sc">$</span>eq[[<span class="dv">2</span>]])<span class="sc">$</span>coefficients[,<span class="st">"Estimate"</span>]         </span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(combine <span class="sc">==</span> <span class="st">"BM"</span>){ <span class="co">#outer loop=Boot + inner loop=MI</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">#prepare empty objects to contain bootstrapped estimates</span></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    data_BM_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    coeff_c <span class="ot">&lt;-</span> coeff_e <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> B, <span class="at">ncol =</span> M)</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    em_c_ctr <span class="ot">&lt;-</span> em_e_ctr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> B, <span class="at">ncol =</span> M)</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>    em_c_int <span class="ot">&lt;-</span> em_e_int <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> B, <span class="at">ncol =</span> M)</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>    data.dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(x<span class="sc">$</span>data)</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>    data_imp <span class="ot">&lt;-</span> <span class="fu">list</span>()    </span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>      <span class="co">#sample with replacement from original data set</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>      data_BM_list[[i]] <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(data.dt[<span class="fu">sample</span>(.N, n, <span class="at">replace =</span> T)])</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>      <span class="co">#split data by arm</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>      data_BM_trt1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(data_BM_list[[i]][data_BM_list[[i]][,trt_name_e]<span class="sc">==</span><span class="fu">unique</span>(x<span class="sc">$</span>data[,trt_name_e])[<span class="dv">1</span>],])</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>      data_BM_trt2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(data_BM_list[[i]][data_BM_list[[i]][,trt_name_e]<span class="sc">==</span><span class="fu">unique</span>(x<span class="sc">$</span>data[,trt_name_e])[<span class="dv">2</span>],])</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>      <span class="co">#apply MI per arm based on arguments from mice objects provided as input</span></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>      mice_data_boot_trt1 <span class="ot">&lt;-</span> <span class="fu">mice</span>(data_BM_trt1, <span class="at">predictorMatrix =</span> pm, </span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>                             <span class="at">method=</span>meth,<span class="at">m =</span> M, <span class="at">maxit =</span> niter, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>      mice_data_boot_trt2 <span class="ot">&lt;-</span> <span class="fu">mice</span>(data_BM_trt2, <span class="at">predictorMatrix =</span> pm, </span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">method=</span>meth,<span class="at">m =</span> M, <span class="at">maxit =</span> niter, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>      <span class="co">#combine the imputed datasets across groups</span></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>      mice_data_boot <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mice_data_boot_trt1, mice_data_boot_trt2)</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>        <span class="co">#extract each imputed data set</span></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>        data_imp[[m]] <span class="ot">&lt;-</span> <span class="fu">complete</span>(mice_data_boot, m)</span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>        <span class="co">#fit model to each imputed data set</span></span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>        model_BM_ec <span class="ot">&lt;-</span> <span class="fu">systemfit</span>(<span class="fu">list</span>(<span class="at">QALYreg =</span> QALYreg, <span class="at">TCreg =</span> TCreg), </span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method=</span>method, <span class="at">data=</span>data_imp[[m]])  </span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>        <span class="co">#extract covariate values</span></span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>        X_e <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(model_BM_ec<span class="sc">$</span>eq[[<span class="dv">1</span>]])</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>        X_c <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(model_BM_ec<span class="sc">$</span>eq[[<span class="dv">2</span>]])        </span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>        <span class="co">#define QALYreg profile</span></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(profile_QALY <span class="sc">==</span> <span class="st">"default"</span>){</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>          profile_b_QALY <span class="ot">&lt;-</span> <span class="fu">apply</span>(X_e, <span class="dv">2</span>, mean, <span class="at">na.rm=</span>T)</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {profile_b_QALY <span class="ot">&lt;-</span> profile_QALY}</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>        profile_b_QALY_ctr <span class="ot">&lt;-</span> profile_b_QALY_int <span class="ot">&lt;-</span> profile_b_QALY</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>        profile_b_QALY_ctr[trt_pos] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#set profile for comparator</span></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>        profile_b_QALY_int[trt_pos] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#set profile for reference</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>        <span class="co">#define TCreg profile</span></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(profile_TC <span class="sc">==</span> <span class="st">"default"</span>){</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>          profile_b_TC <span class="ot">&lt;-</span> <span class="fu">apply</span>(X_c, <span class="dv">2</span>, mean, <span class="at">na.rm=</span>T)</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {profile_b_TC <span class="ot">&lt;-</span> profile_TC}</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>        profile_b_TC_ctr <span class="ot">&lt;-</span> profile_b_TC_int <span class="ot">&lt;-</span> profile_b_TC</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>        profile_b_TC_ctr[trt_pos] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#set profile for comparator</span></span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>        profile_b_TC_int[trt_pos] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#set profile for reference        </span></span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>        <span class="co">#extract coefficient estimates from each model</span></span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>        coeff_e[i,m] <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_BM_ec<span class="sc">$</span>eq[[<span class="dv">1</span>]])<span class="sc">$</span>coefficients[trt_pos,<span class="st">"Estimate"</span>]</span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>        coeff_c[i,m] <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_BM_ec<span class="sc">$</span>eq[[<span class="dv">2</span>]])<span class="sc">$</span>coefficients[trt_pos,<span class="st">"Estimate"</span>]</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>        <span class="co">#compute linear combination of parameters</span></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>        em_e_ctr[i,m] <span class="ot">&lt;-</span> <span class="fu">t</span>(profile_b_QALY_ctr) <span class="sc">%*%</span> <span class="fu">summary</span>(model_BM_ec<span class="sc">$</span>eq[[<span class="dv">1</span>]])<span class="sc">$</span>coefficients[,<span class="st">"Estimate"</span>] </span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>        em_e_int[i,m] <span class="ot">&lt;-</span> <span class="fu">t</span>(profile_b_QALY_int) <span class="sc">%*%</span> <span class="fu">summary</span>(model_BM_ec<span class="sc">$</span>eq[[<span class="dv">1</span>]])<span class="sc">$</span>coefficients[,<span class="st">"Estimate"</span>] </span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>        em_c_ctr[i,m] <span class="ot">&lt;-</span> <span class="fu">t</span>(profile_b_TC_ctr) <span class="sc">%*%</span> <span class="fu">summary</span>(model_BM_ec<span class="sc">$</span>eq[[<span class="dv">2</span>]])<span class="sc">$</span>coefficients[,<span class="st">"Estimate"</span>] </span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>        em_c_int[i,m] <span class="ot">&lt;-</span> <span class="fu">t</span>(profile_b_TC_int) <span class="sc">%*%</span> <span class="fu">summary</span>(model_BM_ec<span class="sc">$</span>eq[[<span class="dv">2</span>]])<span class="sc">$</span>coefficients[,<span class="st">"Estimate"</span>]                 </span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>    }    </span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>  <span class="co">#create list objects to store all results </span></span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>  res_e_b_list <span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"Delta_e"</span><span class="ot">=</span>coeff_e,<span class="st">"mu_e_ctr"</span><span class="ot">=</span>em_e_ctr,<span class="st">"mu_e_int"</span><span class="ot">=</span>em_e_int)</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>  res_c_b_list <span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"Delta_c"</span><span class="ot">=</span>coeff_c,<span class="st">"mu_c_ctr"</span><span class="ot">=</span>em_c_ctr,<span class="st">"mu_c_int"</span><span class="ot">=</span>em_c_int)</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>  input_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"data"</span><span class="ot">=</span>x<span class="sc">$</span>data,<span class="st">"method"</span><span class="ot">=</span>method, <span class="st">"trt_pos"</span><span class="ot">=</span>trt_pos, <span class="st">"QALYreg"</span><span class="ot">=</span>QALYreg,</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"TCreg"</span><span class="ot">=</span>TCreg,<span class="st">"profile_QALY_ctr"</span><span class="ot">=</span>profile_b_QALY_ctr,</span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"profile_QALY_int"</span><span class="ot">=</span>profile_b_QALY_int,<span class="st">"profile_TC_ctr"</span><span class="ot">=</span>profile_b_TC_ctr,</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"profile_TC_int"</span><span class="ot">=</span>profile_b_TC_int, <span class="st">"combine"</span><span class="ot">=</span>combine)</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>  <span class="co">#compute overall list and return it as output from the function</span></span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>  res_ec_b_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"QALY_boot"</span><span class="ot">=</span>res_e_b_list,<span class="st">"TC_boot"</span><span class="ot">=</span>res_c_b_list,<span class="st">"inputs"</span><span class="ot">=</span>input_list)</span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(res_ec_b_list) <span class="ot">&lt;-</span> <span class="st">"bootMICE"</span></span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res_ec_b_list)</span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, I show how the above function can be implemented to the generated data to fit either a BM or MB strategy. To avoid a too long computational time and due to the demonstrative purpose of the post, I will fix the number of bootstrap replications to <span class="math inline">\(B=25\)</span>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#combine MICE with bootstrapping based on OLS/SUR analyses to obtain distributions of statistics of interest </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#such as mean QALY/TC by arm and mean differences between groups</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#get MI and bootstrap results (25 iterations x 5 imputations = 125 replications)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#version MB: first generate M imputed datasets (outer loop) and then within each</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#imputed dataset generate B bootstrap replications (inner loop)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2345</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>boot_mi_res <span class="ot">&lt;-</span> <span class="fu">boot_mi_ec</span>(<span class="at">x=</span>mice_fit, <span class="at">QALYreg =</span> QALY<span class="sc">~</span>trt<span class="sc">+</span>u, </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">TCreg =</span> TC<span class="sc">~</span>trt<span class="sc">+</span>c,<span class="at">method =</span> <span class="st">"OLS"</span>,<span class="at">B=</span><span class="dv">25</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">combine =</span> <span class="st">"MB"</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#summarise B x M matrix of estimates in two possible ways:</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#1)average across imputations </span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>MB1_res_Delta_e <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>Delta_e, <span class="dv">2</span>, mean)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>MB1_res_mu_e_ctr <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>mu_e_ctr, <span class="dv">2</span>, mean)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>MB1_res_mu_e_int <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>mu_e_int, <span class="dv">2</span>, mean)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>MB1_res_Delta_c <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>Delta_c, <span class="dv">2</span>, mean)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>MB1_res_mu_c_ctr <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>mu_c_ctr, <span class="dv">2</span>, mean)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>MB1_res_mu_c_int <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>mu_c_int, <span class="dv">2</span>, mean)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">#2)average across imputations and bootstrap replicates</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>MB2_res_Delta_e <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>Delta_e)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>MB2_res_mu_e_ctr <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>mu_e_ctr)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>MB2_res_mu_e_int <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>mu_e_int)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>MB2_res_Delta_c <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>Delta_c)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>MB2_res_mu_c_ctr <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>mu_c_ctr)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>MB2_res_mu_c_int <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>mu_c_int)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co">#version BM: first generate B bootstrap replications (outer loop) and then within each</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="co">#bootstrapped dataset generate M imputations (inner loop)</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2345</span>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>boot_mi_res <span class="ot">&lt;-</span> <span class="fu">boot_mi_ec</span>(<span class="at">x=</span>mice_fit, <span class="at">QALYreg =</span> QALY<span class="sc">~</span>trt<span class="sc">+</span>u, </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>                          <span class="at">TCreg =</span> TC<span class="sc">~</span>trt<span class="sc">+</span>c,<span class="at">method =</span> <span class="st">"OLS"</span>,<span class="at">B=</span><span class="dv">25</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                          <span class="at">combine =</span> <span class="st">"BM"</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co">#summarise B x M matrix of estimates in two possible ways:</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co">#1)average across imputations </span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>BM1_res_Delta_e <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>Delta_e, <span class="dv">1</span>, mean)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>BM1_res_mu_e_ctr <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>mu_e_ctr, <span class="dv">1</span>, mean)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>BM1_res_mu_e_int <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>mu_e_int, <span class="dv">1</span>, mean)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>BM1_res_Delta_c <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>Delta_c, <span class="dv">1</span>, mean)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>BM1_res_mu_c_ctr <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>mu_c_ctr, <span class="dv">1</span>, mean)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>BM1_res_mu_c_int <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>mu_c_int, <span class="dv">1</span>, mean)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="co">#2)average across imputations and bootstrap replicates</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>BM2_res_Delta_e <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>Delta_e)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>BM2_res_mu_e_ctr <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>mu_e_ctr)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>BM2_res_mu_e_int <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>QALY_boot<span class="sc">$</span>mu_e_int)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>BM2_res_Delta_c <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>Delta_c)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>BM2_res_mu_c_ctr <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>mu_c_ctr)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>BM2_res_mu_c_int <span class="ot">&lt;-</span> <span class="fu">c</span>(boot_mi_res<span class="sc">$</span>TC_boot<span class="sc">$</span>mu_c_int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we can quickly compare the generated incremental quantities <span class="math inline">\(\Delta_e\)</span> distributions under each strategy and aggregation approach, for example using histograms. First, we consider using the averaged <span class="math inline">\(B\)</span> estimates across the <span class="math inline">\(M\)</span> imputations under either MB (red) or BM (blue).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>and then using all the <span class="math inline">\(M\times B\)</span> estimates under either MB (red) or BM (blue)</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Similar functions that allow the implementation of MI and bootstrapping for GLMs and MLMs are also available from my <a href="https://github.com/AnGabrio/Code/tree/master/RHTAmethods">GitHub repository</a>, where there is also a separate file containing all well-wrapped functions that I showed in this and the last post for trial-based CE analyses. Thanks again for reading, and I hope this will be of help for some of you. Till next time!</p>
</section>
<section id="references" class="level1">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-brand2019combining" class="csl-entry" role="listitem">
Brand, Jaap, Stef van Buuren, Saskia le Cessie, and Wilbert van den Hout. 2019. <span>â€œCombining Multiple Imputation and Bootstrap in the Analysis of Cost-Effectiveness Trial Data.â€</span> <em>Statistics in Medicine</em> 38 (2): 210â€“20.
</div>
<div id="ref-schomaker2018bootstrap" class="csl-entry" role="listitem">
Schomaker, Michael, and Christian Heumann. 2018. <span>â€œBootstrap Inference When Using Multiple Imputation.â€</span> <em>Statistics in Medicine</em> 37 (14): 2252â€“66.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Â© Copyright 2024, Andrea Gabrio</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>